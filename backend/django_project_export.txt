
================================================================================
FILE: exportcode.py
================================================================================

import os

# Extensions to include
ALLOWED_EXTENSIONS = {".py", ".html", ".css", ".js"}

# Directories to ignore
EXCLUDED_DIRS = {
    "venv",
    ".git",
    "__pycache__",
    "node_modules",
    "migrations",
    ".vscode"
}

OUTPUT_FILE = "django_project_export.txt"


def should_include_file(filename):
    return os.path.splitext(filename)[1] in ALLOWED_EXTENSIONS


def export_files(root_dir):
    with open(OUTPUT_FILE, "w", encoding="utf-8") as output:
        for root, dirs, files in os.walk(root_dir):
            # Remove excluded directories from traversal
            dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]

            for file in files:
                if should_include_file(file):
                    file_path = os.path.join(root, file)
                    relative_path = os.path.relpath(file_path, root_dir)

                    output.write(f"\n{'=' * 80}\n")
                    output.write(f"FILE: {relative_path}\n")
                    output.write(f"{'=' * 80}\n\n")

                    try:
                        with open(file_path, "r", encoding="utf-8") as f:
                            output.write(f.read())
                    except Exception as e:
                        output.write(f"[Could not read file: {e}]\n")


if __name__ == "__main__":
    project_root = os.getcwd()  # Run from project root
    export_files(project_root)
    print(f"Export complete! Files saved to '{OUTPUT_FILE}'")
================================================================================
FILE: manage.py
================================================================================

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'nutrilift.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

================================================================================
FILE: accounts\admin.py
================================================================================

from django.contrib import admin
from .models import User, Organization, OrgMembership

@admin.register(User)
class UserAdmin(admin.ModelAdmin):
    list_display = ("email", "is_staff", "is_active", "is_superuser", "date_joined")
    search_fields = ("email",)
    ordering = ("-date_joined",)
    filter_horizontal = ()
    fieldsets = (
        (None, {"fields": ("email", "password")}),
        ("Permissions", {"fields": ("is_active", "is_staff", "is_superuser", "groups", "user_permissions")}),
        ("Dates", {"fields": ("last_login", "date_joined")}),
    )
    add_fieldsets = ((None, {"classes": ("wide",), "fields": ("email", "password1", "password2")}),)

# @admin.register(Organization)
# class OrganizationAdmin(admin.ModelAdmin):
#     list_display = ("name", "org_type", "city", "state", "country", "is_active")
#     search_fields = ("name", "city", "state", "country")
#     list_filter = ("org_type", "is_active")

# @admin.register(OrgMembership)
# class OrgMembershipAdmin(admin.ModelAdmin):
#     list_display = ("user", "organization", "role", "is_active", "created_at","assistance_suspended")
#     list_filter = ("role", "is_active", "organization__org_type","assistance_suspended")
#     search_fields = ("user__email", "organization__name")

@admin.register(Organization)
class OrganizationAdmin(admin.ModelAdmin):
    list_display = ("name", "org_type", "city", "state", "country",
                    "is_active", "assistance_suspended")
    list_filter = ("org_type", "is_active", "assistance_suspended")
    search_fields = ("name", "city", "state", "country")

# --- Option 1: simplest (no org suspension on this list) ---
@admin.register(OrgMembership)
class OrgMembershipAdmin(admin.ModelAdmin):
    list_display = ("user", "organization", "role", "is_active", "created_at")
    list_filter = ("role", "is_active", "organization__org_type")
    search_fields = ("user__email", "organization__name")
================================================================================
FILE: accounts\apps.py
================================================================================

from django.apps import AppConfig
class AccountsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "accounts"

================================================================================
FILE: accounts\decorators.py
================================================================================

from functools import wraps
from django.http import HttpResponseForbidden

def require_roles(*roles, allow_superuser=False):
    """
    Usage:
    @require_roles("SAPA_ADMIN", "ORG_ADMIN", allow_superuser=True)
    def view(request): ...
    """
    def decorator(view_func):
        @wraps(view_func)
        def _wrapped(request, *args, **kwargs):
            u = request.user
            if not u.is_authenticated:
                return HttpResponseForbidden("Auth required.")
            if allow_superuser and u.is_superuser:
                return view_func(request, *args, **kwargs)
            mem = getattr(request, "membership", None)
            if not mem:
                return HttpResponseForbidden("Organization context required.")
            if mem.role in roles:
                return view_func(request, *args, **kwargs)
            return HttpResponseForbidden("Insufficient role.")
        return _wrapped
    return decorator

================================================================================
FILE: accounts\managers.py
================================================================================

from django.contrib.auth.base_user import BaseUserManager

class UserManager(BaseUserManager):
    use_in_migrations = True

    def create_user(self, email, password=None, **extra):
        if not email:
            raise ValueError("Email is required")
        email = self.normalize_email(email)
        user = self.model(email=email, **extra)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra):
        extra.setdefault("is_staff", True)
        extra.setdefault("is_superuser", True)
        return self.create_user(email, password, **extra)

================================================================================
FILE: accounts\middleware.py
================================================================================

from django.http import HttpResponseForbidden
from .models import OrgMembership, Organization

class CurrentOrganizationMiddleware:
    """
    Sets request.org and request.membership for authenticated users.

    Selection order:
      1) X-Organization-Id header (numeric id) if the user is a member
      2) ?org=<id> query param (for quick testing)
      3) If the user has exactly one active membership, use it
      4) Otherwise, no org attached (views can enforce via @require_roles)
    """
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        request.org = None
        request.membership = None

        u = getattr(request, "user", None)
        if u and u.is_authenticated:
            qs = OrgMembership.objects.select_related("organization").filter(user=u, is_active=True)

            # 0) Session-selected org (set by onboarding or token link)
            sess_org_id = request.session.get("current_org_id")
            if sess_org_id:
                try:
                    mem = qs.get(organization_id=int(sess_org_id))
                    request.org = mem.organization
                    request.membership = mem
                    return self.get_response(request)
                except (OrgMembership.DoesNotExist, ValueError):
                    # Remove invalid session org
                    request.session.pop("current_org_id", None)

            # 1) Header or ?org= fallback (kept as-is)
            org_id = request.headers.get("X-Organization-Id") or request.GET.get("org")
            if org_id:
                try:
                    mem = qs.get(organization_id=int(org_id))
                    request.org = mem.organization
                    request.membership = mem
                except (OrgMembership.DoesNotExist, ValueError):
                    return HttpResponseForbidden("Invalid organization for this user.")
            elif qs.count() == 1:
                mem = qs.first()
                request.org = mem.organization
                request.membership = mem
        return self.get_response(request)

================================================================================
FILE: accounts\models.py
================================================================================

from django.db import models
from django.contrib.auth.models import AbstractUser
from .managers import UserManager

class Role(models.TextChoices):
    ORG_ADMIN = "ORG_ADMIN", "School Admin"
    TEACHER   = "TEACHER", "Teacher"
    SAPA_ADMIN = "SAPA_ADMIN", "SAPA Admin"
    INDITECH  = "INDITECH", "Inditech"
    SAPA_PGC = "SAPA_PGC", "SAPA Governing Committee"
    MANUFACTURER = "MANUFACTURER", "Manufacturer"
    LOGISTICS = "LOGISTICS", "Logistics Partner"

class User(AbstractUser):
    """
    Email-first auth; username removed. Users can belong to multiple orgs via OrgMembership.
    """
    username = None
    email = models.EmailField(unique=True)

    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = []

    objects = UserManager()

    def __str__(self):
        return self.email

class Organization(models.Model):
    class OrgType(models.TextChoices):
        SCHOOL = "SCHOOL", "School"
        NGO = "NGO", "NGO"
        SAPA = "SAPA", "SAPA"
        INDITECH = "INDITECH", "Inditech"
        
        MANUFACTURER = "MANUFACTURER", "Manufacturer"
        LOGISTICS = "LOGISTICS", "Logistics Partner"

    name = models.CharField(max_length=255)
    org_type = models.CharField(max_length=16, choices=OrgType.choices, default=OrgType.SCHOOL)
    city = models.CharField(max_length=128, blank=True)
    state = models.CharField(max_length=128, blank=True)
    country = models.CharField(max_length=64, blank=True)
    timezone = models.CharField(max_length=64, default="Asia/Kolkata")
    screening_link_token = models.SlugField(max_length=64, unique=True)  # used later for the teacher link
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    assistance_suspended = models.BooleanField(default=False)
    assistance_suspended_at = models.DateTimeField(null=True, blank=True)
    assistance_suspension_reason = models.CharField(max_length=255, blank=True)
    def __str__(self):
        return self.name

class OrgMembership(models.Model):
    """
    Many-to-many link: a user can have different roles in different organizations.
    """
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="memberships")
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="memberships")
    role = models.CharField(max_length=16, choices=Role.choices)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = (("user", "organization", "role"),)
        indexes = [
            models.Index(fields=["organization", "role"]),
            models.Index(fields=["user", "organization"]),
        ]

    def __str__(self):
        return f"{self.user.email} @ {self.organization.name} ({self.role})"

================================================================================
FILE: accounts\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: accounts\views.py
================================================================================

from django.shortcuts import render

# Create your views here.

================================================================================
FILE: accounts\__init__.py
================================================================================


================================================================================
FILE: accounts\management\commands\bootstrap_foundations.py
================================================================================

from django.core.management.base import BaseCommand
from django.utils.crypto import get_random_string
from accounts.models import User, Organization, OrgMembership, Role

class Command(BaseCommand):
    help = "Create superuser and a demo organization + admin membership."

    def add_arguments(self, parser):
        parser.add_argument("--superuser-email", default="admin@nutrilift.local")
        parser.add_argument("--superuser-password", default=None)
        parser.add_argument("--org-name", default="Demo School")
        parser.add_argument("--org-type", default="SCHOOL")

    def handle(self, *args, **opts):
        email = opts["superuser_email"]
        password = opts["superuser_password"] or get_random_string(16)
        org_name = opts["org_name"]
        org_type = opts["org_type"]

        # Superuser
        su, created = User.objects.get_or_create(email=email, defaults={"is_staff": True, "is_superuser": True})
        if created:
            su.set_password(password)
            su.save()
            self.stdout.write(self.style.SUCCESS(f"Created superuser {email} / {password}"))
        else:
            self.stdout.write(self.style.WARNING(f"Superuser {email} already exists"))

        # Demo org
        from django.utils.text import slugify
        token = slugify(org_name) + "-" + get_random_string(8)
        org, _ = Organization.objects.get_or_create(name=org_name, defaults={
            "org_type": org_type, "screening_link_token": token
        })
        self.stdout.write(self.style.SUCCESS(f"Organization ready: {org.name} (token={org.screening_link_token})"))

        # Membership for superuser (as School Admin)
        OrgMembership.objects.get_or_create(user=su, organization=org, role=Role.ORG_ADMIN)
        self.stdout.write(self.style.SUCCESS("Membership added (ORG_ADMIN)."))

        self.stdout.write(self.style.SUCCESS("Foundations bootstrap complete."))

================================================================================
FILE: assist\admin.py
================================================================================

from django.contrib import admin
from .models import Application
from .models import ApprovalBatch, BatchItem

@admin.register(Application)
class ApplicationAdmin(admin.ModelAdmin):
    list_display = ("id","organization","student","guardian","status","source","applied_at","forwarded_at")
    list_filter = ("organization","status","source")
    search_fields = ("student__first_name","student__last_name","guardian__phone_e164")



@admin.register(ApprovalBatch)
class ApprovalBatchAdmin(admin.ModelAdmin):
    list_display = ("organization","method","n_selected","executed_at","created_by")
    list_filter = ("organization","method")
    search_fields = ("organization__name",)

@admin.register(BatchItem)
class BatchItemAdmin(admin.ModelAdmin):
    list_display = ("approval_batch","application","outcome","created_at")
    list_filter = ("outcome",)
    search_fields = ("approval_batch__organization__name","application__student__first_name","application__student__last_name")

================================================================================
FILE: assist\apps.py
================================================================================

from django.apps import AppConfig


class AssistConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'assist'

================================================================================
FILE: assist\forms.py
================================================================================

from django import forms

class ParentConsentForm(forms.Form):
    agree_consent = forms.BooleanField(label="I agree to receive monthly nutrition support for my child.", required=True)
    confirm_understanding = forms.BooleanField(label="I have read and understood the program information.", required=True)

    def as_form_data(self):
        d = self.cleaned_data.copy()
        # Store ONLY consent flags. We intentionally do not collect/stash
        # parent identifiers (name/phone/address) from the public link.
        return {
            "agree_consent": d.get("agree_consent", False),
            "confirm_understanding": d.get("confirm_understanding", False),
        }

================================================================================
FILE: assist\models.py
================================================================================

from django.db import models
from django.utils import timezone
from accounts.models import Organization, User
from roster.models import Student, Guardian


class Application(models.Model):
    class Source(models.TextChoices):
        TEACHER = "TEACHER", "Teacher"
        PARENT  = "PARENT", "Parent"

    class Status(models.TextChoices):
        APPLIED   = "APPLIED", "Applied"
        FORWARDED = "FORWARDED", "Forwarded to SAPA"
        APPROVED  = "APPROVED", "Approved"
        REJECTED  = "REJECTED", "Rejected"
        CLOSED    = "CLOSED", "Closed"   # optional future use

    class IncomeVerificationStatus(models.TextChoices):
        PENDING = "PENDING", "Pending school verification"
        VERIFIED = "VERIFIED", "Verified"
        REJECTED = "REJECTED", "Rejected"

    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="applications")
    pid = models.CharField(max_length=64, null=True, blank=True, db_index=True)
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name="applications")
    guardian = models.ForeignKey(Guardian, on_delete=models.SET_NULL, null=True, blank=True, related_name="applications")

    # Screening that triggered this application (used for auditability and baseline linkage)
    trigger_screening = models.ForeignKey(
        "screening.Screening",
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="assistance_applications",
    )

    # Set from Screening.is_low_income_at_screen at the time of application.
    # School admins can verify/reject before forwarding to SAPA.
    low_income_declared = models.BooleanField(default=False)
    income_verification_status = models.CharField(
        max_length=16,
        choices=IncomeVerificationStatus.choices,
        default=IncomeVerificationStatus.PENDING,
        db_index=True,
    )
    income_verified_at = models.DateTimeField(null=True, blank=True)
    income_verified_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="income_verified_applications",
    )
    income_verification_notes = models.CharField(max_length=255, blank=True)

    source = models.CharField(max_length=16, choices=Source.choices, default=Source.PARENT)
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.APPLIED)

    form_lang = models.CharField(max_length=12, default="en")
    form_data = models.JSONField(default=dict, blank=True)

    applied_at = models.DateTimeField(default=timezone.now)
    sapa_reviewed_at = models.DateTimeField(null=True, blank=True)  # NEW
    forwarded_at = models.DateTimeField(null=True, blank=True)
    forwarded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name="forwarded_applications")

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [
            models.Index(fields=["organization", "created_at"]),
            models.Index(fields=["organization", "status", "created_at"]),
            models.Index(fields=["organization", "pid", "status", "created_at"]),  # NEW
        ]


    def __str__(self):
        return f"{self.student.full_name} – {self.status}"

# from accounts.models import User

class ApprovalBatch(models.Model):
    class Method(models.TextChoices):
        ALL_PENDING = "ALL_PENDING", "All pending"
        TOP_N_ALPHA = "TOP_N_ALPHA", "Top-N alphabetic"

    organization = models.ForeignKey("accounts.Organization", on_delete=models.CASCADE, related_name="approval_batches")
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name="approval_batches")
    method = models.CharField(max_length=16, choices=Method.choices)
    n_selected = models.PositiveIntegerField(null=True, blank=True)
    
    executed_at = models.DateTimeField(default=timezone.now)

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [models.Index(fields=["organization", "-executed_at"])]

    def __str__(self):
        return f"{self.organization.name} – {self.method} – {self.executed_at:%Y-%m-%d %H:%M}"


class BatchItem(models.Model):
    class Outcome(models.TextChoices):
        APPROVED = "APPROVED", "Approved"
        REJECTED = "REJECTED", "Rejected"
        SKIPPED  = "SKIPPED",  "Skipped"   # e.g., not in the Top-N

    approval_batch = models.ForeignKey(ApprovalBatch, on_delete=models.CASCADE, related_name="items")
    application = models.ForeignKey(Application, on_delete=models.CASCADE, related_name="batch_items")
    outcome = models.CharField(max_length=16, choices=Outcome.choices)
    note = models.CharField(max_length=255, blank=True)

    created_at = models.DateTimeField(default=timezone.now, db_index=True)

    class Meta:
        indexes = [models.Index(fields=["outcome","created_at"])]

================================================================================
FILE: assist\services.py
================================================================================

from typing import Iterable, List, Tuple
from django.db import transaction
from django.db.models.functions import Lower, Coalesce
from django.db.models import Value, CharField
from django.utils import timezone
from accounts.models import Organization, User
from roster.models import Student
from .models import Application, ApprovalBatch, BatchItem
from program.models import Enrollment
from audit.utils import audit_log
from django.conf import settings
from decimal import Decimal

def _alphabetic_qs(org: Organization):
    # Case-insensitive ordering; blank last_name handled as ''
    return (Application.objects
            .select_related("student")
            .filter(organization=org, status=Application.Status.FORWARDED)
            .order_by(Coalesce(Lower("student__last_name"), Value("", output_field=CharField())),
                      Coalesce(Lower("student__first_name"), Value("", output_field=CharField()))))

@transaction.atomic
def approve_all(org: Organization, actor: User | None) -> Tuple[ApprovalBatch, int]:
    pending = list(_alphabetic_qs(org))
    
    batch = ApprovalBatch.objects.create(
        organization=org,
        created_by=actor,
        method=ApprovalBatch.Method.ALL_PENDING,
        n_selected=len(pending),
    )
    approved_count = 0
    
    for app in pending:
        if app.status != Application.Status.FORWARDED:
            BatchItem.objects.create(approval_batch=batch, application=app, outcome=BatchItem.Outcome.SKIPPED, note="Not forwarded")
            continue

        
        # Transition
        app.status = Application.Status.APPROVED
        app.sapa_reviewed_at = timezone.now()
        app.save(update_fields=["status","sapa_reviewed_at","updated_at"])
        BatchItem.objects.create(approval_batch=batch, application=app, outcome=BatchItem.Outcome.APPROVED)
        # Ensure Enrollment
        enrollment = getattr(app, "enrollment", None)
        if not enrollment:
            enrollment = Enrollment.create_for_approved(app, actor)

        approved_count += 1

    audit_log(actor, org, "SAPA_APPROVAL_BATCH", target=batch, payload={"method":"ALL_PENDING","approved":approved_count})
    return batch, approved_count

@transaction.atomic
def approve_top_n(org: Organization, n: int, actor: User | None) -> Tuple[ApprovalBatch, int, int]:
    all_pending = list(_alphabetic_qs(org))
    to_approve = all_pending[:max(0, int(n))]
    batch = ApprovalBatch.objects.create(
        organization=org,
        created_by=actor,
        method=ApprovalBatch.Method.TOP_N_ALPHA,
        n_selected=len(to_approve),
    )
    approved_count = 0
    skipped = 0
    
    for app in all_pending:
        if app in to_approve and app.status == Application.Status.FORWARDED:
            
            app.status = Application.Status.APPROVED
            app.sapa_reviewed_at = timezone.now()
            app.save(update_fields=["status","sapa_reviewed_at","updated_at"])
            BatchItem.objects.create(approval_batch=batch, application=app, outcome=BatchItem.Outcome.APPROVED)
            enrollment = getattr(app, "enrollment", None)
            if not enrollment:
                enrollment = Enrollment.create_for_approved(app, actor)

            approved_count += 1
        else:
            BatchItem.objects.create(approval_batch=batch, application=app, outcome=BatchItem.Outcome.SKIPPED, note="Not in Top-N or not forwarded")
            skipped += 1
    audit_log(actor, org, "SAPA_APPROVAL_BATCH", target=batch, payload={"method":"TOP_N_ALPHA","approved":approved_count,"skipped":skipped})
    return batch, approved_count, skipped

@transaction.atomic
def reject_all(org: Organization, actor: User | None) -> Tuple[ApprovalBatch, int]:
    pending = list(_alphabetic_qs(org))
    batch = ApprovalBatch.objects.create(organization=org, created_by=actor, method=ApprovalBatch.Method.ALL_PENDING, n_selected=0)
    rejected_count = 0
    for app in pending:
        app.status = Application.Status.REJECTED
        app.sapa_reviewed_at = timezone.now()
        app.save(update_fields=["status","sapa_reviewed_at","updated_at"])
        BatchItem.objects.create(approval_batch=batch, application=app, outcome=BatchItem.Outcome.REJECTED)
        rejected_count += 1
    audit_log(actor, org, "SAPA_REJECTION_BATCH", target=batch, payload={"rejected":rejected_count})
    return batch, rejected_count

================================================================================
FILE: assist\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: assist\urls.py
================================================================================

from django.urls import path
from .views import (
    assist_apply,
    assist_thanks,
    school_app_dashboard,
    forward_all,
    forward_one,
    verify_income,
    reject_income,
)
from .views_sapa import (
    sapa_approvals_dashboard, sapa_approve_all, sapa_approve_top_n, sapa_reject_all
)
from . import views

app_name = "assist"

urlpatterns = [
    # Public parent application (link from WhatsApp)
    path("assist/apply", assist_apply, name="assist_apply"),
    path("assist/thanks", assist_thanks, name="assist_thanks"),

    # School admin dashboard
    path("assist/admin", school_app_dashboard, name="school_app_dashboard"),
    path("assist/admin/verify-income/<int:app_id>", verify_income, name="verify_income"),
    path("assist/admin/reject-income/<int:app_id>", reject_income, name="reject_income"),
    path("assist/admin/forward-all", forward_all, name="forward_all"),
    path("assist/admin/forward/<int:app_id>", forward_one, name="forward_one"),
    path("assist/sapa/approvals", sapa_approvals_dashboard, name="sapa_approvals_dashboard"),
    path("assist/sapa/approve-all", sapa_approve_all, name="sapa_approve_all"),
    path("assist/sapa/approve-top-n", sapa_approve_top_n, name="sapa_approve_top_n"),
    path("assist/sapa/reject-all", sapa_reject_all, name="sapa_reject_all"),
    path("assist/admin/applications", views.school_applications, name="assist_applications"),
    path("assist/admin/metrics/students/<slug:metric>", views.metric_students, name="metric_students"),
    path("assist/admin/metrics/applications/<slug:status>", views.metric_applications, name="metric_applications"),
]
================================================================================
FILE: assist\views.py
================================================================================

from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from django.utils import timezone
from django.http import HttpResponseBadRequest, HttpResponseForbidden
from django.db import transaction
from accounts.decorators import require_roles
from accounts.models import Role
from audit.utils import audit_log
from roster.models import Student, Guardian
from screening.models import Screening
from .models import Application
from .forms import ParentConsentForm
from datetime import datetime, date
import calendar
import re
from .models import Application, BatchItem
from django.core.paginator import Paginator
from django.db.models import Exists, OuterRef, Subquery, DateTimeField
# --- NEW DETAIL VIEWS FOR METRICS ---

def _age_years(dob):
    if not dob:
        return None
    today = timezone.now().date()
    return today.year - dob.year - ((today.month, today.day) < (dob.month, dob.day))

def _students_metric_qs(org, metric: str, start_dt, end_dt):
    # Base queryset with useful relations for table rendering
    students = (
        Student.objects
        .filter(organization=org)
        .select_related("classroom", "primary_guardian")
    )

    # “In-window” screenings subqueries (to mirror the dashboard period filter)
    window_screenings = Screening.objects.filter(organization=org, student=OuterRef("pk"))
    window_red = window_screenings.filter(risk_level=Screening.RiskLevel.RED)
    if start_dt:  # when period != 'all'
        window_screenings = window_screenings.filter(screened_at__range=(start_dt, end_dt))
        window_red = window_red.filter(screened_at__range=(start_dt, end_dt))

    # For “Total students” (all-time indicators)
    ever_screened = Screening.objects.filter(organization=org, student=OuterRef("pk"))
    ever_red = ever_screened.filter(risk_level=Screening.RiskLevel.RED)

    students = students.annotate(
        screened_in_window=Exists(window_screenings),
        red_in_window=Exists(window_red),
        ever_screened=Exists(ever_screened),
        ever_red=Exists(ever_red),
    )

    m = (metric or "").lower()
    if m in ("screened", "total_screened"):
        students = students.filter(screened_in_window=True)
        title = "Total screened"
    elif m in ("redflag", "red_flagged", "total_redflagged"):
        students = students.filter(red_in_window=True)
        title = "Total red‑flagged"
    elif m in ("boys_screened", "boys-screened"):
        students = students.filter(gender="M", screened_in_window=True)
        title = "Total boys screened"
    elif m in ("boys_redflag", "boys-redflagged"):
        students = students.filter(gender="M", red_in_window=True)
        title = "Total boys red‑flagged"
    elif m in ("girls_screened", "girls-screened"):
        students = students.filter(gender="F", screened_in_window=True)
        title = "Total girls screened"
    elif m in ("girls_redflag", "girls-redflagged"):
        students = students.filter(gender="F", red_in_window=True)
        title = "Total girls red‑flagged"
    else:
        title = "Total students"  # ignores the period filter, like your tile

    students = students.order_by("classroom__grade", "classroom__division",
                                 "first_name", "last_name")
    return title, students

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def metric_students(request, metric: str):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")

    period = request.GET.get("period", "3m")
    start_dt, end_dt = _period_bounds(period)

    title, qs = _students_metric_qs(org, metric, start_dt, end_dt)

    rows = []
    for s in qs.iterator():
        # For “Total students” show all-time indicators; otherwise, period-windowed
        screened_flag = bool(s.ever_screened) if title == "Total students" else bool(s.screened_in_window)
        red_flag = bool(s.ever_red) if title == "Total students" else bool(s.red_in_window)

        class_div = "-"
        if s.classroom:
            class_div = s.classroom.grade if s.classroom.division == "" else f"{s.classroom.grade} {s.classroom.division}"
        phone = getattr(getattr(s, "primary_guardian", None), "phone_e164", None)

        rows.append({
            "name": getattr(s, "full_name", f"{s.first_name} {s.last_name}".strip()),
            "class_div": class_div,
            "age": _age_years(getattr(s, "dob", None)),
            "phone": phone or "-",
            "screened": "Yes" if screened_flag else "No",
            "redflag": "Yes" if red_flag else "No",
        })

    paginator = Paginator(rows, 50)
    page_obj = paginator.get_page(request.GET.get("page"))

    return render(request, "assist/metric_students_list.html", {
        "org": org,
        "title": title,
        "period": period,
        "page_obj": page_obj,
        "total": paginator.count,
    })

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def metric_applications(request, status: str):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")

    period = request.GET.get("period", "3m")
    start_dt, end_dt = _period_bounds(period)

    status_key = (status or "").lower()
    if status_key in ("pending", "forwarded"):
        title = "Applications pending"
        base = Application.objects.filter(organization=org, status=Application.Status.FORWARDED)
    elif status_key in ("approved",):
        title = "Applications approved"
        base = Application.objects.filter(organization=org, status=Application.Status.APPROVED)
    else:
        return HttpResponseBadRequest("Unknown applications metric.")

    # Keep the cohort consistent with the dashboard tiles (windowed by forwarded_at)
    if start_dt:
        base = base.filter(forwarded_at__range=(start_dt, end_dt))

    # Pull “approved_at” from BatchItem.created_at (one per approved app)
    approved_subq = (
        BatchItem.objects
        .filter(application=OuterRef("pk"), outcome=BatchItem.Outcome.APPROVED)
        .order_by("-created_at").values("created_at")[:1]
    )

    apps = (
        base.select_related("student__classroom", "student__primary_guardian")
            .annotate(approved_at=Subquery(approved_subq, output_field=DateTimeField()))
            .order_by("-applied_at")
    )

    rows = []
    for a in apps.iterator():
        s = a.student
        class_div = "-"
        if s.classroom:
            class_div = s.classroom.grade if s.classroom.division == "" else f"{s.classroom.grade} {s.classroom.division}"
        phone = getattr(getattr(s, "primary_guardian", None), "phone_e164", None)

        rows.append({
            "name": getattr(s, "full_name", f"{s.first_name} {s.last_name}".strip()),
            "class_div": class_div,
            "age": _age_years(getattr(s, "dob", None)),
            "phone": phone or "-",
            "applied_at": a.applied_at,
            "forwarded_at": a.forwarded_at,
            "status": "Approved" if a.status == Application.Status.APPROVED else "Pending",
            "approved_at": a.approved_at or "Pending",
        })

    paginator = Paginator(rows, 50)
    page_obj = paginator.get_page(request.GET.get("page"))

    return render(request, "assist/metric_applications_list.html", {
        "org": org,
        "title": title,
        "period": period,
        "page_obj": page_obj,
        "total": paginator.count,
    })

# ---------- Public parent application (consent) ----------
def assist_apply(request):
    """
    Landing page from WhatsApp link (Sprint 2).
    Expects: ?student_id=&screening_id=&lang=
    """
    try:
        student_id = int(request.GET.get("student_id", "0"))
        screening_id = int(request.GET.get("screening_id", "0"))
    except ValueError:
        return HttpResponseBadRequest("Invalid parameters.")

    raw_lang = (request.GET.get("lang") or "").lower()
    m = re.search(r'\b(en|hi|local)\b', raw_lang)   # keep only supported codes
    lang = m.group(1) if m else "en"
    screening = get_object_or_404(Screening, pk=screening_id)
    student = get_object_or_404(Student, pk=student_id, organization=screening.organization)

    # If an APPLIED/ FORWARDED exists recently, show an info banner (idempotency UX)
    pid = student.pid or getattr(screening, "pid", None)
    existing = (
        Application.objects
        .filter(organization=screening.organization, pid=pid)
        .order_by("-created_at")
        .first()
    )

    if request.method == "POST":
        form = ParentConsentForm(request.POST)
        if form.is_valid():
            with transaction.atomic():
                
                g = getattr(student, "primary_guardian", None)   

                low_income = bool(getattr(screening, "is_low_income_at_screen", False))

                pid = student.pid or getattr(screening, "pid", None)

                # Ensure guardian placeholder exists (PID keyed). No phone/name stored.
                g = Guardian.objects.filter(organization=screening.organization, pid=pid).first()
                if g is None and pid:
                    g = Guardian.objects.create(
                        organization=screening.organization,
                        pid=pid,
                        full_name=None,
                        phone_e164=None,
                        whatsapp_opt_in=True,
                    )

                app = Application.objects.create(
                    organization=screening.organization,
                    student=student,
                    guardian=g,
                    pid=pid,
                    trigger_screening=screening,
                    low_income_declared=low_income,
                    income_verification_status=(
                        Application.IncomeVerificationStatus.VERIFIED if low_income
                        else Application.IncomeVerificationStatus.PENDING
                    ),
                    income_verified_at=(timezone.now() if low_income else None),
                    income_verified_by=(getattr(screening, "teacher", None) if low_income else None),
                    source=Application.Source.PARENT,
                    status=Application.Status.APPLIED,
                    form_lang=lang,
                    form_data=form.as_form_data()
                )
                audit_log(user=None, org=screening.organization, action="APPLICATION_APPLIED", target=app,
                          payload={"screening_id": screening.id})

            return redirect(reverse("assist:assist_thanks") + f"?id={app.id}")
    else:
        form = ParentConsentForm()

    return render(request, "assist/apply_form.html", {
        "screening": screening,
        "student": student,
        "org": screening.organization,
        "form": form,
        "existing": existing,
        "lang": lang,
    })

def assist_thanks(request):
    return render(request, "assist/apply_success.html", {})


# ---------- School Admin dashboard + actions ----------
# backend/assist/views.py (helpers, above school_app_dashboard)
def _month_delta(d: date, months: int) -> date:
    """Return date shifted by `months` (can be negative), clamped to month end."""
    y = d.year + (d.month - 1 + months) // 12
    m = (d.month - 1 + months) % 12 + 1
    last = calendar.monthrange(y, m)[1]
    return date(y, m, min(d.day, last))

def _period_bounds(key: str):
    """
    key in {'3m','6m','12m','18m','all'} → (start_dt_or_None, end_dt)
    If 'all', returns (None, now).
    """
    key = (key or "3m").lower()
    now = timezone.now()
    if key == "all":
        return None, now
    months = {"3m": -3, "6m": -6, "12m": -12, "18m": -18}.get(key, -3)
    start_day = _month_delta(now.date(), months)
    tz = timezone.get_current_timezone()
    start_dt = timezone.make_aware(datetime.combine(start_day, datetime.min.time()), tz)
    return start_dt, now

# backend/assist/views.py (replace the function body of school_app_dashboard)
@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def school_app_dashboard(request):

    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    teacher_link = request.build_absolute_uri(
        reverse("teacher_portal_token", args=[org.screening_link_token])
    )
    # Existing table filter by status (unchanged)
    q_status = request.GET.get("status", "APPLIED")
    app_qs = Application.objects.filter(organization=org)
    counts = {
        "APPLIED": app_qs.filter(status=Application.Status.APPLIED).count(),
        "FORWARDED": app_qs.filter(status=Application.Status.FORWARDED).count(),
    }
    if q_status in ("APPLIED", "FORWARDED"):
        app_qs = app_qs.filter(status=q_status)
    applications = app_qs.select_related("student", "guardian").order_by("-applied_at")[:500]

    # NEW: period filter for the summary metrics
    period = request.GET.get("period", "3m")
    start_dt, end_dt = _period_bounds(period)

    # Base screening queryset (optionally windowed)
    screenings = Screening.objects.filter(organization=org)
    if start_dt:
        screenings = screenings.filter(screened_at__range=(start_dt, end_dt))

    # Distinct-student screening counts
    screened_distinct = screenings.values_list("student_id", flat=True).distinct()
    total_screened = screened_distinct.count()
    total_redflag = (
        screenings.filter(risk_level=Screening.RiskLevel.RED)
        .values_list("student_id", flat=True)
        .distinct()
        .count()
    )
    boys_screened = (
        screenings.filter(student__gender="M")
        .values_list("student_id", flat=True)
        .distinct()
        .count()
    )
    boys_redflag = (
        screenings.filter(student__gender="M", risk_level=Screening.RiskLevel.RED)
        .values_list("student_id", flat=True)
        .distinct()
        .count()
    )
    girls_screened = (
        screenings.filter(student__gender="F")
        .values_list("student_id", flat=True)
        .distinct()
        .count()
    )
    girls_redflag = (
        screenings.filter(student__gender="F", risk_level=Screening.RiskLevel.RED)
        .values_list("student_id", flat=True)
        .distinct()
        .count()
    )

    # Applications metrics in the window
    apps = Application.objects.filter(organization=org)
    if start_dt:
        applications_pending = apps.filter(
            status=Application.Status.FORWARDED,
            forwarded_at__range=(start_dt, end_dt),
        ).count()
        applications_approved = apps.filter(
            status=Application.Status.APPROVED,
            forwarded_at__range=(start_dt, end_dt),  # cohort based on when they were sent
        ).count()
    else:
        # 'All' means unbounded
        applications_pending = apps.filter(status=Application.Status.FORWARDED).count()
        applications_approved = apps.filter(status=Application.Status.APPROVED).count()

    summary = {
        "total_students": Student.objects.filter(organization=org).count(),  # not windowed
        "total_screened": total_screened,
        "total_redflag": total_redflag,
        "applications_pending": applications_pending,
        "applications_approved": applications_approved,
        "boys_screened": boys_screened,
        "boys_redflag": boys_redflag,
        "girls_screened": girls_screened,
        "girls_redflag": girls_redflag,
    }

    return render(request, "assist/school_admin_list.html", {
        "teacher_link": teacher_link,
        "org": org,
        "applications": applications,
        "counts": counts,   # keep existing keys to avoid breaking template conditionals
        "status": q_status,
        "period": period,
        "summary": summary,
    })


@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def verify_income(request, app_id: int):
    """School admin marks a parent application as low-income verified.

    This is a precondition to forwarding the application to SAPA.
    """
    if request.method != "POST":
        return HttpResponseBadRequest("POST required.")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    app = get_object_or_404(Application, pk=app_id, organization=org, status=Application.Status.APPLIED)
    notes = (request.POST.get("notes") or "").strip()
    app.low_income_declared = True
    app.income_verification_status = Application.IncomeVerificationStatus.VERIFIED
    app.income_verified_at = timezone.now()
    app.income_verified_by = request.user
    if notes:
        app.income_verification_notes = notes
    app.save(update_fields=[
        "low_income_declared",
        "income_verification_status",
        "income_verified_at",
        "income_verified_by",
        "income_verification_notes",
        "updated_at",
    ])
    audit_log(request.user, org, "APPLICATION_INCOME_VERIFIED", target=app, payload={"notes": notes} if notes else None)
    return redirect(reverse("assist:school_app_dashboard") + "?status=APPLIED")


@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def reject_income(request, app_id: int):
    """School admin rejects the application as not eligible for low-income assistance."""
    if request.method != "POST":
        return HttpResponseBadRequest("POST required.")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    app = get_object_or_404(Application, pk=app_id, organization=org, status=Application.Status.APPLIED)
    notes = (request.POST.get("notes") or "").strip()
    app.income_verification_status = Application.IncomeVerificationStatus.REJECTED
    app.income_verified_at = timezone.now()
    app.income_verified_by = request.user
    if notes:
        app.income_verification_notes = notes
    # Treat as rejected at the school level (keeps it out of SAPA queue)
    app.status = Application.Status.REJECTED
    app.save(update_fields=[
        "status",
        "income_verification_status",
        "income_verified_at",
        "income_verified_by",
        "income_verification_notes",
        "updated_at",
    ])
    audit_log(request.user, org, "APPLICATION_INCOME_REJECTED", target=app, payload={"notes": notes} if notes else None)
    return redirect(reverse("assist:school_app_dashboard") + "?status=APPLIED")


@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def forward_all(request):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required.")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")

    # Only forward applications that are declared low-income and verified by the school.
    pending = Application.objects.filter(
        organization=org,
        status=Application.Status.APPLIED,
        low_income_declared=True,
    )
    updated = 0
    for app in pending.iterator():
        app.status = Application.Status.FORWARDED
        app.forwarded_at = timezone.now()
        app.forwarded_by = request.user
        app.save(update_fields=["status","forwarded_at","forwarded_by","updated_at"])
        audit_log(request.user, org, "APPLICATION_FORWARDED", target=app)
        updated += 1

    # Simple redirect back with a count param
    return redirect(reverse("assist:school_app_dashboard") + f"?status=APPLIED&forwarded={updated}")

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def forward_one(request, app_id):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required.")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    app = get_object_or_404(
        Application,
        pk=app_id,
        organization=org,
        status=Application.Status.APPLIED,
        low_income_declared=True,
    )
    app.status = Application.Status.FORWARDED
    app.forwarded_at = timezone.now()
    app.forwarded_by = request.user
    app.save(update_fields=["status","forwarded_at","forwarded_by","updated_at"])
    audit_log(request.user, org, "APPLICATION_FORWARDED", target=app)
    return redirect(reverse("assist:school_app_dashboard") + "?status=APPLIED")

def school_applications(request):
    org = getattr(request, "org", None)  # how you currently get org
    if not org:
        # keep whatever you currently do when org is missing
        pass

    status = request.GET.get("status", "APPLIED")

    # This block copies the listing logic you currently use on /assist/admin:
    app_qs = Application.objects.filter(organization=org)
    counts = {
        "APPLIED": app_qs.filter(status=Application.Status.APPLIED).count(),
        "FORWARDED": app_qs.filter(status=Application.Status.FORWARDED).count(),
    }
    if status in ("APPLIED", "FORWARDED"):
        app_qs = app_qs.filter(status=status)

    applications = (
        app_qs.select_related("student", "guardian")
             .order_by("-applied_at")[:500]
    )

    return render(
        request,
        "assist/applications_list.html",
        {
            "org": org,
            "applications": applications,
            "counts": counts,
            "status": status,
        },
    )
================================================================================
FILE: assist\views_sapa.py
================================================================================

from django.shortcuts import render, get_object_or_404, redirect
from django.http import HttpResponseBadRequest
from django.urls import reverse
from django.db.models import Count
from accounts.decorators import require_roles
from accounts.models import Role, Organization
from .models import Application
from .services import approve_all, approve_top_n, reject_all
from django.db import models
from django.db.models import Count, Q



@require_roles(Role.SAPA_ADMIN, allow_superuser=True)
def sapa_approvals_dashboard(request):
    # Schools with counts of forwarded & approved applications
    schools = (
        Organization.objects
        .filter(org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO])
        .annotate(
            forwarded_count=Count(
                "applications",
                filter=Q(applications__status=Application.Status.FORWARDED),
            ),
            approved_count=Count(
                "applications",
                filter=Q(applications__status=Application.Status.APPROVED),
            ),
        )
        .order_by("name")
    )


    school_id = request.GET.get("school")
    selected_school = None
    pending = []
    approved = 0

    if school_id:
        selected_school = get_object_or_404(
            Organization,
            pk=int(school_id),
            org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO],
        )

        pending = (
            Application.objects
            .select_related("student", "guardian")
            .filter(organization=selected_school, status=Application.Status.FORWARDED)
            .order_by("student__last_name", "student__first_name")
        )
        approved = (
            Application.objects
            .filter(organization=selected_school, status=Application.Status.APPROVED)
            .count()
        )


    return render(
        request,
        "assist/sapa_approvals.html",
        {
            "schools": schools,
            "selected_school": selected_school,
            "pending": pending,
            "approved_count": approved,
        },
    )


@require_roles(Role.SAPA_ADMIN, allow_superuser=True)
def sapa_approve_all(request):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    school_id = request.POST.get("school_id")
    org = get_object_or_404(Organization, pk=int(school_id))
    
    _, count = approve_all(org, request.user)
    return redirect(reverse("assist:sapa_approvals_dashboard") + f"?school={org.id}&ok=approved_all&n={count}")

@require_roles(Role.SAPA_ADMIN, allow_superuser=True)
def sapa_approve_top_n(request):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    school_id = request.POST.get("school_id")
    n = int(request.POST.get("n","0"))
    org = get_object_or_404(Organization, pk=int(school_id))
    
    _, approved, skipped = approve_top_n(org, n, request.user)
    return redirect(reverse("assist:sapa_approvals_dashboard") + f"?school={org.id}&ok=approved_top_n&n={approved}&skipped={skipped}")

@require_roles(Role.SAPA_ADMIN, allow_superuser=True)
def sapa_reject_all(request):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    school_id = request.POST.get("school_id")
    org = get_object_or_404(Organization, pk=int(school_id))
    _, count = reject_all(org, request.user)
    return redirect(reverse("assist:sapa_approvals_dashboard") + f"?school={org.id}&ok=rejected_all&n={count}")

================================================================================
FILE: assist\__init__.py
================================================================================


================================================================================
FILE: audit\admin.py
================================================================================

from django.contrib import admin
from .models import AuditLog

@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    list_display = ("created_at", "organization", "actor", "action", "target_model", "target_id")
    list_filter = ("organization", "action")
    search_fields = ("target_id", "actor__email", "organization__name")

================================================================================
FILE: audit\apps.py
================================================================================

from django.apps import AppConfig


class AuditConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'audit'

================================================================================
FILE: audit\models.py
================================================================================

from django.db import models
from django.utils import timezone
from accounts.models import Organization, User

class AuditLog(models.Model):
    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="audit_logs")
    actor = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name="audit_logs")
    action = models.CharField(max_length=64)  # e.g., SCREENING_CREATED, CSV_EXPORTED
    target_app = models.CharField(max_length=64, blank=True)
    target_model = models.CharField(max_length=64, blank=True)
    target_id = models.CharField(max_length=64, blank=True)
    payload = models.JSONField(default=dict, blank=True)
    ip = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.TextField(blank=True)

    class Meta:
        indexes = [models.Index(fields=["organization", "action", "created_at"])]

    def __str__(self):
        return f"{self.created_at:%Y-%m-%d %H:%M} {self.action}"

================================================================================
FILE: audit\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: audit\utils.py
================================================================================

def audit_log(user, org, action, target=None, payload=None, request=None):
    from .models import AuditLog
    payload = payload or {}
    target_app = target.__class__._meta.app_label if target else ""
    target_model = target.__class__._meta.model_name if target else ""
    target_id = str(target.pk) if target else ""
    ip = request.META.get("REMOTE_ADDR") if request else None
    ua = request.META.get("HTTP_USER_AGENT") if request else ""
    AuditLog.objects.create(
        organization=org, actor=user, action=action,
        target_app=target_app, target_model=target_model, target_id=target_id,
        payload=payload, ip=ip, user_agent=ua
    )

================================================================================
FILE: audit\views.py
================================================================================

from django.shortcuts import render

# Create your views here.

================================================================================
FILE: audit\__init__.py
================================================================================


================================================================================
FILE: fulfillment\admin.py
================================================================================

from django.contrib import admin

from .models import ProductionOrder, SchoolShipment, ShipmentItem


@admin.register(ProductionOrder)
class ProductionOrderAdmin(admin.ModelAdmin):
    list_display = ("id", "month", "manufacturer", "total_packs", "status", "created_at")
    list_filter = ("status", "month")
    search_fields = ("id", "manufacturer__name")


class ShipmentItemInline(admin.TabularInline):
    model = ShipmentItem
    extra = 0
    autocomplete_fields = ("monthly_supply",)


@admin.register(SchoolShipment)
class SchoolShipmentAdmin(admin.ModelAdmin):
    list_display = ("id", "school", "month_index", "status", "logistics_partner", "tracking_number", "created_at")
    list_filter = ("status", "month_index")
    search_fields = ("school__name", "tracking_number")
    inlines = [ShipmentItemInline]


@admin.register(ShipmentItem)
class ShipmentItemAdmin(admin.ModelAdmin):
    list_display = ("id", "shipment", "monthly_supply", "pack_qty")
    search_fields = ("shipment__id", "monthly_supply__id")

================================================================================
FILE: fulfillment\apps.py
================================================================================

from django.apps import AppConfig


class FulfillmentConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "fulfillment"

================================================================================
FILE: fulfillment\forms.py
================================================================================

from django import forms

from accounts.models import Organization

from .models import ProductionOrder, SchoolShipment


class ProductionOrderForm(forms.ModelForm):
    class Meta:
        model = ProductionOrder
        fields = ["manufacturer", "month", "total_packs", "notes"]


class ShipmentCreateForm(forms.ModelForm):
    class Meta:
        model = SchoolShipment
        fields = ["school", "logistics_partner", "month_index", "tracking_number"]

    def clean_month_index(self):
        v = int(self.cleaned_data.get("month_index") or 0)
        if v < 1 or v > 6:
            raise forms.ValidationError("Month index must be between 1 and 6")
        return v

================================================================================
FILE: fulfillment\models.py
================================================================================

from __future__ import annotations

from django.db import models, transaction
from django.utils import timezone

from accounts.models import Organization, User


class ProductionOrder(models.Model):
    class Status(models.TextChoices):
        DRAFT = "DRAFT", "Draft"
        SENT = "SENT", "Sent to manufacturer"
        IN_PRODUCTION = "IN_PRODUCTION", "In production"
        SHIPPED = "SHIPPED", "Shipped to warehouse"
        RECEIVED = "RECEIVED", "Received at warehouse"

    manufacturer = models.ForeignKey(
        Organization,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="production_orders",
    )
    month = models.DateField(help_text="Use the 1st day of the month (e.g. 2025-01-01)")
    total_packs = models.PositiveIntegerField(default=0)
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.DRAFT, db_index=True)
    notes = models.TextField(blank=True)

    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name="created_production_orders")
    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [models.Index(fields=["status", "month"])]

    def __str__(self) -> str:
        return f"PO {self.id} – {self.month:%Y-%m} ({self.total_packs} packs)"


class SchoolShipment(models.Model):
    class Status(models.TextChoices):
        PLANNED = "PLANNED", "Planned"
        DISPATCHED = "DISPATCHED", "Dispatched"
        DELIVERED = "DELIVERED", "Delivered"

    school = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="shipments")
    logistics_partner = models.ForeignKey(
        Organization,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="logistics_shipments",
    )

    month_index = models.PositiveSmallIntegerField(help_text="Program month index (1..6)")
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.PLANNED, db_index=True)

    tracking_number = models.CharField(max_length=128, blank=True)

    dispatched_at = models.DateTimeField(null=True, blank=True)
    delivered_at = models.DateTimeField(null=True, blank=True)

    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name="created_shipments")
    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [
            models.Index(fields=["school", "status"]),
            models.Index(fields=["status", "created_at"]),
        ]

    def __str__(self) -> str:
        return f"Shipment {self.id} – {self.school.name} – M{self.month_index} – {self.status}"


class ShipmentItem(models.Model):
    shipment = models.ForeignKey(SchoolShipment, on_delete=models.CASCADE, related_name="items")
    monthly_supply = models.OneToOneField(
        "program.MonthlySupply",
        on_delete=models.CASCADE,
        related_name="shipment_item",
    )
    pack_qty = models.PositiveIntegerField(default=1)

    class Meta:
        indexes = [models.Index(fields=["shipment"])]

    def __str__(self) -> str:
        return f"ShipmentItem {self.id} – supply {self.monthly_supply_id}"

================================================================================
FILE: fulfillment\urls.py
================================================================================

from django.urls import path

from . import views

app_name = "fulfillment"

urlpatterns = [
    path("fulfillment/", views.dashboard, name="dashboard"),
    path("fulfillment/production-orders/new", views.production_order_create, name="production_order_create"),

    path("fulfillment/manufacturer/production-orders", views.manufacturer_po_list, name="manufacturer_po_list"),
    path("fulfillment/manufacturer/production-orders/<int:po_id>/status", views.manufacturer_po_update_status, name="manufacturer_po_update_status"),

    path("fulfillment/shipments/new", views.shipment_create, name="shipment_create"),
    path("fulfillment/shipments/<int:shipment_id>", views.shipment_detail, name="shipment_detail"),

    path("fulfillment/logistics/shipments", views.logistics_shipments_list, name="logistics_shipments_list"),
    path("fulfillment/logistics/shipments/<int:shipment_id>/dispatch", views.shipment_dispatch, name="shipment_dispatch"),
    path("fulfillment/logistics/shipments/<int:shipment_id>/deliver", views.shipment_deliver, name="shipment_deliver"),

    path("fulfillment/school/shipments", views.school_incoming, name="school_incoming"),
    path("fulfillment/school/shipments/<int:shipment_id>/confirm", views.school_confirm_delivery, name="school_confirm_delivery"),
]

================================================================================
FILE: fulfillment\views.py
================================================================================

from __future__ import annotations

from django.contrib import messages
from django.db import transaction
from django.http import HttpResponseBadRequest, HttpResponseForbidden
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from django.utils import timezone

from accounts.decorators import require_roles
from accounts.models import Organization, Role
from audit.utils import audit_log
from program.models import MonthlySupply, Enrollment
from program.services import mark_supply_delivered

from .forms import ProductionOrderForm, ShipmentCreateForm
from .models import ProductionOrder, SchoolShipment, ShipmentItem


@require_roles(Role.SAPA_ADMIN, Role.INDITECH, allow_superuser=True)
def dashboard(request):
    pos = ProductionOrder.objects.select_related("manufacturer").order_by("-created_at")[:200]
    shipments = SchoolShipment.objects.select_related("school", "logistics_partner").order_by("-created_at")[:200]
    return render(request, "fulfillment/dashboard.html", {"pos": pos, "shipments": shipments})


@require_roles(Role.SAPA_ADMIN, Role.INDITECH, allow_superuser=True)
def production_order_create(request):
    if request.method == "POST":
        form = ProductionOrderForm(request.POST)
        if form.is_valid():
            po = form.save(commit=False)
            po.created_by = request.user
            po.save()
            audit_org = po.manufacturer or getattr(request, "org", None)
            if audit_org:
                audit_log(
                   user=request.user,
                   org=audit_org,
                   action="PRODUCTION_ORDER_CREATED",
                   target=po,
                   request=request,  # captures IP + User-Agent in the audit row
                )
            messages.success(request, "Production order created.")
            return redirect(reverse("fulfillment:dashboard"))

    else:
        form = ProductionOrderForm()
    return render(request, "fulfillment/po_form.html", {"form": form})


@require_roles(Role.MANUFACTURER, allow_superuser=True)
def manufacturer_po_list(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    pos = ProductionOrder.objects.filter(manufacturer=org).order_by("-created_at")
    return render(
        request,
        "fulfillment/manufacturer_po_list.html",
        {"pos": pos, "org": org, "status_choices": ProductionOrder.Status.choices},
    )


@require_roles(Role.MANUFACTURER, allow_superuser=True)
def manufacturer_po_update_status(request, po_id: int):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    po = get_object_or_404(ProductionOrder, pk=po_id, manufacturer=org)
    new_status = request.POST.get("status")
    if new_status not in [c[0] for c in ProductionOrder.Status.choices]:
        return HttpResponseBadRequest("Invalid status")
    po.status = new_status
    po.save(update_fields=["status", "updated_at"])
    audit_log(request.user, org, "PRODUCTION_ORDER_STATUS_UPDATED", target=po, payload={"status": new_status})
    return redirect(reverse("fulfillment:manufacturer_po_list"))


@require_roles(Role.SAPA_ADMIN, Role.INDITECH, allow_superuser=True)
def shipment_create(request):
    """Create a school shipment by auto-attaching eligible MonthlySupply rows."""
    if request.method == "POST":
        form = ShipmentCreateForm(request.POST)
        if form.is_valid():
            shipment = form.save(commit=False)
            shipment.created_by = request.user
            # Do not allow shipments for suspended schools
            if shipment.school.assistance_suspended:
                return HttpResponseForbidden(
                    "School is suspended due to overdue screening milestones; cannot create shipments."
                )
            shipment.save()

            # Attach eligible supplies
            supplies = MonthlySupply.objects.filter(
                enrollment__organization=shipment.school,
                enrollment__status=Enrollment.Status.ACTIVE,
                month_index=shipment.month_index,
                delivered_on__isnull=True,
            )
            if shipment.month_index > 1:
                supplies = supplies.filter(ok_to_ship_next=True)

            items = [ShipmentItem(shipment=shipment, monthly_supply=ms, pack_qty=1) for ms in supplies]
            if items:
                ShipmentItem.objects.bulk_create(items, ignore_conflicts=True)

            audit_log(request.user, shipment.school, "SHIPMENT_CREATED", target=shipment, payload={"items": len(items)})
            messages.success(request, f"Shipment created with {len(items)} item(s).")
            return redirect(reverse("fulfillment:shipment_detail", args=[shipment.id]))
    else:
        form = ShipmentCreateForm()
    return render(request, "fulfillment/shipment_form.html", {"form": form})


@require_roles(Role.SAPA_ADMIN, Role.INDITECH, Role.LOGISTICS, Role.ORG_ADMIN, allow_superuser=True)
def shipment_detail(request, shipment_id: int):
    shipment = get_object_or_404(SchoolShipment.objects.select_related("school", "logistics_partner"), pk=shipment_id)

    # Basic authorization: logistics sees theirs, school sees theirs, admins see all
    if request.user.is_superuser:
        pass
    else:
        role = getattr(getattr(request, "membership", None), "role", None)
        if role == Role.LOGISTICS and request.org and shipment.logistics_partner_id != request.org.id:
            return HttpResponseForbidden("Not allowed")
        if role == Role.ORG_ADMIN and request.org and shipment.school_id != request.org.id:
            return HttpResponseForbidden("Not allowed")

    items = shipment.items.select_related("monthly_supply__enrollment__student").order_by("monthly_supply__enrollment__student__last_name")
    return render(request, "fulfillment/shipment_detail.html", {"shipment": shipment, "items": items})


@require_roles(Role.LOGISTICS, allow_superuser=True)
def logistics_shipments_list(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    shipments = SchoolShipment.objects.filter(logistics_partner=org).select_related("school").order_by("-created_at")
    return render(request, "fulfillment/logistics_shipments_list.html", {"shipments": shipments, "org": org})


@require_roles(Role.LOGISTICS, allow_superuser=True)
def shipment_dispatch(request, shipment_id: int):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    shipment = get_object_or_404(SchoolShipment, pk=shipment_id, logistics_partner=org)
    shipment.status = SchoolShipment.Status.DISPATCHED
    shipment.dispatched_at = timezone.now()
    shipment.tracking_number = (request.POST.get("tracking_number") or shipment.tracking_number)
    shipment.save(update_fields=["status", "dispatched_at", "tracking_number", "updated_at"])
    audit_log(request.user, shipment.school, "SHIPMENT_DISPATCHED", target=shipment, payload={"tracking": shipment.tracking_number})
    return redirect(reverse("fulfillment:logistics_shipments_list"))


def _mark_shipment_delivered(shipment: SchoolShipment, actor):
    if shipment.status == SchoolShipment.Status.DELIVERED:
        return
    shipment.status = SchoolShipment.Status.DELIVERED
    shipment.delivered_at = timezone.now()
    shipment.save(update_fields=["status", "delivered_at", "updated_at"])

    for item in shipment.items.select_related("monthly_supply"):
        mark_supply_delivered(item.monthly_supply, delivered_on=shipment.delivered_at.date(), actor=actor)


@require_roles(Role.LOGISTICS, allow_superuser=True)
def shipment_deliver(request, shipment_id: int):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    shipment = get_object_or_404(SchoolShipment, pk=shipment_id, logistics_partner=org)
    _mark_shipment_delivered(shipment, actor=request.user)
    audit_log(request.user, shipment.school, "SHIPMENT_DELIVERED", target=shipment)
    return redirect(reverse("fulfillment:logistics_shipments_list"))


@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def school_incoming(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    shipments = SchoolShipment.objects.filter(school=org).order_by("-created_at")[:200]
    return render(request, "fulfillment/school_incoming.html", {"shipments": shipments, "org": org})


@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def school_confirm_delivery(request, shipment_id: int):
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    shipment = get_object_or_404(SchoolShipment, pk=shipment_id, school=org)
    _mark_shipment_delivered(shipment, actor=request.user)
    audit_log(request.user, org, "SHIPMENT_CONFIRMED_BY_SCHOOL", target=shipment)
    return redirect(reverse("fulfillment:school_incoming"))

================================================================================
FILE: fulfillment\__init__.py
================================================================================


================================================================================
FILE: messaging\admin.py
================================================================================

from django.contrib import admin
from .models import MessageLog

@admin.register(MessageLog)
class MessageLogAdmin(admin.ModelAdmin):
    list_display = ("created_at", "organization", "pid", "template_code", "language", "status", "provider_msg_id")
    list_filter = ("organization", "status", "template_code", "language")
    search_fields = ("pid", "provider_msg_id", "idempotency_key")
    readonly_fields = ("created_at", "updated_at", "sent_at", "pid", "to_phone_e164", "payload")
================================================================================
FILE: messaging\i18n.py
================================================================================

import os
from typing import Optional

LANG_CODE = {
    "en": os.getenv("MSG_LANG_EN", "en"),
    "hi": os.getenv("MSG_LANG_HI", "hi"),
    "local": os.getenv("MSG_LANG_LOCAL", os.getenv("MSG_LANG_EN", "en")),
}

def to_provider_lang(value: Optional[str]) -> str:
    """Normalize arbitrary inputs like 'EN', 'en_US', 'hi-IN', 'local' → provider code."""
    v = (value or "").lower()
    if v.startswith("hi"):
        return LANG_CODE["hi"]
    if v == "local":
        return LANG_CODE["local"]
    # default and any 'en*' variant
    return LANG_CODE["en"]

FLAG_TEXT = {
    "en": {
        "bmi_low": "low BMI for age",
        "measurement_incomplete": "measurement incomplete",
        "diet_diversity_low": "low diet diversity",
        "symptoms_present": "some symptoms reported",
        "multiple_symptoms": "multiple symptoms reported",
    },
    "hi": {
        "bmi_low": "आयु के अनुसार BMI कम",
        "measurement_incomplete": "माप अपूर्ण",
        "diet_diversity_low": "आहार विविधता कम",
        "symptoms_present": "कुछ लक्षण रिपोर्ट हुए",
        "multiple_symptoms": "कई लक्षण रिपोर्ट हुए",
    },
    # Use org/guardian 'local' language; fallback to English if not found
    "local": {
        "bmi_low": "Local: low BMI",
        "measurement_incomplete": "Local: measurement incomplete",
        "diet_diversity_low": "Local: low diet diversity",
        "symptoms_present": "Local: some symptoms",
        "multiple_symptoms": "Local: multiple symptoms",
    }
}

def choose_language(guardian_pref: str | None, org_locale: str | None) -> str:
    for cand in (guardian_pref, org_locale, "en"):
        if not cand:
            continue
        c = cand.lower()
        if c in ("en","hi","local"):
            return c
        # normalize common variants
        if c.startswith("en"): return "en"
        if c.startswith("hi"): return "hi"
    return "en"

def flags_to_text(flags, lang: str) -> str:
    mapping = FLAG_TEXT.get(lang) or FLAG_TEXT["en"]
    return ", ".join(mapping.get(f, f) for f in (flags or []))

def edu_video_url(lang: str) -> str:
    if lang == "hi":
        return os.getenv("EDU_VIDEO_URL_HI", os.getenv("EDU_VIDEO_URL_EN",""))
    if lang == "local":
        return os.getenv("EDU_VIDEO_URL_LOCAL", os.getenv("EDU_VIDEO_URL_EN",""))
    return os.getenv("EDU_VIDEO_URL_EN","")

def assist_apply_url(student_id: int, screening_id: int, lang: str) -> str:
    base = os.getenv("ASSIST_APPLY_URL_BASE","")
    print("Base",base)
    sep = "&" if "?" in base else "?"
    return f"{base}{sep}student_id={student_id}&screening_id={screening_id}&lang={lang}"

================================================================================
FILE: messaging\models.py
================================================================================

from django.db import models
from django.utils import timezone
from accounts.models import Organization
import uuid

class MessageLog(models.Model):
    idempotency_key = models.CharField(
        max_length=36,
        unique=True,
        default=uuid.uuid4,   # Django will str() the UUID
        editable=False,
    )

    class Status(models.TextChoices):
        QUEUED = "QUEUED", "Queued"
        SENT = "SENT", "Sent"
        DELIVERED = "DELIVERED", "Delivered"
        READ = "READ", "Read"
        FAILED = "FAILED", "Failed"

    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="messages")

    # NEW: store the student's PID for linkage/auditing
    pid = models.CharField(max_length=64, blank=True, default="", db_index=True, editable=False)

    # PII fields: must NOT be stored going forward
    to_phone_e164 = models.CharField(max_length=20, db_index=True, blank=True, default="", editable=False)
    payload = models.JSONField(blank=True, default=dict, editable=False)

    channel = models.CharField(max_length=16, default="whatsapp")
    template_code = models.CharField(max_length=64, blank=True)   # e.g., RED_EDU_V1 / RED_ASSIST_V1
    language = models.CharField(max_length=16, default="en")      # 'en' | 'hi' | 'local' (or ISO)
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.QUEUED)
    provider_msg_id = models.CharField(max_length=128, blank=True)
    scheduled_at = models.DateTimeField(null=True, blank=True, db_index=True)
    sent_at = models.DateTimeField(null=True, blank=True)
    error_code = models.CharField(max_length=64, blank=True)
    error_title = models.CharField(max_length=255, blank=True)

    # linkage to operational event
    related_screening = models.ForeignKey("screening.Screening", on_delete=models.SET_NULL, null=True, blank=True, related_name="+")
    related_supply = models.ForeignKey("program.MonthlySupply", on_delete=models.SET_NULL, null=True, blank=True, related_name="+")

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [
            models.Index(fields=["organization", "status"]),
            models.Index(fields=["scheduled_at", "status"]),
            models.Index(fields=["organization", "pid", "created_at"]),  # useful for audit lookups
        ]

    def __str__(self):
        pid_short = (self.pid or "")[:8]
        return f"{pid_short} {self.template_code} {self.status}"

    def save(self, *args, **kwargs):
        """
        Enforce that we NEVER persist phone or payload.
        Even if some code mistakenly sets these, we blank them here.
        """
        self.to_phone_e164 = ""
        self.payload = {}

        update_fields = kwargs.get("update_fields")
        if update_fields is not None:
            kwargs["update_fields"] = list(set(update_fields) | {"to_phone_e164", "payload"})

        super().save(*args, **kwargs)
================================================================================
FILE: messaging\ratelimit.py
================================================================================

import os, time
import redis

_RURL = (
    os.getenv("RATELIMIT_REDIS_URL")
    or os.getenv("CELERY_BROKER_URL")
    or "redis://localhost:6379/0"
)

_r = redis.Redis.from_url(_RURL)

class RateLimitExceeded(Exception): ...

def _bucket(key: str, window_sec: int, max_count: int):
    now = int(time.time())
    p = _r.pipeline()
    p.incr(key, 1)
    p.expire(key, window_sec)
    count, _ = p.execute()
    if int(count) > max_count:
        raise RateLimitExceeded(f"Rate limit exceeded for {key}")

def check_global_per_min():
    cap = int(os.getenv("WA_RATE_GLOBAL_PER_MIN", "90"))
    _bucket("rl:wa:global:1m", 60, cap)

def check_per_phone_daily(phone: str, template: str):
    cap = int(os.getenv("WA_RATE_PER_PHONE_PER_DAY", "2"))
    key = f"rl:wa:{template}:{phone}:1d"
    _bucket(key, 24*3600, cap)

================================================================================
FILE: messaging\services.py
================================================================================

import os
from typing import Dict, Tuple, Optional
from urllib.parse import quote
from django.utils import timezone
from accounts.models import Organization
from roster.models import Guardian
from screening.models import Screening
from .models import MessageLog
from .i18n import choose_language, flags_to_text, edu_video_url, assist_apply_url
import hashlib
from django.db import transaction
from .ratelimit import check_global_per_min, check_per_phone_daily, RateLimitExceeded
import uuid
# provider picker
def _provider():
    prov = (os.getenv("WHATSAPP_PROVIDER") or "mock").lower()
    if prov == "meta":
        from .providers.meta_cloud import MetaCloudProvider
        return MetaCloudProvider()
    elif prov == "aisensy":
        from .providers.aisensy import AiSensyProvider
        return AiSensyProvider()
    else:
        from .providers.mock import MockProvider
        return MockProvider()

# Map our internal codes to WABA template names
TEMPLATE_NAME = {
    "RED_EDU_V1": "nutrilift_redflag_edu_v1",
    "RED_ASSIST_V1": "nutrilift_redflag_assist_v1",
}

# Map language shortcut to WABA language codes
LANG_CODE = {
    "en": "en",    # you may use en_US if that is how the template was approved
    "hi": "hi",
    "local": "en", # fallback; you can add actual local (e.g., "mr") once approved
}

def whatsapp_click_to_chat_url(phone_e164: str, text: str) -> str:
    digits = "".join([c for c in (phone_e164 or "") if c.isdigit()])
    return f"https://wa.me/{digits}?text={quote(text or '')}"

def _student_pid(screening: Screening) -> str:
    return (
        (getattr(screening, "pid", None) or "")
        or (getattr(getattr(screening, "student", None), "pid", None) or "")
        or ""
    )

def _guardian_and_phone(screening: Screening, *, to_phone_e164: Optional[str] = None):
    """
    Returns (guardian, phone).
    If to_phone_e164 is provided, it is used instead of guardian.phone_e164.
    This is required when we do not store guardian phone numbers in the DB.
    """
    g = getattr(getattr(screening, "student", None), "primary_guardian", None)
    phone = (to_phone_e164 or "").strip() or (getattr(g, "phone_e164", "") or "").strip()
    return g, phone

# def _make_idem_key(*parts):
#     raw = "|".join(str(p) for p in parts)
#     return hashlib.sha256(raw.encode("utf-8")).hexdigest()[:60]

def _make_idem_key(*parts):
    raw = "|".join(str(p) for p in parts)
    # Deterministic 36-char key that fits CharField(max_length=36)
    # UUIDv5 is stable for the same input and namespace
    return str(uuid.uuid5(uuid.NAMESPACE_URL, raw))

def _click_to_chat_text(body_lines: list[str]) -> str:
    """Join body lines for pre-filled WhatsApp text (simple, readable)."""
    return "\n".join([str(x) for x in body_lines if x])

def prepare_redflag_education_click_to_chat(screening: Screening, *, to_phone_e164: str):
    """
    Compute WhatsApp click-to-chat URL WITHOUT storing phone or payload.
    Stores only pid + metadata in MessageLog.
    Returns (MessageLog, wa_url).
    """
    org: Organization = screening.organization
    phone = (to_phone_e164 or "").strip()
    if not phone:
        raise ValueError("Missing guardian phone (pass to_phone_e164)")

    pid = _student_pid(screening)

    guardian = getattr(getattr(screening, "student", None), "primary_guardian", None)
    lang = choose_language(getattr(guardian, "preferred_language", None), getattr(org, "locale", None))

    flags_txt = flags_to_text(screening.red_flags, lang)
    video = edu_video_url(lang)

    body_lines = [screening.student.full_name, flags_txt, video]
    text = _click_to_chat_text(body_lines)
    wa_url = whatsapp_click_to_chat_url(phone, text)

    # Idempotency per (screening + pid + template) so we don't create duplicates
    idem = _make_idem_key("red_edu", pid, screening.id)
    existing = MessageLog.objects.filter(idempotency_key=idem).first()
    if existing:
        return existing, wa_url

    # Rate limiting (still uses phone transiently; not stored in DB)
    check_global_per_min()
    check_per_phone_daily(phone, "RED_EDU_V1")

    log = MessageLog.objects.create(
        organization=org,
        pid=pid,
        template_code="RED_EDU_V1",
        language=lang,
        related_screening=screening,
        idempotency_key=idem,
        status=MessageLog.Status.QUEUED,
    )
    return log, wa_url

def prepare_redflag_assistance_click_to_chat(screening: Screening, *, to_phone_e164: str):
    """
    Compute WhatsApp click-to-chat URL WITHOUT storing phone or payload.
    Stores only pid + metadata in MessageLog.
    Returns (MessageLog, wa_url).
    """
    org: Organization = screening.organization
    phone = (to_phone_e164 or "").strip()
    if not phone:
        raise ValueError("Missing guardian phone (pass to_phone_e164)")

    pid = _student_pid(screening)

    guardian = getattr(getattr(screening, "student", None), "primary_guardian", None)
    lang = choose_language(getattr(guardian, "preferred_language", None), getattr(org, "locale", None))

    flags_txt = flags_to_text(screening.red_flags, lang)
    video = edu_video_url(lang)
    apply_url = assist_apply_url(screening.student_id, screening.id, lang)

    text = _click_to_chat_text([flags_txt, video, apply_url])
    wa_url = whatsapp_click_to_chat_url(phone, text)

    idem = _make_idem_key("red_assist", pid, screening.id)
    existing = MessageLog.objects.filter(idempotency_key=idem).first()
    if existing:
        return existing, wa_url

    check_global_per_min()
    check_per_phone_daily(phone, "RED_ASSIST_V1")

    log = MessageLog.objects.create(
        organization=org,
        pid=pid,
        template_code="RED_ASSIST_V1",
        language=lang,
        related_screening=screening,
        idempotency_key=idem,
        status=MessageLog.Status.QUEUED,
    )
    return log, wa_url

@transaction.atomic
def send_redflag_education(screening: Screening, *, to_phone_e164: Optional[str] = None):
    org = screening.organization
    guardian, phone = _guardian_and_phone(screening, to_phone_e164=to_phone_e164)
    if not phone:
        raise ValueError("Missing guardian phone (pass to_phone_e164)")

    lang = choose_language(getattr(guardian, "preferred_language", None), getattr(org, "locale", None))
    flags_txt = flags_to_text(screening.red_flags, lang)
    video = edu_video_url(lang)

    components = {
        "body": [screening.student.full_name, flags_txt, video],
        "buttons": [video],
    }

    idem = _make_idem_key("red_edu", phone, screening.id)
    existing = MessageLog.objects.filter(idempotency_key=idem).first()
    if existing:
        return existing

    check_global_per_min()
    check_per_phone_daily(phone, "RED_EDU_V1")

    log = MessageLog.objects.create(
        organization=org,
        to_phone_e164=phone,
        template_code="RED_EDU_V1",
        language=lang,
        payload={"screening_id": screening.id, "flags": screening.red_flags, "video": video, "_components": components},
        related_screening=screening,
        idempotency_key=idem,
        status=MessageLog.Status.QUEUED,
    )
    from .tasks import send_message_task
    send_message_task.delay(log.id)
    return log


def send_redflag_assistance(screening: Screening, *, to_phone_e164: Optional[str] = None) -> MessageLog:
    org: Organization = screening.organization
    guardian, phone = _guardian_and_phone(screening, to_phone_e164=to_phone_e164)
    if not phone:
        raise ValueError("Missing guardian phone (pass to_phone_e164)")

    lang = choose_language(getattr(guardian, "preferred_language", None), getattr(org, "locale", None))
    flags_txt = flags_to_text(screening.red_flags, lang)
    video = edu_video_url(lang)
    apply_url = assist_apply_url(screening.student_id, screening.id, lang)

    components = {
        "body": [
            screening.student.full_name,
            flags_txt,
            video,
            apply_url
        ],
        "buttons": [video, apply_url]
    }

    log = MessageLog.objects.create(
        organization=org,
        to_phone_e164=phone,
        template_code="RED_ASSIST_V1",
        language=lang,
        payload={"screening_id": screening.id, "flags": screening.red_flags, "video": video, "apply_url": apply_url},
        related_screening=screening,
        status=MessageLog.Status.QUEUED,
    )

    prov = _provider()
    msg_id, pstatus = prov.send_template(phone, TEMPLATE_NAME["RED_ASSIST_V1"], LANG_CODE[lang], components)
    log.provider_msg_id = msg_id
    log.status = MessageLog.Status.SENT if str(pstatus).lower() == "sent" else MessageLog.Status.QUEUED
    log.sent_at = timezone.now()
    log.save(update_fields=["provider_msg_id", "status", "sent_at", "updated_at"])
    return log

# add to TEMPLATE_NAME mapping 
TEMPLATE_NAME.update({
    "COMPLIANCE_REMINDER_V1": "nutrilift_compliance_reminder_v1",  # name in your WABA
}) 

def send_compliance_reminder(supply) -> MessageLog:
    """
    Sends a WhatsApp reminder to complete Day-27 compliance.
    """
    from django.urls import reverse
    from django.conf import settings
    from roster.models import Guardian

    org = supply.enrollment.organization
    student = supply.enrollment.student
    guardian = student.primary_guardian
    phone = guardian.phone_e164 if guardian else ""

    base = os.getenv("PUBLIC_BASE_URL", "http://localhost:8000")
    link = f"{base}{reverse('program:compliance_form', args=[supply.qr_token])}"

    lang = choose_language(getattr(guardian, "preferred_language", None), getattr(org, "locale", None))
    components = {
        # Adjust placeholders to your approved WABA template
        "body": [
            student.full_name,  # {{1}} Child Name
            link,               # {{2}} Link to compliance form
        ],
        "buttons": [link],     # URL button 0 -> {{1}} dynamic URL
    }

    log = MessageLog.objects.create(
        organization=org,
        to_phone_e164=phone,
        template_code="COMPLIANCE_REMINDER_V1",
        language=lang,
        payload={"supply_id": supply.id, "student": student.full_name, "link": link},
        related_supply=supply,
        status=MessageLog.Status.QUEUED,
    )

    prov = _provider()
    msg_id, pstatus = prov.send_template(phone, TEMPLATE_NAME["COMPLIANCE_REMINDER_V1"], LANG_CODE[lang], components)
    log.provider_msg_id = msg_id
    log.status = MessageLog.Status.SENT if pstatus.lower() == "sent" else MessageLog.Status.QUEUED
    log.sent_at = timezone.now()
    log.save(update_fields=["provider_msg_id","status","sent_at","updated_at"])
    return log

def prepare_screening_status_click_to_chat(screening: Screening, *, to_phone_e164: str):
    """
    Returns (MessageLog, wa_url) without storing phone/payload in DB.
    """
    level = (screening.risk_level or "GREEN").upper()
    is_low_income = bool(getattr(screening, "is_low_income_at_screen", False))

    if level == "RED" and is_low_income:
        return prepare_redflag_assistance_click_to_chat(screening, to_phone_e164=to_phone_e164)
    return prepare_redflag_education_click_to_chat(screening, to_phone_e164=to_phone_e164)
================================================================================
FILE: messaging\tasks.py
================================================================================

import logging, time
from celery import shared_task
from django.utils import timezone
from .models import MessageLog

from .i18n import to_provider_lang, choose_language

from .services import TEMPLATE_NAME

log = logging.getLogger(__name__)

@shared_task(bind=True, max_retries=5, default_retry_delay=30)  # ~ exponential-ish backoff
def send_message_task(self, message_id: int):
    from .services import _provider
    try:
        msg = MessageLog.objects.get(id=message_id)
    except MessageLog.DoesNotExist:
        return "gone"

    if msg.status in ("SENT","DELIVERED","READ"):
        return "already sent"

    # prov = _provider()
    # lang_code = to_provider_lang(msg.language)
    # components = msg.payload.get("_components") or {}  # we will stash components before queueing
    prov = _provider()
    lang_code = to_provider_lang(msg.language)
    components = msg.payload.get("_components") or {}
    # Resolve the actual template name for the provider
    tpl = TEMPLATE_NAME.get(msg.template_code, msg.template_code)

    try:
        #pid, pstatus = prov.send_template(msg.to_phone_e164, msg.template_code if msg.template_code in ("COMPLIANCE_REMINDER_V1","nutrilift_compliance_reminder_v1") else msg.template_code, lang_code, components)
        pid, pstatus = prov.send_template(
            msg.to_phone_e164,
            tpl,           # e.g., "nutrilift_redflag_edu_v1"
            lang_code,     # "en" | "hi"
            components
        )
        msg.provider_msg_id = pid
        msg.status = MessageLog.Status.SENT if str(pstatus).lower() == "sent" else MessageLog.Status.QUEUED
        msg.sent_at = timezone.now()
        msg.save(update_fields=["provider_msg_id","status","sent_at","updated_at"])
        return "ok"
    except Exception as e:
        log.warning("send_message_task error: %s", e)
        raise self.retry(exc=e, countdown=min(300, (self.request.retries+1)*30))

================================================================================
FILE: messaging\urls.py
================================================================================

from django.urls import path
from .views import wa_webhook

urlpatterns = [
    path("webhooks/whatsapp/", wa_webhook, name="wa_webhook"),
]

================================================================================
FILE: messaging\views.py
================================================================================

import hmac, hashlib, os, json
from django.http import HttpResponse, JsonResponse, HttpResponseForbidden
from django.views.decorators.csrf import csrf_exempt
from django.utils import timezone
from .models import MessageLog
from .i18n import flags_to_text, choose_language
from django.shortcuts import get_object_or_404, render
from django.urls import reverse
from urllib.parse import quote

VERIFY_TOKEN = os.getenv("WA_VERIFY_TOKEN","")
APP_SECRET = os.getenv("WA_APP_SECRET","")

def _verify_signature(request):
    if not APP_SECRET:
        return True
    signature = request.headers.get("X-Hub-Signature-256","").replace("sha256=","")
    digest = hmac.new(APP_SECRET.encode("utf-8"), request.body, hashlib.sha256).hexdigest()
    return hmac.compare_digest(signature, digest)

@csrf_exempt
def wa_webhook(request):
    # GET: verification
    if request.method == "GET":
        mode = request.GET.get("hub.mode")
        token = request.GET.get("hub.verify_token")
        challenge = request.GET.get("hub.challenge")
        if mode == "subscribe" and token == VERIFY_TOKEN:
            return HttpResponse(challenge or "")
        return HttpResponseForbidden("Verification failed")

    # POST: events
    if request.method == "POST":
        if not _verify_signature(request):
            return HttpResponseForbidden("Invalid signature")
        try:
            data = json.loads(request.body.decode("utf-8"))
        except Exception:
            return HttpResponse(status=400)

        # Iterate status updates (Meta format)
        for entry in data.get("entry", []):
            for change in entry.get("changes", []):
                value = change.get("value", {})
                for status in value.get("statuses", []):
                    msg_id = status.get("id") or ""
                    wa_status = (status.get("status") or "").lower()
                    error = status.get("errors", [{}])[0] if status.get("errors") else {}

                    try:
                        log = MessageLog.objects.get(provider_msg_id=msg_id)
                    except MessageLog.DoesNotExist:
                        continue

                    if wa_status == "sent":
                        log.status = MessageLog.Status.SENT
                    elif wa_status == "delivered":
                        log.status = MessageLog.Status.DELIVERED
                    elif wa_status == "read":
                        log.status = MessageLog.Status.READ
                    elif wa_status == "failed":
                        log.status = MessageLog.Status.FAILED
                        log.error_code = str(error.get("code",""))
                        log.error_title = error.get("title","")
                    else:
                        # unknown state; do not regress
                        pass
                    log.updated_at = timezone.now()
                    log.save(update_fields=["status","error_code","error_title","updated_at"])
        return JsonResponse({"ok": True})
    return HttpResponse(status=405)

def _digits_only(phone_e164: str) -> str:
    return "".join([c for c in (phone_e164 or "") if c.isdigit()])

def _wa_link(phone_e164: str, text: str) -> str:
    digits = _digits_only(phone_e164)
    return f"https://wa.me/{digits}?text={quote(text)}"

def whatsapp_preview(request, log_id: int):
    """
    Interstitial page that (a) shows the pre-filled message, (b) tries to open WhatsApp
    with a single click fallback. Does NOT send anything automatically.
    """
    log = get_object_or_404(MessageLog, pk=log_id)
    payload = log.payload or {}

    # Build the prefilled text ONLY from current payload + links
    if payload.get("_prefill_text"):
        text = str(payload.get("_prefill_text") or "").strip()
    # Legacy flows
    elif log.template_code == "RED_EDU_V1":
        body = (payload.get("_components", {}) or {}).get("body") or []
        text = "\n".join([str(x) for x in body if x])
    elif log.template_code == "RED_ASSIST_V1":
        # flags humanization (no payload change)
        try:
            s = log.related_screening
            lang = choose_language(
                getattr(getattr(s.student, "primary_guardian", None), "preferred_language", None),
                getattr(s.organization, "locale", None)
            )
            flags_txt = flags_to_text(payload.get("flags", []), lang)
        except Exception:
            flags_txt = ", ".join(payload.get("flags", []))
        text = "\n".join([
            flags_txt,
            payload.get("video", "") or "",
            payload.get("apply_url", "") or "",
        ]).strip()
    else:
        text = json.dumps(payload)  # fallback (not expected for this flow)

    wa_url = _wa_link(log.to_phone_e164, text)
    # By default return to screening result; allow override with ?next=
    next_url = request.GET.get("next")
    if not next_url and log.related_screening_id:
        next_url = reverse("screening_result", args=[log.related_screening_id])
    next_url = next_url or "/"

    return render(request, "screening/whatsapp_preview.html", {
        "wa_url": wa_url,
        "message_text": text,
        "phone": log.to_phone_e164,
        "template_code": log.template_code,
        "next_url": next_url,
    })
================================================================================
FILE: messaging\providers\aisensy.py
================================================================================

# messaging/providers/aisensy.py
import os, requests
from .base import WhatsAppProvider

class AiSensyProvider(WhatsAppProvider):
    """
    Thin wrapper over AiSensy Campaign API v2.
    Uses API Campaigns you've set live (one per language), e.g.
    nutrilift_redflag_edu_v1_en / _hi
    """
    def __init__(self):
        self.api_key = os.getenv("AISENSY_API_KEY")
        self.base_url = os.getenv("AISENSY_BASE_URL", "https://backend.aisensy.com/campaign/t1/api/v2")
        self.source = os.getenv("AISENSY_SOURCE", "backend")
        self.username_fallback = os.getenv("AISENSY_USERNAME_FALLBACK", "User")
        if not self.api_key:
            raise RuntimeError("Missing AISENSY_API_KEY")

    def send_template(self, to_phone_e164: str, template_name: str, language_code: str, components: dict):
        """
        components contract (from your existing service layer):
          - components["body"]    : list of strings -> ordered {{1}}, {{2}}, ... for the Body
          - components["buttons"] : list of strings -> dynamic button URLs (informational)
        For AiSensy, templateParams must include all {{n}} used by the campaign.
        We assume your campaigns reuse the same {{n}} in buttons as in body,
        so 'body' alone satisfies the count. If your button uses extra {{n}},
        pass components["params"] explicitly with the full ordered list.
        """
        campaign_name = f"{template_name}_{language_code}"  # e.g., nutrilift_redflag_assist_v1_hi

        # Prefer explicit "params" if provided; else default to body-only
        body_params = components.get("body") or []
        template_params = components.get("params", body_params)

        # Use first body param as recipient name if available
        user_name = str(components.get("user_name") or (body_params[0] if body_params else self.username_fallback))

        payload = {
            "apiKey": self.api_key,
            "campaignName": campaign_name,
            "destination": to_phone_e164,         # keep E.164; AiSensy accepts +91… (docs)
            "userName": user_name,
            "source": self.source,
            "templateParams": [str(x) for x in template_params],
        }

        # Optional: attach a few useful attributes as strings
        attrs = components.get("attributes") or {}
        if attrs:
            payload["attributes"] = {str(k): str(v) for k, v in attrs.items()}

        r = requests.post(self.base_url, json=payload, timeout=20)
        # If AiSensy returns non-2xx, raise; Celery will retry if used
        r.raise_for_status()

        # Response may be {"status":"success","message":"queued"} or similar; an ID isn't guaranteed
        try:
            data = r.json()
        except ValueError:
            data = {}

        provider_status = str(data.get("status", "sent")).lower()  # treat success as "sent"
        # We don't get a WhatsApp message-id here; persist an empty id.
        return ("", "sent" if provider_status in ("success", "sent") else provider_status)

================================================================================
FILE: messaging\providers\base.py
================================================================================

from abc import ABC, abstractmethod
from typing import Dict, Tuple

class WhatsAppProvider(ABC):
    @abstractmethod
    def send_template(self, to_phone_e164: str, template_name: str, language_code: str, components: Dict) -> Tuple[str, str]:
        """
        Returns (provider_msg_id, provider_status)
        components is provider-specific; for Meta Cloud we pass {"body": [...], "buttons": [...]}
        """
        raise NotImplementedError

================================================================================
FILE: messaging\providers\meta_cloud.py
================================================================================

import os, requests
from .base import WhatsAppProvider

class MetaCloudProvider(WhatsAppProvider):
    """
    Minimal wrapper for WhatsApp Cloud API (template sends).
    Requires:
      WA_PHONE_NUMBER_ID, WA_ACCESS_TOKEN
    """
    def __init__(self):
        self.phone_number_id = os.getenv("WA_PHONE_NUMBER_ID")
        self.token = os.getenv("WA_ACCESS_TOKEN")
        if not self.phone_number_id or not self.token:
            raise RuntimeError("Meta Cloud Provider missing WA_PHONE_NUMBER_ID/WA_ACCESS_TOKEN")

    def send_template(self, to_phone_e164: str, template_name: str, language_code: str, components: dict):
        url = f"https://graph.facebook.com/v20.0/{self.phone_number_id}/messages"
        headers = {"Authorization": f"Bearer {self.token}", "Content-Type": "application/json"}
        payload = {
            "messaging_product": "whatsapp",
            "to": to_phone_e164,
            "type": "template",
            "template": {
                "name": template_name,                    # must exist/approved in WABA
                "language": {"code": language_code},      # e.g., "en", "hi"
                "components": []
            }
        }
        # Body params
        body_params = components.get("body", [])
        if body_params:
            payload["template"]["components"].append({
                "type": "body",
                "parameters": [{"type":"text","text": str(x)} for x in body_params]
            })
        # URL buttons (index order must match template)
        buttons = components.get("buttons", [])
        for idx, url_text in enumerate(buttons):
            payload["template"]["components"].append({
                "type": "button", "sub_type": "url", "index": idx,
                "parameters": [{"type":"text","text": url_text}]
            })
        r = requests.post(url, json=payload, headers=headers, timeout=20)
        r.raise_for_status()
        data = r.json()
        # Return first message id if present
        msg_id = (data.get("messages") or [{}])[0].get("id","")
        return (msg_id or "", "sent")

================================================================================
FILE: messaging\providers\mock.py
================================================================================

import uuid
from .base import WhatsAppProvider

class MockProvider(WhatsAppProvider):
    def send_template(self, to_phone_e164: str, template_name: str, language_code: str, components: dict):
        # pretend it's sent and immediately 'SENT'
        return (f"mock-{uuid.uuid4()}", "sent")

================================================================================
FILE: nutrilift\asgi.py
================================================================================

"""
ASGI config for nutrilift project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'nutrilift.settings')

application = get_asgi_application()

================================================================================
FILE: nutrilift\celery.py
================================================================================

import os
from celery import Celery

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "nutrilift.settings")

app = Celery("nutrilift")
app.config_from_object("django.conf:settings", namespace="CELERY")
app.autodiscover_tasks()

================================================================================
FILE: nutrilift\settings.py
================================================================================

"""
Unified Django settings for the Nutrilift backend.

This consolidates the previous package `nutrilift.settings` (base.py, local.py,
staging.py, production.py) into a single module `nutrilift.settings`.

Derived from the original `base.py` with `local.py` and `staging.py` behavior
preserved via the DJANGO_ENV compatibility shim at the bottom.
"""

import os
from pathlib import Path
from celery.schedules import crontab
import json, sys

#To use the project without Docker
from dotenv import load_dotenv
import socket

SETTINGS_FILE = Path(__file__).resolve()
PROJECT_ROOT = SETTINGS_FILE.parent.parent.parent  # Go up: nutrilift -> backend -> project_root
load_dotenv(PROJECT_ROOT / ".env", override=False)


# Auto-detect if running in Docker or locally
def _is_docker():
    """Detect if we're running inside Docker."""
    # Check for Docker-specific file
    if Path('/.dockerenv').exists():
        return True
    # Try to resolve Docker service hostname 'db'
    try:
        socket.gethostbyname('db')
        return True
    except (socket.gaierror, OSError):
        return False

IS_DOCKER = _is_docker()

# Auto-adjust DB_HOST and Redis URLs for local development
if not IS_DOCKER:
    # Override Docker-specific hostnames with localhost equivalents
    if os.getenv("DB_HOST") == "db":
        os.environ["DB_HOST"] = "127.0.0.1"
    if os.getenv("CELERY_BROKER_URL", "").startswith("redis://redis:"):
        os.environ["CELERY_BROKER_URL"] = "redis://127.0.0.1:6379/0"
    if os.getenv("CELERY_RESULT_BACKEND", "").startswith("redis://redis:"):
        os.environ["CELERY_RESULT_BACKEND"] = "redis://127.0.0.1:6379/1"
    if os.getenv("MYSQL_HOST") == "db":
        os.environ["MYSQL_HOST"] = "127.0.0.1"

    # Rate limiting Redis URL is independent of Celery and must be normalized too
    if os.getenv("RATELIMIT_REDIS_URL", "").startswith("redis://redis:"):
        os.environ["RATELIMIT_REDIS_URL"] = "redis://127.0.0.1:6379/0"
# PHASE 11
LOG_JSON = os.getenv("LOG_JSON", "1") == "1"
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")

# IMPORTANT: this file lives at nutrilift/backend/nutrilift/settings.py
# We keep BASE_DIR pointing to /backend (same as before) by using .parent.parent
BASE_DIR = Path(__file__).resolve().parent.parent


SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "dev-unsafe")
DEBUG = os.getenv("DJANGO_DEBUG", "0") == "1"
#ALLOWED_HOSTS = [h.strip() for h in os.getenv("ALLOWED_HOSTS", "localhost,127.0.0.1").split(",") if h.strip()]
ALLOWED_HOSTS=["*"]
CSRF_TRUSTED_ORIGINS = [o.strip() for o in os.getenv("CSRF_TRUSTED_ORIGINS", "").split(",") if o.strip()]

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    # project apps
    "accounts",
    "orgs",
    "roster.apps.RosterConfig",
    "screening",
    "audit",
    "messaging",
    "assist",
    "program.apps.ProgramConfig",  # <- keep this dotted path
    "fulfillment",
    "reporting.apps.ReportingConfig",                   # sprint 8
    "ops",                         # observability + backups
    "screening_only",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    # RBAC org scoping
    "accounts.middleware.CurrentOrganizationMiddleware",
    # PHASE 11
    "ops.middleware.RequestLogMiddleware",
]

# Templates (needed for Django admin)
TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],  # same location as before
        "APP_DIRS": True,                  # allows loading app templates (incl. admin)
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",   # admin needs this
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

ROOT_URLCONF = "nutrilift.urls"
WSGI_APPLICATION = "nutrilift.wsgi.application"
ASGI_APPLICATION = "nutrilift.asgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        #"NAME": os.getenv("MYSQL_DATABASE", "nutrilift"),
        "NAME": "nutrilift",
        #"USER": os.getenv("MYSQL_USER", "nutrilift"),
        "USER": "nutrilift",
        #"PASSWORD": os.getenv("MYSQL_PASSWORD", "nutrilift"),
        "PASSWORD": "q&cWMVFaV%BV%SrQ",
        #"HOST": os.getenv("DB_HOST", "127.0.0.1"),
        "HOST": "localhost",
        "PORT": int(os.getenv("DB_PORT", "3306")),
        "OPTIONS": {
            "charset": "utf8mb4",
            "use_unicode": True,
        },
    }
}

AUTH_USER_MODEL = "accounts.User"
AUTHENTICATION_BACKENDS = ["django.contrib.auth.backends.ModelBackend"]

LANGUAGE_CODE = "en-us"
TIME_ZONE = os.getenv("TIME_ZONE", "UTC")
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# --- Phase 2: Funding ---



# Admin URL (harden in staging/prod)
ADMIN_URL = os.getenv("ADMIN_URL", "admin")

# CELERY_BROKER_URL = os.getenv("CELERY_BROKER_URL", "redis://redis:6379/0")
# CELERY_RESULT_BACKEND = os.getenv("CELERY_RESULT_BACKEND", "redis://redis:6379/1")
CELERY_BROKER_URL = os.getenv("CELERY_BROKER_URL", "redis://127.0.0.1:6379/0")
CELERY_RESULT_BACKEND = os.getenv("CELERY_RESULT_BACKEND", "redis://127.0.0.1:6379/1")
CELERY_TIMEZONE = TIME_ZONE

# Celery beat schedules (copied as-is)
CELERY_BEAT_SCHEDULE = {
    "compliance-reminders-15min": {
        "task": "program.tasks.send_compliance_due_reminders",
        "schedule": crontab(minute="*/15"),
    },
    "milestones-overdue-and-enforcement-daily": {
        "task": "program.tasks.update_milestones_and_enforcement",
        "schedule": crontab(hour=2, minute=15),
    },
}

CELERY_BEAT_SCHEDULE.update({
    "reporting-rollup-nightly": {
        "task": "reporting.tasks.build_daily_rollups",
        "schedule": crontab(hour=1, minute=30),  # 01:30 every day
    },
    "reporting-send-due-reports-daily": {
        "task": "reporting.tasks.send_due_school_reports",
        "schedule": crontab(hour=3, minute=5),   # 03:05 every day
    },
})

# PHASE 11
CELERY_BEAT_SCHEDULE.update({
    "ops-beat-heartbeat-every-1m": {
        "task": "ops.tasks.beat_heartbeat",
        "schedule": crontab(minute="*/1")
    },
    "ops-nightly-backup": {
        "task": "ops.tasks.nightly_backup",
        "schedule": crontab(hour=2, minute=30)
    },
})

# ------------------------------------------------------------------------------
# Single-file environment profile (replaces settings.local/staging/production)
# ------------------------------------------------------------------------------
# Prefer DJANGO_ENV; if not set, fall back to the *suffix* of DJANGO_SETTINGS_MODULE
# (e.g. ".local", ".staging", ".production") for compatibility with existing env files.
DJANGO_ENV = os.getenv("DJANGO_ENV")
if not DJANGO_ENV:
    _dsm = os.getenv("DJANGO_SETTINGS_MODULE", "")
    if _dsm.endswith(".local"):
        DJANGO_ENV = "local"
    elif _dsm.endswith(".staging"):
        DJANGO_ENV = "staging"
    elif _dsm.endswith(".production"):
        DJANGO_ENV = "production"
    else:
        DJANGO_ENV = "local"  # safe default for development

DJANGO_ENV = DJANGO_ENV.lower()

if DJANGO_ENV == "local":
    # Match previous settings.local: always enable DEBUG in local dev
    DEBUG = True
elif DJANGO_ENV in {"staging", "production"}:
    # Match previous settings.staging (production imported staging)
    DEBUG = False
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_SSL_REDIRECT = True
    SECURE_HSTS_SECONDS = 3600
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
# ------------------------------------------------------------------------------

# --- Screening-only program config ---
GOOGLE_OAUTH_CLIENT_ID = os.getenv("GOOGLE_OAUTH_CLIENT_ID", "")
GOOGLE_OAUTH_CLIENT_SECRET = os.getenv("GOOGLE_OAUTH_CLIENT_SECRET", "")

# Optional content links used in onboarding UI
SCREENING_GUIDE_URL = os.getenv("SCREENING_GUIDE_URL", "")
SCREENING_TRAINING_VIDEO_URL = os.getenv("SCREENING_TRAINING_VIDEO_URL", "")

# Academic year start month (India often June)
SCREENING_ACADEMIC_YEAR_START_MONTH = int(os.getenv("SCREENING_ACADEMIC_YEAR_START_MONTH", "6"))

SCREENING_TERMS_URL = os.getenv("SCREENING_TERMS_URL", "")

STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"

# --- PID (Pseudonymous ID) settings ---
PID_HMAC_KEY = os.getenv("PID_HMAC_KEY")
if not PID_HMAC_KEY:
    # In production, you MUST set PID_HMAC_KEY so PID is non-reversible.
    if not DEBUG:
        raise RuntimeError("PID_HMAC_KEY environment variable is required when DEBUG=False")
    # DEV fallback only (do not use in production)
    PID_HMAC_KEY = SECRET_KEY

================================================================================
FILE: nutrilift\urls.py
================================================================================

from django.conf import settings
from django.contrib import admin
from django.http import JsonResponse
from django.urls import path
from accounts.decorators import require_roles
from accounts.models import Role
from django.urls import path, include

def health(_):
    return JsonResponse({"ok": True})

@require_roles(Role.SAPA_ADMIN, Role.ORG_ADMIN, allow_superuser=True)
def whoami(request):
    u = request.user
    org = getattr(request, "org", None)
    return JsonResponse({
        "email": u.email,
        "roles": list(u.memberships.values_list("role", flat=True)),
        "active_org": org.name if org else None,
    })

urlpatterns = [
    path("health/", health),
    path(f"{settings.ADMIN_URL}/", admin.site.urls),
    path("whoami/", whoami),
    path("screening/", include("screening.urls")),
    path("", include("messaging.urls")),
    path("", include("assist.urls")),
    path("", include("program.urls")),
    path("", include("fulfillment.urls")),
    path("", include("reporting.urls")),
    path("", include("ops.urls")),
    path("", include("orgs.urls")),
    path("screening-program/", include("screening_only.urls")),
]



================================================================================
FILE: nutrilift\wsgi.py
================================================================================

"""
WSGI config for nutrilift project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'nutrilift.settings')

application = get_wsgi_application()

================================================================================
FILE: nutrilift\__init__.py
================================================================================

from .celery import app as celery_app
__all__ = ("celery_app",)

================================================================================
FILE: ops\admin.py
================================================================================

from django.contrib import admin

# Register your models here.

================================================================================
FILE: ops\apps.py
================================================================================

from django.apps import AppConfig
class OpsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "ops"

================================================================================
FILE: ops\middleware.py
================================================================================

import json, time, logging, os
from django.utils.deprecation import MiddlewareMixin
from django.utils.timezone import now

log = logging.getLogger("request")
REDACT = os.getenv("REDACT_PII_IN_LOGS","1") == "1"
LOG_REQUESTS = os.getenv("LOG_REQUESTS","1") == "1"

REDACT_KEYS = {"password","parent_phone_e164","phone","to_phone_e164","email"}

def _scrub(d: dict):
    if not REDACT or not d: return d
    out = {}
    for k,v in d.items():
        if k.lower() in REDACT_KEYS:
            out[k] = "***redacted***"
        else:
            out[k] = v
    return out

class RequestLogMiddleware(MiddlewareMixin):
    def process_request(self, request):
        if not LOG_REQUESTS: return
        request._ts = time.time()

    def process_response(self, request, response):
        if not LOG_REQUESTS: return response
        try:
            dur = time.time() - getattr(request, "_ts", time.time())
            u = getattr(request, "user", None)
            org = getattr(request, "org", None)
            payload = {
                "ts": now().isoformat(),
                "method": request.method,
                "path": request.path,
                "status": response.status_code,
                "duration_ms": int(dur*1000),
                "user": (u.email if u and u.is_authenticated else None),
                "org": (org.id if org else None),
                "ip": request.META.get("REMOTE_ADDR"),
                "ua": request.META.get("HTTP_USER_AGENT",""),
            }
            # Only log POST bodies minimally
            if request.method in ("POST","PUT","PATCH"):
                payload["body_keys"] = list(getattr(request, "POST", {}).keys())
            log.info(json.dumps(payload))
        except Exception:
            pass
        return response

================================================================================
FILE: ops\models.py
================================================================================

from django.db import models
from django.utils import timezone

class Heartbeat(models.Model):
    key = models.CharField(max_length=32, unique=True)   # e.g., "beat"
    seen_at = models.DateTimeField(default=timezone.now, db_index=True)
    def __str__(self): return f"{self.key} @ {self.seen_at}"

================================================================================
FILE: ops\pii.py
================================================================================

def mask_phone(p: str) -> str:
    if not p: return ""
    tail = p[-4:]
    return f"{'*'*(len(p)-4)}{tail}"

================================================================================
FILE: ops\tasks.py
================================================================================

from celery import shared_task
from django.utils import timezone
from .models import Heartbeat
import os, subprocess, tempfile, datetime, boto3
from celery import shared_task

@shared_task
def beat_heartbeat():
    Heartbeat.objects.update_or_create(key="beat", defaults={"seen_at": timezone.now()})
    return "ok"

def _mysqldump_to_file(path: str):
    host = os.getenv("MYSQL_HOST") or os.getenv("DB_HOST") or "127.0.0.1"
    if host == "db":
        host = "127.0.0.1"


    port = os.getenv("MYSQL_PORT","3306")
    db = os.getenv("MYSQL_DATABASE","nutrilift")
    user = os.getenv("MYSQL_USER","nutrilift")
    pwd = os.getenv("MYSQL_PASSWORD","nutrilift")
    cmd = [
        "mysqldump", f"-h{host}", f"-P{port}", f"-u{user}", f"-p{pwd}",
        "--single-transaction", "--routines", "--triggers", "--events",
        db
    ]
    with open(path, "wb") as f:
        subprocess.check_call(cmd, stdout=f)

@shared_task
def nightly_backup():
    bucket = os.getenv("AWS_S3_BACKUP_BUCKET")
    if not bucket:
        return "no bucket configured"
    with tempfile.NamedTemporaryFile(suffix=".sql", delete=False) as tmp:
        _mysqldump_to_file(tmp.name)
        key = f"db/{datetime.datetime.utcnow().strftime('%Y-%m-%d')}.sql"
        s3 = boto3.client("s3", region_name=os.getenv("AWS_DEFAULT_REGION"))
        s3.upload_file(tmp.name, bucket, key, ExtraArgs={"ServerSideEncryption": "AES256"})
    return f"s3://{bucket}/{key}"

================================================================================
FILE: ops\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: ops\urls.py
================================================================================

from django.urls import path
from .views import healthz
urlpatterns = [ path("ops/healthz", healthz) ]

================================================================================
FILE: ops\views.py
================================================================================

from django.http import JsonResponse
from django.utils import timezone
from .models import Heartbeat

def healthz(request):
    beat = Heartbeat.objects.filter(key="beat").first()
    beat_ok = False
    if beat:
        beat_ok = (timezone.now() - beat.seen_at).total_seconds() < 180  # <3min
    return JsonResponse({"ok": True, "celery_beat_ok": beat_ok})

================================================================================
FILE: ops\__init__.py
================================================================================


================================================================================
FILE: ops\management\commands\anonymize_db.py
================================================================================

import random, string
from django.core.management.base import BaseCommand, CommandError
from django.conf import settings
from roster.models import Student, Guardian

def _rand_name():
    return "User" + "".join(random.choices(string.ascii_uppercase+string.digits, k=6))

class Command(BaseCommand):
    help = "Scramble PII (use ONLY on staging/dev)."

    def handle(self, *args, **opts):
        if not settings.DEBUG:
            raise CommandError("Refusing to anonymize in non-DEBUG environment.")
        for s in Student.objects.all().iterator():
            s.first_name = _rand_name(); s.last_name = ""
            s.save(update_fields=["first_name","last_name"])
        for g in Guardian.objects.all().iterator():
            if g.phone_e164:
                g.phone_e164 = "+91" + "".join(random.choices("0123456789", k=8))
            g.full_name = _rand_name()
            g.save(update_fields=["full_name","phone_e164"])
        self.stdout.write(self.style.SUCCESS("Anonymized students & guardians."))

================================================================================
FILE: ops\management\commands\backup_db_to_s3.py
================================================================================

from django.core.management.base import BaseCommand
from ops.tasks import nightly_backup
class Command(BaseCommand):
    help = "Run a DB backup now and upload to S3."
    def handle(self, *args, **opts):
        res = nightly_backup()
        self.stdout.write(self.style.SUCCESS(str(res)))

================================================================================
FILE: orgs\admin.py
================================================================================

from django.contrib import admin

# Register your models here.

================================================================================
FILE: orgs\apps.py
================================================================================

from django.apps import AppConfig
class OrgsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "orgs"

================================================================================
FILE: orgs\forms.py
================================================================================

from django import forms
from accounts.models import Organization

class OrgSignupForm(forms.Form):
    # Organization fields
    name = forms.CharField(max_length=255, label="Organization name")
    org_type = forms.ChoiceField(choices=Organization.OrgType.choices, label="Organization type")
    city = forms.CharField(max_length=128, required=False)
    state = forms.CharField(max_length=128, required=False)
    country = forms.CharField(max_length=64, required=False)
    # Admin user fields
    admin_email = forms.EmailField(label="Admin email")
    password1 = forms.CharField(widget=forms.PasswordInput, label="Password")
    password2 = forms.CharField(widget=forms.PasswordInput, label="Confirm password")

    def clean(self):
        data = super().clean()
        if data.get("password1") != data.get("password2"):
            self.add_error("password2", "Passwords do not match.")
        return data


class OrgLoginForm(forms.Form):
    email = forms.EmailField(label="Email")
    password = forms.CharField(widget=forms.PasswordInput, label="Password")

================================================================================
FILE: orgs\models.py
================================================================================

from django.db import models
# Placeholder – classrooms/students come in Sprint 1

================================================================================
FILE: orgs\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: orgs\urls.py
================================================================================

from django.urls import path
from .views import org_start

app_name = "orgs"
urlpatterns = [
    path("orgs/start", org_start, name="org_start"),
]

================================================================================
FILE: orgs\views.py
================================================================================

from django.contrib.auth import authenticate, login
from django.db import transaction
from django.shortcuts import render, redirect
from django.urls import reverse
from django.utils.crypto import get_random_string
from django.utils.text import slugify

from accounts.models import Organization, User, OrgMembership, Role
from .forms import OrgSignupForm, OrgLoginForm
from django.http import HttpResponse
from accounts.decorators import require_roles


def _unique_screening_token(name: str) -> str:
    base = slugify(name) or "org"
    while True:
        token = f"{base}-{get_random_string(8)}"
        if not Organization.objects.filter(screening_link_token=token).exists():
            return token

# --- NEW: OrgType -> Role mapping for the org creator/admin user ---
ORG_TYPE_TO_ROLE = {
    Organization.OrgType.SCHOOL: Role.ORG_ADMIN,        # "School Admin"
    Organization.OrgType.NGO: Role.ORG_ADMIN,           # "School Admin"
    Organization.OrgType.SAPA: Role.SAPA_ADMIN,         # "SAPA Admin"
    Organization.OrgType.INDITECH: Role.INDITECH,       # "Inditech"
    Organization.OrgType.MANUFACTURER: Role.MANUFACTURER,  # "Manufacturer"
    Organization.OrgType.LOGISTICS: Role.LOGISTICS,     # "Logistics Partner"
}

def _pick_primary_membership(user: User):
    """
    Pick the membership we’ll treat as the user's primary org context.
    Current product assumption: 1 user -> 1 org (common case).
    """
    return (
        user.memberships
            .filter(is_active=True)
            .select_related("organization")
            .order_by("created_at")
            .first()
    )

def _redirect_for_membership(mem: OrgMembership):
    """
    Redirect to the most significant dashboard page based on membership role.
    Keep this mapping EXACTLY as requested.
    """
    role = mem.role

    if role == Role.ORG_ADMIN:
        try:
            mem.organization.screening_only_profile
            return redirect(reverse("screening_only:admin_link_dashboard"))
        except Exception:
            return redirect(reverse("assist:school_app_dashboard"))

    if role == Role.SAPA_ADMIN:
        return redirect(reverse("assist:sapa_approvals_dashboard"))  # /assist/sapa/approvals

    if role == Role.INDITECH:
        return redirect(reverse("reporting:inditech_dashboard"))  # /reporting/inditech


    if role == Role.MANUFACTURER:
        return redirect(reverse("fulfillment:manufacturer_po_list"))  # /fulfillment/manufacturer/production-orders

    if role == Role.LOGISTICS:
        return redirect(reverse("fulfillment:logistics_shipments_list"))  # /fulfillment/logistics/shipments

    # Optional safety fallback:
    if role == Role.TEACHER:
        return redirect(reverse("teacher_portal_token", args=[mem.organization.screening_link_token]))

    return redirect(reverse("orgs:org_start"))


@transaction.atomic
def org_start(request):
    """One page with two modes: signup (create org) and login (existing org)."""
    mode = request.GET.get("mode", "signup")
    if request.method == "POST":
        mode = request.POST.get("mode", mode)

    if mode == "login":
        form = OrgLoginForm(request.POST or None)
        if request.method == "POST" and form.is_valid():
            user = authenticate(request, email=form.cleaned_data["email"], password=form.cleaned_data["password"])
            if user is None:
                form.add_error(None, "Invalid email or password.")
            else:
                login(request, user)

                mem = _pick_primary_membership(user)
                if not mem:
                    form.add_error(None, "No active organization membership found for this user.")
                else:
                # ensure org context is set for middleware-protected dashboards
                    request.session["current_org_id"] = mem.organization_id
                    return _redirect_for_membership(mem)

        return render(request, "orgs/start.html", {"mode": "login", "login_form": form, "signup_form": OrgSignupForm()})

    # Default: signup
    form = OrgSignupForm(request.POST or None)
    if request.method == "POST" and form.is_valid():
        # Create organization
        org = Organization.objects.create(
            name=form.cleaned_data["name"],
            org_type=form.cleaned_data["org_type"],
            city=form.cleaned_data["city"],
            state=form.cleaned_data["state"],
            country=form.cleaned_data["country"],
            # timezone default = "Asia/Kolkata" (model default)
            screening_link_token=_unique_screening_token(form.cleaned_data["name"]),
            # is_active default True (model default)
        )
        # Create admin user
        user = User.objects.create_user(
            email=form.cleaned_data["admin_email"],
            password=form.cleaned_data["password1"],
            is_staff=True  # optional; keeps access to Django admin if you wish
        )
        # Link membership
        selected_org_type = org.org_type  # stored on Organization
        mapped_role = ORG_TYPE_TO_ROLE.get(selected_org_type, Role.ORG_ADMIN)

        mem = OrgMembership.objects.create(user=user, organization=org, role=mapped_role)

        # Log in and set org context for continuity
        login(request, user)
        request.session["current_org_id"] = org.id
        return _redirect_for_membership(mem)


    return render(request, "orgs/start.html", {"mode": "signup", "signup_form": form, "login_form": OrgLoginForm()})



================================================================================
FILE: orgs\__init__.py
================================================================================


================================================================================
FILE: program\admin.py
================================================================================

from django.contrib import admin
from .models import Enrollment
from django.contrib import admin
from django.utils import timezone
from .models import Enrollment, MonthlySupply
from .models import ComplianceSubmission
from .models import ScreeningMilestone

@admin.register(Enrollment)
class EnrollmentAdmin(admin.ModelAdmin):
    list_display = ("organization","student","status","start_date","end_date","approved_by")
    list_filter = ("organization","status")
    search_fields = ("student__first_name","student__last_name")

@admin.action(description="Mark as delivered today (sets compliance due +27 days)")
def _mark_delivered_today(modeladmin, request, queryset):
    from .services import mark_supply_delivered
    for s in queryset:
        mark_supply_delivered(s, timezone.now().date(), actor=request.user)

@admin.register(MonthlySupply)
class MonthlySupplyAdmin(admin.ModelAdmin):
    list_display = ("enrollment","month_index","scheduled_delivery_date","delivered_on","compliance_due_at","qr_token")
    list_filter = ("enrollment__organization","delivered_on")
    search_fields = ("enrollment__student__first_name","enrollment__student__last_name","qr_token")
    actions = [_mark_delivered_today]

@admin.register(ComplianceSubmission)
class ComplianceSubmissionAdmin(admin.ModelAdmin):
    list_display = ("monthly_supply","status","submitted_at")
    list_filter = ("status","monthly_supply__enrollment__organization")
    search_fields = ("monthly_supply__enrollment__student__first_name",
                     "monthly_supply__enrollment__student__last_name")

@admin.register(ScreeningMilestone)
class ScreeningMilestoneAdmin(admin.ModelAdmin):
    list_display = ("enrollment","milestone","status","due_on","completed_at")
    list_filter = ("status","milestone","enrollment__organization")
    search_fields = ("enrollment__student__first_name","enrollment__student__last_name")

================================================================================
FILE: program\apps.py
================================================================================

from django.apps import AppConfig
class ProgramConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "program"
    def ready(self):
        # Import signals so Django registers the receivers at startup
        from . import signals  # noqa 

================================================================================
FILE: program\forms.py
================================================================================

from django import forms

class ComplianceForm(forms.Form):
    CHOICES = [
        ("COMPLIANT", "Yes, we were able to give the supplement daily or almost daily."),
        ("UNABLE", "No, we were unable to comply."),
    ]
    status = forms.ChoiceField(choices=CHOICES, widget=forms.RadioSelect)
    notes = forms.CharField(widget=forms.Textarea, required=False, label="Anything you'd like to tell us? (optional)")

================================================================================
FILE: program\models.py
================================================================================

# backend/program/models.py
from __future__ import annotations
from datetime import date, datetime, timedelta, time as _time
import secrets
from typing import Optional

from django.db import models, transaction
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.utils import timezone

from accounts.models import Organization, User
from assist.models import Application
from roster.models import Student
from screening.models import Screening

from datetime import date, timedelta
from django.utils.dateparse import parse_date

def _mint_token(nbytes: int = 24) -> str:
    # url-safe, ~32 chars for 24 bytes
    return secrets.token_urlsafe(nbytes)


def _unique_qr_token() -> str:
    # generate until unique
    for _ in range(6):
        token = _mint_token(24)
        if not MonthlySupply.objects.filter(qr_token=token).exists():
            return token
    # last resort (extremely unlikely)
    return _mint_token(32)


def _due_dt_for(delivered_on: date) -> datetime:
    """
    Compliance due = delivered_on + 27 days at 09:00 local time.
    Adjust time to something reasonable for reminders next sprint.
    """
    local_tz = timezone.get_current_timezone()
    target_day = delivered_on + timedelta(days=27)
    naive = datetime.combine(target_day, _time(hour=9, minute=0, second=0))
    return timezone.make_aware(naive, local_tz)


class Enrollment(models.Model):
    class Status(models.TextChoices):
        ACTIVE = "ACTIVE", "Active"
        COMPLETED = "COMPLETED", "Completed"
        STOPPED = "STOPPED", "Stopped"

    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="enrollments")
    application = models.OneToOneField(Application, on_delete=models.PROTECT, related_name="enrollment")
    student = models.ForeignKey(Student, on_delete=models.PROTECT, related_name="enrollments")

    start_date = models.DateField()
    end_date = models.DateField()
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.ACTIVE)
    approved_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name="+")
    meta = models.JSONField(default=dict, blank=True)

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [models.Index(fields=["organization", "status"])]

    def __str__(self):
        return f"{self.student.full_name} ({self.status})"

    @staticmethod
    def create_for_approved(app: Application, approved_by: User | None):
        start = timezone.now().date()
        end = start + timedelta(days=180)
        with transaction.atomic():
            e = Enrollment.objects.create(
                organization=app.organization,
                application=app,
                student=app.student,
                start_date=start,
                end_date=end,
                status=Enrollment.Status.ACTIVE,
                approved_by=approved_by,
            )
            MonthlySupply.bootstrap_for_enrollment(e)
            ScreeningMilestone.bootstrap_for_enrollment(e)  # NEW
        return e
    #phase 11
    def _normalize_dates(self):
        # Coerce strings (e.g. "2024-01-01") to datetime.date
        if isinstance(self.start_date, str):
            parsed = parse_date(self.start_date)
            if parsed is not None:
                self.start_date = parsed
        if isinstance(self.end_date, str):
            parsed = parse_date(self.end_date)
            if parsed is not None:
                self.end_date = parsed
    def save(self, *args, **kwargs):
        self._normalize_dates()
        return super().save(*args, **kwargs)

class MonthlySupply(models.Model):
    """
    One row per month (1..6). Each pack has a unique qr_token printed on its label.
    When 'delivered_on' is set, we compute 'compliance_due_at = delivered_on + 27 days'.
    """
    enrollment = models.ForeignKey(Enrollment, on_delete=models.CASCADE, related_name="supplies")
    month_index = models.PositiveSmallIntegerField()  # 1..6
    scheduled_delivery_date = models.DateField(null=True, blank=True)
    delivered_on = models.DateField(null=True, blank=True)
    compliance_due_at = models.DateTimeField(null=True, blank=True, db_index=True)

    qr_token = models.CharField(max_length=96, unique=True)
    ok_to_ship_next = models.BooleanField(default=False)  # used in Sprint 6 gating

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = (("enrollment", "month_index"),)
        indexes = [
            models.Index(fields=["delivered_on"]),
            models.Index(fields=["compliance_due_at"]),
        ]

    def __str__(self):
        return f"{self.enrollment.student.full_name} M{self.month_index}"

    def set_delivered(self, delivered_on: Optional[date] = None, save: bool = True):
        delivered_on = delivered_on or timezone.now().date()
        self.delivered_on = delivered_on
        self.compliance_due_at = _due_dt_for(delivered_on)
        if save:
            self.save(update_fields=["delivered_on", "compliance_due_at", "updated_at"])

    def save(self, *args, **kwargs):
        # ensure token exists
        if not self.qr_token:
            self.qr_token = _unique_qr_token()

        # recompute due if delivered_on changed (best-effort)
        if self.delivered_on and not self.compliance_due_at:
            self.compliance_due_at = _due_dt_for(self.delivered_on)
        super().save(*args, **kwargs)

    # @staticmethod
    # def bootstrap_for_enrollment(e: Enrollment):
    #     """
    #     Create supplies 1..6 if none exist.
    #     scheduled_delivery_date is optional; set first month to start_date for convenience.
    #     """
    #     if e.supplies.exists():
    #         return
    #     objs = []
    #     for i in range(1, 7):
    #         objs.append(MonthlySupply(
    #             enrollment=e,
    #             month_index=i,
    #             scheduled_delivery_date=e.start_date if i == 1 else None,
    #             qr_token=_unique_qr_token()
    #         ))
    #     MonthlySupply.objects.bulk_create(objs, ignore_conflicts=True)

    # @staticmethod
    # def bootstrap_for_enrollment(e: "Enrollment"):
    #     """
    #     Create 3‑month (+~90d) and 6‑month (+~180d) milestones if missing.
    #     """
    #     existing = {m.milestone for m in e.milestones.all()}

    #     # --- Normalize to date to avoid string + timedelta TypeError ---
    #     start = e.start_date
    #     if isinstance(start, str):
    #         parsed = parse_date(start)
    #         if parsed is not None:
    #             start = parsed
    #         else:
    #             # as a fallback, load from DB which returns a proper date
    #             e.refresh_from_db(fields=["start_date"])
    #             start = e.start_date
    #     # ----------------------------------------------------------------

    #     rows = []
    #     if "MONTH_3" not in existing:
    #         rows.append(ScreeningMilestone(
    #             enrollment=e,
    #             milestone=ScreeningMilestone.Milestone.MONTH_3,
    #             due_on=start + timedelta(days=90),
    #         ))
    #     if "MONTH_6" not in existing:
    #         rows.append(ScreeningMilestone(
    #             enrollment=e,
    #             milestone=ScreeningMilestone.Milestone.MONTH_6,
    #             due_on=start + timedelta(days=180),
    #         ))

    #     # (whatever you already do to persist `rows`, e.g., bulk_create)
    @staticmethod
    def bootstrap_for_enrollment(e: "Enrollment"):
        """Create supplies 1..6 for an enrollment if they do not already exist.

        IMPORTANT: this method *must* create MonthlySupply rows. Milestone creation
        is handled by ScreeningMilestone.bootstrap_for_enrollment().
        """
        if e.supplies.exists():
            return

        # Normalize dates (defensive)
        start = e.start_date
        if isinstance(start, str):
            start = parse_date(start) or timezone.now().date()

        objs = []
        for i in range(1, 7):
            sched = start + timedelta(days=30 * (i - 1))
            objs.append(
                MonthlySupply(
                    enrollment=e,
                    month_index=i,
                    scheduled_delivery_date=sched,
                    qr_token=_unique_qr_token(),
                )
            )

        MonthlySupply.objects.bulk_create(objs, ignore_conflicts=True)

class ComplianceSubmission(models.Model):
    class Status(models.TextChoices):
        NOT_SUBMITTED = "NOT_SUBMITTED", "Not submitted"
        COMPLIANT = "COMPLIANT", "Submitted & compliant"
        UNABLE = "UNABLE", "Submitted & unable"

    monthly_supply = models.OneToOneField(MonthlySupply, on_delete=models.CASCADE, related_name="compliance")
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.NOT_SUBMITTED)
    submitted_at = models.DateTimeField(null=True, blank=True)
    responses = models.JSONField(default=dict, blank=True)

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [models.Index(fields=["status", "created_at"])]

    def __str__(self):
        return f"{self.monthly_supply} → {self.status}"


# Optional: also generate supplies when someone creates an Enrollment directly (safety net)
# @receiver(post_save, sender=Enrollment)
# def _auto_generate_supplies(sender, instance: Enrollment, created: bool, **kwargs):
#     if created:
#         MonthlySupply.bootstrap_for_enrollment(instance)
@receiver(post_save, sender=Enrollment)
def _auto_generate_supplies_and_milestones(sender, instance: Enrollment, created: bool, **kwargs):
    if created:
        MonthlySupply.bootstrap_for_enrollment(instance)
        ScreeningMilestone.bootstrap_for_enrollment(instance)  # NEW

class ScreeningMilestone(models.Model):
    class Milestone(models.TextChoices):
        MONTH_3 = "MONTH_3", "3-month"
        MONTH_6 = "MONTH_6", "6-month"

    class Status(models.TextChoices):
        DUE = "DUE", "Due"
        COMPLETED = "COMPLETED", "Completed"
        OVERDUE = "OVERDUE", "Overdue"

    enrollment = models.ForeignKey("program.Enrollment", on_delete=models.CASCADE, related_name="milestones")
    milestone = models.CharField(max_length=16, choices=Milestone.choices)
    due_on = models.DateField()
    status = models.CharField(max_length=16, choices=Status.choices, default=Status.DUE)

    completed_screening = models.ForeignKey("screening.Screening", on_delete=models.SET_NULL, null=True, blank=True, related_name="+")
    completed_at = models.DateTimeField(null=True, blank=True)

    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = (("enrollment","milestone"),)
        indexes = [
            models.Index(fields=["status","due_on"]),
            models.Index(fields=["enrollment","milestone"]),
        ]

    def __str__(self):
        return f"{self.enrollment.student.full_name} – {self.milestone} – {self.status}"

    @staticmethod
    def bootstrap_for_enrollment(e: "Enrollment"):
        """
        Create 3‑month (+~90d) and 6‑month (+~180d) milestones if missing.
        """
        existing = {m.milestone for m in e.milestones.all()}
        rows = []
        if "MONTH_3" not in existing:
            rows.append(ScreeningMilestone(
                enrollment=e,
                milestone=ScreeningMilestone.Milestone.MONTH_3,
                due_on=e.start_date + timedelta(days=90),
            ))
        if "MONTH_6" not in existing:
            rows.append(ScreeningMilestone(
                enrollment=e,
                milestone=ScreeningMilestone.Milestone.MONTH_6,
                due_on=e.start_date + timedelta(days=180),
            ))
        if rows:
            ScreeningMilestone.objects.bulk_create(rows, ignore_conflicts=True)

    def mark_completed(self, screening: Screening):
        if self.status == self.Status.COMPLETED:
            return
        self.status = self.Status.COMPLETED
        self.completed_screening = screening
        self.completed_at = timezone.now()
        self.save(update_fields=["status","completed_screening","completed_at","updated_at"])

================================================================================
FILE: program\services.py
================================================================================

from datetime import date
from django.db import transaction
from django.utils import timezone
from audit.utils import audit_log
from .models import MonthlySupply
from django.db.models import Q, Count
from accounts.models import Organization
from .models import ScreeningMilestone, Enrollment

@transaction.atomic
def mark_supply_delivered(supply: MonthlySupply, delivered_on: date | None, actor=None):
    supply.set_delivered(delivered_on or timezone.now().date(), save=True)
    if actor:
        audit_log(actor, supply.enrollment.organization, "SUPPLY_DELIVERED",
                  target=supply, payload={"month_index": supply.month_index,
                                          "compliance_due_at": supply.compliance_due_at.isoformat()})
    return supply

def apply_gating_after_submission(supply: MonthlySupply):
    """
    If month m is COMPLIANT -> set month (m+1).ok_to_ship_next = True
    Else -> False. Month 6 has no next-supply.
    """
    comp = getattr(supply, "compliance", None)
    if not comp:
        return
    next_ms = MonthlySupply.objects.filter(enrollment=supply.enrollment, month_index=supply.month_index + 1).first()
    if not next_ms:
        return
    next_ms.ok_to_ship_next = (comp.status == comp.Status.COMPLIANT)
    next_ms.save(update_fields=["ok_to_ship_next", "updated_at"])

GRACE_DAYS = 0  # set >0 if you want a grace window after due date

@transaction.atomic
def compute_overdue_milestones(today: date | None = None) -> int:
    """
    Mark all DUE milestones whose due_on < today - GRACE_DAYS as OVERDUE.
    """
    today = today or timezone.now().date()
    threshold = today - timezone.timedelta(days=GRACE_DAYS)
    qs = ScreeningMilestone.objects.select_for_update().filter(
        status=ScreeningMilestone.Status.DUE,
        due_on__lt=threshold
    )
    n = qs.update(status=ScreeningMilestone.Status.OVERDUE)
    return n

@transaction.atomic
def evaluate_org_enforcement(org: Organization) -> None:
    """
    Suspend org if it has any OVERDUE milestones on ACTIVE enrollments.
    Unsuspend if none remain.
    """
    overdue_exists = ScreeningMilestone.objects.filter(
        enrollment__organization=org,
        enrollment__status=Enrollment.Status.ACTIVE,
        status=ScreeningMilestone.Status.OVERDUE
    ).exists()

    if overdue_exists and not org.assistance_suspended:
        org.assistance_suspended = True
        org.assistance_suspended_at = timezone.now()
        org.assistance_suspension_reason = "Overdue 3/6-month screening milestone(s)."
        org.save(update_fields=["assistance_suspended","assistance_suspended_at","assistance_suspension_reason"])
    elif not overdue_exists and org.assistance_suspended:
        org.assistance_suspended = False
        org.assistance_suspended_at = None
        org.assistance_suspension_reason = ""
        org.save(update_fields=["assistance_suspended","assistance_suspended_at","assistance_suspension_reason"])

def evaluate_enforcement_for_all_orgs():
    for org in Organization.objects.all().iterator():
        evaluate_org_enforcement(org)

================================================================================
FILE: program\signals.py
================================================================================

# backend/program/signals.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.utils import timezone
from screening.models import Screening
from .models import Enrollment, ScreeningMilestone
from .services import evaluate_org_enforcement
from .models import MonthlySupply, ComplianceSubmission

@receiver(post_save, sender=MonthlySupply)
def ensure_compliance_row(sender, instance: MonthlySupply, created, **kwargs):
    """
    Ensure every MonthlySupply has a ComplianceSubmission row.
    Use get_or_create for idempotency (safe on bulk/backfills).
    """
    if created:
        ComplianceSubmission.objects.get_or_create(monthly_supply=instance)

@receiver(post_save, sender=Screening)
def _complete_milestone_on_screening(sender, instance: Screening, created, **kwargs):
    if not created:
        return
    student = instance.student
    org = instance.organization
    # For the student's ACTIVE enrollments, complete any due/overdue milestones whose due_on has passed.
    # NOTE: without this, an OVERDUE milestone can never be completed and a school will remain suspended.
    enrollments = Enrollment.objects.filter(student=student, organization=org, status=Enrollment.Status.ACTIVE)
    for e in enrollments:
        for m in e.milestones.filter(
            status__in=[ScreeningMilestone.Status.DUE, ScreeningMilestone.Status.OVERDUE],
            due_on__lte=instance.screened_at.date(),
        ):
            m.mark_completed(instance)
    # Re-evaluate enforcement (may unsuspend)
    evaluate_org_enforcement(org)
================================================================================
FILE: program\tasks.py
================================================================================

import os
from datetime import timedelta
from django.utils import timezone
from celery import shared_task
from .models import MonthlySupply
from messaging.models import MessageLog
from messaging.services import send_compliance_reminder
from .services import compute_overdue_milestones, evaluate_enforcement_for_all_orgs
from accounts.models import Organization
@shared_task
def send_compliance_due_reminders():
    """
    Every 15 min:
    - Find supplies with delivered_on set
    - due at/earlier than now
    - compliance not yet submitted (NOT_SUBMITTED)
    - no reminder sent today for this supply
    Then queue a WhatsApp reminder.
    """
    now = timezone.now()
    since = now - timedelta(hours=24)

    qs = (MonthlySupply.objects
          .select_related("enrollment__student__primary_guardian", "enrollment__organization")
          .filter(delivered_on__isnull=False, compliance_due_at__lte=now,
                  compliance__status="NOT_SUBMITTED"))

    for s in qs:
        # Skip if no guardian phone
        g = getattr(s.enrollment.student, "primary_guardian", None)
        if not g or not g.phone_e164:
            continue
        # Skip if already reminded in last 24h
        already = MessageLog.objects.filter(
            related_supply=s, template_code="COMPLIANCE_REMINDER_V1",
            created_at__gte=since
        ).exists()
        if already:
            continue
        send_compliance_reminder(s)

@shared_task
def update_milestones_and_enforcement():
    compute_overdue_milestones()
    evaluate_enforcement_for_all_orgs()
================================================================================
FILE: program\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: program\urls.py
================================================================================

from django.urls import path
from .views import qr_landing, compliance_start, mark_delivered_view
from .views import compliance_form, compliance_success
from .views import (
    milestones_dashboard, milestones_sapa_overview
)
app_name = "program"

urlpatterns = [
    path("qr/<str:token>/", qr_landing, name="qr_landing"),
    path("program/compliance/start", compliance_start, name="compliance_start"),
    path("program/fulfillment/mark-delivered/<int:supply_id>/", mark_delivered_view, name="mark_delivered"),
    path("program/compliance/<str:token>", compliance_form, name="compliance_form"),
    path("program/compliance/<str:token>/thanks", compliance_success, name="compliance_success"),
    # path("program/fulfillment/mark-delivered/<int:supply_id>/", mark_delivered_view, name="mark_delivered"),
    path("program/milestones", milestones_dashboard, name="milestones_dashboard"), # ORG admin
    path("program/sapa/milestones", milestones_sapa_overview, name="milestones_sapa"), # SAPA admin
]

================================================================================
FILE: program\views.py
================================================================================

from django.shortcuts import get_object_or_404, render, redirect
from django.http import HttpResponseBadRequest
from django.urls import reverse
from django.utils import timezone
from django.http import HttpResponseForbidden
from audit.utils import audit_log
from .models import MonthlySupply
from .models import MonthlySupply, ComplianceSubmission
from .forms import ComplianceForm
from .services import mark_supply_delivered,apply_gating_after_submission
from accounts.decorators import require_roles
from accounts.models import Role
from django.db.models import Count, Q
from .models import ScreeningMilestone, Enrollment

def qr_landing(request, token: str):
    """
    Public landing after scanning a pack QR.
    Shows instructions + link to start the compliance form (Sprint 6).
    """
    supply = get_object_or_404(MonthlySupply, qr_token=token)
    org = supply.enrollment.organization
    student = supply.enrollment.student

    audit_log(user=None, org=org, action="QR_OPENED", target=supply, payload={"month": supply.month_index})

    return render(request, "program/qr_landing.html", {
        "supply": supply,
        "student": student,
        "org": org,
        "is_delivered": bool(supply.delivered_on),
    })


# def compliance_start(request):
#     """
#     Placeholder page that will link into Sprint 6 compliance form.
#     Accepts ?token=<qr_token>
#     """
#     token = request.GET.get("token") or ""
#     if not token:
#         return HttpResponseBadRequest("Missing token")
#     supply = get_object_or_404(MonthlySupply, qr_token=token)
#     return render(request, "program/compliance_start.html", {
#         "supply": supply,
#         "due": supply.compliance_due_at,
#         "delivered_on": supply.delivered_on,
#     })


# Optional helper for lightweight fulfillment outside admin (RBAC kept simple here).
from accounts.decorators import require_roles
from accounts.models import Role

# @require_roles(Role.ORG_ADMIN, Role.SAPA_ADMIN, Role.INDITECH, allow_superuser=True)
# def mark_delivered_view(request, supply_id: int):
#     from .services import mark_supply_delivered
#     if request.method != "POST":
#         return HttpResponseBadRequest("POST required")
#     supply = get_object_or_404(MonthlySupply, pk=supply_id)
#     mark_supply_delivered(supply, delivered_on=None, actor=request.user)
#     # redirect to admin change page or a list you already have
#     return redirect(f"/admin/program/monthlysupply/{supply.id}/change/")

def compliance_form(request, token: str):
    ms = get_object_or_404(MonthlySupply, qr_token=token)
    comp, _ = ComplianceSubmission.objects.get_or_create(monthly_supply=ms)

    if request.method == "POST":
        form = ComplianceForm(request.POST)
        if form.is_valid():
            comp.status = form.cleaned_data["status"]
            comp.submitted_at = timezone.now()
            comp.responses = {"notes": form.cleaned_data.get("notes","")}
            comp.save(update_fields=["status","submitted_at","responses","updated_at"])

            apply_gating_after_submission(ms)
            audit_log(user=None, org=ms.enrollment.organization, action="COMPLIANCE_SUBMITTED",
                      target=comp, payload={"status": comp.status, "supply_id": ms.id})

            return redirect(reverse("program:compliance_success", args=[ms.qr_token]))
    else:
        form = ComplianceForm(initial={"status": "COMPLIANT"})

    return render(request, "program/compliance_form.html", {
        "supply": ms, "form": form,
        "due": ms.compliance_due_at, "delivered_on": ms.delivered_on
    })

def compliance_success(request, token: str):
    ms = get_object_or_404(MonthlySupply, qr_token=token)
    comp = getattr(ms, "compliance", None)
    return render(request, "program/compliance_success.html", {"supply": ms, "comp": comp})

def compliance_start(request):
    """
    Backward-compatibility for Sprint 5 URL:
    /program/compliance/start?token=<qr_token>
    """
    token = request.GET.get("token")
    if not token:
        return HttpResponseBadRequest("Missing token")
    return redirect(reverse("program:compliance_form", args=[token]))

@require_roles(Role.ORG_ADMIN, Role.SAPA_ADMIN, Role.INDITECH, allow_superuser=True)
def mark_delivered_view(request, supply_id: int):
    """
    Legacy-compatible wrapper so older URLs that point to 'mark_delivered_view'
    continue to work. Internally we call the new helper mark_supply_delivered().
    """
    
    if request.method != "POST":
        return HttpResponseBadRequest("POST required")
    
    #commented for pytest fixing in phase 11

    # org = ms.enrollment.organization
    # if org.assistance_suspended:
    #     return HttpResponseForbidden("School is suspended due to overdue screening milestones; please complete the required 3/6‑month screenings.")
    
    # ms = get_object_or_404(MonthlySupply, pk=supply_id)
    #added for the pytest fixing
    ms = get_object_or_404(MonthlySupply, pk=supply_id)
    org = ms.enrollment.organization
    if org.assistance_suspended:
        return HttpResponseForbidden(
            "School is suspended due to overdue screening milestones; "
            "please complete the required 3/6‑month screenings."
        )
        
    mark_supply_delivered(ms, delivered_on=None, actor=request.user)
    return redirect(f"/admin/program/monthlysupply/{ms.id}/change/")

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def milestones_dashboard(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")

    today = timezone.now().date()
    upcoming_threshold = today + timezone.timedelta(days=14)

    milestones = (ScreeningMilestone.objects
                  .select_related("enrollment__student")
                  .filter(enrollment__organization=org)
                  .order_by("due_on"))

    counts = {
        "due": milestones.filter(status=ScreeningMilestone.Status.DUE, due_on__lte=upcoming_threshold).count(),
        "overdue": milestones.filter(status=ScreeningMilestone.Status.OVERDUE).count(),
        "completed": milestones.filter(status=ScreeningMilestone.Status.COMPLETED).count(),
    }

    due_list = milestones.filter(status=ScreeningMilestone.Status.DUE, due_on__lte=upcoming_threshold)
    overdue_list = milestones.filter(status=ScreeningMilestone.Status.OVERDUE)

    return render(request, "program/milestones_school.html", {
        "org": org,
        "counts": counts,
        "due_list": due_list,
        "overdue_list": overdue_list,
        "today": today,
        "suspended": org.assistance_suspended,
        "reason": org.assistance_suspension_reason,
    })

@require_roles(Role.SAPA_ADMIN, allow_superuser=True)
def milestones_sapa_overview(request):
    # Simple aggregate: overdue counts per org
    rows = (ScreeningMilestone.objects
            .filter(enrollment__status=Enrollment.Status.ACTIVE)
            .values("enrollment__organization__id","enrollment__organization__name")
            .annotate(
                overdue=Count("id", filter=Q(status=ScreeningMilestone.Status.OVERDUE)),
                due=Count("id", filter=Q(status=ScreeningMilestone.Status.DUE)),
                completed=Count("id", filter=Q(status=ScreeningMilestone.Status.COMPLETED)),
            )
            .order_by("enrollment__organization__name"))

    return render(request, "program/milestones_sapa.html", {"rows": rows})

================================================================================
FILE: program\__init__.py
================================================================================


================================================================================
FILE: program\management\commands\backfill_milestones.py
================================================================================

from django.core.management.base import BaseCommand
from program.models import Enrollment, ScreeningMilestone

class Command(BaseCommand):
    help = "Create 3- and 6-month milestones for enrollments missing them."

    def handle(self, *args, **kwargs):
        created = 0
        for e in Enrollment.objects.all().iterator():
            before = e.milestones.count()
            ScreeningMilestone.bootstrap_for_enrollment(e)
            created += (e.milestones.count() - before)
        self.stdout.write(self.style.SUCCESS(f"Created {created} milestones."))

================================================================================
FILE: program\management\commands\backfill_monthly_supplies.py
================================================================================

from django.core.management.base import BaseCommand
from program.models import Enrollment, MonthlySupply

class Command(BaseCommand):
    help = "Generate 6 monthly supplies (with QR tokens) for enrollments missing them."

    def handle(self, *args, **opts):
        created_total = 0
        for e in Enrollment.objects.all().iterator():
            before = e.supplies.count()
            MonthlySupply.bootstrap_for_enrollment(e)
            after = e.supplies.count()
            if after > before:
                self.stdout.write(self.style.SUCCESS(f"Enrollment {e.id}: created {after-before} supplies"))
                created_total += (after - before)
        self.stdout.write(self.style.SUCCESS(f"Done. Created {created_total} supplies."))

================================================================================
FILE: program\management\commands\recompute_gating.py
================================================================================

from django.core.management.base import BaseCommand
from program.models import MonthlySupply
from program.services import apply_gating_after_submission

class Command(BaseCommand):
    help = "Recompute ok_to_ship_next for all supplies based on compliance."

    def handle(self, *args, **opts):
        n = 0
        for ms in MonthlySupply.objects.select_related("compliance","enrollment").all().iterator():
            if hasattr(ms, "compliance"):
                apply_gating_after_submission(ms)
                n += 1
        self.stdout.write(self.style.SUCCESS(f"Recomputed gating for {n} supplies."))

================================================================================
FILE: program\management\commands\recompute_milestones_overdue.py
================================================================================

from django.core.management.base import BaseCommand
from program.services import compute_overdue_milestones, evaluate_enforcement_for_all_orgs

class Command(BaseCommand):
    help = "Mark overdue milestones and recompute enforcement for all orgs."

    def handle(self, *args, **kwargs):
        n = compute_overdue_milestones()
        evaluate_enforcement_for_all_orgs()
        self.stdout.write(self.style.SUCCESS(f"Marked {n} milestones overdue and evaluated enforcement."))

================================================================================
FILE: reporting\admin.py
================================================================================

from django.contrib import admin
from .models import SchoolStatDaily, SchoolReportStatus

@admin.register(SchoolStatDaily)
class SchoolStatDailyAdmin(admin.ModelAdmin):
    list_display = ("organization","day","screened","red_flags","approved","supplies_delivered","compliance_compliant","milestones_overdue")
    list_filter = ("organization",)
    date_hierarchy = "day"

@admin.register(SchoolReportStatus)
class SchoolReportStatusAdmin(admin.ModelAdmin):
    list_display = ("organization","next_due_on","last_sent_at","last_period_start","last_period_end")
    list_filter = ("next_due_on",)
    search_fields = ("organization__name",)

================================================================================
FILE: reporting\apps.py
================================================================================

from django.apps import AppConfig

class ReportingConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "reporting"

    def ready(self):
        # Register signal handlers that keep SchoolStatDaily rollups up-to-date.
        from . import signals  # noqa: F401
================================================================================
FILE: reporting\models.py
================================================================================

from __future__ import annotations
from dataclasses import asdict
from datetime import date, timedelta
from django.db import models
from django.utils import timezone
from accounts.models import Organization

class SchoolStatDaily(models.Model):
    """
    One row per (organization, date) rollup. Snapshot of counts for that day.
    """
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="daily_stats")
    day = models.DateField(db_index=True)

    # Screenings
    screened = models.PositiveIntegerField(default=0)
    red_flags = models.PositiveIntegerField(default=0)

    # Applications
    applied = models.PositiveIntegerField(default=0)
    forwarded = models.PositiveIntegerField(default=0)
    approved = models.PositiveIntegerField(default=0)
    rejected = models.PositiveIntegerField(default=0)

    # Enrollments
    enrollments_created = models.PositiveIntegerField(default=0)

    # Logistics
    supplies_delivered = models.PositiveIntegerField(default=0)

    # Compliance
    compliance_submitted = models.PositiveIntegerField(default=0)
    compliance_compliant = models.PositiveIntegerField(default=0)
    compliance_unable = models.PositiveIntegerField(default=0)

    # Milestones (events on this day)
    milestones_due = models.PositiveIntegerField(default=0)
    milestones_overdue = models.PositiveIntegerField(default=0)
    milestones_completed = models.PositiveIntegerField(default=0)

    created_at = models.DateTimeField(default=timezone.now)

    class Meta:
        unique_together = (("organization", "day"),)
        indexes = [models.Index(fields=["organization", "day"])]

    def __str__(self):
        return f"{self.organization.name} – {self.day}"

class SchoolReportStatus(models.Model):
    """
    Tracks 6-month performance report cycles per school for Inditech console.
    When we send a report, we move next_due_on by +180 days.
    """
    organization = models.OneToOneField(Organization, on_delete=models.CASCADE, related_name="report_status")
    last_sent_at = models.DateTimeField(null=True, blank=True)
    last_period_start = models.DateField(null=True, blank=True)
    last_period_end = models.DateField(null=True, blank=True)
    next_due_on = models.DateField(null=True, blank=True)

    created_at = models.DateTimeField(default=timezone.now)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.organization.name} – next due {self.next_due_on or '-'}"

    def ensure_defaults(self):
        if not self.next_due_on:
            # default: 180 days after org created_at (or today if none)
            base = (self.organization.created_at.date() if hasattr(self.organization, "created_at") else timezone.now().date())
            self.next_due_on = base + timedelta(days=180)
        self.save(update_fields=["next_due_on","updated_at"])

================================================================================
FILE: reporting\services.py
================================================================================

from __future__ import annotations
from datetime import datetime, timedelta, date
from django.db import transaction
from django.utils import timezone
from django.db.models import Q, Count
from django.db.models.functions import TruncDate
from accounts.models import Organization
from screening.models import Screening
from assist.models import Application
from program.models import Enrollment, MonthlySupply, ComplianceSubmission, ScreeningMilestone
from .models import SchoolStatDaily, SchoolReportStatus

def _bounds_for_day(day: date):
    tz = timezone.get_current_timezone()
    start = timezone.make_aware(datetime.combine(day, datetime.min.time()), tz)
    end = timezone.make_aware(datetime.combine(day, datetime.max.time()), tz)
    return start, end
def _bounds_for_period(start_day: date, end_day: date):
    """Timezone-aware datetime bounds for an inclusive date range."""
    tz = timezone.get_current_timezone()
    start = timezone.make_aware(datetime.combine(start_day, datetime.min.time()), tz)
    end = timezone.make_aware(datetime.combine(end_day, datetime.max.time()), tz)
    return start, end

@transaction.atomic
def build_daily_rollup(org: Organization, day: date) -> SchoolStatDaily:
    start, end = _bounds_for_day(day)

    # Screenings
    screenings = Screening.objects.filter(organization=org, screened_at__range=(start, end))
    screened = screenings.count()
    red_flags = screenings.filter(risk_level="RED").count()

    # Applications by timestamps
    applied = Application.objects.filter(organization=org, applied_at__range=(start, end)).count()
    forwarded = Application.objects.filter(organization=org, forwarded_at__range=(start, end)).count()
    approved = Application.objects.filter(organization=org, sapa_reviewed_at__range=(start, end), status="APPROVED").count()
    rejected = Application.objects.filter(organization=org, sapa_reviewed_at__range=(start, end), status="REJECTED").count()

    # Enrollments created today
    enrollments_created = Enrollment.objects.filter(organization=org, created_at__range=(start, end)).count()

    # Logistics
    supplies_delivered = MonthlySupply.objects.filter(enrollment__organization=org, delivered_on=day).count()

    # Compliance
    comps = ComplianceSubmission.objects.filter(monthly_supply__enrollment__organization=org, submitted_at__range=(start, end))
    compliance_submitted = comps.count()
    compliance_compliant = comps.filter(status="COMPLIANT").count()
    compliance_unable = comps.filter(status="UNABLE").count()

    # Milestones (events on this day)
    milestones_due = ScreeningMilestone.objects.filter(enrollment__organization=org, due_on=day).count()
    milestones_overdue = ScreeningMilestone.objects.filter(enrollment__organization=org, status="OVERDUE", updated_at__range=(start, end)).count()
    milestones_completed = ScreeningMilestone.objects.filter(enrollment__organization=org, status="COMPLETED", completed_at__range=(start, end)).count()

    # Upsert
    SchoolStatDaily.objects.filter(organization=org, day=day).delete()
    row = SchoolStatDaily.objects.create(
        organization=org, day=day,
        screened=screened, red_flags=red_flags,
        applied=applied, forwarded=forwarded, approved=approved, rejected=rejected,
        enrollments_created=enrollments_created,
        supplies_delivered=supplies_delivered,
        compliance_submitted=compliance_submitted, compliance_compliant=compliance_compliant, compliance_unable=compliance_unable,
        milestones_due=milestones_due, milestones_overdue=milestones_overdue, milestones_completed=milestones_completed,
    )
    # ensure report status row exists
    rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
    rs.ensure_defaults()
    return row

@transaction.atomic
def build_rollups_for_period_bulk(org: Organization, start_day: date, end_day: date) -> int:
    """Build rollups for an org/date range using grouped DB aggregates.

    This is significantly faster than calling build_daily_rollup(...) once per day
    when (re)building large windows like the default 180 days.

    Returns:
      Number of daily rows written.
    """
    if start_day > end_day:
        return 0

    tz = timezone.get_current_timezone()
    start_dt, end_dt = _bounds_for_period(start_day, end_day)

    days: list[date] = []
    d = start_day
    while d <= end_day:
        days.append(d)
        d += timedelta(days=1)

    metrics = {
        "screened": 0,
        "red_flags": 0,
        "applied": 0,
        "forwarded": 0,
        "approved": 0,
        "rejected": 0,
        "enrollments_created": 0,
        "supplies_delivered": 0,
        "compliance_submitted": 0,
        "compliance_compliant": 0,
        "compliance_unable": 0,
        "milestones_due": 0,
        "milestones_overdue": 0,
        "milestones_completed": 0,
    }
    by_day: dict[date, dict] = {day: dict(metrics) for day in days}

    # Screenings
    for r in (
        Screening.objects.filter(organization=org, screened_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("screened_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["screened"] = r["c"]

    for r in (
        Screening.objects.filter(organization=org, risk_level="RED", screened_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("screened_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["red_flags"] = r["c"]

    # Applications
    for r in (
        Application.objects.filter(organization=org, applied_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("applied_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["applied"] = r["c"]

    for r in (
        Application.objects.filter(organization=org, forwarded_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("forwarded_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["forwarded"] = r["c"]

    for r in (
        Application.objects.filter(organization=org, status="APPROVED", sapa_reviewed_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("sapa_reviewed_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["approved"] = r["c"]

    for r in (
        Application.objects.filter(organization=org, status="REJECTED", sapa_reviewed_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("sapa_reviewed_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["rejected"] = r["c"]

    # Enrollments
    for r in (
        Enrollment.objects.filter(organization=org, created_at__range=(start_dt, end_dt))
        .annotate(day=TruncDate("created_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["enrollments_created"] = r["c"]

    # Logistics
    for r in (
        MonthlySupply.objects.filter(
            enrollment__organization=org,
            delivered_on__gte=start_day,
            delivered_on__lte=end_day,
        )
        .values("delivered_on")
        .annotate(c=Count("id"))
    ):
        by_day[r["delivered_on"]]["supplies_delivered"] = r["c"]

    # Compliance
    for r in (
        ComplianceSubmission.objects.filter(
            monthly_supply__enrollment__organization=org,
            submitted_at__range=(start_dt, end_dt),
        )
        .annotate(day=TruncDate("submitted_at", tzinfo=tz))
        .values("day")
        .annotate(
            submitted=Count("id"),
            compliant=Count("id", filter=Q(status="COMPLIANT")),
            unable=Count("id", filter=Q(status="UNABLE")),
        )
    ):
        by_day[r["day"]]["compliance_submitted"] = r["submitted"]
        by_day[r["day"]]["compliance_compliant"] = r["compliant"]
        by_day[r["day"]]["compliance_unable"] = r["unable"]

    # Milestones
    for r in (
        ScreeningMilestone.objects.filter(enrollment__organization=org, due_on__gte=start_day, due_on__lte=end_day)
        .values("due_on")
        .annotate(c=Count("id"))
    ):
        by_day[r["due_on"]]["milestones_due"] = r["c"]

    for r in (
        ScreeningMilestone.objects.filter(
            enrollment__organization=org,
            status="OVERDUE",
            updated_at__range=(start_dt, end_dt),
        )
        .annotate(day=TruncDate("updated_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["milestones_overdue"] = r["c"]

    for r in (
        ScreeningMilestone.objects.filter(
            enrollment__organization=org,
            status="COMPLETED",
            completed_at__range=(start_dt, end_dt),
        )
        .annotate(day=TruncDate("completed_at", tzinfo=tz))
        .values("day")
        .annotate(c=Count("id"))
    ):
        by_day[r["day"]]["milestones_completed"] = r["c"]

    now = timezone.now()
    rows = [
        SchoolStatDaily(
            organization=org,
            day=day,
            created_at=now,
            updated_at=now,
            **by_day[day],
        )
        for day in days
    ]

    SchoolStatDaily.objects.filter(organization=org, day__gte=start_day, day__lte=end_day).delete()
    SchoolStatDaily.objects.bulk_create(rows, batch_size=500)

    rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
    rs.ensure_defaults()

    return len(rows)

def build_rollups_for_day(day: date) -> int:
    n = 0
    for org in Organization.objects.all().iterator():
        build_daily_rollup(org, day)
        n += 1
    return n

def period_summary(org: Organization, start_day: date, end_day: date) -> dict:
    qs = SchoolStatDaily.objects.filter(organization=org, day__gte=start_day, day__lte=end_day)
    agg = {
        "screened": 0, "red_flags": 0,
        "applied": 0, "forwarded": 0, "approved": 0, "rejected": 0,
        "enrollments_created": 0,
        "supplies_delivered": 0,
        "compliance_submitted": 0, "compliance_compliant": 0, "compliance_unable": 0,
        "milestones_due": 0, "milestones_overdue": 0, "milestones_completed": 0,
    }
    for r in qs:
        for k in agg.keys():
            agg[k] += getattr(r, k, 0)
    # convenience metrics
    agg["compliance_rate"] = round((agg["compliance_compliant"] / agg["compliance_submitted"]) * 100, 1) if agg["compliance_submitted"] else 0.0
    agg["red_rate"] = round((agg["red_flags"] / agg["screened"]) * 100, 1) if agg["screened"] else 0.0
    return agg

def six_month_window_ending(day: date):
    start = day - timedelta(days=180)
    return start, day

def ensure_rollups_for_period(
    org: Organization,
    start_day: date,
    end_day: date,
    *,
    rebuild_recent_days: int = 2,
) -> int:
    """Ensure SchoolStatDaily rows exist and are current for a given period."""
    if start_day > end_day:
        return 0

    existing_days = set(
        SchoolStatDaily.objects.filter(
            organization=org,
            day__gte=start_day,
            day__lte=end_day,
        ).values_list("day", flat=True)
    )

    recent = set()
    for i in range(max(0, rebuild_recent_days)):
        recent.add(end_day - timedelta(days=i))

    days_to_build: list[date] = []
    d = start_day
    while d <= end_day:
        if (d not in existing_days) or (d in recent):
            days_to_build.append(d)
        d += timedelta(days=1)

    total_days = (end_day - start_day).days + 1
    if total_days >= 14 and len(days_to_build) >= int(total_days * 0.6):
        build_rollups_for_period_bulk(org, start_day, end_day)
        return total_days

    for day in days_to_build:
        build_daily_rollup(org, day)

    return len(days_to_build)


def ensure_rollups_caught_up(
    org: Organization,
    start_day: date,
    end_day: date,
    *,
    rebuild_recent_days: int = 2,
) -> int:
    """Catch up missing rollups and refresh recent days."""
    if start_day > end_day:
        return 0

    last_day = (
        SchoolStatDaily.objects.filter(organization=org)
        .order_by("-day")
        .values_list("day", flat=True)
        .first()
    )

    if not last_day or last_day < start_day:
        if not last_day:
            has_activity = (
                Screening.objects.filter(organization=org, screened_at__date__range=(start_day, end_day)).exists()
                or Application.objects.filter(organization=org, applied_at__date__range=(start_day, end_day)).exists()
            )
            if not has_activity:
                return 0

        return ensure_rollups_for_period(
            org,
            start_day,
            end_day,
            rebuild_recent_days=rebuild_recent_days,
        )

    if last_day < end_day:
        backfill_start = max(start_day, last_day + timedelta(days=1))
        return ensure_rollups_for_period(
            org,
            backfill_start,
            end_day,
            rebuild_recent_days=rebuild_recent_days,
        )

    refresh_start = max(start_day, end_day - timedelta(days=max(0, rebuild_recent_days - 1)))
    return ensure_rollups_for_period(
        org,
        refresh_start,
        end_day,
        rebuild_recent_days=rebuild_recent_days,
    )

================================================================================
FILE: reporting\signals.py
================================================================================

"""Reporting rollup signals.

The Inditech and school dashboards read from reporting.models.SchoolStatDaily.
Historically these rollups were only generated via a management command or a
nightly Celery beat job, which meant dashboards could show all zeros unless a
backfill was run.

These signals keep daily rollups current by rebuilding the relevant day whenever
source data changes.
"""

from __future__ import annotations

from datetime import date

from django.db import transaction
from django.db.models.signals import post_delete, post_save, pre_save
from django.dispatch import receiver
from django.utils import timezone

from assist.models import Application
from program.models import ComplianceSubmission, Enrollment, MonthlySupply, ScreeningMilestone
from screening.models import Screening

from .services import build_daily_rollup


def _local_day(dt) -> date | None:
    if not dt:
        return None
    try:
        return timezone.localtime(dt).date()
    except Exception:
        return dt.date()


def _queue_rebuild(org, day: date | None):
    if not org or not day:
        return
    transaction.on_commit(lambda: build_daily_rollup(org, day))


# ---------------------------------------------------------------------------
# Screening
# ---------------------------------------------------------------------------

@receiver(pre_save, sender=Screening)
def _screening_capture_previous(sender, instance: Screening, **kwargs):
    if not instance.pk:
        return
    try:
        prev = Screening.objects.get(pk=instance.pk)
    except Screening.DoesNotExist:
        return
    instance._prev_screened_at = prev.screened_at
    instance._prev_org_id = prev.organization_id


@receiver(post_save, sender=Screening)
@receiver(post_delete, sender=Screening)
def _screening_refresh_rollup(sender, instance: Screening, **kwargs):
    _queue_rebuild(instance.organization, _local_day(getattr(instance, "screened_at", None)))

    prev_dt = getattr(instance, "_prev_screened_at", None)
    prev_org_id = getattr(instance, "_prev_org_id", None)
    if prev_dt and prev_org_id and prev_org_id != instance.organization_id:
        from accounts.models import Organization
        try:
            prev_org = Organization.objects.get(pk=prev_org_id)
        except Organization.DoesNotExist:
            prev_org = None
        _queue_rebuild(prev_org, _local_day(prev_dt))
    elif prev_dt:
        _queue_rebuild(instance.organization, _local_day(prev_dt))


# ---------------------------------------------------------------------------
# Applications (supplement requests)
# ---------------------------------------------------------------------------

@receiver(pre_save, sender=Application)
def _application_capture_previous(sender, instance: Application, **kwargs):
    if not instance.pk:
        return
    try:
        prev = Application.objects.get(pk=instance.pk)
    except Application.DoesNotExist:
        return
    instance._prev_applied_at = prev.applied_at
    instance._prev_forwarded_at = prev.forwarded_at
    instance._prev_reviewed_at = prev.sapa_reviewed_at
    instance._prev_org_id = prev.organization_id


@receiver(post_save, sender=Application)
@receiver(post_delete, sender=Application)
def _application_refresh_rollup(sender, instance: Application, **kwargs):
    from accounts.models import Organization

    orgs: list[Organization] = []
    if getattr(instance, "organization_id", None):
        orgs.append(instance.organization)
    prev_org_id = getattr(instance, "_prev_org_id", None)
    if prev_org_id and prev_org_id != instance.organization_id:
        try:
            orgs.append(Organization.objects.get(pk=prev_org_id))
        except Organization.DoesNotExist:
            pass

    days: set[date] = set()
    for dt in (
        getattr(instance, "applied_at", None),
        getattr(instance, "forwarded_at", None),
        getattr(instance, "sapa_reviewed_at", None),
        getattr(instance, "_prev_applied_at", None),
        getattr(instance, "_prev_forwarded_at", None),
        getattr(instance, "_prev_reviewed_at", None),
    ):
        d = _local_day(dt)
        if d:
            days.add(d)

    for org in orgs:
        for day in days:
            _queue_rebuild(org, day)


# ---------------------------------------------------------------------------
# Program logistics / compliance
# ---------------------------------------------------------------------------

@receiver(pre_save, sender=Enrollment)
def _enrollment_capture_previous(sender, instance: Enrollment, **kwargs):
    if not instance.pk:
        return
    try:
        prev = Enrollment.objects.get(pk=instance.pk)
    except Enrollment.DoesNotExist:
        return
    instance._prev_created_at = prev.created_at


@receiver(post_save, sender=Enrollment)
@receiver(post_delete, sender=Enrollment)
def _enrollment_refresh_rollup(sender, instance: Enrollment, **kwargs):
    _queue_rebuild(instance.organization, _local_day(getattr(instance, "created_at", None)))
    prev_dt = getattr(instance, "_prev_created_at", None)
    if prev_dt:
        _queue_rebuild(instance.organization, _local_day(prev_dt))


@receiver(pre_save, sender=MonthlySupply)
def _monthly_supply_capture_previous(sender, instance: MonthlySupply, **kwargs):
    if not instance.pk:
        return
    try:
        prev = MonthlySupply.objects.get(pk=instance.pk)
    except MonthlySupply.DoesNotExist:
        return
    instance._prev_delivered_on = prev.delivered_on


@receiver(post_save, sender=MonthlySupply)
@receiver(post_delete, sender=MonthlySupply)
def _monthly_supply_refresh_rollup(sender, instance: MonthlySupply, **kwargs):
    org = instance.enrollment.organization if getattr(instance, "enrollment_id", None) else None
    _queue_rebuild(org, getattr(instance, "delivered_on", None))
    prev_day = getattr(instance, "_prev_delivered_on", None)
    if prev_day:
        _queue_rebuild(org, prev_day)


@receiver(pre_save, sender=ComplianceSubmission)
def _compliance_capture_previous(sender, instance: ComplianceSubmission, **kwargs):
    if not instance.pk:
        return
    try:
        prev = ComplianceSubmission.objects.get(pk=instance.pk)
    except ComplianceSubmission.DoesNotExist:
        return
    instance._prev_submitted_at = prev.submitted_at


@receiver(post_save, sender=ComplianceSubmission)
@receiver(post_delete, sender=ComplianceSubmission)
def _compliance_refresh_rollup(sender, instance: ComplianceSubmission, **kwargs):
    org = None
    if getattr(instance, "monthly_supply_id", None):
        try:
            org = instance.monthly_supply.enrollment.organization
        except Exception:
            org = None

    _queue_rebuild(org, _local_day(getattr(instance, "submitted_at", None)))
    prev_dt = getattr(instance, "_prev_submitted_at", None)
    if prev_dt:
        _queue_rebuild(org, _local_day(prev_dt))


@receiver(pre_save, sender=ScreeningMilestone)
def _milestone_capture_previous(sender, instance: ScreeningMilestone, **kwargs):
    if not instance.pk:
        return
    try:
        prev = ScreeningMilestone.objects.get(pk=instance.pk)
    except ScreeningMilestone.DoesNotExist:
        return
    instance._prev_due_on = prev.due_on
    instance._prev_updated_at = prev.updated_at
    instance._prev_completed_at = getattr(prev, "completed_at", None)


@receiver(post_save, sender=ScreeningMilestone)
@receiver(post_delete, sender=ScreeningMilestone)
def _milestone_refresh_rollup(sender, instance: ScreeningMilestone, **kwargs):
    org = instance.enrollment.organization if getattr(instance, "enrollment_id", None) else None

    days: set[date] = set()
    for d in (getattr(instance, "due_on", None), getattr(instance, "_prev_due_on", None)):
        if d:
            days.add(d)

    for dt in (
        getattr(instance, "updated_at", None),
        getattr(instance, "completed_at", None),
        getattr(instance, "_prev_updated_at", None),
        getattr(instance, "_prev_completed_at", None),
    ):
        d = _local_day(dt)
        if d:
            days.add(d)

    for day in days:
        _queue_rebuild(org, day)

================================================================================
FILE: reporting\tasks.py
================================================================================

from __future__ import annotations
import csv, io, os
from datetime import timedelta
from celery import shared_task
from django.core.mail import EmailMessage
from django.utils import timezone
from accounts.models import Organization
from .models import SchoolReportStatus
from .services import build_rollups_for_day, period_summary, six_month_window_ending

@shared_task
def build_daily_rollups():
    # roll up "yesterday" so the day is complete
    day = (timezone.now() - timedelta(days=1)).date()
    build_rollups_for_day(day)

def _make_school_performance_csv(org: Organization, start_day, end_day) -> bytes:
    agg = period_summary(org, start_day, end_day)
    buff = io.StringIO()
    w = csv.writer(buff)
    # Header
    w.writerow(["School", org.name])
    w.writerow(["Period", f"{start_day} to {end_day}"])
    w.writerow([])
    # Summary KPIs
    w.writerow(["Metric","Value"])
    for k in ["screened","red_flags","applied","forwarded","approved","rejected",
              "enrollments_created","supplies_delivered",
              "compliance_submitted","compliance_compliant","compliance_unable",
              "milestones_due","milestones_overdue","milestones_completed",
              "red_rate","compliance_rate"]:
        w.writerow([k, agg.get(k, 0)])
    return buff.getvalue().encode("utf-8")

@shared_task
def send_due_school_reports():

    today = timezone.now().date()
    to_recipients = [e.strip() for e in (os.getenv("ESAPA_REPORT_TO","").split(",")) if e.strip()]
    if not to_recipients:
        return 0

    sent = 0
    for org in Organization.objects.all().iterator():
        rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
        rs.ensure_defaults()
        if rs.next_due_on and rs.next_due_on <= today:
            start, end = six_month_window_ending(today)
            csv_bytes = _make_school_performance_csv(org, start, end)
            filename = f"{org.name.replace(' ','_')}_performance_{start}_{end}.csv"
            email = EmailMessage(
                subject=f"Nutrilift – {org.name} six‑month performance report",
                body=(f"Attached is the performance report for {org.name} covering {start} to {end}.\n"
                      f"This export was generated automatically by the system."),
                to=to_recipients,
            )
            email.attach(filename, csv_bytes, "text/csv")
            email.send(fail_silently=True)

            rs.last_sent_at = timezone.now()
            rs.last_period_start = start
            rs.last_period_end = end
            rs.next_due_on = today + timedelta(days=180)
            rs.save(update_fields=["last_sent_at","last_period_start","last_period_end","next_due_on","updated_at"])
            sent += 1
    return sent

================================================================================
FILE: reporting\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: reporting\urls.py
================================================================================

from django.urls import path
from .views import (
    school_dashboard, export_school_csv,
    inditech_dashboard, inditech_school, inditech_export_school_csv,inditech_school_applications,
)
from . import views

app_name = "reporting"

urlpatterns = [
    path("reporting/school", school_dashboard, name="school_dashboard"),
    path("reporting/school/export.csv", export_school_csv, name="export_school_csv"),

    path("reporting/inditech", inditech_dashboard, name="inditech_dashboard"),
    path("reporting/inditech/school/<int:org_id>", inditech_school, name="inditech_school"),
    path("reporting/inditech/school/<int:org_id>/export.csv", inditech_export_school_csv, name="inditech_export_school_csv"),
    path("inditech/", views.inditech_console, name="inditech_console"),
    path(
    "reporting/inditech/school/<int:org_id>/applications/<str:bucket>",
    inditech_school_applications,
    name="inditech_school_applications",
),
]

================================================================================
FILE: reporting\views.py
================================================================================

from __future__ import annotations
import csv, io
from datetime import timedelta, date
from django.http import HttpResponse, HttpResponseForbidden
from django.shortcuts import render, get_object_or_404
from django.utils import timezone
from accounts.decorators import require_roles
from accounts.models import Role, Organization
from .models import SchoolStatDaily, SchoolReportStatus
from .services import period_summary, six_month_window_ending
from django.contrib.auth.decorators import login_required
from .services import period_summary, ensure_rollups_caught_up
from assist.models import Application

def _six_months():
    end = timezone.now().date()
    start = end - timedelta(days=180)
    return start, end

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def school_dashboard(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    start, end = _six_months()
    agg = period_summary(org, start, end)
    # trend: last 30 days screened
    last30 = end - timedelta(days=29)
    trend = (SchoolStatDaily.objects
             .filter(organization=org, day__gte=last30, day__lte=end)
             .order_by("day"))

    rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
    ctx = {"org": org, "start": start, "end": end, "agg": agg, "trend": trend, "report_status": rs}
    return render(request, "reporting/school_dashboard.html", ctx)

@require_roles(Role.ORG_ADMIN, allow_superuser=True)
def export_school_csv(request):
    org = request.org
    if not org:
        return HttpResponseForbidden("Organization context required.")
    # allow custom range; default 6 months
    def _parse(d):
        try: return date.fromisoformat(d)
        except Exception: return None
    start = _parse(request.GET.get("start")) or (timezone.now().date() - timedelta(days=180))
    end = _parse(request.GET.get("end")) or timezone.now().date()

    agg = period_summary(org, start, end)
    buff = io.StringIO()
    w = csv.writer(buff)
    w.writerow(["School", org.name])
    w.writerow(["Period", f"{start} to {end}"])
    w.writerow([])
    w.writerow(["Metric","Value"])
    for k,v in agg.items():
        w.writerow([k, v])
    resp = HttpResponse(buff.getvalue(), content_type="text/csv")
    resp["Content-Disposition"] = f'attachment; filename="{org.name.replace(" ","_")}_{start}_{end}_summary.csv"'
    return resp

@require_roles(Role.INDITECH, allow_superuser=True)
def inditech_dashboard(request):
    # summary across all schools for the last 6 months + next_due_on
    start, end = _six_months()
    rows = []
    for org in Organization.objects.filter(
        org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO]
    ).order_by("name"):
        agg = period_summary(org, start, end)
        rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
        rows.append({
            "org": org,
            "agg": agg,
            "next_due_on": rs.next_due_on,
            "last_sent_at": rs.last_sent_at,
        })
    return render(request, "reporting/inditech_dashboard.html", {"rows": rows, "start": start, "end": end})

@require_roles(Role.INDITECH, allow_superuser=True)
def inditech_school(request, org_id: int):
    org = get_object_or_404(
        Organization,
        pk=org_id,
        org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO],
    )

    start, end = _six_months()
    agg = period_summary(org, start, end)
    rs, _ = SchoolReportStatus.objects.get_or_create(organization=org)
    # trend
    last30 = end - timedelta(days=29)
    trend = (SchoolStatDaily.objects
             .filter(organization=org, day__gte=last30, day__lte=end)
             .order_by("day"))
    return render(request, "reporting/inditech_school.html", {"org": org, "agg": agg, "trend": trend, "start": start, "end": end, "report_status": rs})

@require_roles(Role.INDITECH, allow_superuser=True)
def inditech_export_school_csv(request, org_id: int):
    org = get_object_or_404(
        Organization,
        pk=org_id,
        org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO],
    )

    start, end = _six_months()
    agg = period_summary(org, start, end)
    buff = io.StringIO()
    w = csv.writer(buff)
    w.writerow(["School", org.name])
    w.writerow(["Period", f"{start} to {end}"])
    w.writerow([])
    w.writerow(["Metric","Value"])
    for k,v in agg.items():
        w.writerow([k, v])
    resp = HttpResponse(buff.getvalue(), content_type="text/csv")
    resp["Content-Disposition"] = f'attachment; filename="{org.name.replace(" ","_")}_{start}_{end}_summary.csv"'
    return resp

@login_required
def inditech_console(request):
    # Teachers are regular users; only staff should see this console.
    if not request.user.is_staff:
        return HttpResponseForbidden("Forbidden")
    return HttpResponse("Inditech Console")  # simple 200 for staff

@require_roles(Role.INDITECH, allow_superuser=True)
def inditech_school_applications(request, org_id: int, bucket: str):
    """List supplement requests (assist.Application) for a school.

    Buckets:
      * pending  -> APPLIED + FORWARDED
      * approved -> APPROVED
      * rejected -> REJECTED
    """
    org = get_object_or_404(
        Organization,
        pk=org_id,
        org_type__in=[Organization.OrgType.SCHOOL, Organization.OrgType.NGO],
    )

    bucket = (bucket or "").strip().lower()
    if bucket == "pending":
        statuses = [Application.Status.APPLIED, Application.Status.FORWARDED]
        heading = "Pending applications"
    elif bucket == "approved":
        statuses = [Application.Status.APPROVED]
        heading = "Approved applications"
    elif bucket == "rejected":
        statuses = [Application.Status.REJECTED]
        heading = "Rejected applications"
    else:
        return HttpResponseForbidden("Invalid application bucket")

    apps = (
        Application.objects.filter(organization=org, status__in=statuses)
        .select_related("organization", "student", "guardian")
        .order_by("-applied_at")
    )

    return render(
        request,
        "reporting/inditech_school_applications.html",
        {
            "org": org,
            "bucket": bucket,
            "heading": heading,
            "applications": apps,
        },
    )

================================================================================
FILE: reporting\__init__.py
================================================================================


================================================================================
FILE: reporting\management\commands\backfill_rollups.py
================================================================================

from datetime import date, timedelta
from django.core.management.base import BaseCommand
from django.utils import timezone
from reporting.services import build_rollups_for_day

class Command(BaseCommand):
    help = "Build daily rollups for a date range (default last 180 days)."

    def add_arguments(self, parser):
        parser.add_argument("--start", type=str, help="YYYY-MM-DD")
        parser.add_argument("--end", type=str, help="YYYY-MM-DD")

    def handle(self, *args, **opts):
        def _parse(s):
            try: return date.fromisoformat(s) if s else None
            except Exception: return None

        end = _parse(opts.get("end")) or timezone.now().date()
        start = _parse(opts.get("start")) or (end - timedelta(days=180))

        d = start
        n = 0
        while d <= end:
            build_rollups_for_day(d)
            self.stdout.write(f"Rolled up {d}")
            d += timedelta(days=1); n += 1
        self.stdout.write(self.style.SUCCESS(f"Completed {n} days."))

================================================================================
FILE: reporting\templates\reporting\inditech_dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Inditech – Schools Overview</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.5rem;border-bottom:1px solid #eee;text-align:left}
    .btn{border:1px solid #d1d5db;border-radius:8px;padding:.35rem .6rem;text-decoration:none}
  </style>
</head>
<body>
  <h2>Inditech – Registered Schools ({{ start }} → {{ end }})</h2>
  <div class="toolbar">
    <a class="btn" href="{% url 'fulfillment:dashboard' %}">Go to Fulfillment Dashboard</a>
  </div>
  <table>
    <thead><tr>
      <th>School</th><th>Screened</th><th>Red</th><th>Approved</th>
      <th>Compliance %</th><th>Next Report Due</th><th>Last Sent</th><th>Actions</th>
    </tr></thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td><a href="{% url 'reporting:inditech_school' row.org.id %}">{{ row.org.name }}</a></td>
        <td>{{ row.agg.screened }}</td>
        <td>{{ row.agg.red_flags }}</td>
        <td>{{ row.agg.approved }}</td>
        <td>{{ row.agg.compliance_rate }}%</td>
        <td>{{ row.next_due_on|default:"—" }}</td>
        <td>{{ row.last_sent_at|date:"Y-m-d H:i"|default:"—" }}</td>
        <td><a class="btn" href="{% url 'reporting:inditech_export_school_csv' row.org.id %}">Download CSV</a></td>
      </tr>
      
      
      {% empty %}
      <tr><td colspan="8">No schools</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: reporting\templates\reporting\inditech_school.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Inditech – {{ org.name }}</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem}
    .tile{border:1px solid #e5e7eb;border-radius:8px;padding:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.4rem;border-bottom:1px solid #eee;text-align:left}
    .btn{border:1px solid #d1d5db;border-radius:8px;padding:.4rem .7rem;text-decoration:none}
  </style>
</head>
<body>
  <h2>{{ org.name }} – Screening Performance</h2>
  <p>Period: {{ start }} → {{ end }} | Next due: {{ report_status.next_due_on|default:"—" }} | Last sent: {{ report_status.last_sent_at|date:"Y-m-d H:i"|default:"—" }}</p>

  <div class="grid">
    <div class="tile"><strong>Screened</strong><div>{{ agg.screened }}</div></div>
    <div class="tile"><strong>Red flags</strong><div>{{ agg.red_flags }} ({{ agg.red_rate }}%)</div></div>
    <div class="tile"><strong>Approved</strong><div>{{ agg.approved }}</div></div>
    <div class="tile"><strong>Compliance</strong><div>{{ agg.compliance_rate }}%</div></div>
    <div class="tile"><strong>Delivered</strong><div>{{ agg.supplies_delivered }}</div></div>
    <div class="tile"><strong>Milestones overdue</strong><div>{{ agg.milestones_overdue }}</div></div>
  </div>

  <p style="margin-top:1rem">
    <a class="btn" href="{% url 'reporting:inditech_export_school_csv' org.id %}">Download performance report (CSV)</a>
  </p>
  <h3>Supplement requests (Applications)</h3>
  <p>
    <a class="btn" href="{% url 'reporting:inditech_school_applications' org.id 'pending' %}">Pending applications</a>
    <a class="btn" href="{% url 'reporting:inditech_school_applications' org.id 'approved' %}">Approved applications</a>
    <a class="btn" href="{% url 'reporting:inditech_school_applications' org.id 'rejected' %}">Rejected applications</a>
  </p>

  <h3>30‑day Screenings Trend</h3>
  <table>
    <thead><tr><th>Date</th><th>Screened</th><th>Red flags</th></tr></thead>
    <tbody>
      {% for r in trend %}
        <tr><td>{{ r.day }}</td><td>{{ r.screened }}</td><td>{{ r.red_flags }}</td></tr>
      {% empty %}
        <tr><td colspan="3">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: reporting\templates\reporting\inditech_school_applications.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ org.name }} – {{ heading }}</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.5rem;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    .btn{border:1px solid #d1d5db;border-radius:8px;padding:.35rem .6rem;text-decoration:none;display:inline-block}
    .btn.active{background:#f3f4f6}
    .muted{color:#6b7280}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.75rem 0}
  </style>
</head>
<body>
  <h2>{{ org.name }} – {{ heading }}</h2>
  <p class="muted">
    <a class="btn" href="{% url 'reporting:inditech_school' org.id %}">← Back to school performance</a>
  </p>

  <div class="toolbar">
    <a class="btn {% if bucket == 'pending' %}active{% endif %}" href="{% url 'reporting:inditech_school_applications' org.id 'pending' %}">Pending applications</a>
    <a class="btn {% if bucket == 'approved' %}active{% endif %}" href="{% url 'reporting:inditech_school_applications' org.id 'approved' %}">Approved applications</a>
    <a class="btn {% if bucket == 'rejected' %}active{% endif %}" href="{% url 'reporting:inditech_school_applications' org.id 'rejected' %}">Rejected applications</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Organization</th>
        <th>Student</th>
        <th>Guardian</th>
        <th>Status</th>
        <th>Source</th>
        <th>Applied at</th>
        <th>Forwarded at</th>
      </tr>
    </thead>
    <tbody>
      {% for a in applications %}
      <tr>
        <td>
          {% if request.user.is_staff %}
            <a href="{% url 'admin:assist_application_change' a.id %}">{{ a.id }}</a>
          {% else %}
            {{ a.id }}
          {% endif %}
        </td>
        <td>{{ a.organization.name }}</td>
        <td>{{ a.student.full_name }}</td>
        <td>{{ a.guardian.full_name|default:"—" }}</td>
        <td>{{ a.get_status_display }}</td>
        <td>{{ a.get_source_display }}</td>
        <td>{{ a.applied_at|date:"Y-m-d H:i" }}</td>
        <td>{{ a.forwarded_at|date:"Y-m-d H:i"|default:"—" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8">No applications found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: reporting\templates\reporting\school_dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ org.name }} – Dashboard</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem}
    .tile{border:1px solid #e5e7eb;border-radius:8px;padding:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.4rem;border-bottom:1px solid #eee;text-align:left}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid #d1d5db;border-radius:8px;padding:.5rem .8rem;text-decoration:none}
  </style>
</head>
<body>
  <h2>{{ org.name }} – Dashboard</h2>
  <p>Period: {{ start }} → {{ end }}</p>

  <div class="grid">
    <div class="tile"><strong>Screened</strong><div>{{ agg.screened }}</div></div>
    <div class="tile"><strong>Red flags</strong><div>{{ agg.red_flags }} ({{ agg.red_rate }}%)</div></div>
    <div class="tile"><strong>Approved</strong><div>{{ agg.approved }}</div></div>
    <div class="tile"><strong>Supplies delivered</strong><div>{{ agg.supplies_delivered }}</div></div>
    <div class="tile"><strong>Compliance submitted</strong><div>{{ agg.compliance_submitted }}</div></div>
    <div class="tile"><strong>Compliance rate</strong><div>{{ agg.compliance_rate }}%</div></div>
    <div class="tile"><strong>Milestones overdue</strong><div>{{ agg.milestones_overdue }}</div></div>
    <div class="tile"><strong>Enrollments</strong><div>{{ agg.enrollments_created }}</div></div>
  </div>

  <div class="row" style="margin-top:1rem">
    <a class="btn" href="{% url 'reporting:export_school_csv' %}?start={{ start }}&end={{ end }}">Download Report (CSV)</a>
    {% if report_status.next_due_on %}
      <div class="tile">Next 6‑month report due: <strong>{{ report_status.next_due_on }}</strong></div>
    {% endif %}
  </div>

  <h3>30‑day Screenings Trend</h3>
  <table>
    <thead><tr><th>Date</th><th>Screened</th><th>Red flags</th></tr></thead>
    <tbody>
      {% for r in trend %}
        <tr><td>{{ r.day }}</td><td>{{ r.screened }}</td><td>{{ r.red_flags }}</td></tr>
      {% empty %}
        <tr><td colspan="3">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: roster\admin.py
================================================================================

from django.contrib import admin
from .models import Classroom, Guardian, Student, StudentGuardian

@admin.register(Classroom)
class ClassroomAdmin(admin.ModelAdmin):
    list_display = ("organization", "grade", "division", "created_at")
    list_filter = ("organization", "grade")
    search_fields = ("organization__name", "grade", "division")

@admin.register(Guardian)
class GuardianAdmin(admin.ModelAdmin):
    list_display = ("organization", "full_name", "phone_e164", "whatsapp_opt_in")
    list_filter = ("organization", "whatsapp_opt_in")
    search_fields = ("full_name", "phone_e164")

@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = ("organization", "full_name", "gender", "classroom", "is_low_income")
    list_filter = ("organization", "gender", "classroom", "is_low_income")
    search_fields = ("first_name", "last_name", "student_code", "primary_guardian__phone_e164")

@admin.register(StudentGuardian)
class StudentGuardianAdmin(admin.ModelAdmin):
    list_display = ("student", "guardian", "relationship", "created_at")
    search_fields = ("student__first_name", "guardian__full_name")

================================================================================
FILE: roster\apps.py
================================================================================

from django.apps import AppConfig


class RosterConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'roster'
    def ready(self):
        # Register signal handlers that seed default classrooms for new schools.
        from . import signals  # noqa: F401

================================================================================
FILE: roster\models.py
================================================================================

from django.db import models
from django.utils import timezone
from accounts.models import Organization

class TimeStampedModel(models.Model):
    created_at = models.DateTimeField(default=timezone.now, db_index=True)
    updated_at = models.DateTimeField(auto_now=True)
    class Meta:
        abstract = True

class Classroom(TimeStampedModel):
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="classrooms")
    grade = models.CharField(max_length=64)
    division = models.CharField(max_length=64, blank=True)

    class Meta:
        unique_together = (("organization", "grade", "division"),)
        indexes = [models.Index(fields=["organization", "grade", "division"])]

    def __str__(self):
        return f"{self.grade}{('-' + self.division) if self.division else ''}"

class Guardian(TimeStampedModel):
    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="guardians")
    pid = models.CharField(max_length=64, null=True, blank=True, db_index=True)
    full_name = models.CharField(max_length=255, null=True, blank=True, editable=False)
    phone_e164 = models.CharField(max_length=20, null=True, blank=True, editable=False)
    whatsapp_opt_in = models.BooleanField(default=True)
    preferred_language = models.CharField(max_length=8, default="en")

    class Meta:
        unique_together = (
            ("organization", "phone_e164"),  # legacy (phone will be NULL going forward)
            ("organization", "pid"),         # new linkage
        )
        indexes = [
            models.Index(fields=["organization", "pid"]),
            models.Index(fields=["organization", "full_name"]),
            models.Index(fields=["organization", "phone_e164"]),
        ]

    def __str__(self):
        if self.full_name:
            return self.full_name
        if self.pid:
            return f"Guardian {self.pid[:8]}"
        return f"Guardian {self.pk}"

class Student(TimeStampedModel):
    class Gender(models.TextChoices):
        MALE = "M", "Male"
        FEMALE = "F", "Female"
        OTHER = "O", "Other"

    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="students")
    classroom = models.ForeignKey(Classroom, on_delete=models.SET_NULL, null=True, blank=True, related_name="students")
    pid = models.CharField(max_length=64, null=True, blank=True, db_index=True)
    first_name = models.CharField(max_length=128, null=True, blank=True, editable=False)
    last_name  = models.CharField(max_length=128, null=True, blank=True, editable=False)
    gender = models.CharField(max_length=1, choices=Gender.choices)
    dob = models.DateField(null=True, blank=True)
    student_code = models.CharField(max_length=64, blank=True)  # optional school id
    is_low_income = models.BooleanField(default=False)
    primary_guardian = models.ForeignKey("Guardian", on_delete=models.SET_NULL, null=True, blank=True, related_name="+")
    notes = models.TextField(blank=True)

    class Meta:
        unique_together = (
            ("organization", "classroom", "student_code"),
            ("organization", "pid"),
        )
        indexes = [
            models.Index(fields=["organization", "pid"]),
            models.Index(fields=["organization", "last_name", "first_name"]),
        ]

    @property
    def full_name(self) -> str:
        # Backwards-compatible display string WITHOUT storing real PII.
        if self.first_name or self.last_name:
            return f"{self.first_name or ''} {self.last_name or ''}".strip()
        if self.student_code:
            return f"Student {self.student_code}"
        if self.pid:
            return f"Student {self.pid[:8]}"
        return "Student"


class StudentGuardian(TimeStampedModel):
    class Relationship(models.TextChoices):
        MOTHER = "MOTHER", "Mother"
        FATHER = "FATHER", "Father"
        GUARDIAN = "GUARDIAN", "Guardian"

    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name="guardian_links")
    guardian = models.ForeignKey(Guardian, on_delete=models.CASCADE, related_name="student_links")
    relationship = models.CharField(max_length=16, choices=Relationship.choices, default=Relationship.GUARDIAN)

    class Meta:
        unique_together = (("student", "guardian"),)

================================================================================
FILE: roster\pid.py
================================================================================

import base64
import hashlib
import hmac
import re
from django.conf import settings

_WS_RE = re.compile(r"\s+")

def _normalize_first_name(first_name: str) -> str:
    """
    Normalize the student name input into the canonical 'first name' used for PID:
    - lowercased
    - trimmed
    - collapse whitespace
    - take FIRST token only (guards against someone typing full name)
    """
    s = (first_name or "").strip().lower()
    s = _WS_RE.sub(" ", s)
    if not s:
        return ""
    return s.split(" ")[0]

def _normalize_phone(phone_e164: str) -> str:
    """
    phone is expected to already be normalized to E.164 by the form.
    """
    return (phone_e164 or "").strip()

def compute_pid(*, first_name: str, phone_e164: str) -> str:
    """
    Deterministic PID = base32(HMAC_SHA256(PID_HMAC_KEY, "<first>|<phone>")) truncated.
    - Non-reversible (unless key is compromised AND attacker brute-forces inputs)
    - Alphanumeric (A-Z + 2-7), no punctuation
    """
    fn = _normalize_first_name(first_name)
    ph = _normalize_phone(phone_e164)

    if not fn or not ph:
        raise ValueError("first_name and phone_e164 are required to compute PID")

    key = (getattr(settings, "PID_HMAC_KEY", "") or "").encode("utf-8")
    if not key:
        raise RuntimeError("settings.PID_HMAC_KEY is not set")

    msg = f"{fn}|{ph}".encode("utf-8")
    digest = hmac.new(key, msg, hashlib.sha256).digest()

    # base32 => [A-Z2-7], strip padding, take 26 chars (~130 bits)
    pid = base64.b32encode(digest).decode("ascii").rstrip("=")
    return pid[:26]

================================================================================
FILE: roster\services.py
================================================================================

"""Roster domain services.

Current use:
  - Seed default Classroom rows for new SCHOOL organizations so teachers can
    immediately select Grade/Division in the "Add student" flow.
"""

from __future__ import annotations

from django.db import transaction

from accounts.models import Organization
from .models import Classroom


def _grades_nursery_to_12() -> list[str]:
    return ["Nursery", "K.G."] + [str(i) for i in range(1, 13)]


def _sections_a_to_z() -> list[str]:
    return [chr(c) for c in range(ord("A"), ord("Z") + 1)]


@transaction.atomic
def ensure_default_classrooms_for_school(org: Organization) -> int:
    """Ensure default classroom (grade/division) rows exist for a SCHOOL org.

    Creates:
      - Grades: Nursery, K.G., 1..12, Other
      - Sections: A..Z, Other (for each grade)
      - For the "Other" grade, we only create section "Other" to avoid
        meaningless combinations like "Other-A".

    Idempotent: safe to call multiple times.

    Returns:
      Number of Classroom objects attempted to be created.
    """
    if not org or org.org_type != Organization.OrgType.SCHOOL:
        return 0

    grades: list[str] = _grades_nursery_to_12() + ["Other"]
    sections: list[str] = _sections_a_to_z() + ["Other"]

    rows: list[Classroom] = []
    for grade in grades:
        if grade == "Other":
            # Keep "Other" as a valid fallback, but avoid generating 26 extra
            # combinations that have no real meaning.
            rows.append(Classroom(organization=org, grade="Other", division="Other"))
            continue

        for section in sections:
            rows.append(Classroom(organization=org, grade=grade, division=section))

    # INSERT IGNORE (MySQL) / ON CONFLICT DO NOTHING (Postgres) behavior.
    Classroom.objects.bulk_create(rows, ignore_conflicts=True, batch_size=500)
    return len(rows)

================================================================================
FILE: roster\signals.py
================================================================================

"""Roster signals.

Goal:
  When a new SCHOOL organization is created, automatically seed default
  Classroom rows (grades Nursery, K.G., 1..12 + Other; sections A..Z + Other) so that
  teachers can immediately select grade/division in the "Add student" flow.
"""

from __future__ import annotations

from django.db import transaction
from django.db.models.signals import post_save
from django.dispatch import receiver

from accounts.models import Organization
from .services import ensure_default_classrooms_for_school


@receiver(post_save, sender=Organization)
def seed_default_classrooms_on_new_school(sender, instance: Organization, created: bool, **kwargs):
    if kwargs.get("raw"):
        # Skip fixture loading scenarios.
        return

    # Only seed once at creation time and only for SCHOOL orgs.
    if not created:
        return
    if instance.org_type != Organization.OrgType.SCHOOL:
        return

    # If org creation rolls back, we should not leave behind classrooms.
    transaction.on_commit(lambda: ensure_default_classrooms_for_school(instance))

================================================================================
FILE: roster\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: roster\views.py
================================================================================

from django.shortcuts import render

# Create your views here.

================================================================================
FILE: roster\__init__.py
================================================================================


================================================================================
FILE: screening\admin.py
================================================================================

from django.contrib import admin
from .models import Screening

@admin.register(Screening)
class ScreeningAdmin(admin.ModelAdmin):
    list_display = ("student", "organization", "risk_level", "screened_at")
    list_filter = ("organization", "risk_level", "screened_at")
    search_fields = ("student__first_name", "student__last_name")

================================================================================
FILE: screening\apps.py
================================================================================

from django.apps import AppConfig


class ScreeningConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'screening'

================================================================================
FILE: screening\bmi_reference.py
================================================================================

import json
from functools import lru_cache
from pathlib import Path
from typing import Dict, Tuple

_DATA_DIR = Path(__file__).resolve().parent / "data"
_BOYS_FILE = _DATA_DIR / "bmi_boys_5_18.json"
_GIRLS_FILE = _DATA_DIR / "bmi_girls_5_18.json"

@lru_cache(maxsize=2)
def _load_table(sex: str) -> Dict[float, Dict[str, float]]:
    sex = (sex or "").upper()
    path = _BOYS_FILE if sex == "M" else _GIRLS_FILE
    raw = json.loads(path.read_text(encoding="utf-8"))
    return {float(k): {"median": float(v["median"]), "sd": float(v["sd"])} for k, v in raw.items()}

def nearest_age_key(age_years: float, sex: str) -> float:
    table = _load_table(sex)
    ages = sorted(table.keys())
    if age_years <= ages[0]:
        return ages[0]
    if age_years >= ages[-1]:
        return ages[-1]
    return min(ages, key=lambda a: abs(a - age_years))

def bmi_to_baz(*, bmi: float, age_years: float, sex: str) -> Tuple[float, float, float, float]:
    """
    BAZ = (BMI - median) / SD
    Returns: (baz, ref_age_used, median, sd)
    """
    ref_age = nearest_age_key(age_years, sex)
    ref = _load_table(sex)[ref_age]
    median = ref["median"]
    sd = ref["sd"]
    if sd <= 0:
        raise ValueError("Invalid SD in BMI reference table")
    baz = (float(bmi) - float(median)) / float(sd)
    return baz, ref_age, median, sd

================================================================================
FILE: screening\decorators.py
================================================================================

from functools import wraps
from django.http import HttpResponseForbidden
from django.shortcuts import redirect
from django.urls import reverse

from accounts.models import Role, OrgMembership, Organization


def _is_screening_only_org(org: Organization) -> bool:
    try:
        org.screening_only_profile
        return True
    except Exception:
        return False


def require_teacher_or_public(view_func):
    @wraps(view_func)
    def _wrapped(request, *args, **kwargs):
        # Normal teacher access (authenticated)
        if request.user.is_authenticated:
            mem = getattr(request, "membership", None)
            if mem and mem.role in (Role.TEACHER, Role.ORG_ADMIN):
                return view_func(request, *args, **kwargs)

        # Legacy public teacher-session access (DISABLED for Screening-only orgs)
        org_id = request.session.get("public_teacher_org_id")
        if org_id:
            org = Organization.objects.filter(id=org_id).first()
            if org:
                if _is_screening_only_org(org):
                    # Force new Screening Program teacher auth flow
                    return redirect(reverse("screening_only:teacher_access_portal", args=[org.screening_link_token]))

                request.org = org
                request.membership = (
                    OrgMembership.objects.filter(user=request.user, organization=org, is_active=True).first()
                    if request.user.is_authenticated
                    else None
                )
                return view_func(request, *args, **kwargs)

        return HttpResponseForbidden("Teacher login required.")
    return _wrapped

================================================================================
FILE: screening\export.py
================================================================================

import csv
from datetime import timedelta
from django.http import HttpResponse
from django.utils import timezone
from accounts.decorators import require_roles
from accounts.models import Role
from .models import Screening
from audit.utils import audit_log

@require_roles(Role.ORG_ADMIN, Role.INDITECH, allow_superuser=True)
def export_screenings_csv(request):
    org = getattr(request, "org", None)
    if not org:
        return HttpResponse("Organization context required", status=403)

    # Last 6 months by default (matches dashboard text on p.8)
    since = request.GET.get("since")
    if since:
        try:
            from datetime import datetime
            since = datetime.fromisoformat(since)
        except Exception:
            since = timezone.now() - timedelta(days=180)
    else:
        since = timezone.now() - timedelta(days=180)

    qs = (Screening.objects
          .select_related("student", "student__classroom", "student__primary_guardian")
          .filter(organization=org, screened_at__gte=since)
          .order_by("-screened_at"))
    audit_log(request.user, org, "CSV_EXPORTED", payload={"count": qs.count()})
    
    response = HttpResponse(content_type="text/csv")
    response["Content-Disposition"] = 'attachment; filename="screenings.csv"'
    writer = csv.writer(response)
    writer.writerow([
        "Screened At", "Student Name", "Gender", "Age (years)", "Classroom",
        "Parent Phone", "Height (cm)", "Weight (kg)", "BMI (approx)",
        "Risk", "Red Flags"
    ])
    for s in qs:
        # compute BMI for export only
        bmi = ""
        if s.height_cm and s.weight_kg and float(s.height_cm) > 0:
            h = float(s.height_cm) / 100.0
            bmi = round(float(s.weight_kg) / (h*h), 1)
        guardian_phone = s.student.primary_guardian.phone_e164 if s.student.primary_guardian else ""
        classroom = s.student.classroom or ""
        writer.writerow([
            s.screened_at.strftime("%Y-%m-%d %H:%M"),
            s.student.full_name,
            s.gender,
            s.age_years or "",
            str(classroom),
            guardian_phone,
            s.height_cm or "",
            s.weight_kg or "",
            bmi,
            s.risk_level,
            ";".join(s.red_flags or []),
        ])
    return response

================================================================================
FILE: screening\forms.py
================================================================================

from django import forms
from django.core.exceptions import ValidationError
from django.utils import timezone
import re

from roster.models import Student, Classroom
from .models import Screening

def _normalize_phone_to_e164(raw: str) -> str:
    raw = (raw or "").strip()
    if not raw:
        return ""
    digits = re.sub(r"\D", "", raw)
    if len(digits) == 11 and digits.startswith("0"):
        digits = digits[1:]
    if len(digits) == 12 and digits.startswith("91"):
        digits = digits[2:]
    if len(digits) == 10:
        return f"+91{digits}"
    if raw.startswith("+") and re.match(r"^\+\d{8,15}$", raw):
        return raw
    raise ValidationError("Enter a valid 10-digit Indian mobile number.")

def _age_months(dob, as_of_date) -> int:
    if not dob:
        raise ValidationError("Date of birth is required.")
    y = as_of_date.year - dob.year
    m = as_of_date.month - dob.month
    months = y * 12 + m
    if as_of_date.day < dob.day:
        months -= 1
    return max(months, 0)

_BOOL_CHOICES = (("yes", "Yes"), ("no", "No"))
_BOOL_SELECT_CHOICES = (("", "Select"), *_BOOL_CHOICES)

def YesNoSelectField(label: str, *, required: bool = True):
    """Yes/No dropdown.

    Important: includes a blank placeholder so the browser does not auto-select "Yes".
    """
    return forms.TypedChoiceField(
        label=label,
        choices=_BOOL_SELECT_CHOICES,
        coerce=lambda x: _coerce_bool(x),
        required=required,
        widget=forms.Select,
    )
    
def _coerce_bool(v):
    if v in (True, "True", "true", "1", "yes", "YES", "on"):
        return True
    if v in (False, "False", "false", "0", "no", "NO", "off"):
        return False
    return None

def YesNoField(label: str, *, required: bool = True):
    return forms.TypedChoiceField(
        label=label,
        choices=_BOOL_CHOICES,
        coerce=lambda x: _coerce_bool(x),
        required=required,
        widget=forms.RadioSelect,
    )

class NewScreeningForm(forms.ModelForm):
    # SECTION A
    student_name = forms.CharField(label="Student Name", max_length=255, required=True)
    unique_student_id = forms.CharField(label="Unique Student ID", max_length=64, required=True)
    dob = forms.DateField(label="Date of Birth (DOB)", required=True,
                          widget=forms.DateInput(attrs={"type": "date"}))
    sex = forms.ChoiceField(
        label="Sex",
        choices=(("", "Select sex"), ("M", "Male"), ("F", "Female")),
        required=True,
    )

    parent_phone_e164 = forms.CharField(label="Parent WhatsApp No.", required=True)

        # SECTION B
    # NOTE: Only ONE reading each is required (as per field feedback).
    weight_kg_r1 = forms.DecimalField(label="Weight (kg)", max_digits=5, decimal_places=2)
    height_cm_r1 = forms.DecimalField(label="Height (cm)", max_digits=5, decimal_places=2)
    _MUAC_TAPE_CHOICES = (("RED", "Red"), ("YELLOW", "Yellow"), ("GREEN", "Green"))
    muac_tape_color = forms.ChoiceField(
        label="MUAC (tape color)",
        choices=_MUAC_TAPE_CHOICES,
        widget=forms.RadioSelect,
        required=False,
    )


    # SECTION C
    health_general_poor = forms.BooleanField(label="General health is poor", required=False)
    health_pallor = forms.BooleanField(label="Pallor (pale inside eyelids/palms)", required=False)
    health_fatigue_dizzy_faint = forms.BooleanField(label="Fatigue, dizziness, or fainting", required=False)
    health_breathlessness = forms.BooleanField(label="Breathlessness on exertion", required=False)
    health_frequent_infections = forms.BooleanField(label="Frequent infections (3 or more in last month)", required=False)
    health_chronic_cough_or_diarrhea = forms.BooleanField(label="Chronic cough or chronic diarrhea", required=False)
    health_visible_worms = forms.BooleanField(label="Visible worm passage", required=False)
    health_dental_or_gum_or_ulcers = forms.BooleanField(label="Dental caries, gum bleeding, or mouth ulcers", required=False)
    health_night_vision_difficulty = forms.BooleanField(label="Night vision difficulty (stumbling in dim light)", required=False)
    health_bone_or_joint_pain = forms.BooleanField(label="Bone or joint pains", required=False)

    appetite = YesNoField("Does the child not feel like eating and never feels hungry?")


    # Girls (Age ≥10 only)
    menarche_started = forms.BooleanField(label="Has menarche started?", required=False)

    _MENARCHE_AGE_CHOICES = [("", "Select age"), *[(str(i), str(i)) for i in range(10, 19)]]
    menarche_age_years = forms.TypedChoiceField(
        label="Age at 1st period (years)",
        choices=_MENARCHE_AGE_CHOICES,
        required=False,
        coerce=lambda x: int(x) if x else None,
        widget=forms.Select,
    )

    _PADS_PER_DAY_CHOICES = [("", "Select"), *[(str(i), str(i)) for i in range(1, 11)]]
    pads_per_day = forms.TypedChoiceField(
        label="Heavy bleeding – pads/day",
        choices=_PADS_PER_DAY_CHOICES,
        required=False,
        coerce=lambda x: int(x) if x else None,
        widget=forms.Select,
    )

    bleeding_clots = forms.BooleanField(label="Heavy bleeding – passing clots", required=False)
    bleeding_days = forms.IntegerField(
        label="How many days does the bleeding last?",
        required=False,
        min_value=0,
        widget=forms.NumberInput(attrs={'type': 'number', 'min': '0'}),
    )
    _CYCLE_LENGTH_CHOICES = (
        ("", "Select"),
        ("LT_45", "Less than 45 days"),
        ("GT_45", "More than 45 days"),
    )
    cycle_length_days = forms.ChoiceField(
        label="Irregular cycles (>45 days apart)?",
        choices=_CYCLE_LENGTH_CHOICES,
        required=False,
        widget=forms.Select,
    )


    # SECTION D
    diet_type = forms.ChoiceField(
        label="Usual Diet Type",
        choices=(("LACTO_VEG", "Lacto-vegetarian"),
                 ("LACTO_OVO", "Lacto-ovo-vegetarian (eats eggs)"),
                 ("NON_VEG", "Non-vegetarian")),
        widget=forms.RadioSelect,
        required=True,
    )

    breakfast_eaten = YesNoSelectField("Breakfast eaten?")
    lunch_eaten = YesNoSelectField("Lunch eaten at school?")
    green_leafy_veg = YesNoSelectField("Green leafy veg (Palak/Methi/Amaranth)")
    other_vegetables = YesNoSelectField("Other vegetables")
    fruits = YesNoSelectField("Fruits")
    dal_pulses_beans = YesNoSelectField("Dal / Pulses / Beans")
    milk_curd = YesNoSelectField("Milk / Curd")
    egg = YesNoSelectField("Egg")
    fish_chicken_meat = YesNoSelectField("Fish / Chicken / Meat")
    nuts_groundnuts = YesNoSelectField("Nuts / Groundnuts")
    ssb_or_packaged_snacks = YesNoSelectField("SSB (Sugary Drinks) or Packaged Snacks eaten?")

    # SECTION E
    deworming_taken = forms.ChoiceField(
        label="Deworming taken in last 6–12 months?",
        choices=(("yes", "Yes"), ("no", "No"), ("dont_know", "Don't Know")),
        widget=forms.RadioSelect,
        required=True,
    )

    _DEWORMING_MONTHS_CHOICES = [
        ('', 'Select months'),
        *[(str(i), f"{i} month" if i == 1 else f"{i} months") for i in range(1, 13)],
    ]
    deworming_date = forms.TypedChoiceField(
        label="How many months ago?",
        choices=_DEWORMING_MONTHS_CHOICES,
        required=False,
        coerce=lambda x: int(x) if x else None,
        widget=forms.Select,
    )

    # SECTION F
    hunger_vital_sign = forms.ChoiceField(
        label='Do you always get as much food as you want to eat at home?',
        choices=(("OFTEN_TRUE", "Often true"),
                ("SOMETIMES_TRUE", "Sometimes true"),
                ("NEVER_TRUE", "Never true")),
        widget=forms.RadioSelect,
        required=True,
    )

    class Meta:
        model = Screening
        fields = []

    def __init__(self, *args, **kwargs):
        self.student = kwargs.pop("student", None)
        self.org = kwargs.pop("organization", None)
        super().__init__(*args, **kwargs)

        if self.student:
            self.fields["student_name"].initial = self.student.full_name
            self.fields["student_name"].disabled = True

            if getattr(self.student, "student_code", ""):
                self.fields["unique_student_id"].initial = self.student.student_code
            if getattr(self.student, "dob", None):
                self.fields["dob"].initial = self.student.dob
            if getattr(self.student, "gender", None) in {"M", "F"}:
                self.fields["sex"].initial = self.student.gender

            g = getattr(self.student, "primary_guardian", None)
            if g and getattr(g, "phone_e164", ""):
                self.fields["parent_phone_e164"].initial = g.phone_e164

    def clean_parent_phone_e164(self):
        return _normalize_phone_to_e164(self.cleaned_data.get("parent_phone_e164"))

    def clean_unique_student_id(self):
        student_id = (self.cleaned_data.get("unique_student_id") or "").strip()
        if not student_id:
            return student_id

        # Enforce uniqueness ONLY within the class (Classroom).
        target_classroom = None

        # If we're screening an existing student, use that student's classroom
        if self.student and getattr(self.student, "classroom_id", None):
            target_classroom = self.student.classroom
        else:
            # For "add student" flow, grade/division come from the AddStudentForm in the same POST
            grade = (self.data.get("grade") or "").strip()
            division = (self.data.get("division") or "").strip()
            if grade and division:
                target_classroom = Classroom.objects.filter(
                    organization=self.org,
                    grade=grade,
                    division=division,
                ).first()

        qs = Student.objects.filter(organization=self.org, student_code__iexact=student_id)

        # Only scope to classroom if we can resolve it
        if target_classroom:
            qs = qs.filter(classroom=target_classroom)

        if self.student:
            qs = qs.exclude(id=self.student.id)

        if qs.exists():
            raise forms.ValidationError(
                "A student with this Roll Number already exists in the selected class."
            )

        return student_id

    def clean(self):
        data = super().clean()

        dob = data.get("dob")
        today = timezone.localdate()
        months = _age_months(dob, today)
        age_years = round(months / 12.0, 2)

        # NOTE: Only ONE reading each is required (as per field feedback).
        w1 = data.get("weight_kg_r1")
        h1 = data.get("height_cm_r1")

        try:
            weight_kg = float(w1)
        except Exception:
            raise ValidationError("Weight is required.")
        try:
            height_cm = float(h1)
        except Exception:
            raise ValidationError("Height is required.")


        if not (5 <= weight_kg <= 200):
            raise ValidationError("Weight seems out of range. Please re-check readings.")
        if not (50 <= height_cm <= 250):
            raise ValidationError("Height seems out of range. Please re-check readings.")

        muac_tape = data.get("muac_tape_color")
        if months >= 60:
            muac_tape = "GREEN"
            data["muac_tape_color"] = "GREEN"
        is_girl_10plus = (data.get("sex") == "F") and (months >= 120)
        if not is_girl_10plus:
            data["menarche_started"] = False
            data["menarche_age_years"] = None
            data["pads_per_day"] = None
            data["bleeding_clots"] = False
            data["cycle_length_days"] = None
            data["bleeding_days"] = None
        elif not bool(data.get("menarche_started")):
            data["menarche_age_years"] = None
            data["pads_per_day"] = None
            data["bleeding_clots"] = False
            data["cycle_length_days"] = None
            data["bleeding_days"] = None

        # Deworming follow-up gating
        if (data.get("deworming_taken") or "") != "yes":
            data["deworming_date"] = None

        answers = {
            # A
            "unique_student_id": data.get("unique_student_id"),
            "sex": data.get("sex"),

            # B
            "weight_kg_r1": str(w1) if w1 is not None else None,
            "height_cm_r1": str(h1) if h1 is not None else None,
            "muac_tape_color": data.get("muac_tape_color"),

            # C
            "health_general_poor": bool(data.get("health_general_poor")),
            "health_pallor": bool(data.get("health_pallor")),
            "health_fatigue_dizzy_faint": bool(data.get("health_fatigue_dizzy_faint")),
            "health_breathlessness": bool(data.get("health_breathlessness")),
            "health_frequent_infections": bool(data.get("health_frequent_infections")),
            "health_chronic_cough_or_diarrhea": bool(data.get("health_chronic_cough_or_diarrhea")),
            "health_visible_worms": bool(data.get("health_visible_worms")),
            "health_dental_or_gum_or_ulcers": bool(data.get("health_dental_or_gum_or_ulcers")),
            "health_night_vision_difficulty": bool(data.get("health_night_vision_difficulty")),
            "health_bone_or_joint_pain": bool(data.get("health_bone_or_joint_pain")),
            "appetite": data.get("appetite"),

            "menarche_started": bool(data.get("menarche_started")),
            "menarche_age_years": float(data.get("menarche_age_years")) if data.get("menarche_age_years") is not None else None,
            "pads_per_day": data.get("pads_per_day"),
            "bleeding_clots": bool(data.get("bleeding_clots")),
            "cycle_length_days": data.get("cycle_length_days"),
            "bleeding_days": data.get("bleeding_days"),
            # D
            "diet_type": data.get("diet_type"),
            "breakfast_eaten": data.get("breakfast_eaten"),
            "lunch_eaten": data.get("lunch_eaten"),
            "green_leafy_veg": data.get("green_leafy_veg"),
            "other_vegetables": data.get("other_vegetables"),
            "fruits": data.get("fruits"),
            "dal_pulses_beans": data.get("dal_pulses_beans"),
            "milk_curd": data.get("milk_curd"),
            "egg": data.get("egg"),
            "fish_chicken_meat": data.get("fish_chicken_meat"),
            "nuts_groundnuts": data.get("nuts_groundnuts"),
            "millet_whole_grains": data.get("millet_whole_grains"),
            "ssb_or_packaged_snacks": data.get("ssb_or_packaged_snacks"),

            # E
            "deworming_taken": data.get("deworming_taken"),
            "deworming_date": data.get("deworming_date"),

            # F
            "hunger_vital_sign": data.get("hunger_vital_sign"),
        }

        data["_derived"] = {
            "age_months": months,
            "age_years": age_years,
            "height_cm": height_cm,
            "weight_kg": weight_kg,
            "muac_cm": None,
        }
        data["answers"] = answers
        return data

class AddStudentForm(forms.Form):
    grade = forms.ChoiceField(choices=[])
    division = forms.ChoiceField(choices=[])
    is_low_income = forms.BooleanField(label="Low income family", required=False)

    def __init__(self, *args, **kwargs):
        self.org = kwargs.pop("organization")
        super().__init__(*args, **kwargs)

        # Prefer a natural grade ordering for dropdown UX:
        # Nursery, 1..12, Other, then any non-standard values.
        preferred_grade_order = ["Nursery" "K.G."] + [str(i) for i in range(1, 13)] + ["Other"]
        grade_rank = {g: i for i, g in enumerate(preferred_grade_order)}

        grades = list(
            Classroom.objects.filter(organization=self.org)
            .values_list("grade", flat=True)
            .distinct()
        )
        grades.sort(key=lambda g: (grade_rank.get(g, 999), str(g)))
        self.fields["grade"].choices = [("", "Select grade")] + [(g, g) for g in grades]

        initial_grade = self.initial.get("grade") or (grades[0] if grades else "")

        # Prefer A..Z then Other for divisions/sections.
        preferred_division_order = [chr(c) for c in range(ord("A"), ord("Z") + 1)] + ["Other"]
        division_rank = {d: i for i, d in enumerate(preferred_division_order)}

        divisions = list(
            Classroom.objects.filter(organization=self.org, grade=initial_grade)
            .values_list("division", flat=True)
            .distinct()
        )
        divisions.sort(key=lambda d: (division_rank.get(d or "", 999), str(d or "")))
        self.fields["division"].choices = [("", "Select division")] + [(d, d or "—") for d in divisions]

    def clean(self):
        data = super().clean()
        grade = data.get("grade") or ""
        division = data.get("division") or ""
        if grade and not Classroom.objects.filter(organization=self.org, grade=grade, division=division).exists():
            raise ValidationError("Selected Grade/Division does not exist. Please ask admin to create the class first.")
        return data

================================================================================
FILE: screening\models.py
================================================================================

from django.db import models
from django.utils import timezone
from accounts.models import Organization, User
from roster.models import Student

class Screening(models.Model):
    class RiskLevel(models.TextChoices):
        GREEN = "GREEN", "Green"
        YELLOW = "YELLOW", "Yellow"
        RED = "RED", "Red"

    organization = models.ForeignKey(Organization, on_delete=models.CASCADE, related_name="screenings")
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name="screenings")
    pid = models.CharField(max_length=64, null=True, blank=True, db_index=True)
    teacher = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name="screenings")
    screened_at = models.DateTimeField(default=timezone.now, db_index=True)

    gender = models.CharField(max_length=1, choices=Student.Gender.choices)
    age_years = models.DecimalField(max_digits=4, decimal_places=2, null=True, blank=True)
    age_months = models.PositiveIntegerField(null=True, blank=True)

    height_cm = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    weight_kg = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    muac_cm = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)

    bmi = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True)
    baz = models.DecimalField(max_digits=6, decimal_places=2, null=True, blank=True)

    # Stores ALL Section A–F answers (raw) per screening
    answers = models.JSONField(default=dict, blank=True)

    risk_level = models.CharField(max_length=8, choices=RiskLevel.choices, default=RiskLevel.GREEN)
    red_flags = models.JSONField(default=list, blank=True)  # now holds all triggering reasons
    is_low_income_at_screen = models.BooleanField(default=False)

    class Meta:
        indexes = [
            models.Index(fields=["organization", "screened_at"]),
            models.Index(fields=["organization", "student", "screened_at"]),
            models.Index(fields=["organization", "risk_level", "screened_at"]),
            models.Index(fields=["organization", "pid", "screened_at"]),  # NEW
        ]

    def __str__(self):
        return f"{self.student.full_name} @ {self.screened_at:%Y-%m-%d} ({self.risk_level})"

================================================================================
FILE: screening\services.py
================================================================================

from dataclasses import dataclass
from typing import Dict, List, Optional, Tuple, Any

from .bmi_reference import bmi_to_baz

@dataclass
class RiskResult:
    level: str                 # "GREEN" | "YELLOW" | "RED"
    flags: List[str]           # machine-friendly reasons
    derived: Dict[str, Any]    # computed metrics for storage/debug

def _bmi(height_cm: Optional[float], weight_kg: Optional[float]) -> Optional[float]:
    if height_cm is None or weight_kg is None:
        return None
    if float(height_cm) <= 0:
        return None
    m = float(height_cm) / 100.0
    return float(weight_kg) / (m * m)

def _muac_numeric_flag(muac_cm: Optional[float], age_months: Optional[int]) -> Optional[str]:
    if muac_cm is None or age_months is None:
        return None
    if age_months < 6 or age_months > 59:
        return None
    x = float(muac_cm)
    if x < 11.5:
        return "RED"
    if x < 12.5:
        return "YELLOW"
    return None

def _muac_tape_flag(muac_tape_color: Optional[str], age_months: Optional[int]) -> Optional[str]:
    if age_months is None:
        return None
    if age_months < 6 or age_months > 59:
        return None
    if not muac_tape_color:
        return None
    c = str(muac_tape_color).upper()
    if c in {"RED", "YELLOW"}:
        return c
    return None


def _baz_category(baz: float) -> Tuple[str, str]:
    # Sheet thresholds:
    # RED: < -3 (severe thinness), > +2 (obesity)
    # YELLOW: < -2 (thinness), > +1 (overweight)
    # GREEN: [-2, +1]
    if baz < -3:
        return "RED", "severe_thinness"
    if baz < -2:
        return "YELLOW", "thinness"
    if baz > 2:
        return "RED", "obesity"
    if baz > 1:
        return "YELLOW", "overweight"
    return "GREEN", "normal"

_HEALTH_REDFLAG_KEYS = [
    "health_general_poor",
    "health_pallor",
    "health_fatigue_dizzy_faint",
    "health_breathlessness",
    "health_frequent_infections",
    "health_chronic_cough_or_diarrhea",
    "health_visible_worms",
    "health_dental_or_gum_or_ulcers",
    "health_night_vision_difficulty",
    "health_bone_or_joint_pain",
]

def compute_risk(
    *,
    age_years: Optional[float],
    age_months: Optional[int],
    sex: str,  # "M" | "F" | "O"
    height_cm: Optional[float],
    weight_kg: Optional[float],
    muac_cm: Optional[float],
    answers: Dict[str, Any],
) -> RiskResult:
    """
    Overall status per sheet:

      GREEN:
        - BAZ between -2 and +1
        - No Section-C health red flags
        - Hunger = "Never true"
        - No diet/program flags

      YELLOW:
        - BAZ between -3 and -2 OR > +1
        - OR any diet/program flags

      RED:
        - BAZ < -3 OR > +2
        - OR any Section-C health red flags
        - OR Hunger Often/Sometimes true
        - OR heavy bleeding (girls)
    """
    flags: List[str] = []
    derived: Dict[str, Any] = {}

    # --- BMI + BAZ ---
    bmi = _bmi(height_cm, weight_kg)
    derived["bmi"] = bmi

    growth_level = "YELLOW"  # default when incomplete/unavailable
    if bmi is not None and age_years is not None and 5.0 <= float(age_years) <= 18.0 and (sex or "").upper() in {"M", "F"}:
        baz, ref_age, median, sd = bmi_to_baz(bmi=float(bmi), age_years=float(age_years), sex=(sex or "").upper())
        derived.update({"baz": baz, "bmi_ref_age_years": ref_age, "bmi_ref_median": median, "bmi_ref_sd": sd})

        # SD boundaries generated via loop (explicitly requested)
        derived["bmi_sd_boundaries"] = {z: float(median) + float(z) * float(sd) for z in (-3, -2, 1, 2)}

        growth_level, baz_cat = _baz_category(float(baz))
        derived["baz_category"] = baz_cat
        flags.append(f"baz_{baz_cat}")
    else:
        flags.append("baz_unavailable")

    # --- MUAC (6–59 months only) ---
    muac_level = _muac_tape_flag(answers.get("muac_tape_color"), age_months)
    if muac_level is None:
        muac_level = _muac_numeric_flag(muac_cm, age_months)

    derived["muac_level"] = muac_level

    if muac_level == "RED":
        flags.append("muac_red")
    elif muac_level == "YELLOW":
        flags.append("muac_yellow")

    # --- Section C: Quick Health Red Flags (any YES => RED) ---
    health_red = []

    for key in _HEALTH_REDFLAG_KEYS:
        if key=="health_general_poor":
            if answers.get(key) is False:
                health_red.append("health_general_poor")
        else:
            if answers.get(key) is True:
                health_red.append(key)

    appetite = answers.get("appetite")
    # Old records: GOOD/NORMAL/POOR. New records: boolean where True means "Yes".
    if appetite is False or (isinstance(appetite, str) and appetite.upper() == "POOR"):
        health_red.append("appetite_not_hungry")

    # Adolescent girls (age >=10 only): heavy bleeding + irregular cycles
    if (sex or "").upper() == "F" and age_years is not None and float(age_years) >= 10.0 and bool(answers.get("menarche_started")):
        pads_per_day = answers.get("pads_per_day")
        bleeding_clots = bool(answers.get("bleeding_clots"))

        # pads/day > 4 => red flag
        if pads_per_day is not None and int(pads_per_day) > 4:
            health_red.append("heavy_bleeding")

        if bleeding_clots:
            health_red.append("heavy_bleeding")
            
        bleeding_days = answers.get("bleeding_days")
        if bleeding_days is not None and int(bleeding_days) > 10:
            health_red.append("bleeding_days_gt_10")

        cycle_raw = answers.get("cycle_length_days")
        if isinstance(cycle_raw, str) and cycle_raw.upper() == "GT_45":
            health_red.append("irregular_cycles_gt_45")
        elif cycle_raw is not None:
            # old numeric compatibility
            try:
                if int(cycle_raw) > 45:
                    health_red.append("irregular_cycles_gt_45")
            except Exception:
                pass


    derived["health_red_flags"] = health_red
    flags.extend(health_red)

    # --- Section F: Food Security ---
    hunger = (answers.get("hunger_vital_sign") or "").upper()
    derived["hunger_vital_sign"] = hunger
    
    food_security_red = hunger in {"SOMETIMES_TRUE", "NEVER_TRUE"}
    if food_security_red:
        flags.append("food_insecurity")

    # --- Section D + E: Diet + Program (drives YELLOW) ---
    diet_flags = []
    diet_type = (answers.get("diet_type") or "").upper()  #LACTO_VEG / LACTO_OVO / NON_VEG
    derived["diet_type"] = diet_type

    if answers.get("breakfast_eaten") is False:
        diet_flags.append("breakfast_skipped")
    if answers.get("lunch_eaten") is False:
        diet_flags.append("lunch_skipped")

    def _flag_if_no(key: str, enabled: bool = True):
        if enabled and answers.get(key) is False:
            diet_flags.append(f"missing_{key}")

    _flag_if_no("green_leafy_veg")
    _flag_if_no("other_vegetables")
    _flag_if_no("fruits")
    _flag_if_no("dal_pulses_beans")

    # Conditional logic taken from the sheet:
    _flag_if_no("milk_curd", enabled=(diet_type in {"LACTO_VEG", "NON_VEG"}))
    _flag_if_no("egg", enabled=(diet_type in {"LACTO_OVO", "NON_VEG"}))
    _flag_if_no("fish_chicken_meat", enabled=(diet_type == "NON_VEG"))

    _flag_if_no("nuts_groundnuts")
    

    # Negative check: YES => needs attention (sheet marks “Red Flag” on YES)
    ssb_red = False
    if answers.get("ssb_or_packaged_snacks") is True:
        diet_flags.append("ssb_or_packaged_snacks")
        ssb_red = True

    # Program enabler: deworming “No” => flag
    if answers.get("deworming_taken") is False:
        diet_flags.append("deworming_not_recent")

    derived["diet_flags"] = diet_flags
    flags.extend(diet_flags)

    deworming_taken_raw = answers.get("deworming_taken")
    if deworming_taken_raw is False:
        diet_flags.append("deworming_not_recent")
    elif isinstance(deworming_taken_raw, str):
        v = deworming_taken_raw.lower()
        if v == "no":
            diet_flags.append("deworming_not_recent")
        elif v in {"dont_know", "don't know", "dontknow", "unknown"}:
            diet_flags.append("deworming_unknown")

    # --- Final status decision ---
    if growth_level == "RED" or muac_level == "RED" or health_red or food_security_red or ssb_red or diet_flags:
        level = "RED"
    elif growth_level == "YELLOW" or muac_level == "YELLOW":
        level = "YELLOW"
    else:
        level = "GREEN"

    

    # Helpful debugging strings (kept in DB in Screening.red_flags)
    if derived.get("baz") is not None:
        flags.append(f"baz={derived['baz']:.2f}")
    if derived.get("bmi") is not None:
        flags.append(f"bmi={derived['bmi']:.1f}")

    return RiskResult(level=level, flags=flags, derived=derived)

================================================================================
FILE: screening\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: screening\urls.py
================================================================================

from django.urls import path, re_path
from .views import (
    teacher_portal,
    teacher_portal_token,
    teacher_add_student,
    screening_create,
    screening_result,
    send_parent_whatsapp,
)
from .export import export_screenings_csv

urlpatterns = [
    re_path(r"^teacher/(?P<token>[-a-z0-9_]+-[A-Za-z0-9]{8})/add-student/$",
            teacher_add_student, name="teacher_add_student_token"),
    path("teacher/add-student/", teacher_add_student, name="teacher_add_student"),
    re_path(r"^teacher/(?P<token>[-a-z0-9_]+-[A-Za-z0-9]{8})/$",
            teacher_portal_token, name="teacher_portal_token"),

    path("teacher/", teacher_portal, name="teacher_portal"),
    path("teacher/screen/<int:student_id>/", screening_create, name="screening_create"),
    path("teacher/result/<int:screening_id>/", screening_result, name="screening_result"),
    path("teacher/send/<int:screening_id>/", send_parent_whatsapp, name="send_parent_whatsapp"),

    path("admin/export/screenings.csv", export_screenings_csv, name="export_screenings_csv"),
]

================================================================================
FILE: screening\views.py
================================================================================

import json
from datetime import timedelta

from django.contrib import messages
from django.core.exceptions import ValidationError
from django.db import IntegrityError, transaction
from django.db.models import Q, OuterRef, Subquery, Exists
from django.http import HttpResponseForbidden
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from django.utils import timezone

from accounts.models import Organization, OrgMembership
from audit.utils import audit_log
from messaging.models import MessageLog
from messaging.ratelimit import RateLimitExceeded
from messaging.services import prepare_screening_status_click_to_chat
from roster.models import Classroom, Guardian, Student

from .decorators import require_teacher_or_public
from .forms import AddStudentForm, NewScreeningForm
from .models import Screening
from .services import compute_risk
from assist.models import Application
import logging
logger = logging.getLogger(__name__)

from roster.pid import compute_pid
from django.http import HttpResponse
import json as _json

def teacher_portal_token(request, token: str):
    try:
            org.screening_only_profile
            return redirect(reverse("screening_only:teacher_access_portal", args=[org.screening_link_token]))
    except Exception:
            pass

    org = get_object_or_404(Organization, screening_link_token=token)
    request.session["public_teacher_org_id"] = org.id
    request.org = org
    if request.user.is_authenticated:
        request.membership = OrgMembership.objects.filter(
            user=request.user, organization=org, is_active=True
        ).first()
    return teacher_portal(request)

def _teacher_fk(request):
    return request.user if getattr(request.user, "is_authenticated", False) else None

def _open_in_new_tab_then_redirect(*, wa_url: str, redirect_url: str) -> HttpResponse:
    """
    Returns an HTML page with a modal that says "Open WhatsApp". When the user
    clicks the button, window.open() is user-triggered so it is not blocked.
    """
    wa_js = _json.dumps(wa_url)
    next_js = _json.dumps(redirect_url)
    # Escape for use in HTML attributes if needed (wa_url is already in JS)
    wa_escaped = wa_url.replace("'", "&#39;").replace('"', "&quot;")
    redirect_escaped = redirect_url.replace("'", "&#39;").replace('"', "&quot;")

    html = f"""<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Screening complete</title>
  <style>
    body {{ margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #fafafa; min-height: 100vh; display: flex; align-items: center; justify-content: center; }}
    .modal-overlay {{ position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }}
    .modal {{ background: #fff; border-radius: 12px; padding: 24px; max-width: 380px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); text-align: center; }}
    .modal h2 {{ margin: 0 0 12px 0; font-size: 1.25rem; color: #111; }}
    .modal p {{ margin: 0 0 20px 0; color: #555; font-size: 0.95rem; line-height: 1.4; }}
    .modal .buttons {{ display: flex; flex-direction: column; gap: 10px; }}
    .modal .btn {{ display: inline-block; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 500; text-decoration: none; border: none; cursor: pointer; transition: background 0.15s; }}
    .modal .btn-whatsapp {{ background: #000; color: #fff; }}
    .modal .btn-whatsapp:hover {{ opacity: 0.9; }}
    .modal .btn-dashboard {{ background: #f3f4f6; color: #374151; }}
    .modal .btn-dashboard:hover {{ background: #e5e7eb; }}
  </style>
  </head>
  <body>
    <div class="modal-overlay" role="dialog" aria-labelledby="modal-title" aria-modal="true">
      <div class="modal">
        <h2 id="modal-title">Screening complete</h2>
        <p>Open WhatsApp to send the message to the parent, then go to the dashboard.</p>
        <div class="buttons">
          <button type="button" class="btn btn-whatsapp" id="open-whatsapp">Open WhatsApp</button>
          <a href="{redirect_escaped}" class="btn btn-dashboard" id="go-dashboard">Go to dashboard</a>
        </div>
      </div>
    </div>
    <script>
      (function () {{
        var waUrl = {wa_js};
        var redirectUrl = {next_js};
        var openBtn = document.getElementById("open-whatsapp");
        var dashboardLink = document.getElementById("go-dashboard");
        openBtn.addEventListener("click", function () {{
          try {{
            window.open(waUrl, "_blank", "noopener");
            window.location.href = redirectUrl;
          }} catch (e) {{
            console.error("[NutriLift] window.open error:", e);
          }}
        }});
      }})();
    </script>
    <noscript>
      <p style="padding: 20px; text-align: center;">
        <a href="{wa_escaped}" target="_blank" rel="noopener">Open WhatsApp</a> &middot;
        <a href="{redirect_escaped}">Go to dashboard</a>
      </p>
    </noscript>
  </body>
</html>"""
    return HttpResponse(html)

def _prepare_parent_whatsapp_url(request, s, *, parent_phone_e164: str) -> str | None:
    """
    Builds the WhatsApp click-to-chat URL immediately (no preview page).
    Also creates a MessageLog WITHOUT phone/payload (stores only pid + metadata).
    """
    phone = (parent_phone_e164 or "").strip()
    if not phone:
        messages.warning(request, "No parent phone number provided; cannot open WhatsApp.")
        return None

    try:
        # Screening-only orgs
        try:
            s.organization.screening_only_profile
            is_screening_only = True
        except Exception:
            is_screening_only = False

        if is_screening_only:
            # In Screening Program, only RED sends parent WhatsApp
            if s.risk_level != "RED":
                return None

            from screening_only.services import prepare_screening_only_redflag_click_to_chat
            form_language = (request.POST.get("form_language") or request.GET.get("lang") or "").strip()
            qa_text = (request.POST.get("wa_questions_and_answers") or "").strip()

            _log, wa_url = prepare_screening_only_redflag_click_to_chat(
                request,
                s,
                form_language=form_language,
                questions_and_answers=qa_text,
                to_phone_e164=phone,
            )
            return wa_url or None

        # Standard orgs
        from messaging.services import prepare_screening_status_click_to_chat
        _log, wa_url = prepare_screening_status_click_to_chat(s, to_phone_e164=phone)
        return wa_url or None

    except RateLimitExceeded as e:
        messages.error(request, str(e))
        return None
    except Exception:
        logger.exception("WhatsApp URL preparation failed")
        messages.error(request, "Could not open WhatsApp.")
        return None



@require_teacher_or_public
def teacher_portal(request):
    org = getattr(request, "org", None)
    if not org:
        return HttpResponseForbidden("Organization context required.")

    classroom_id = request.GET.get("classroom")
    risk = request.GET.get("risk")  # GREEN|YELLOW|RED
    q = (request.GET.get("q") or "").strip()

    last_screening = (
        Screening.objects
            .filter(organization=org, pid=OuterRef("pid"))
            .order_by("-screened_at")
            .values("risk_level")[:1]
    )

    approved_application = (
        Application.objects
        .filter(
            organization=org,
            pid=OuterRef("pid"),
            status=Application.Status.APPROVED,
        )
    )

    students = (
        Student.objects
        .filter(organization=org)
        .annotate(
            last_risk=Subquery(last_screening),
            supplements_granted=Exists(approved_application),
        )
    )
    
    if classroom_id:
        students = students.filter(classroom_id=classroom_id)
    if risk in {"GREEN", "YELLOW", "RED"}:
        students = students.filter(last_risk=risk)
    if q:
        students = students.order_by("classroom__grade", "classroom__division", "student_code", "pid")

    students = students.order_by("last_name", "first_name")
    classrooms = Classroom.objects.filter(organization=org).order_by("grade", "division")

    return render(request, "screening/teacher_portal.html", {
        "students": students,
        "classrooms": classrooms,
        "selected_classroom": int(classroom_id) if classroom_id else None,
        "selected_risk": risk or "",
        "q": q,
        "teacher_token": org.screening_link_token,
    })

def _warn_if_large_change(student: Student, height_cm: float, weight_kg: float, now_dt):
    prev = Screening.objects.filter(
        organization=student.organization,
        pid=student.pid,
        screened_at__gte=now_dt - timedelta(days=183),
    ).order_by("-screened_at").first()

    if not prev:
        return []
    warnings = []
    try:
        if prev.weight_kg is not None and abs(float(prev.weight_kg) - float(weight_kg)) > 10:
            warnings.append("Weight changed by > 10kg in ~6 months. Please verify readings.")
        if prev.height_cm is not None and abs(float(prev.height_cm) - float(height_cm)) > 10:
            warnings.append("Height changed by > 10cm in ~6 months. Please verify readings.")
    except Exception:
        pass
    return warnings

@require_teacher_or_public
def screening_create(request, student_id: int):
    org = getattr(request, "org", None)
    if not org:
        return HttpResponseForbidden("Organization context required.")
    student = get_object_or_404(Student, pk=student_id, organization=org)

    if request.method == "POST":
        form = NewScreeningForm(request.POST, student=student)
        if form.is_valid():
            derived = form.cleaned_data["_derived"]
            answers = form.cleaned_data["answers"]

            # Update student master
            student.student_code = answers.get("unique_student_id") or student.student_code
            student.dob = form.cleaned_data.get("dob") or student.dob
            student.gender = form.cleaned_data.get("sex") or student.gender
            student.save(update_fields=["student_code", "dob", "gender", "updated_at"])

            # Guardian (mandatory)
            pid = student.pid

            # Legacy fallback: if an old student exists without pid, try to compute it once.
            if not pid:
                try:
                    pid = compute_pid(
                        first_name=(student.first_name or ""),
                        phone_e164=form.cleaned_data["parent_phone_e164"],
                    )
                    student.pid = pid
                    student.save(update_fields=["pid", "updated_at"])
                except Exception:
                    pid = None

            guardian = None
            if pid:
                guardian, _ = Guardian.objects.get_or_create(
                    organization=org,
                    pid=pid,
                    defaults={
                        "full_name": None,
                        "phone_e164": None,
                        "whatsapp_opt_in": True,
                    },
                )
                if student.primary_guardian_id != guardian.id:
                    student.primary_guardian = guardian
                    student.save(update_fields=["primary_guardian", "updated_at"])

            if student.primary_guardian_id != guardian.id:
                student.primary_guardian = guardian
                student.save(update_fields=["primary_guardian", "updated_at"])

            now_dt = timezone.now()
            height_cm = float(derived["height_cm"])
            weight_kg = float(derived["weight_kg"])

            for w in _warn_if_large_change(student, height_cm, weight_kg, now_dt):
                messages.warning(request, w)

            s = Screening(
                organization=org,
                student=student,
                pid=pid,  # NEW
                teacher=_teacher_fk(request),
                screened_at=now_dt,
                gender=student.gender,
                age_years=derived["age_years"],
                age_months=derived["age_months"],
                height_cm=height_cm,
                weight_kg=weight_kg,
                muac_cm=derived.get("muac_cm"),
                answers=answers,
                is_low_income_at_screen=bool(getattr(student, "is_low_income", False)),
            )

            rr = compute_risk(
                age_years=float(derived["age_years"]),
                age_months=int(derived["age_months"]),
                sex=student.gender,
                height_cm=height_cm,
                weight_kg=weight_kg,
                muac_cm=float(derived["muac_cm"]) if derived.get("muac_cm") is not None else None,
                answers=answers,
            )
            s.risk_level = rr.level
            s.red_flags = rr.flags
            if rr.derived.get("bmi") is not None:
                s.bmi = rr.derived["bmi"]
            if rr.derived.get("baz") is not None:
                s.baz = rr.derived["baz"]
            s.save()

            parent_phone = form.cleaned_data.get("parent_phone_e164") or ""
            dashboard_url = reverse("screening_only:teacher_dashboard")

            parent_phone = (form.cleaned_data.get("parent_phone_e164") or "").strip()
            wa_url = _prepare_parent_whatsapp_url(request, s, parent_phone_e164=parent_phone)

            if wa_url:
                return _open_in_new_tab_then_redirect(wa_url=wa_url, redirect_url=dashboard_url)

            return redirect(dashboard_url)

        return render(request, "screening/screening_form.html", {"student": student, "form": form})

    form = NewScreeningForm(student=student)
    return render(request, "screening/screening_form.html", {"student": student, "form": form})

@require_teacher_or_public
def screening_result(request, screening_id: int):
    org = getattr(request, "org", None)
    if not org:
        return HttpResponseForbidden("Organization context required.")
    s = get_object_or_404(Screening, pk=screening_id, organization=org)
    last_message = MessageLog.objects.filter(related_screening=s).order_by("-created_at").first()

    teacher_view = {
        "GREEN": "Child’s growth and diet look on track.",
        "YELLOW": "Some areas need attention (e.g., low veg/fruit or fewer protein servings).",
        "RED": "Child shows signs needing a check-up (e.g., growth outside healthy range / possible anemia).",
    }.get((s.risk_level or "").upper(), "")

    return render(request, "screening/screening_result.html", {
        "s": s,
        "last_message": last_message,
        "teacher_view": teacher_view,
    })

@require_teacher_or_public
def send_parent_whatsapp(request, screening_id):
    s = get_object_or_404(Screening, id=screening_id, organization=request.org)
    dashboard_url = reverse("screening_only:teacher_dashboard")

    # Since we do not store phone numbers, the caller must provide it
    phone = (request.GET.get("phone_e164") or request.POST.get("phone_e164") or "").strip()
    if not phone:
        messages.error(request, "Parent phone is not stored. Please enter the phone number to open WhatsApp.")
        return redirect(dashboard_url)

    wa_url = _prepare_parent_whatsapp_url(request, s, parent_phone_e164=phone)
    if not wa_url:
        return redirect(dashboard_url)

    # This redirect will be opened in a new tab if the link/form uses target="_blank"
    return redirect(wa_url)


@require_teacher_or_public
def teacher_add_student(request, token=None):
    org = getattr(request, "org", None)
    if not org:
        return HttpResponseForbidden("Organization context required.")

    initial = {}
    selected_classroom_id = request.GET.get("classroom")
    if selected_classroom_id:
        c = Classroom.objects.filter(id=selected_classroom_id, organization=org).first()
        if c:
            initial["grade"] = c.grade
            initial["division"] = c.division

    preferred_division_order = [chr(c) for c in range(ord("A"), ord("Z") + 1)] + ["Other"]
    division_rank = {d: i for i, d in enumerate(preferred_division_order)}
    divisions_by_grade = {}
    for g, d in Classroom.objects.filter(organization=org).values_list("grade", "division"):
        divisions_by_grade.setdefault(g, set()).add(d or "")
    
    # Convert sets -> sorted lists for JSON serialization.
    divisions_by_grade = {
        g: sorted(list(ds), key=lambda x: (division_rank.get(x, 999), str(x)))
        for g, ds in divisions_by_grade.items()
    }

    if request.method == "POST":
        student_form = AddStudentForm(request.POST, organization=org, initial=initial)
        screening_form = NewScreeningForm(request.POST, student=None, organization=org)

        if student_form.is_valid() and screening_form.is_valid():
            try:
                with transaction.atomic():
                    grade = student_form.cleaned_data["grade"]
                    division = student_form.cleaned_data["division"] or ""
                    classroom = Classroom.objects.filter(organization=org, grade=grade, division=division).first()
                    if not classroom:
                        raise ValidationError("Selected Grade/Division does not exist.")

                    # --- Compute PID from transient form inputs (DO NOT STORE these values) ---
                    # Support both naming conventions:
                    #   - your prompt: first_name, phone_e164
                    #   - current codebase: student_name, parent_phone_e164
                    raw_first_name = (request.POST.get("first_name") or request.POST.get("student_name") or "").strip()

                    # phone comes from cleaned_data so it is normalized to E.164
                    phone_e164 = (
                        screening_form.cleaned_data.get("phone_e164")
                        or screening_form.cleaned_data.get("parent_phone_e164")
                    )

                    pid = compute_pid(first_name=raw_first_name, phone_e164=phone_e164)

                    answers = screening_form.cleaned_data["answers"]     # already PII-free after Step 4
                    derived = screening_form.cleaned_data["_derived"]

                    # --- Upsert Student by PID (within this organization) ---
                    student = Student.objects.filter(organization=org, pid=pid).first()

                    if student is None:
                        # Create placeholder guardian row keyed by PID (no name, no phone stored)
                        guardian, _ = Guardian.objects.get_or_create(
                            organization=org,
                            pid=pid,
                            defaults={
                                "full_name": None,
                                "phone_e164": None,
                                "whatsapp_opt_in": True,
                            },
                        )

                        # Create placeholder student row keyed by PID (no name stored)
                        student = Student.objects.create(
                            organization=org,
                            classroom=classroom,
                            pid=pid,
                            first_name=None,
                            last_name=None,
                            gender=answers.get("sex"),
                            dob=screening_form.cleaned_data.get("dob"),
                            is_low_income=student_form.cleaned_data.get("is_low_income", False),
                            student_code=answers.get("unique_student_id"),
                            primary_guardian=guardian,
                        )
                    else:
                        # Ensure guardian row exists (PID-keyed)
                        guardian, _ = Guardian.objects.get_or_create(
                            organization=org,
                            pid=pid,
                            defaults={
                                "full_name": None,
                                "phone_e164": None,
                                "whatsapp_opt_in": True,
                            },
                        )

                        # Optional: keep student up-to-date without storing PII
                        update_fields = []
                        if student.classroom_id != classroom.id:
                            student.classroom = classroom
                            update_fields.append("classroom")

                        #    Keep non-PII master data updated
                        new_code = answers.get("unique_student_id")
                        if new_code and student.student_code != new_code:
                            student.student_code = new_code
                            update_fields.append("student_code")

                        new_dob = screening_form.cleaned_data.get("dob")
                        if new_dob and student.dob != new_dob:
                            student.dob = new_dob
                            update_fields.append("dob")

                        new_gender = answers.get("sex")
                        if new_gender and student.gender != new_gender:
                            student.gender = new_gender
                            update_fields.append("gender")

                        new_low_income = student_form.cleaned_data.get("is_low_income", False)
                        if getattr(student, "is_low_income", False) != new_low_income:
                            student.is_low_income = new_low_income
                            update_fields.append("is_low_income")

                        if student.primary_guardian_id != guardian.id:
                            student.primary_guardian = guardian
                            update_fields.append("primary_guardian")

                        if update_fields:
                            student.save(update_fields=update_fields + ["updated_at"])

                    # --- Create Screening record linked by PID ---
                    now_dt = timezone.now()
                    height_cm = float(derived["height_cm"])
                    weight_kg = float(derived["weight_kg"])

                    s = Screening(
                        organization=org,
                        student=student,                 # kept for compatibility, but linkage is PID
                        pid=pid,                         # NEW linkage field
                        teacher=_teacher_fk(request),
                        screened_at=now_dt,
                        gender=student.gender,
                        age_years=derived["age_years"],
                        age_months=derived["age_months"],
                        height_cm=height_cm,
                        weight_kg=weight_kg,
                        muac_cm=derived.get("muac_cm"),
                        answers=answers,                 # PII-free JSON
                        is_low_income_at_screen=student_form.cleaned_data.get("is_low_income", False),
                    )

                    rr = compute_risk(
                        age_years=float(derived["age_years"]),
                        age_months=int(derived["age_months"]),
                        sex=student.gender,
                        height_cm=height_cm,
                        weight_kg=weight_kg,
                        muac_cm=float(derived["muac_cm"]) if derived.get("muac_cm") is not None else None,
                        answers=answers,
                    )
                    s.risk_level = rr.level
                    s.red_flags = rr.flags
                    if rr.derived.get("bmi") is not None:
                        s.bmi = rr.derived["bmi"]
                    if rr.derived.get("baz") is not None:
                        s.baz = rr.derived["baz"]
                    s.save()


                parent_phone = screening_form.cleaned_data.get("parent_phone_e164") or ""
                dashboard_url = reverse("screening_only:teacher_dashboard")

                parent_phone = (screening_form.cleaned_data.get("parent_phone_e164") or "").strip()
                wa_url = _prepare_parent_whatsapp_url(request, s, parent_phone_e164=parent_phone)

                messages.success(request, "Student created and screening completed.")

                if wa_url:
                    return _open_in_new_tab_then_redirect(wa_url=wa_url, redirect_url=dashboard_url)

                return redirect(dashboard_url)

            except (IntegrityError, ValidationError, ValueError) as e:
                messages.error(request, f"Could not complete: {e}")

    else:
        student_form = AddStudentForm(organization=org, initial=initial)
        screening_form = NewScreeningForm(student=None, organization=org)

    return render(request, "screening/add_student.html", {
        "student_form": student_form,
        "screening_form": screening_form,
        "divisions_by_grade": json.dumps(divisions_by_grade),
    })

================================================================================
FILE: screening\__init__.py
================================================================================


================================================================================
FILE: screening_only\admin.py
================================================================================

from django.contrib import admin
from .models import ScreeningSchoolProfile, ScreeningTermsAcceptance


@admin.register(ScreeningSchoolProfile)
class ScreeningSchoolProfileAdmin(admin.ModelAdmin):
    list_display = ("organization", "district", "principal_email", "operator_email", "created_at")
    search_fields = ("organization__name", "principal_email", "operator_email", "district")


@admin.register(ScreeningTermsAcceptance)
class ScreeningTermsAcceptanceAdmin(admin.ModelAdmin):
    list_display = ("organization", "user", "actor_role", "version", "accepted_at")
    search_fields = ("organization__name", "user__email", "actor_role", "version")

================================================================================
FILE: screening_only\apps.py
================================================================================

from django.apps import AppConfig


class ScreeningOnlyConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "screening_only"

================================================================================
FILE: screening_only\decorators.py
================================================================================

from functools import wraps
from django.http import HttpResponseForbidden

from accounts.decorators import require_roles
from accounts.models import Role


def require_screening_only_org(view_func):
    @wraps(view_func)
    def _wrapped(request, *args, **kwargs):
        org = getattr(request, "org", None)
        if not org:
            return HttpResponseForbidden("Organization context missing.")
        try:
            org.screening_only_profile
        except Exception:
            return HttpResponseForbidden("This organization is not enrolled in the Screening Program.")
        return view_func(request, *args, **kwargs)
    return _wrapped


def require_screening_only_admin(view_func):
    return require_roles(Role.ORG_ADMIN)(require_screening_only_org(view_func))


def require_screening_only_teacher(view_func):
    # Allow both Teacher and School Admin into the screening-only “teacher” views
    return require_roles(Role.TEACHER, Role.ORG_ADMIN)(require_screening_only_org(view_func))

================================================================================
FILE: screening_only\forms.py
================================================================================

from django import forms
from accounts.models import User

class SchoolEnrollmentForm(forms.Form):
    school_name = forms.CharField(max_length=255, required=True)
    #district = forms.CharField(max_length=128, required=False)
    address = forms.CharField(max_length=255, required=True)

    city = forms.CharField(max_length=100, required=True)
    state = forms.CharField(max_length=100, required=True)
    country = forms.CharField(max_length=64, required=True, initial="India")

    principal_name = forms.CharField(max_length=255, required=True)
    principal_email = forms.EmailField(required=True)

    operator_name = forms.CharField(max_length=255, required=True)
    operator_email = forms.EmailField(required=True)

    local_language_code = forms.ChoiceField(
        choices=[('hi', 'Hindi'), ('mr', 'Marathi')],
        required=True,
    )

    terms_accepted = forms.BooleanField(required=True, label="")

    def clean(self):
        cleaned = super().clean()
        # Same person can be both principal and operator; we keep both emails when required.
        return cleaned


class TeacherAccessForm(forms.Form):
    full_name = forms.CharField(max_length=255)
    email = forms.EmailField()
    accept_terms = forms.BooleanField(required=True)

    # def clean_email(self):
    #     email = self.cleaned_data.get("email")
    #     if email:
    #         email = email.strip().lower()
    #         # Check if a user with this email already exists
    #         if User.objects.filter(email=email).exists():
    #             raise forms.ValidationError(
    #                 "An account with this email already exists. Please use a different email address."
    #             )
    #     return email
================================================================================
FILE: screening_only\google_oauth.py
================================================================================

import json
import secrets
from typing import Any, Dict, Optional
from urllib.parse import urlencode
from urllib.request import Request, urlopen
from urllib.error import HTTPError, URLError


GOOGLE_AUTH_URL = "https://accounts.google.com/o/oauth2/v2/auth"
GOOGLE_TOKEN_URL = "https://oauth2.googleapis.com/token"
GOOGLE_TOKENINFO_URL = "https://oauth2.googleapis.com/tokeninfo"


class GoogleOAuthError(Exception):
    pass


def _http_post_form(url: str, data: Dict[str, str], timeout: int = 15) -> Dict[str, Any]:
    body = urlencode(data).encode("utf-8")
    req = Request(
        url,
        data=body,
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        method="POST",
    )
    try:
        with urlopen(req, timeout=timeout) as resp:
            raw = resp.read().decode("utf-8")
            return json.loads(raw)
    except HTTPError as e:
        raw = e.read().decode("utf-8", errors="ignore")
        raise GoogleOAuthError(f"HTTPError {e.code} from Google token endpoint: {raw}")
    except URLError as e:
        raise GoogleOAuthError(f"URLError contacting Google token endpoint: {e}")


def _http_get_json(url: str, params: Dict[str, str], timeout: int = 15) -> Dict[str, Any]:
    full_url = f"{url}?{urlencode(params)}"
    req = Request(full_url, headers={"Accept": "application/json"}, method="GET")
    try:
        with urlopen(req, timeout=timeout) as resp:
            raw = resp.read().decode("utf-8")
            return json.loads(raw)
    except HTTPError as e:
        raw = e.read().decode("utf-8", errors="ignore")
        raise GoogleOAuthError(f"HTTPError {e.code} from Google tokeninfo endpoint: {raw}")
    except URLError as e:
        raise GoogleOAuthError(f"URLError contacting Google tokeninfo endpoint: {e}")


def generate_state() -> str:
    return secrets.token_urlsafe(24)


def build_authorization_url(
    *,
    client_id: str,
    redirect_uri: str,
    state: str,
) -> str:
    params = {
        "client_id": client_id,
        "redirect_uri": redirect_uri,
        "response_type": "code",
        "scope": "openid email profile",
        "state": state,
        "prompt": "select_account",
        # you can add "access_type": "online" or "offline" if you need refresh tokens
        "access_type": "online",
    }
    return f"{GOOGLE_AUTH_URL}?{urlencode(params)}"


def exchange_code_for_id_token(
    *,
    code: str,
    client_id: str,
    client_secret: str,
    redirect_uri: str,
) -> str:
    token_resp = _http_post_form(
        GOOGLE_TOKEN_URL,
        data={
            "code": code,
            "client_id": client_id,
            "client_secret": client_secret,
            "redirect_uri": redirect_uri,
            "grant_type": "authorization_code",
        },
    )
    id_token = token_resp.get("id_token")
    if not id_token:
        raise GoogleOAuthError(f"No id_token in token response: {token_resp}")
    return id_token


def verify_id_token_and_get_email(
    *,
    id_token: str,
    client_id: str,
) -> Dict[str, Any]:
    """
    Uses Google's tokeninfo endpoint to validate and decode the ID token.

    Returns the decoded payload including 'email', 'email_verified', 'name', etc.
    """
    info = _http_get_json(GOOGLE_TOKENINFO_URL, params={"id_token": id_token})
    aud = info.get("aud")
    if aud != client_id:
        raise GoogleOAuthError(f"Invalid token audience. Expected {client_id}, got {aud}")

    if str(info.get("email_verified", "")).lower() not in ("true", "1", "yes"):
        raise GoogleOAuthError("Google account email is not verified.")

    email = info.get("email")
    if not email:
        raise GoogleOAuthError("No email found in Google token payload.")

    return info

================================================================================
FILE: screening_only\models.py
================================================================================

from django.conf import settings
from django.db import models
from django.utils import timezone


class ScreeningSchoolProfile(models.Model):
    """
    Marks an Organization as enrolled in the Screening-only program and stores
    registration + authorization metadata required by the Screening Program flow.
    """
    organization = models.OneToOneField(
        "accounts.Organization",
        on_delete=models.CASCADE,
        related_name="screening_only_profile",
    )

    # Registration metadata (from the PDF's School Registration screen)
    district = models.CharField(max_length=128, blank=True, default="")
    address = models.CharField(max_length=255, blank=True, default="")

    principal_name = models.CharField(max_length=255, blank=True, default="")
    principal_email = models.EmailField()

    operator_name = models.CharField(max_length=255, blank=True, default="")
    operator_email = models.EmailField(blank=True, default="")

    # "Local language" used as the 3rd language in WhatsApp messages and video page.
    # Keep it flexible: you can store "mr", "te", etc. If not configured, fallback happens in code.
    local_language_code = models.CharField(max_length=12, blank=True, default="")

    onboarding_completed_at = models.DateTimeField(null=True, blank=True)

    created_at = models.DateTimeField(default=timezone.now, editable=False)
    updated_at = models.DateTimeField(auto_now=True)

    def is_authorized_admin_email(self, email: str) -> bool:
        if not email:
            return False
        e = email.strip().lower()
        pe = (self.principal_email or "").strip().lower()
        oe = (self.operator_email or "").strip().lower()
        return e == pe or (oe and e == oe)

    def __str__(self) -> str:
        return f"ScreeningSchoolProfile({self.organization_id})"


class ScreeningTermsAcceptance(models.Model):
    """
    Records one-time (versioned) acceptance of Screening Program terms/conditions
    per user, per organization, and per actor role (ORG_ADMIN / TEACHER).
    """
    class ActorRole(models.TextChoices):
        ORG_ADMIN = "ORG_ADMIN", "School Admin"
        TEACHER = "TEACHER", "Teacher"

    organization = models.ForeignKey(
        "accounts.Organization",
        on_delete=models.CASCADE,
        related_name="screening_only_terms_acceptances",
    )
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="screening_only_terms_acceptances",
    )
    actor_role = models.CharField(max_length=16, choices=ActorRole.choices)
    version = models.CharField(max_length=32, default="v1")
    accepted_at = models.DateTimeField(default=timezone.now)

    # Optional audit metadata
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.CharField(max_length=255, blank=True, default="")

    class Meta:
        unique_together = ("organization", "user", "actor_role", "version")

    def __str__(self) -> str:
        return f"TermsAcceptance({self.organization_id},{self.user_id},{self.actor_role},{self.version})"

================================================================================
FILE: screening_only\services.py
================================================================================

from __future__ import annotations
from messaging.services import whatsapp_click_to_chat_url
from collections import defaultdict
from dataclasses import dataclass
from datetime import date, datetime
from typing import Dict, Iterable, List, Optional, Tuple

from django.conf import settings
from django.core import signing
from django.db.models import Count
from django.utils import timezone
from django.utils.text import slugify

from accounts.models import Organization
from messaging.models import MessageLog
#from messaging.services import click_to_chat_url
from messaging.i18n import flags_to_text
from roster.services import _grades_nursery_to_12
DEFAULT_GRADES=_grades_nursery_to_12()

from screening.models import Screening
import uuid
from django.urls import reverse

PARENT_TOKEN_SALT = "screening_only_parent_v1"
TERMS_VERSION = "v1"

# Academic year configuration (India often June -> May)
ACADEMIC_YEAR_START_MONTH = getattr(settings, "SCREENING_ACADEMIC_YEAR_START_MONTH", 6)


def unique_screening_token(org_name: str) -> str:
    from django.utils.crypto import get_random_string

    base = slugify(org_name)[:48] or "school"
    for _ in range(10):
        token = f"{base}-{get_random_string(8)}"
        if not Organization.objects.filter(screening_link_token=token).exists():
            return token
    # Extremely unlikely
    return f"{base}-{get_random_string(12)}"


def academic_year_label_for_date(d: date, start_month: int = ACADEMIC_YEAR_START_MONTH) -> str:
    if d.month < start_month:
        start_year = d.year - 1
    else:
        start_year = d.year
    end_year = start_year + 1
    return f"{start_year}-{str(end_year)[-2:]}"


def academic_year_range(label: str, start_month: int = ACADEMIC_YEAR_START_MONTH) -> Tuple[datetime, datetime]:
    """
    label like "2024-25" -> returns [2024-06-01 00:00, 2025-06-01 00:00) in server timezone.
    """
    label = (label or "").strip()
    if not label or "-" not in label:
        today = timezone.localdate()
        label = academic_year_label_for_date(today, start_month=start_month)

    start_year_str = label.split("-")[0]
    start_year = int(start_year_str)
    end_year = start_year + 1

    start_dt = datetime(start_year, start_month, 1, 0, 0, 0, tzinfo=timezone.get_current_timezone())
    end_dt = datetime(end_year, start_month, 1, 0, 0, 0, tzinfo=timezone.get_current_timezone())
    return start_dt, end_dt


def available_academic_years(org: Organization, years_back: int = 5) -> List[str]:
    today = timezone.localdate()
    current = academic_year_label_for_date(today)
    # Simple last N options; can be refined if you want min/max from Screening data.
    start_year = int(current.split("-")[0])
    labels = []
    for y in range(start_year - years_back + 1, start_year + 1):
        labels.append(f"{y}-{str(y+1)[-2:]}")
    return list(reversed(labels))


def _grade_rank_map() -> Dict[str, int]:
    #DEFAULT_GRADES includes Nursery, K.G., 1..12
    ranks = {}
    for idx, g in enumerate(DEFAULT_GRADES):
        ranks[str(g)] = idx
    return ranks


def screening_counts_by_class(org: Organization, start_dt: datetime, end_dt: datetime) -> List[dict]:
    """
    Returns rows like:
      {"grade": "4", "division": "C", "screened_once": 12, "screened_twice": 3, "total_students": 15}
    computed based on number of Screening rows per student in the given range.
    """
    ranks = _grade_rank_map()

    qs = (
        Screening.objects
        .filter(organization=org, screened_at__gte=start_dt, screened_at__lt=end_dt)
        .values(
            "student_id",
            "student__classroom_id",
            "student__classroom__grade",
            "student__classroom__division",
        )
        .annotate(n=Count("id"))
    )

    by_classroom = defaultdict(lambda: {"grade": "", "division": "", "screened_once": 0, "screened_twice": 0, "total_students": 0})
    for row in qs:
        key = row["student__classroom_id"] or 0
        d = by_classroom[key]
        d["grade"] = row["student__classroom__grade"] or ""
        d["division"] = row["student__classroom__division"] or ""
        if row["n"] >= 2:
            d["screened_twice"] += 1
        elif row["n"] == 1:
            d["screened_once"] += 1
        d["total_students"] += 1

    rows = list(by_classroom.values())

    def _sort_key(r: dict):
        g = str(r.get("grade") or "")
        return (ranks.get(g, 10_000), str(r.get("division") or ""))

    rows.sort(key=_sort_key)
    return rows


def build_parent_token(screening_id: int) -> str:
    return signing.dumps({"sid": screening_id}, salt=PARENT_TOKEN_SALT, compress=True)


def parse_parent_token(token: str) -> int:
    data = signing.loads(token, salt=PARENT_TOKEN_SALT)
    return int(data["sid"])


# ---------------------------------------------------------------------------
# Screening Program: Parent WhatsApp message (NO RED-FLAG NAMING)
# Source text: NutriLift_Parent_WhatsApp_Message_NoRedFlag_Multilingual.docx
# ---------------------------------------------------------------------------

PARENT_WHATSAPP_MESSAGE_TEMPLATES = {
    "en": "\n".join([
        "Dear Parent/Guardian,",
        "This is <teacher name>, class teacher (<school name>). On <date>, we did the routine twice-a-year growth & nutrition screening for your child (Class <class/div>).",
        "We:",
        "measured height and weight; and",
        "asked your child a few simple questions. Your child answered, and I recorded the answers in the screening form.",
        "Based on the measurements and answers, the screening tool recommends a children’s doctor (pediatrician) check. Please show this message to the doctor.",
        "Please watch this short video for simple guidance: <video/page link>",
        "Please note:",
        "A child’s answers can sometimes be wrong or incomplete.",
        "If any measurement/answer is wrong, please contact me to do the screening again.",
        "Important:",
        "This is a school screening message. It is not a medical diagnosis.",
        "Please do not forward this message.",
        "If you received this message by mistake, reply “WRONG NUMBER” and delete it.",
        "Questions and measurements / your child’s answers:",
        "<questions and answers>",
    ]),
    "hi": "\n".join([
        "प्रिय माता-पिता/अभिभावक,",
        "यह <teacher name> है, आपके बच्चे का (कक्षा <class/div>) कक्षा अध्यापक/अध्यापिका (<school name>)। <date> को हमने आपके बच्चे की नियमित (वर्ष में दो बार) वृद्धि और पोषण की जांच की।",
        "हमने:",
        "बच्चे की लंबाई और वजन मापा; और",
        "कुछ आसान प्रश्न बच्चे से पूछे। आपके बच्चे ने उत्तर दिए और मैंने उन्हें जांच फॉर्म में दर्ज किया।",
        "इन मापों और उत्तरों के आधार पर, स्क्रीनिंग टूल बच्चों के डॉक्टर (बाल रोग विशेषज्ञ) से जांच कराने की सलाह देता है। कृपया यह संदेश डॉक्टर को दिखाएं।",
        "सरल जानकारी के लिए कृपया यह छोटा वीडियो देखें: <video/page link>",
        "कृपया ध्यान दें:",
        "बच्चों के उत्तर कभी-कभी गलत या अधूरे हो सकते हैं।",
        "यदि कोई माप/उत्तर गलत है, तो कृपया मुझसे संपर्क करें ताकि हम फिर से जांच कर सकें।",
        "महत्वपूर्ण:",
        "यह स्कूल की स्क्रीनिंग है, यह कोई मेडिकल निदान नहीं है।",
        "कृपया इस संदेश को आगे न भेजें।",
        "यदि यह संदेश आपको गलती से मिला है, तो “WRONG NUMBER” लिखकर जवाब दें और संदेश को हटा दें।",
        "प्रश्न और माप / आपके बच्चे के उत्तर:",
        "<questions and answers>",
    ]),
    "ta": "\n".join([
        "அன்பார்ந்த பெற்றோர்/ பாதுகாவலர்,",
        "இது உங்கள் குழந்தையின் வகுப்பு (வகுப்பு <class/div>) ஆசிரியர்/ஆசிரியையாகிய <teacher name>, (<school name>) . <date> அன்று நாங்கள் குழந்தைகளுக்கான வழக்கமான ஆண்டுக்கு இரண்டு முறை வளர்ச்சி மற்றும் ஊட்டச்சத்து பரிசோதனையை மேற்கொண்டோம்.",
        "நாங்கள்:",
        "குழந்தைகளின் உயரம் மற்றும் எடையை அளந்தோம்; மற்றும்",
        "குழந்தையிடம் சில எளிய கேள்விகளைக் கேட்டோம். உங்கள் குழந்தை பதிலளித்தது, நான் அந்த பதில்களை பரிசோதனைப் படிவத்தில் பதிவு செய்தேன்.",
        "அளவீடுகள் மற்றும் பதில்களின் அடிப்படையில், பரிசோதனைக் கருவி ஒரு குழந்தைகள் மருத்துவர் (குழந்தை நல மருத்துவர்) பரிசோதனையை பரிந்துரைக்கிறது. தயவுசெய்து இந்தச் செய்தியை மருத்துவரிடம் காட்டுங்கள்.",
        "எளிய வழிகாட்டுதலுக்கு இந்த குறுகிய வீடியோவைப் பாருங்கள்: <video/page link>",
        "தயவுசெய்து கவனத்தில் கொள்ளுங்கள்:",
        "குழந்தையின் பதில்கள் சில நேரங்களில் தவறாகவோ முழுமையற்றதாகவோ இருக்கலாம்.",
        "ஏதேனும் அளவீடு/பதில் தவறாக இருந்தால், மீண்டும் பரிசோதனை செய்ய என்னை தொடர்பு கொள்ளுங்கள்.",
        "முக்கியம்:",
        "இது ஒரு பள்ளி பரிசோதனை செய்தி. இது ஒரு மருத்துவ நோயறிதல் அல்ல.",
        "தயவுசெய்து இந்தச் செய்தியை மற்றவர்களுக்கு அனுப்ப வேண்டாம்.",
        "நீங்கள் தவறுதலாக இந்தச் செய்தியைப் பெற்றிருந்தால், “WRONG NUMBER” என்று பதிலளித்து அதை நீக்குங்கள்.",
        "கேள்விகள் மற்றும் அளவீடுகள் / உங்கள் குழந்தையின் பதில்கள்:",
        "<questions and answers>",
    ]),
    "te": "\n".join([
        "ప్రియమైన తల్లిదండ్రులకు/సంరక్షకులకు,",
        "ఇది <teacher name>, మీ పిల్లల (తరగతి <class/div>) క్లాస్ టీచర్ (<school name>). <date>నాడు, మీ పిల్లల కోసం సంవత్సరానికి రెండుసార్లు నిర్వహించే సాధారణ గ్రోత్ మరియు పోషణ పరీక్ష చేశాము.",
        "మేము:",
        "మీ పిల్లల ఎత్తు మరియు బరువు కొలిచాము; మరియు",
        "మీ పిల్లలను కొన్ని సాధారణ ప్రశ్నలు అడిగాము. మీ పిల్లలు సమాధానాలు ఇచ్చారు, నేను వాటిని స్క్రీనింగ్ ఫారంలో నమోదు చేశాను.",
        "కొలతలు మరియు సమాధానాల ఆధారంగా, స్క్రీనింగ్ టూల్ పిల్లల వైద్యుడు (పీడియాట్రిషియన్) చెక్ సిఫారసు చేస్తుంది. దయచేసి ఈ మెసేజ్‌ను డాక్టర్‌కు చూపించండి.",
        "సులభమైన మార్గదర్శకానికి ఈ చిన్న వీడియో చూడండి: <video/page link>",
        "దయచేసి గమనించండి:",
        "కొన్ని సార్లు పిల్లల సమాధానాలు తప్పు లేదా అసంపూర్ణంగా ఉండవచ్చు.",
        "ఏదైనా కొలత/సమాధానం తప్పు ఉంటే, దయచేసి నన్ను సంప్రదించి స్క్రీనింగ్ మళ్లీ చేయించండి.",
        "ముఖ్యమైనది:",
        "ఇది స్కూల్ స్క్రీనింగ్ మెసేజ్. ఇది మెడికల్ డయాగ్నసిస్ కాదు.",
        "దయచేసి ఈ సందేశాన్ని ఫార్వర్డ్ చేయవద్దు.",
        "మీకు ఈ సందేశం పొరపాటున అందితే, “WRONG NUMBER” అని జవాబు ఇచ్చి డిలీట్ చేయండి.",
        "ప్రశ్నలు మరియు కొలతలు / మీ పిల్లల సమాధానాలు:",
        "<questions and answers>",
    ]),
    "ml": "\n".join([
        "പ്രിയപ്പെട്ട രക്ഷിതാവിന്/രക്ഷകര്‍ത്താവിന്,",
        "ഞാൻ <teacher name> ആണ്, നിങ്ങളുടെ കുട്ടിയുടെ (ക്ലാസ് <class/div>) ക്ലാസ് ടീച്ചര്‍ (<school name>). <date> ന്, നിങ്ങളുടെ കുട്ടിയുടെ പതിവ് (വർഷത്തിൽ രണ്ട് തവണ) വളർച്ചയും പോഷകാഹാര പരിശോധനയും നടത്തി.",
        "ഞങ്ങൾ:",
        "കുട്ടിയുടെ ഉയരവും ഭാരവും അളന്നു; കൂടാതെ",
        "കുട്ടിയോട് കുറച്ച് ലളിതമായ ചോദ്യങ്ങൾ ചോദിച്ചു. നിങ്ങളുടെ കുട്ടി മറുപടി പറഞ്ഞു, ഞാൻ അത് സ്ക്രീനിംഗ് ഫോമിൽ രേഖപ്പെടുത്തി.",
        "അളവുകളും മറുപടികളും അടിസ്ഥാനമാക്കി, സ്ക്രീനിംഗ് ടൂൾ കുട്ടികളുടെ ഡോക്ടർ (പീഡിയാട്രിഷ്യൻ) പരിശോധന ശുപാർശ ചെയ്യുന്നു. ദയവായി ഈ സന്ദേശം ഡോക്ടറെ കാണിക്കുക.",
        "ലളിതമായ മാർഗ്ഗനിർദ്ദേശത്തിനായി ഈ ചെറിയ വീഡിയോ കാണുക: <video/page link>",
        "ദയവായി ശ്രദ്ധിക്കുക:",
        "കുട്ടികളുടെ മറുപടികൾ ചിലപ്പോൾ തെറ്റായതോ അപൂർണമായതോ ആയിരിക്കാം.",
        "ഏതെങ്കിലും അളവ്/മറുപടി തെറ്റാണെങ്കില്‍, ദയവായി എന്നെ ബന്ധപ്പെടുക, സ്ക്രീനിംഗ് വീണ്ടും ചെയ്യാനായി.",
        "പ്രധാനപ്പെട്ടത്:",
        "ഇത് സ്കൂൾ സ്ക്രീനിംഗ് സന്ദേശമാണ്. ഇത് ഒരു മെഡിക്കൽ രോഗനിർണയം അല്ല.",
        "ദയവായി ഈ സന്ദേശം ഫോർവേഡ് ചെയ്യരുത്.",
        "ഈ സന്ദേശം നിങ്ങൾക്ക് തെറ്റായി ലഭിച്ചതാണെങ്കിൽ, “WRONG NUMBER” എന്ന് മറുപടി നൽകി അത് ഡിലീറ്റ് ചെയ്യുക.",
        "ചോദ്യങ്ങളും അളവുകളും / നിങ്ങളുടെ കുട്ടിയുടെ മറുപടികൾ:",
        "<questions and answers>",
    ]),
    "kn": "\n".join([
        "ಪ್ರಿಯ ಪೋಷಕರೇ/ರಕ್ಷಕರೇ,",
        "ನಾನು <teacher name>, ನಿಮ್ಮ ಮಗುವಿನ (ವರ್ಗ <class/div>) ತರಗತಿ ಶಿಕ್ಷಕ/ಶಿಕ್ಷಕಿಯಾಗಿದ್ದು (<school name>). <date> ರಂದು ನಾವು ನಿಮ್ಮ ಮಗುವಿಗಾಗಿ ವರ್ಷದ ಎರಡು ಬಾರಿ ನಡೆಯುವ ಸಾಮಾನ್ಯ ಬೆಳವಣಿಗೆ ಮತ್ತು ಪೌಷ್ಟಿಕಾಂಶ ತಪಾಸಣೆಯನ್ನು ಮಾಡಿದೆವು.",
        "ನಾವು:",
        "ಮಗುವಿನ ಎತ್ತರ ಮತ್ತು ತೂಕವನ್ನು ಅಳೆಯಿತು; ಮತ್ತು",
        "ಮಗುವಿಗೆ ಕೆಲವು ಸರಳ ಪ್ರಶ್ನೆಗಳನ್ನು ಕೇಳಿದೆವು. ನಿಮ್ಮ ಮಗು ಉತ್ತರಿಸಿತು, ನಾನು ಆ ಉತ್ತರಗಳನ್ನು ತಪಾಸಣೆ ಫಾರ್ಮ್‌ನಲ್ಲಿ ದಾಖಲಿಸಿದೆನು.",
        "ಅಳತೆಗಳು ಮತ್ತು ಉತ್ತರಗಳ ಆಧಾರದ ಮೇಲೆ, ತಪಾಸಣೆ ಉಪಕರಣವು ಮಕ್ಕಳ ವೈದ್ಯರು (ಪೀಡಿಯಾಟ್ರಿಷಿಯನ್) ಪರಿಶೀಲನೆ ಮಾಡಿಸಲು ಸಲಹೆ ನೀಡುತ್ತದೆ. ದಯವಿಟ್ಟು ಈ ಸಂದೇಶವನ್ನು ವೈದ್ಯರಿಗೆ ತೋರಿಸಿ.",
        "ಸರಳ ಮಾರ್ಗದರ್ಶನಕ್ಕಾಗಿ ಈ ಚಿಕ್ಕ ವೀಡಿಯೊವನ್ನು ನೋಡಿ: <video/page link>",
        "ದಯವಿಟ್ಟು ಗಮನಿಸಿ:",
        "ಮಗುವಿನ ಉತ್ತರಗಳು ಕೆಲವೊಮ್ಮೆ ತಪ್ಪಾಗಿರಬಹುದು ಅಥವಾ ಅಪೂರ್ಣವಾಗಿರಬಹುದು.",
        "ಯಾವುದೇ ಅಳತೆ/ಉತ್ತರ ತಪ್ಪಿದ್ದರೆ, ದಯವಿಟ್ಟು ನನ್ನನ್ನು ಸಂಪರ್ಕಿಸಿ ಮತ್ತೆ ತಪಾಸಣೆ ಮಾಡಿಸಿ.",
        "ಮುಖ್ಯ:",
        "ಇದು ಶಾಲಾ ತಪಾಸಣೆ ಸಂದೇಶ. ಇದು ವೈದ್ಯಕೀಯ ನಿರ್ಣಯವಲ್ಲ.",
        "ದಯವಿಟ್ಟು ಈ ಸಂದೇಶವನ್ನು ಫಾರ್ವರ್ಡ್ ಮಾಡಬೇಡಿ.",
        "ನೀವು ಈ ಸಂದೇಶವನ್ನು ತಪ್ಪಾಗಿ ಪಡೆದಿದ್ದರೆ, “WRONG NUMBER” ಎಂದು ಉತ್ತರಿಸಿ ಮತ್ತು ಅದನ್ನು ಅಳಿಸಿ.",
        "ಪ್ರಶ್ನೆಗಳು ಮತ್ತು ಅಳತೆಗಳು / ನಿಮ್ಮ ಮಗುವಿನ ಉತ್ತರಗಳು:",
        "<questions and answers>",
    ]),
    "mr": "\n".join([
        "प्रिय पालक/संरक्षक,",
        "मी <teacher name> आहे, तुमच्या मुलाचा/मुलीचा (इयत्ता <class/div>) वर्गशिक्षक/वर्गशिक्षिका (<school name>)। <date> रोजी, आम्ही तुमच्या मुलाचे नियमित (वर्षातून दोन वेळा) वाढ आणि पोषण तपासणी केली.",
        "आम्ही:",
        "मुलाची उंची आणि वजन मोजले; आणि",
        "मुलाला काही सोपे प्रश्न विचारले. तुमच्या मुलाने उत्तरे दिली आणि मी ती तपासणी फॉर्ममध्ये नोंदवली.",
        "मोजमापे आणि उत्तरांच्या आधारे, स्क्रीनिंग टूल मुलांच्या डॉक्टर (बालरोग तज्ञ) तपासणीची शिफारस करते. कृपया हा संदेश डॉक्टरांना दाखवा.",
        "सोप्या मार्गदर्शनासाठी हा छोटा व्हिडिओ बघा: <video/page link>",
        "कृपया लक्षात घ्या:",
        "कधी कधी मुलांची उत्तरे चुकीची किंवा अपूर्ण असू शकतात.",
        "जर कोणतेही मोजमाप/उत्तर चुकीचे असेल, तर कृपया माझ्याशी संपर्क साधा, जेणेकरून आम्ही स्क्रीनिंग पुन्हा करू शकू.",
        "महत्वाचे:",
        "हा शाळेचा स्क्रीनिंग संदेश आहे. हे वैद्यकीय निदान नाही.",
        "कृपया हा संदेश पुढे पाठवू नका.",
        "जर तुम्हाला हा संदेश चुकून मिळाला असेल, तर “WRONG NUMBER” असे उत्तर द्या आणि तो हटवा.",
        "प्रश्न आणि मोजमापे / तुमच्या मुलाची उत्तरे:",
        "<questions and answers>",
    ]),
    "bn": "\n".join([
        "প্রিয় অভিভাবক/অভিভাবিকা,",
        "আমি <teacher name>, আপনার সন্তানের (শ্রেণী <class/div>) শ্রেণী শিক্ষক/শিক্ষিকা (<school name>)। <date> তারিখে আমরা আপনার সন্তানের নিয়মিত (বছরে দুবার) বৃদ্ধি ও পুষ্টি পরীক্ষা করেছি।",
        "আমরা:",
        "সন্তানের উচ্চতা ও ওজন মেপেছি; এবং",
        "সন্তানকে কয়েকটি সহজ প্রশ্ন করেছি। আপনার সন্তান উত্তর দিয়েছে এবং আমি সেই উত্তরগুলি স্ক্রীনিং ফর্মে লিখেছি।",
        "পরিমাপ এবং উত্তরগুলির ভিত্তিতে, স্ক্রীনিং টুল শিশুদের ডাক্তার (পেডিয়াট্রিশিয়ান) দ্বারা পরীক্ষা করার পরামর্শ দেয়। অনুগ্রহ করে এই বার্তাটি ডাক্তারকে দেখান।",
        "সহজ নির্দেশনার জন্য এই ছোট ভিডিওটি দেখুন: <video/page link>",
        "অনুগ্রহ করে মনে রাখবেন:",
        "সন্তানের উত্তর কখনও কখনও ভুল বা অসম্পূর্ণ হতে পারে।",
        "যদি কোনও পরিমাপ/উত্তর ভুল হয়, অনুগ্রহ করে আমার সাথে যোগাযোগ করুন যাতে আমরা আবার স্ক্রীনিং করতে পারি।",
        "গুরুত্বপূর্ণ:",
        "এটি একটি স্কুল স্ক্রীনিং বার্তা। এটি কোনও চিকিৎসা নির্ণয় নয়।",
        "অনুগ্রহ করে এই বার্তাটি ফরোয়ার্ড করবেন না।",
        "আপনি যদি ভুলবশত এই বার্তাটি পেয়ে থাকেন, তাহলে “WRONG NUMBER” লিখে উত্তর দিন এবং এটি মুছে ফেলুন।",
        "প্রশ্ন ও পরিমাপ / আপনার সন্তানের উত্তর:",
        "<questions and answers>",
    ]),
}

def _normalize_form_language(lang: str) -> str:
    """
    Normalize a language code coming from the teacher UI.
    Supported: en, mr, hi, te, ta, ml, kn, bn
    """
    lang = (lang or "").strip().lower()
    if not lang:
        return "mr"
    # tolerate "hi-IN", etc.
    lang = lang.split("-", 1)[0]
    if lang not in PARENT_WHATSAPP_MESSAGE_TEMPLATES:
        return "mr"
    return lang


def _render_parent_whatsapp_message(
    *,
    lang: str,
    teacher_name: str,
    school_name: str,
    date_str: str,
    class_div: str,
    video_url: str,
    questions_and_answers: str,
) -> str:
    template = PARENT_WHATSAPP_MESSAGE_TEMPLATES.get(lang) or PARENT_WHATSAPP_MESSAGE_TEMPLATES["mr"]
    msg = template
    replacements = {
        "<teacher name>": teacher_name or "",
        "<school name>": school_name or "",
        "<date>": date_str or "",
        "<class/div>": class_div or "",
        "<video/page link>": video_url or "",
        "<questions and answers>": (questions_and_answers or "").strip() or "-",
    }
    for k, v in replacements.items():
        msg = msg.replace(k, v)
    return msg


def _screening_parent_whatsapp_idempotency_key(screening_id: int, pid: str) -> str:
    """One message per (screening, pid)."""
    raw = f"SCREENING_PARENT_WHATSAPP_V1|{screening_id}|{pid}"
    return str(uuid.uuid5(uuid.NAMESPACE_URL, raw))


def prepare_screening_only_redflag_click_to_chat(
    request,
    screening: "Screening",
    *,
    form_language: str = "",
    questions_and_answers: str = "",
    to_phone_e164: str = "",
) -> Tuple[Optional[MessageLog], str]:
    """
    Returns (MessageLog, wa_url). Does NOT store phone or payload in MessageLog.
    Stores only pid + metadata.
    """
    org = screening.organization
    student = screening.student

    pid = (getattr(screening, "pid", "") or getattr(student, "pid", "") or "").strip()

    phone = (to_phone_e164 or "").strip()
    if not phone:
        return None, ""

    lang = _normalize_form_language(form_language)

    teacher_name = ""
    try:
        u = getattr(request, "user", None)
        if u and getattr(u, "is_authenticated", False):
            teacher_name = (u.get_full_name() or "").strip()
            if not teacher_name:
                teacher_name = (getattr(u, "email", "") or getattr(u, "username", "") or "").strip()
    except Exception:
        teacher_name = ""
    if not teacher_name:
        teacher_name = "Class Teacher"

    school_name = (getattr(org, "name", "") or "").strip()
    date_str = timezone.localtime(screening.screened_at).strftime("%d-%m-%Y")

    classroom = getattr(student, "classroom", None)
    class_div = str(classroom) if classroom else ""

    parent_token = build_parent_token(screening.id)
    video_url = request.build_absolute_uri(reverse("screening_only:parent_video", args=[parent_token]))

    prefill_text = _render_parent_whatsapp_message(
        lang=lang,
        teacher_name=teacher_name,
        school_name=school_name,
        date_str=date_str,
        class_div=class_div,
        video_url=video_url,
        questions_and_answers=questions_and_answers,
    )

    wa_url = whatsapp_click_to_chat_url(phone, prefill_text)

    idem = _screening_parent_whatsapp_idempotency_key(screening.id, pid)
    existing = MessageLog.objects.filter(idempotency_key=idem).first()
    if existing:
        return existing, wa_url

    log = MessageLog.objects.create(
        idempotency_key=idem,
        organization=org,
        pid=pid,
        channel="whatsapp",
        template_code="SCREENING_ONLY_PARENT_NO_REDFLAG_V1",
        language=lang,
        status=MessageLog.Status.QUEUED,
        related_screening=screening,
    )
    return log, wa_url
================================================================================
FILE: screening_only\teacher_terms_content.py
================================================================================

from __future__ import annotations

# Language drop-down options. Labels are in the same script as the language.
# Order requested: English, Marathi, Hindi, Telugu, Tamil, Malayalam, Kannada, Bengali
LANG_OPTIONS = [
    ('en', 'English'),
    ('mr', 'मराठी'),
    ('hi', 'हिन्दी'),
    ('te', 'తెలుగు'),
    ('ta', 'தமிழ்'),
    ('ml', 'മലയാളം'),
    ('kn', 'ಕನ್ನಡ'),
    ('bn', 'বাংলা'),
]

# Default language for the Terms page (Marathi)
DEFAULT_LANG = 'mr'

# Terms & Conditions text, split into display paragraphs.
TERMS_BY_LANG = {
    'en': [
        'NutriLift Screening Platform — Class Teacher Authorised User Terms',
        'By clicking "I Agree", you confirm you are using the Platform only as an Authorised User of your School.',
        '1. Authorised use only',
        '1.1 You will screen only students assigned to you by the School and only for the NutriLift Screening Program.',
        '1.2 You acknowledge the School is the Data Fiduciary; you are acting as the School’s authorised agent.',
        '2. Data entry accuracy and integrity',
        '2.1 You will follow the measurement SOP and enter values accurately; you will re-check outliers or obvious errors before submission.',
        '2.2 You will not guess sensitive attributes. If a field requires classification (e.g., "low income / not-low"), you will follow the School’s documented criterion and not make discretionary judgments beyond that criterion.',
        '3. WhatsApp message handling (high-risk step)',
        '3.1 Before opening WhatsApp, you will confirm the parent/guardian number is correct (recommended: verify last 4 digits with school records or the parent).',
        '3.2 Before sending, you will read the entire pre-populated message to ensure it corresponds to the correct child and correct entries.',
        '3.3 You will not forward the message content to groups or third parties.',
        '3.4 If you believe you sent a message to the wrong recipient, you will immediately notify School leadership and follow the incident SOP.',
        '4. Privacy and device security',
        '4.1 You will use only a secured device (screen lock enabled; do not share device; keep OS updated).',
        '4.2 You will not take screenshots, export data, maintain parallel spreadsheets, or store child health details outside approved School channels.',
        '5. No diagnosis and appropriate communication',
        '5.1 You acknowledge outputs are screening indicators, not diagnoses. Parents must be directed to consult qualified clinicians as appropriate.',
        '6. Compliance, logging, and audits',
        '6.1 You acknowledge your use may be logged for program integrity and security purposes.',
        '6.2 You will cooperate with any investigation into suspected misuse or security incidents.',
        '7. Consequences',
        '7.1 Breach of these terms can lead to suspension of access and may trigger School disciplinary action.',
    ],

    'mr': [
        'NutriLift Screening Platform — वर्गशिक्षक अधिकृत वापरकर्ता अटी',
        '"I Agree" वर क्लिक करून, आपण हे प्लॅटफॉर्म केवळ आपल्या शाळेचे अधिकृत वापरकर्ता म्हणूनच वापरत आहात, याची आपण खात्री देता.',
        '1. केवळ अधिकृत वापर',
        '1.1 शाळेने आपल्याला दिलेल्या विद्यार्थ्यांचीच आणि फक्त NutriLift Screening कार्यक्रमासाठीच आपण तपासणी (स्क्रीनिंग) कराल.',
        '1.2 शाळाच Data Fiduciary (डेटा फिड्यूशियरी) आहे, हे आपण मान्य करता; आपण शाळेच्या अधिकृत प्रतिनिधी/एजंट म्हणून काम करता.',
        '2. डेटा नोंदीची अचूकता आणि प्रामाणिकता',
        '2.1 मोजमाप SOP (Standard Operating Procedure) चे पालन करून मूल्ये अचूकपणे नोंदवाल; सबमिट करण्यापूर्वी अपवादात्मक/असामान्य मूल्ये किंवा स्पष्ट चुका पुन्हा तपासाल.',
        '2.2 संवेदनशील गुणधर्मांचा आपण अंदाज लावणार नाही. एखाद्या फील्डमध्ये वर्गीकरण आवश्यक असल्यास (उदा., "कमी उत्पन्न / कमी नाही"), शाळेने दिलेल्या लिखित निकषांचे पालन कराल आणि त्या निकषांपलीकडे स्वेच्छाधारित निर्णय घेणार नाही.',
        '3. WhatsApp संदेश हाताळणी (उच्च-जोखीम पाऊल)',
        '3.1 WhatsApp उघडण्यापूर्वी पालक/पालक-प्रतिनिधीचा नंबर योग्य आहे याची खात्री कराल (शिफारस: शाळेच्या नोंदींशी किंवा पालकाशी शेवटचे 4 अंक पडताळा).',
        '3.2 पाठवण्यापूर्वी, पूर्व-भरलेला संपूर्ण संदेश वाचून तो योग्य मुलाशी व योग्य नोंदींशी संबंधित आहे याची खात्री कराल.',
        '3.3 संदेशातील मजकूर गटांमध्ये किंवा तृतीय पक्षांना फॉरवर्ड करणार नाही.',
        '3.4 चुकीच्या व्यक्तीस संदेश गेला असे वाटल्यास, त्वरित शाळेच्या नेतृत्वाला कळवून घटना SOP चे पालन कराल.',
        '4. गोपनीयता आणि उपकरण सुरक्षा',
        '4.1 फक्त सुरक्षित उपकरण वापराल (स्क्रीन लॉक सुरू; उपकरण शेअर करू नका; OS अद्ययावत ठेवा).',
        '4.2 स्क्रीनशॉट घेणार नाही, डेटा एक्सपोर्ट करणार नाही, स्वतंत्र स्प्रेडशीट ठेवणार नाही, आणि शाळेने मान्य केलेल्या चॅनेल्सच्या बाहेर मुलांची आरोग्यविषयक माहिती साठवणार नाही.',
        '5. निदान नाही आणि योग्य संवाद',
        '5.1 आउटपुट हे फक्त screening संकेत आहेत, निदान नाही, हे आपण मान्य करता. आवश्यकतेनुसार पालकांना पात्र डॉक्टरांचा सल्ला घेण्यास सांगितले पाहिजे.',
        '6. अनुपालन, लॉगिंग आणि ऑडिट',
        '6.1 कार्यक्रमाची प्रामाणिकता व सुरक्षा यासाठी आपल्या वापराची लॉगिंग होऊ शकते, हे आपण मान्य करता.',
        '6.2 संशयास्पद गैरवापर किंवा सुरक्षा घटनेबाबतच्या कोणत्याही तपासात आपण सहकार्य कराल.',
        '7. परिणाम',
        '7.1 या अटींचा भंग झाल्यास आपला प्रवेश निलंबित होऊ शकतो आणि शाळा शिस्तभंग कारवाई करू शकते.',
    ],

    'hi': [
        'न्यूट्रिलिफ्ट स्क्रीनिंग प्लेटफ़ॉर्म — कक्षा शिक्षक के लिए अधिकृत उपयोगकर्ता शर्तें',
        '“I Agree” पर क्लिक करके, आप पुष्टि करते हैं कि आप इस प्लेटफ़ॉर्म का उपयोग केवल अपने विद्यालय के अधिकृत उपयोगकर्ता के रूप में कर रहे/रही हैं।',
        '1. केवल अधिकृत उपयोग',
        '1.1 आप केवल उन्हीं विद्यार्थियों की स्क्रीनिंग करेंगे जिन्हें विद्यालय ने आपको सौंपा है, और केवल न्यूट्रिलिफ्ट स्क्रीनिंग कार्यक्रम के लिए।',
        '1.2 आप स्वीकार करते हैं कि विद्यालय Data Fiduciary (डेटा फिड्यूशियरी) है; आप विद्यालय के अधिकृत प्रतिनिधि/एजेंट के रूप में कार्य कर रहे/रही हैं।',
        '2. डेटा प्रविष्टि की शुद्धता और ईमानदारी',
        '2.1 आप माप संबंधी SOP (Standard Operating Procedure) का पालन करेंगे और मान सही-सही दर्ज करेंगे; सबमिट करने से पहले असामान्य मान या स्पष्ट त्रुटियों को दोबारा जाँचेंगे।',
        '2.2 आप संवेदनशील गुणों का अनुमान नहीं लगाएंगे। यदि किसी फ़ील्ड में वर्गीकरण चाहिए (उदा., "कम आय / कम नहीं"), तो आप विद्यालय के लिखित मानदंड का पालन करेंगे और उसके बाहर अपना अनुमान/निर्णय नहीं करेंगे।',
        '3. WhatsApp संदेश प्रबंधन (उच्च-जोखिम चरण)',
        '3.1 WhatsApp खोलने से पहले, आप यह सुनिश्चित करेंगे कि माता-पिता/अभिभावक का नंबर सही है (सुझाव: विद्यालय रिकॉर्ड या अभिभावक से अंतिम 4 अंक मिलान करें)।',
        '3.2 भेजने से पहले, आप पूरा पूर्व-भरा संदेश पढ़ेंगे ताकि यह सुनिश्चित हो सके कि यह सही बच्चे और सही प्रविष्टियों से संबंधित है।',
        '3.3 आप संदेश की सामग्री को समूहों या किसी तीसरे व्यक्ति को फ़ॉरवर्ड नहीं करेंगे।',
        '3.4 यदि आपको लगे कि संदेश गलत प्राप्तकर्ता को चला गया है, तो आप तुरंत विद्यालय प्रशासन/नेतृत्व को सूचित करेंगे और घटना SOP का पालन करेंगे।',
        '4. गोपनीयता और डिवाइस सुरक्षा',
        '4.1 आप केवल सुरक्षित डिवाइस का उपयोग करेंगे (स्क्रीन लॉक चालू; डिवाइस साझा नहीं; OS अपडेट रखें)।',
        '4.2 आप स्क्रीनशॉट नहीं लेंगे, डेटा एक्सपोर्ट नहीं करेंगे, अलग से स्प्रेडशीट नहीं बनाएंगे, और विद्यालय के स्वीकृत चैनलों के बाहर बच्चे के स्वास्थ्य से जुड़ी जानकारी नहीं रखेंगे।',
        '5. निदान नहीं और उचित संवाद',
        '5.1 आप स्वीकार करते हैं कि आउटपुट स्क्रीनिंग संकेत हैं, निदान नहीं। आवश्यकतानुसार माता-पिता को योग्य चिकित्सक से परामर्श के लिए निर्देशित किया जाना चाहिए।',
        '6. अनुपालन, लॉगिंग और ऑडिट',
        '6.1 आप स्वीकार करते हैं कि कार्यक्रम की सत्यनिष्ठा और सुरक्षा के लिए आपके उपयोग की लॉगिंग हो सकती है।',
        '6.2 आप किसी भी जांच में सहयोग करेंगे जो संदिग्ध दुरुपयोग या सुरक्षा घटना से संबंधित हो।',
        '7. परिणाम',
        '7.1 इन शर्तों का उल्लंघन होने पर आपकी पहुँच निलंबित की जा सकती है और विद्यालय अनुशासनात्मक कार्रवाई कर सकता है।',
    ],

    'te': [
        'NutriLift Screening Platform — తరగతి ఉపాధ్యాయుల అధీకృత వినియోగ నిబంధనలు',
        '"I Agree" పై క్లిక్ చేయడం ద్వారా, మీరు ఈ ప్లాట్\u200cఫారమ్\u200cను మీ పాఠశాల అధీకృత వినియోగదారుగా మాత్రమే ఉపయోగిస్తున్నారని నిర్ధారిస్తారు.',
        '1. అధీకృత వినియోగమే',
        '1.1 పాఠశాల మీకు కేటాయించిన విద్యార్థులకే, మరియు NutriLift Screening కార్యక్రమం కోసం మాత్రమే మీరు స్క్రీనింగ్ చేస్తారు.',
        '1.2 పాఠశాలే Data Fiduciary (డేటా ఫిడ్యూషియరీ) అని మీరు అంగీకరిస్తారు; మీరు పాఠశాల యొక్క అధీకృత ప్రతినిధి/ఏజెంట్\u200cగా వ్యవహరిస్తారు.',
        '2. డేటా ఎంట్రీ ఖచ్చితత్వం మరియు సమగ్రత',
        '2.1 కొలత SOP (Standard Operating Procedure) ను పాటించి విలువలను ఖచ్చితంగా నమోదు చేస్తారు; సబ్మిట్ చేసే ముందు అసాధారణంగా భిన్నమైన విలువలు లేదా స్పష్టమైన తప్పులను మళ్లీ తనిఖీ చేస్తారు.',
        '2.2 సున్నితమైన లక్షణాలను మీరు ఊహించరు. ఏదైనా ఫీల్డ్\u200cలో వర్గీకరణ అవసరమైతే (ఉదా., "తక్కువ ఆదాయం / తక్కువ కాదు"), పాఠశాల లిఖిత ప్రమాణాలను అనుసరిస్తారు; వాటికి మించి స్వేచ్ఛానుసార నిర్ణయాలు తీసుకోరు.',
        '3. WhatsApp సందేశ నిర్వహణ (అధిక ప్రమాద దశ)',
        '3.1 WhatsApp తెరవడానికి ముందు, తల్లిదండ్రి/గార్డియన్ నంబర్ సరైనదని నిర్ధారిస్తారు (సిఫారసు: పాఠశాల రికార్డులు లేదా తల్లిదండ్రితో చివరి 4 అంకెలను ధృవీకరించండి).',
        '3.2 పంపించే ముందు, ముందుగా నింపబడిన మొత్తం సందేశాన్ని చదివి, అది సరైన పిల్ల మరియు సరైన ఎంట్రీలకు సంబంధించినదని నిర్ధారిస్తారు.',
        '3.3 సందేశంలోని విషయాన్ని గ్రూపులకు లేదా మూడవ పక్షాలకు ఫార్వర్డ్ చేయరు.',
        '3.4 తప్పు వ్యక్తికి సందేశం పంపబడిందని అనిపిస్తే, వెంటనే పాఠశాల నాయకత్వానికి తెలియజేసి, సంఘటన SOP ను అనుసరిస్తారు.',
        '4. గోప్యత మరియు పరికరం భద్రత',
        '4.1 సురక్షిత పరికరాన్ని మాత్రమే ఉపయోగిస్తారు (స్క్రీన్ లాక్ ఆన్; పరికరాన్ని పంచుకోరు; OS అప్డేట్\u200cగా ఉంచండి).',
        '4.2 స్క్రీన్\u200cషాట్లు తీయరు, డేటాను ఎగుమతి చేయరు, వేరే స్ప్రెడ్\u200cషీట్లు ఉంచరు, పాఠశాల ఆమోదించిన ఛానళ్ల వెలుపల పిల్ల ఆరోగ్య వివరాలను నిల్వ చేయరు.',
        '5. నిర్ధారణ కాదు మరియు సరైన కమ్యూనికేషన్',
        '5.1 అవుట్\u200cపుట్లు screening సూచికలు మాత్రమే; నిర్ధారణలు కావని మీరు అంగీకరిస్తారు. అవసరమైతే తల్లిదండ్రులను అర్హత గల వైద్యులను సంప్రదించడానికి మార్గనిర్దేశం చేయాలి.',
        '6. అనుసరణ, లాగింగ్, ఆడిట్లు',
        '6.1 కార్యక్రమ సమగ్రత మరియు భద్రత కోసం మీ వినియోగం లాగ్ చేయబడవచ్చు అని మీరు అంగీకరిస్తారు.',
        '6.2 అనుమానాస్పద దుర్వినియోగం లేదా భద్రతా సంఘటనపై జరిగే ఏ విచారణకైనా మీరు సహకరిస్తారు.',
        '7. పరిణామాలు',
        '7.1 ఈ నిబంధనలు ఉల్లంఘిస్తే, మీ యాక్సెస్ నిలిపివేయబడవచ్చు మరియు పాఠశాల శాసన చర్యలు తీసుకోవచ్చు.',
    ],

    'ta': [
        'NutriLift Screening Platform — வகுப்பு ஆசிரியர் அங்கீகரிக்கப்பட்ட பயனர் விதிமுறைகள்',
        '"I Agree" என்பதை கிளிக் செய்வதன் மூலம், நீங்கள் இந்த தளத்தை உங்கள் பள்ளியின் அங்கீகரிக்கப்பட்ட பயனர் என்ற வகையில் மட்டுமே பயன்படுத்துகிறீர்கள் என்பதை உறுதிப்படுத்துகிறீர்கள்.',
        '1. அங்கீகரிக்கப்பட்ட பயன்பாடு மட்டும்',
        '1.1 பள்ளி உங்களுக்கு ஒதுக்கிய மாணவர்களையே நீங்கள் ஸ்கிரீனிங் செய்வீர்கள்; மேலும் NutriLift Screening திட்டத்திற்காக மட்டுமே.',
        '1.2 பள்ளி தான் Data Fiduciary (தரவு ஃபிட்யூஷியரி) என்பதை நீங்கள் ஒப்புக்கொள்கிறீர்கள்; நீங்கள் பள்ளியின் அங்கீகரிக்கப்பட்ட பிரதிநிதி/முகவராக செயல்படுகிறீர்கள்.',
        '2. தரவு உள்ளீட்டின் துல்லியம் மற்றும் நேர்மை',
        '2.1 அளவீட்டு SOP (Standard Operating Procedure) பின்பற்றி மதிப்புகளை துல்லியமாக உள்ளிடுவீர்கள்; சமர்ப்பிக்கும் முன் மிக அதிகமாக மாறுபடும் மதிப்புகள் அல்லது தெளிவான பிழைகளை மீண்டும் சரிபார்ப்பீர்கள்.',
        '2.2 சென்சிட்டிவ்/முக்கிய பண்புகளை நீங்கள் ஊகிக்க மாட்டீர்கள். ஏதேனும் புலத்தில் வகைப்படுத்தல் தேவைப்பட்டால் (உ.தா., "குறைந்த வருமானம் / இல்லை"), பள்ளி ஆவணப்படுத்திய அளவுகோலை பின்பற்றி, அதற்கு அப்பால் தனிப்பட்ட ஊகத் தீர்மானங்களை எடுக்க மாட்டீர்கள்.',
        '3. WhatsApp செய்தி கையாளுதல் (உயர் ஆபத்து கட்டம்)',
        '3.1 WhatsApp திறக்கும் முன், பெற்றோர்/காவலர் எண்ணை சரியாக உறுதிப்படுத்துவீர்கள் (பரிந்துரை: பள்ளி பதிவுகள் அல்லது பெற்றோருடன் கடைசி 4 இலக்கங்களை சரிபார்க்கவும்).',
        '3.2 அனுப்புவதற்கு முன், முன் நிரப்பப்பட்ட முழு செய்தியையும் வாசித்து, அது சரியான குழந்தைக்கும் சரியான உள்ளீடுகளுக்கும் பொருந்துகிறது என்பதை உறுதி செய்வீர்கள்.',
        '3.3 செய்தி உள்ளடக்கத்தை குழுக்களுக்கு அல்லது மூன்றாம் நபர்களுக்கு ஃபார்வர்ட் செய்ய மாட்டீர்கள்.',
        '3.4 தவறான பெறுநருக்கு செய்தி அனுப்பப்பட்டதாக நீங்கள் நினைத்தால், உடனடியாக பள்ளி நிர்வாகத்தை அறிவித்து, சம்பவ SOP-ஐ பின்பற்றுவீர்கள்.',
        '4. தனியுரிமை மற்றும் சாதன பாதுகாப்பு',
        '4.1 பாதுகாப்பான சாதனம் மட்டுமே பயன்படுத்துவீர்கள் (ஸ்கிரீன் லாக் இயக்கத்தில்; சாதனத்தை பகிர வேண்டாம்; OS-ஐ புதுப்பித்து வைத்திருங்கள்).',
        '4.2 ஸ்கிரீன்\u200cஷாட் எடுக்க மாட்டீர்கள்; தரவை ஏற்றுமதி செய்ய மாட்டீர்கள்; தனியாக ஸ்ப்ரெட்\u200cஷீட் வைத்திருக்க மாட்டீர்கள்; பள்ளி அனுமதித்த வழிகளுக்கு வெளியே குழந்தையின் ஆரோக்கிய விவரங்களை சேமிக்க மாட்டீர்கள்.',
        '5. நோய் நிர்ணயம் இல்லை; பொருத்தமான தொடர்பு',
        '5.1 இந்த வெளியீடுகள் screening குறியீடுகள் மட்டுமே, நோய் நிர்ணயம் அல்ல என்பதை நீங்கள் ஒப்புக்கொள்கிறீர்கள். தேவையான இடங்களில் பெற்றோர்களை தகுதி பெற்ற மருத்துவரை அணுக வழிநடத்த வேண்டும்.',
        '6. இணக்கம், லாகிங் மற்றும் ஆய்வுகள்',
        '6.1 திட்டத்தின் நேர்மை மற்றும் பாதுகாப்பிற்காக உங்கள் பயன்பாடு பதிவு (logging) செய்யப்படலாம் என்பதை நீங்கள் ஒப்புக்கொள்கிறீர்கள்.',
        '6.2 சந்தேகமான தவறான பயன்பாடு அல்லது பாதுகாப்பு சம்பவம் தொடர்பான எந்த விசாரணையிலும் நீங்கள் ஒத்துழைப்பீர்கள்.',
        '7. விளைவுகள்',
        '7.1 இந்த விதிமுறைகளை மீறினால் உங்கள் அணுகல் இடைநிறுத்தப்படலாம் மற்றும் பள்ளி ஒழுக்க நடவடிக்கை எடுக்கலாம்.',
    ],

    'ml': [
        'NutriLift Screening Platform — ക്ലാസ് ടീച്ചർ അംഗീകൃത ഉപയോക്തൃ നിബന്ധനകൾ',
        '"I Agree" ക്ലിക്ക് ചെയ്യുന്നതിലൂടെ, നിങ്ങൾ ഈ പ്ലാറ്റ്ഫോം നിങ്ങളുടെ സ്കൂളിലെ അംഗീകൃത ഉപയോക്താവെന്ന നിലയിൽ മാത്രമേ ഉപയോഗിക്കുകയുള്ളു എന്ന് ഉറപ്പാക്കുന്നു.',
        '1. അംഗീകൃത ഉപയോഗം മാത്രം',
        '1.1 സ്കൂൾ നിങ്ങളിലേക്ക് ഏൽപ്പിച്ച വിദ്യാർത്ഥികളെ മാത്രമേ നിങ്ങൾ സ്ക്രീൻ ചെയ്യൂ; അത് NutriLift Screening പരിപാടിക്കായി മാത്രം.',
        '1.2 സ്കൂൾ തന്നെയാണ് Data Fiduciary (ഡാറ്റ ഫിഡ്യൂഷിയറി) എന്ന് നിങ്ങൾ അംഗീകരിക്കുന്നു; നിങ്ങൾ സ്കൂളിന്റെ അംഗീകൃത പ്രതിനിധി/ഏജന്റായി പ്രവർത്തിക്കുന്നു.',
        '2. ഡാറ്റ എൻട്രിയുടെ കൃത്യതയും അഖണ്ഡതയും',
        '2.1 അളവെടുപ്പ് SOP (Standard Operating Procedure) പിന്തുടർന്ന് മൂല്യങ്ങൾ കൃത്യമായി നൽകും; സമർപ്പിക്കുന്നതിന് മുമ്പ് അസാധാരണമായ മൂല്യങ്ങളോ വ്യക്തമായ പിശകുകളോ വീണ്ടും പരിശോധിക്കും.',
        '2.2 സംവേദനശീലമായ ഗുണങ്ങൾ നിങ്ങൾ അനുമാനിക്കില്ല. ഏതെങ്കിലും ഫീൽഡിൽ വർഗ്ഗീകരണം ആവശ്യമെങ്കിൽ (ഉദാ., "കുറഞ്ഞ വരുമാനം / കുറവ് അല്ല"), സ്കൂൾ രേഖപ്പെടുത്തിയ മാനദണ്ഡം പിന്തുടരും; അതിന് പുറത്തായി ഇഷ്ടാനുസൃത തീരുമാനങ്ങൾ എടുക്കില്ല.',
        '3. WhatsApp സന്ദേശ കൈകാര്യം (ഉയർന്ന അപകട ഘട്ടം)',
        '3.1 WhatsApp തുറക്കുന്നതിന് മുമ്പ്, മാതാപിതാവ്/ഗാർഡിയന്റെ നമ്പർ ശരിയാണെന്ന് ഉറപ്പാക്കും (ശുപാർശ: സ്കൂൾ രേഖകളിലോ മാതാപിതാവിനോടോ അവസാന 4 അക്കങ്ങൾ സ്ഥിരീകരിക്കുക).',
        '3.2 അയയ്ക്കുന്നതിന് മുമ്പ്, മുൻകൂട്ടി പൂരിപ്പിച്ച മുഴുവൻ സന്ദേശവും വായിച്ച് അത് ശരിയായ കുട്ടിയുടേയും ശരിയായ എൻട്രികളുടേയുംതന്നെയാണെന്ന് ഉറപ്പാക്കും.',
        '3.3 സന്ദേശ ഉള്ളടക്കം ഗ്രൂപ്പുകളിലേക്കോ മൂന്നാം കക്ഷികളിലേക്കോ ഫോർവേഡ് ചെയ്യില്ല.',
        '3.4 തെറ്റായ സ്വീകരിക്കുന്നയാളിലേക്ക് സന്ദേശം അയച്ചതായി തോന്നിയാൽ, ഉടൻ സ്കൂൾ നേതൃത്വത്തെ അറിയിക്കുകയും ഇൻസിഡന്റ് SOP പിന്തുടരുകയും ചെയ്യും.',
        '4. സ്വകാര്യതയും ഉപകരണ സുരക്ഷയും',
        '4.1 സുരക്ഷിതമായ ഉപകരണം മാത്രമേ ഉപയോഗിക്കൂ (സ്ക്രീൻ ലോക്ക് ഓൺ; ഉപകരണം പങ്കിടരുത്; OS അപ്ഡേറ്റ് നിലനിർത്തുക).',
        '4.2 സ്ക്രീൻഷോട്ട് എടുക്കില്ല, ഡാറ്റ എക്സ്പോർട്ട് ചെയ്യില്ല, സമാന്തര സ്പ്രെഡ്ഷീറ്റുകൾ നിലനിർത്തില്ല, സ്കൂൾ അംഗീകൃത ചാനലുകൾക്കു പുറത്തായി കുട്ടിയുടെ ആരോഗ്യ വിവരങ്ങൾ സൂക്ഷിക്കില്ല.',
        '5. രോഗനിർണയം അല്ല; യോജിച്ച ആശയവിനിമയം',
        '5.1 ഔട്ട്പുട്ടുകൾ screening സൂചനകൾ മാത്രമാണെന്നും രോഗനിർണയം അല്ലെന്നും നിങ്ങൾ അംഗീകരിക്കുന്നു. ആവശ്യമായിടത്ത് മാതാപിതാക്കളെ യോഗ്യതയുള്ള ഡോക്ടറെ സമീപിക്കാൻ നിർദ്ദേശിക്കണം.',
        '6. അനുസരണം, ലോഗിംഗ്, ഓഡിറ്റ്',
        '6.1 പരിപാടിയുടെ അഖണ്ഡതക്കും സുരക്ഷയ്ക്കുമായി നിങ്ങളുടെ ഉപയോഗം ലോഗ് ചെയ്യപ്പെടാം എന്ന് നിങ്ങൾ അംഗീകരിക്കുന്നു.',
        '6.2 സംശയാസ്പദ ദുരുപയോഗം അല്ലെങ്കിൽ സുരക്ഷാ സംഭവവുമായി ബന്ധപ്പെട്ട ഏത് അന്വേഷണം ഉണ്ടായാലും നിങ്ങൾ സഹകരിക്കും.',
        '7. പ്രതിഫലങ്ങൾ',
        '7.1 ഈ നിബന്ധനകൾ ലംഘിച്ചാൽ നിങ്ങളുടെ ആക്\u200cസസ് സസ്\u200cപെൻഡ് ചെയ്യപ്പെടാം, സ്കൂൾ ശാസന നടപടി സ്വീകരിക്കാം.',
    ],

    'kn': [
        'NutriLift Screening Platform — ತರಗತಿ ಶಿಕ್ಷಕರ ಅಧಿಕೃತ ಬಳಕೆದಾರ ನಿಯಮಗಳು',
        '"I Agree" ಅನ್ನು ಕ್ಲಿಕ್ ಮಾಡುವ ಮೂಲಕ, ನೀವು ಈ ಪ್ಲಾಟ್\u200cಫಾರ್ಮ್ ಅನ್ನು ನಿಮ್ಮ ಶಾಲೆಯ ಅಧಿಕೃತ ಬಳಕೆದಾರನಾಗಿ ಮಾತ್ರ ಬಳಸುತ್ತಿರುವುದನ್ನು ದೃಢಪಡಿಸುತ್ತೀರಿ.',
        '1. ಅಧಿಕೃತ ಬಳಕೆ ಮಾತ್ರ',
        '1.1 ಶಾಲೆ ನಿಮಗೆ ನಿಯೋಜಿಸಿದ ವಿದ್ಯಾರ್ಥಿಗಳನ್ನಷ್ಟೇ ಮತ್ತು NutriLift Screening ಕಾರ್ಯಕ್ರಮಕ್ಕಾಗಿ ಮಾತ್ರ ನೀವು ಸ್ಕ್ರೀನಿಂಗ್ ಮಾಡುತ್ತೀರಿ.',
        '1.2 ಶಾಲೆಯೇ Data Fiduciary (ಡೇಟಾ ಫಿಡ್ಯೂಶಿಯರಿ) ಎಂದು ನೀವು ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೀರಿ; ನೀವು ಶಾಲೆಯ ಅಧಿಕೃತ ಪ್ರತಿನಿಧಿ/ಏಜೆಂಟ್ ಆಗಿ ಕಾರ್ಯನಿರ್ವಹಿಸುತ್ತೀರಿ.',
        '2. ಡೇಟಾ ನಮೂದು: ಶುದ್ಧತೆ ಮತ್ತು ಸಮಗ್ರತೆ',
        '2.1 ಅಳತೆ SOP (Standard Operating Procedure) ಅನ್ನು ಅನುಸರಿಸಿ ಮೌಲ್ಯಗಳನ್ನು ನಿಖರವಾಗಿ ದಾಖಲಿಸುತ್ತೀರಿ; ಸಲ್ಲಿಸುವ ಮೊದಲು ಅಸಾಮಾನ್ಯ ಮೌಲ್ಯಗಳು ಅಥವಾ ಸ್ಪಷ್ಟ ದೋಷಗಳನ್ನು ಮತ್ತೆ ಪರಿಶೀಲಿಸುತ್ತೀರಿ.',
        '2.2 ಸಂವೇದನಾಶೀಲ ಲಕ್ಷಣಗಳನ್ನು ನೀವು ಊಹಿಸುವುದಿಲ್ಲ. ಯಾವುದಾದರೂ ಫೀಲ್ಡ್\u200cಗೆ ವರ್ಗೀಕರಣ ಅಗತ್ಯವಿದ್ದರೆ (ಉದಾ., "ಕಡಿಮೆ ಆದಾಯ / ಕಡಿಮೆ ಅಲ್ಲ"), ಶಾಲೆಯ ದಾಖಲೀಕೃತ ಮಾನದಂಡವನ್ನು ಅನುಸರಿಸುತ್ತೀರಿ; ಅದಕ್ಕಿಂತ ಮೀರಿಸಿ ಸ್ವಇಚ್ಛೆಯ ನಿರ್ಣಯಗಳನ್ನು ತೆಗೆದುಕೊಳ್ಳುವುದಿಲ್ಲ.',
        '3. WhatsApp ಸಂದೇಶ ನಿರ್ವಹಣೆ (ಹೆಚ್ಚಿನ ಅಪಾಯದ ಹಂತ)',
        '3.1 WhatsApp ತೆರೆಯುವ ಮೊದಲು, ಪೋಷಕ/ಗಾರ್ಡಿಯನ್ ಸಂಖ್ಯೆ ಸರಿಯಿದೆ ಎಂದು ಖಚಿತಪಡಿಸುತ್ತೀರಿ (ಶಿಫಾರಸು: ಶಾಲಾ ದಾಖಲಾತಿಗಳೊಂದಿಗೆ ಅಥವಾ ಪೋಷಕರೊಂದಿಗೆ ಕೊನೆಯ 4 ಅಂಕೆಗಳನ್ನು ಪರಿಶೀಲಿಸಿ).',
        '3.2 ಕಳುಹಿಸುವ ಮೊದಲು, ಪೂರ್ವಭರಿತ ಸಂದೇಶವನ್ನು ಸಂಪೂರ್ಣವಾಗಿ ಓದಿ, ಅದು ಸರಿಯಾದ ಮಗು ಮತ್ತು ಸರಿಯಾದ ನಮೂದುಗಳಿಗೆ ಹೊಂದಿದೆ ಎಂದು ಖಚಿತಪಡಿಸುತ್ತೀರಿ.',
        '3.3 ಸಂದೇಶದ ವಿಷಯವನ್ನು ಗುಂಪುಗಳಿಗೆ ಅಥವಾ ಮೂರನೇ ವ್ಯಕ್ತಿಗಳಿಗೆ ಫಾರ್ವರ್ಡ್ ಮಾಡುವುದಿಲ್ಲ.',
        '3.4 ತಪ್ಪು ಸ್ವೀಕರಿಸುವವರಿಗೆ ಸಂದೇಶ ಹೋಗಿದೆ ಎಂದು মনেಿಸಿದರೆ, ತಕ್ಷಣ ಶಾಲಾ ನಾಯಕತ್ವಕ್ಕೆ ತಿಳಿಸಿ, ಘಟನೆ SOP ಅನ್ನು ಅನುಸರಿಸುತ್ತೀರಿ.',
        '4. ಗೌಪ್ಯತೆ ಮತ್ತು ಸಾಧನ ಭದ್ರತೆ',
        '4.1 ಸುರಕ್ಷಿತ ಸಾಧನವನ್ನು ಮಾತ್ರ ಬಳಸುತ್ತೀರಿ (ಸ್ಕ್ರೀನ್ ಲಾಕ್ ಆನ್; ಸಾಧನ ಹಂಚಿಕೊಳ್ಳಬೇಡಿ; OS ಅನ್ನು ಅಪ್ಡೇಟ್ ಆಗಿಡಿ).',
        '4.2 ಸ್ಕ್ರೀನ್\u200cಶಾಟ್ ತೆಗೆದುಕೊಳ್ಳುವುದಿಲ್ಲ, ಡೇಟಾ ಎಕ್ಸ್\u200cಪೋರ್ಟ್ ಮಾಡುವುದಿಲ್ಲ, ಸಮಾಂತರ ಸ್ಪ್ರೆಡ್\u200cಶೀಟ್\u200cಗಳನ್ನು ಇಡುವುದಿಲ್ಲ, ಶಾಲೆ ಅನುಮೋದಿಸಿದ ಚಾನೆಲ್\u200cಗಳ ಹೊರಗೆ ಮಕ್ಕಳ ಆರೋಗ್ಯ ವಿವರಗಳನ್ನು ಸಂಗ್ರಹಿಸುವುದಿಲ್ಲ.',
        '5. ರೋಗನಿರ್ಣಯ ಅಲ್ಲ; ಸರಿಯಾದ ಸಂವಹನ',
        '5.1 ಔಟ್\u200cಪುಟ್\u200cಗಳು screening ಸೂಚಕಗಳು ಮಾತ್ರ, ರೋಗನಿರ್ಣಯಗಳು ಅಲ್ಲ ಎಂದು ನೀವು ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೀರಿ. ಅಗತ್ಯವಿದ್ದರೆ ಪೋಷಕರಿಗೆ ಅರ್ಹ ವೈದ್ಯರನ್ನು ಸಂಪರ್ಕಿಸಲು ಮಾರ್ಗದರ್ಶನ ನೀಡಬೇಕು.',
        '6. ಅನುಸರಣೆ, ಲಾಗಿಂಗ್ ಮತ್ತು ಆಡಿಯಿಟ್\u200cಗಳು',
        '6.1 ಕಾರ್ಯಕ್ರಮದ ಸಮಗ್ರತೆ ಮತ್ತು ಭದ್ರತೆಗೆ ನಿಮ್ಮ ಬಳಕೆ ಲಾಗ್ ಆಗಬಹುದು ಎಂದು ನೀವು ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೀರಿ.',
        '6.2 ಶಂಕಿತ ದುರುಪಯೋಗ ಅಥವಾ ಭದ್ರತಾ ಘಟನೆಯ ತನಿಖೆಗೆ ನೀವು ಸಹಕರಿಸುತ್ತೀರಿ.',
        '7. ಪರಿಣಾಮಗಳು',
        '7.1 ಈ ನಿಯಮಗಳನ್ನು ಉಲ್ಲಂಘಿಸಿದರೆ ನಿಮ್ಮ ಪ್ರವೇಶವನ್ನು ಸ್ಥಗಿತಗೊಳಿಸಬಹುದು ಮತ್ತು ಶಾಲಾ ಶಿಸ್ತು ಕ್ರಮ ಕೈಗೊಳ್ಳಬಹುದು.',
    ],

    'bn': [
        'NutriLift Screening Platform — শ্রেণিশিক্ষকের অনুমোদিত ব্যবহারকারী শর্তাবলি',
        '"I Agree" ক্লিক করে আপনি নিশ্চিত করছেন যে আপনি এই প্ল্যাটফর্মটি শুধুমাত্র আপনার স্কুলের অনুমোদিত ব্যবহারকারী হিসেবে ব্যবহার করছেন।',
        '1. শুধুমাত্র অনুমোদিত ব্যবহার',
        '1.1 স্কুল যে শিক্ষার্থীদের আপনার কাছে দায়িত্ব দিয়েছে, কেবল তাদেরই এবং শুধুমাত্র NutriLift Screening প্রোগ্রামের জন্য আপনি স্ক্রিনিং করবেন।',
        '1.2 আপনি স্বীকার করছেন যে স্কুলই Data Fiduciary (ডেটা ফিডিউশিয়ারি); আপনি স্কুলের অনুমোদিত প্রতিনিধি/এজেন্ট হিসেবে কাজ করছেন।',
        '2. ডেটা এন্ট্রির সঠিকতা ও সততা',
        '2.1 মাপজোকের SOP (Standard Operating Procedure) অনুসরণ করে মানগুলো সঠিকভাবে লিখবেন; জমা দেওয়ার আগে অস্বাভাবিক মান বা স্পষ্ট ভুল থাকলে আবার যাচাই করবেন।',
        '2.2 সংবেদনশীল তথ্য আপনি অনুমান করবেন না। কোনো ফিল্ডে শ্রেণিবিভাগ প্রয়োজন হলে (যেমন, "কম আয় / কম নয়"), স্কুলের লিখিত মানদণ্ড অনুসরণ করবেন এবং তার বাইরে নিজস্ব অনুমান/বিবেচনায় সিদ্ধান্ত নেবেন না।',
        '3. WhatsApp বার্তা পরিচালনা (উচ্চ ঝুঁকির ধাপ)',
        '3.1 WhatsApp খোলার আগে আপনি নিশ্চিত করবেন যে অভিভাবক/গার্ডিয়ানের নম্বরটি সঠিক (পরামর্শ: স্কুল রেকর্ড বা অভিভাবকের সঙ্গে শেষ ৪টি অঙ্ক মিলিয়ে নিন)।',
        '3.2 পাঠানোর আগে, পূর্ব-ভরাট সম্পূর্ণ বার্তাটি পড়বেন যাতে নিশ্চিত হওয়া যায় এটি সঠিক শিশুর এবং সঠিক এন্ট্রির সঙ্গে মিলছে।',
        '3.3 বার্তার বিষয়বস্তু গ্রুপে বা তৃতীয় পক্ষের কাছে ফরওয়ার্ড করবেন না।',
        '3.4 ভুল প্রাপকের কাছে বার্তা চলে গেছে বলে মনে হলে, সঙ্গে সঙ্গে স্কুল কর্তৃপক্ষকে জানাবেন এবং incident SOP অনুসরণ করবেন।',
        '4. গোপনীয়তা ও ডিভাইস নিরাপত্তা',
        '4.1 শুধুমাত্র সুরক্ষিত ডিভাইস ব্যবহার করবেন (স্ক্রিন লক চালু; ডিভাইস শেয়ার করবেন না; OS আপডেট রাখবেন)।',
        '4.2 স্ক্রিনশট নেবেন না, ডেটা এক্সপোর্ট করবেন না, আলাদা স্প্রেডশিট রাখবেন না, এবং স্কুল অনুমোদিত চ্যানেলের বাইরে শিশুর স্বাস্থ্যসংক্রান্ত তথ্য সংরক্ষণ করবেন না।',
        '5. রোগ নির্ণয় নয় এবং সঠিক যোগাযোগ',
        '5.1 আপনি স্বীকার করছেন যে আউটপুটগুলো screening সূচক, রোগ নির্ণয় নয়। প্রয়োজন অনুযায়ী অভিভাবকদের যোগ্য চিকিৎসকের পরামর্শ নিতে বলা হবে।',
        '6. কমপ্লায়েন্স, লগিং ও অডিট',
        '6.1 প্রোগ্রামের স্বচ্ছতা এবং নিরাপত্তার জন্য আপনার ব্যবহার লগ করা হতে পারে—এটা আপনি স্বীকার করছেন।',
        '6.2 সন্দেহজনক অপব্যবহার বা নিরাপত্তা ঘটনার যে কোনো তদন্তে আপনি সহযোগিতা করবেন।',
        '7. পরিণতি',
        '7.1 এই শর্ত ভঙ্গ করলে আপনার অ্যাক্সেস স্থগিত হতে পারে এবং স্কুল শৃঙ্খলামূলক ব্যবস্থা নিতে পারে।',
    ],
}

================================================================================
FILE: screening_only\tests.py
================================================================================

from django.test import TestCase

# Create your tests here.

================================================================================
FILE: screening_only\urls.py
================================================================================

from django.urls import path

from . import views

app_name = "screening_only"

urlpatterns = [
    # School enrollment (public)
    path("enroll/login/", views.existing_admin_login, name="existing_admin_login"),
    path("enroll/", views.enroll_school, name="enroll_school"),
    #path("enroll/success/<slug:token>/", views.enroll_success, name="enroll_success"),

    # Google OAuth
    path("auth/google/start/", views.google_oauth_start, name="google_oauth_start"),
    path("auth/google/callback/", views.google_oauth_callback, name="google_oauth_callback"),
    path("auth/logout/", views.logout_view, name="logout"),

    # Admin flow
    path("admin/<slug:token>/auth/", views.admin_auth_required, name="admin_auth_required"),
    #path("admin/onboarding/", views.admin_onboarding, name="admin_onboarding"),
    path("admin/link/", views.admin_link_dashboard, name="admin_link_dashboard"),
    path("admin/dashboard/", views.admin_performance_dashboard, name="admin_performance_dashboard"),

    # Teacher flow
    path("teacher/auth-required/", views.teacher_auth_required, name="teacher_auth_required"),
    path("teacher/onboarding/", views.teacher_onboarding, name="teacher_onboarding"),
    path("teacher/class-selection/", views.teacher_class_selection, name="teacher_class_selection"),
    path("teacher/dashboard/", views.teacher_dashboard, name="teacher_dashboard"),
    path("teacher/terms/", views.teacher_terms, name="teacher_terms"),
    path("teacher/<slug:token>/", views.teacher_access_portal, name="teacher_access_portal"),

    # Parent flow (public, tokenized)
    path("p/<str:token>/video/", views.parent_video, name="parent_video"),
    path("p/<str:token>/result/", views.parent_result, name="parent_result"),

    # Inditech
    path("inditech/schools/", views.inditech_school_list, name="inditech_school_list"),
    path("inditech/schools/<int:org_id>/dashboard/", views.inditech_school_dashboard, name="inditech_school_dashboard"),
]

================================================================================
FILE: screening_only\views.py
================================================================================

from __future__ import annotations

from datetime import timedelta
from typing import Optional

from django.conf import settings
from django.contrib import messages
from django.contrib.auth import login, logout, get_user_model
from django.http import HttpResponseForbidden, HttpRequest, HttpResponse
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from django.utils import timezone
from messaging.i18n import flags_to_text
from accounts.models import Organization, OrgMembership, Role
from roster.models import Classroom, Student
from screening.models import Screening
from django.db.models import OuterRef, Subquery, Q
from .decorators import require_screening_only_admin, require_screening_only_teacher
from .forms import SchoolEnrollmentForm, TeacherAccessForm
from .google_oauth import (
    GoogleOAuthError,
    build_authorization_url,
    exchange_code_for_id_token,
    generate_state,
    verify_id_token_and_get_email,
)
from .models import ScreeningSchoolProfile, ScreeningTermsAcceptance
from .services import (
    TERMS_VERSION,
    academic_year_range,
    available_academic_years,
    screening_counts_by_class,
    unique_screening_token,
    parse_parent_token,
)
from .teacher_terms_content import DEFAULT_LANG, LANG_OPTIONS, TERMS_BY_LANG

# Session key used to remember teacher's currently selected class/section (Classroom.id)
TEACHER_SELECTED_CLASSROOM_SESSION_KEY = "sp_teacher_selected_classroom_id"

User = get_user_model()


def _split_full_name(full_name: str) -> tuple[str, str]:
    full_name = (full_name or "").strip()
    if not full_name:
        return "", ""
    parts = full_name.split()
    if len(parts) == 1:
        return parts[0], ""
    return parts[0], " ".join(parts[1:])


def _ensure_membership(user, org: Organization, role: str) -> OrgMembership:
    mem, _created = OrgMembership.objects.get_or_create(
        user=user,
        organization=org,
        role=role,
        defaults={"is_active": True},
    )
    if not mem.is_active:
        mem.is_active = True
        mem.save(update_fields=["is_active"])
    return mem


def _is_terms_accepted(user, org: Organization, actor_role: str) -> bool:
    return ScreeningTermsAcceptance.objects.filter(
        user=user,
        organization=org,
        actor_role=actor_role,
        version=TERMS_VERSION,
    ).exists()


def enroll_school(request: HttpRequest) -> HttpResponse:
    """
    Public enrollment link common for all schools:contentReference[oaicite:10]{index=10}.
    Creates Organization + ScreeningSchoolProfile.
    """
    if request.method == "POST":
        form = SchoolEnrollmentForm(request.POST)
        if form.is_valid():
            token = unique_screening_token(form.cleaned_data["school_name"])

            org = Organization.objects.create(
                name=form.cleaned_data["school_name"],
                org_type="SCHOOL",
                city=form.cleaned_data.get("city") or "",
                state=form.cleaned_data.get("state") or "",
                country=form.cleaned_data.get("country") or "India",
                screening_link_token=token,
            )
            ScreeningSchoolProfile.objects.create(
                organization=org,
                district=form.cleaned_data.get("district") or "",
                address=form.cleaned_data.get("address") or "",
                principal_name=form.cleaned_data.get("principal_name") or "",
                principal_email=form.cleaned_data["principal_email"],
                operator_name=form.cleaned_data.get("operator_name") or "",
                operator_email=form.cleaned_data.get("operator_email") or "",
                local_language_code=form.cleaned_data.get("local_language_code") or "",
            )

            messages.success(request, "School registered. Next: sign in with your authorized Google account.")
            return redirect("screening_only:admin_auth_required", token=org.screening_link_token)
    else:
        form = SchoolEnrollmentForm()

    return render(request, "screening_only/enroll_school.html", {"form": form})


def enroll_success(request: HttpRequest, token: str) -> HttpResponse:
    org = get_object_or_404(Organization, screening_link_token=token)
    try:
        org.screening_only_profile
    except Exception:
        return HttpResponseForbidden("Not a Screening Program school.")

    admin_auth_url = reverse("screening_only:admin_auth_required", args=[token])
    return render(
        request,
        "screening_only/enroll_success.html",
        {
            "org": org,
            "admin_auth_url": admin_auth_url,
        },
    )


def admin_auth_required(request: HttpRequest, token: str) -> HttpResponse:
    """
    Prompts admin to sign in with registered Google account:contentReference[oaicite:11]{index=11}.
    """
    org = get_object_or_404(Organization, screening_link_token=token)
    profile = getattr(org, "screening_only_profile", None)
    if not profile:
        return HttpResponseForbidden("This school is not enrolled in the Screening Program.")

    # Store pending OAuth context in session
    request.session["sp_oauth_role"] = "admin"
    request.session["sp_oauth_org_id"] = org.id
    request.session.modified = True

    return render(
        request,
        "screening_only/admin_auth_required.html",
        {
            "org": org,
            "principal_email": profile.principal_email,
            "operator_email": profile.operator_email,
            "google_start_url": reverse("screening_only:google_oauth_start"),
        },
    )


def teacher_access_portal(request: HttpRequest, token: str) -> HttpResponse:
    """
    Teacher enters name + email, accepts T&C, then signs in with Google using the SAME email:contentReference[oaicite:12]{index=12}.
    """
    org = get_object_or_404(Organization, screening_link_token=token)
    profile = getattr(org, "screening_only_profile", None)
    if not profile:
        return HttpResponseForbidden("This school is not enrolled in the Screening Program.")

    if request.method == "POST":
        form = TeacherAccessForm(request.POST)
        if form.is_valid():
            email = form.cleaned_data["email"].strip().lower()
            full_name = form.cleaned_data["full_name"].strip()

            request.session["sp_oauth_role"] = "teacher"
            request.session["sp_oauth_org_id"] = org.id
            request.session["sp_teacher_email"] = email
            request.session["sp_teacher_full_name"] = full_name
            request.session["sp_teacher_terms_ok"] = True
            request.session.modified = True

            return redirect("screening_only:teacher_auth_required")
    else:
        form = TeacherAccessForm()

    return render(
        request,
        "screening_only/teacher_access_portal.html",
        {
            "org": org,
            "form": form,
        },
    )

def teacher_terms(request: HttpRequest) -> HttpResponse:
    """
    Public Terms & Conditions page for teachers.
    Default language is Marathi. Language switches via ?lang=<code> (full page refresh).
    """
    lang = (request.GET.get("lang") or DEFAULT_LANG).strip().lower()
    if lang not in TERMS_BY_LANG:
        lang = DEFAULT_LANG
    return_token = request.GET.get("return_token", "").strip()
    return render(
        request,
        "screening_only/teacher_terms.html",
        {
            "lang": lang,
            "languages": LANG_OPTIONS,
            "terms_paragraphs": TERMS_BY_LANG[lang],
            "return_token": return_token,
        },
    )

def teacher_auth_required(request: HttpRequest) -> HttpResponse:
    """
    Separate screen: “Sign in with Google”, reminds teacher to use the correct email:contentReference[oaicite:13]{index=13}.
    """
    role = request.session.get("sp_oauth_role")
    org_id = request.session.get("sp_oauth_org_id")
    expected = request.session.get("sp_teacher_email")
    if role != "teacher" or not org_id or not expected:
        messages.error(request, "Teacher access session expired. Please open the teacher link again.")
        return redirect("screening_only:enroll_school")

    org = get_object_or_404(Organization, id=org_id)
    return render(
        request,
        "screening_only/teacher_auth_required.html",
        {
            "org": org,
            "expected_email": expected,
            "google_start_url": reverse("screening_only:google_oauth_start"),
        },
    )

@require_screening_only_teacher
def teacher_onboarding(request: HttpRequest) -> HttpResponse:
    """
    Teacher onboarding: show guide/training, then continue to dashboard.
    """
    org = request.org  # set by the decorator/middleware
    guide_url = getattr(settings, "SCREENING_GUIDE_URL", "") or "#"
    training_url = getattr(settings, "SCREENING_TRAINING_VIDEO_URL", "") or "#"
    continue_url = reverse("screening_only:teacher_class_selection")

    return render(
        request,
        "screening_only/admin_onboarding.html",
        {
            "org": org,
            "guide_url": guide_url,
            "training_url": training_url,
            "continue_url": continue_url,
        },
    )


def google_oauth_start(request: HttpRequest) -> HttpResponse:
    client_id = getattr(settings, "GOOGLE_OAUTH_CLIENT_ID", None) or ""
    if not client_id:
        return HttpResponseForbidden("GOOGLE_OAUTH_CLIENT_ID is not configured.")

    state = generate_state()
    request.session["sp_oauth_state"] = state
    request.session.modified = True

    redirect_uri = request.build_absolute_uri(reverse("screening_only:google_oauth_callback"))
    url = build_authorization_url(client_id=client_id, redirect_uri=redirect_uri, state=state)
    return redirect(url)


def google_oauth_callback(request: HttpRequest) -> HttpResponse:
    client_id = getattr(settings, "GOOGLE_OAUTH_CLIENT_ID", None) or ""
    client_secret = getattr(settings, "GOOGLE_OAUTH_CLIENT_SECRET", None) or ""

    if not client_id or not client_secret:
        return HttpResponseForbidden("Google OAuth is not configured (missing client id/secret).")

    state = request.GET.get("state") or ""
    code = request.GET.get("code") or ""
    expected_state = request.session.get("sp_oauth_state") or ""

    if not code or not state or state != expected_state:
        messages.error(request, "Invalid login session. Please try again.")
        return redirect("screening_only:enroll_school")

    role = request.session.get("sp_oauth_role")
    
    # For existing_admin, we don't have org_id yet - we'll find it after OAuth
    # For other roles (admin, teacher), we need org_id
    if role != "existing_admin":
        org_id = request.session.get("sp_oauth_org_id")
        if not role or not org_id:
            messages.error(request, "Login session expired. Please start again.")
            return redirect("screening_only:enroll_school")
        org = get_object_or_404(Organization, id=org_id)
    
    redirect_uri = request.build_absolute_uri(reverse("screening_only:google_oauth_callback"))

    try:
        id_token = exchange_code_for_id_token(code=code, client_id=client_id, client_secret=client_secret, redirect_uri=redirect_uri)
        token_info = verify_id_token_and_get_email(id_token=id_token, client_id=client_id)
    except GoogleOAuthError as e:
        messages.error(request, f"Google sign-in failed: {e}")
        return redirect("screening_only:enroll_school")

    email = (token_info.get("email") or "").strip().lower()

    # Handle existing admin login FIRST (before other role checks)
    if role == "existing_admin":
        # Find organization by matching email to principal_email or operator_email
        from .models import ScreeningSchoolProfile
        
        # Find the organization where this email is authorized
        profile = ScreeningSchoolProfile.objects.filter(
            Q(principal_email__iexact=email) | Q(operator_email__iexact=email)
        ).select_related("organization").first()
        
        if not profile:
            messages.error(
                request, 
                f"No school found for email {email}. Please register your school first."
            )
            return redirect("screening_only:enroll_school")
        
        org = profile.organization
        
        # Get or create user
        user, created = User.objects.get_or_create(email=email, defaults={"is_active": True})
        if created:
            user.set_unusable_password()
            user.save()
        
        # Check if membership already exists - don't create duplicate
        existing_membership = OrgMembership.objects.filter(
            user=user, 
            organization=org, 
            role=Role.ORG_ADMIN
        ).first()
    
        if existing_membership:
            # Membership exists, just activate if inactive
            if not existing_membership.is_active:
                existing_membership.is_active = True
                existing_membership.save(update_fields=["is_active"])
        else:
            # Create membership only if it doesn't exist
            _ensure_membership(user, org, Role.ORG_ADMIN)
        
        login(request, user, backend="django.contrib.auth.backends.ModelBackend")
        request.session["current_org_id"] = org.id
        
        # Clear OAuth session
        for k in ["sp_oauth_state", "sp_oauth_role", "sp_oauth_org_id"]:
            request.session.pop(k, None)
        
        # Redirect directly to admin link dashboard (not onboarding)
        return redirect("screening_only:admin_link_dashboard")
    # Admin authorization: only registered principal/operator emails may login:contentReference[oaicite:14]{index=14}.
    if role == "admin":
        profile: Optional[ScreeningSchoolProfile] = getattr(org, "screening_only_profile", None)
        if not profile:
            return HttpResponseForbidden("This school is not enrolled in the Screening Program.")
        if not profile.is_authorized_admin_email(email):
            return render(
                request,
                "screening_only/admin_unauthorized.html",
                {
                    "org": org,
                    "attempted_email": email,
                    "principal_email": profile.principal_email,
                    "operator_email": profile.operator_email,
                    "retry_url": reverse("screening_only:admin_auth_required", args=[org.screening_link_token]),
                },
            )

        user, created = User.objects.get_or_create(email=email, defaults={"is_active": True})
        if created:
            user.set_unusable_password()
            user.save()

        _ensure_membership(user, org, Role.ORG_ADMIN)
        login(request, user, backend="django.contrib.auth.backends.ModelBackend")
        request.session["current_org_id"] = org.id

        # clear oauth session
        for k in ["sp_oauth_state", "sp_oauth_role", "sp_oauth_org_id"]:
            request.session.pop(k, None)
          # Auto-accept terms and mark onboarding as completed
        if not _is_terms_accepted(user, org, ScreeningTermsAcceptance.ActorRole.ORG_ADMIN):
            ScreeningTermsAcceptance.objects.create(
                organization=org,
                user=user,
                actor_role=ScreeningTermsAcceptance.ActorRole.ORG_ADMIN,
                version=TERMS_VERSION,
                ip_address=_get_ip(request),
                user_agent=(request.META.get("HTTP_USER_AGENT") or "")[:255],
            )
  
        # Mark onboarding as completed
        try:
            prof = org.screening_only_profile
            if not prof.onboarding_completed_at:
                prof.onboarding_completed_at = timezone.now()
                prof.save(update_fields=["onboarding_completed_at"])
        except Exception:
            pass
        return redirect("screening_only:admin_link_dashboard")

    # Teacher authorization: logged-in email must match entered email:contentReference[oaicite:15]{index=15}.
    if role == "teacher":
        expected = (request.session.get("sp_teacher_email") or "").strip().lower()
        full_name = (request.session.get("sp_teacher_full_name") or "").strip()

        if not expected or email != expected:
            return render(
                request,
                "screening_only/teacher_access_denied.html",
                {
                    "org": org,
                    "expected_email": expected,
                    "attempted_email": email,
                    "retry_url": reverse("screening_only:teacher_auth_required"),
                    "change_email_url": reverse("screening_only:teacher_access_portal", args=[org.screening_link_token]),
                },
            )

        user, created = User.objects.get_or_create(email=email, defaults={"is_active": True})
        if created:
            user.set_unusable_password()

        fn, ln = _split_full_name(full_name)
        if fn and not user.first_name:
            user.first_name = fn
        if ln and not user.last_name:
            user.last_name = ln
        user.save()

        existing_memberships = OrgMembership.objects.filter(
            user=user,
            is_active=True
        ).select_related("organization")

        allowed_for_teacher_flow = [Role.TEACHER, Role.ORG_ADMIN]
        # Check if user has NON-TEACHER roles (and no TEACHER role)
        non_teacher_memberships = existing_memberships.exclude(role__in=allowed_for_teacher_flow)
        teacher_memberships = existing_memberships.filter(role=Role.TEACHER)

        if non_teacher_memberships.exists() and not teacher_memberships.exists():
            other_orgs = [mem.organization.name for mem in non_teacher_memberships]
            other_roles = [mem.role for mem in non_teacher_memberships]
            return render(
                request,
                "screening_only/teacher_access_denied.html",  # You may want to create a new template for this
                {
                    "org": org,
                    "expected_email": expected,
                    "attempted_email": email,
                    "error_message": f"This email is already registered with other organization(s) ({', '.join(other_orgs)}) with role(s): {', '.join(set(other_roles))}. "
                                     f"Teachers cannot use an email that is registered with a different role. Please use a different email address.",
                    "retry_url": reverse("screening_only:teacher_auth_required"),
                    "change_email_url": reverse("screening_only:teacher_access_portal", args=[org.screening_link_token]),
                },
            )
        # other_org_memberships = existing_memberships.exclude(organization=org).select_related("organization")
        current_org_memberships = existing_memberships.filter(organization=org)
        other_org_memberships = existing_memberships.exclude(organization=org).select_related("organization")
        if other_org_memberships.exists():
            other_orgs = [mem.organization.name for mem in other_org_memberships]
            messages.warning(
                request,
                f"This email is already registered with other organization(s): {', '.join(other_orgs)}. "
                f"You are now also registered as a teacher for {org.name}."
            ) 
        # Ensure membership for this organization as teacher
        if not current_org_memberships.exists():
            _ensure_membership(user, org, Role.TEACHER)
        login(request, user, backend="django.contrib.auth.backends.ModelBackend")
        request.session["current_org_id"] = org.id

        # record teacher terms acceptance (they checked accept_terms in step 1)
        if request.session.get("sp_teacher_terms_ok") and not _is_terms_accepted(user, org, ScreeningTermsAcceptance.ActorRole.TEACHER):
            ScreeningTermsAcceptance.objects.create(
                organization=org,
                user=user,
                actor_role=ScreeningTermsAcceptance.ActorRole.TEACHER,
                version=TERMS_VERSION,
                ip_address=_get_ip(request),
                user_agent=(request.META.get("HTTP_USER_AGENT") or "")[:255],
            )

        # clear oauth session
        for k in ["sp_oauth_state", "sp_oauth_role", "sp_oauth_org_id", "sp_teacher_email", "sp_teacher_full_name", "sp_teacher_terms_ok"]:
            request.session.pop(k, None)

        return redirect("screening_only:teacher_onboarding")     
        

    messages.error(request, "Unknown login flow.")
    return redirect("screening_only:enroll_school")


def _get_ip(request: HttpRequest) -> Optional[str]:
    xff = request.META.get("HTTP_X_FORWARDED_FOR")
    if xff:
        # take first
        return xff.split(",")[0].strip()
    return request.META.get("REMOTE_ADDR")


@require_screening_only_admin
def admin_onboarding(request: HttpRequest) -> HttpResponse:
    """
    Admin onboarding includes acceptance (one-time) and moves to link sharing dashboard:contentReference[oaicite:16]{index=16}.
    """
    org = request.org
    user = request.user

    accepted = _is_terms_accepted(user, org, ScreeningTermsAcceptance.ActorRole.ORG_ADMIN)
    if request.method == "POST":
        if request.POST.get("accept_terms") == "on":
            if not accepted:
                ScreeningTermsAcceptance.objects.create(
                    organization=org,
                    user=user,
                    actor_role=ScreeningTermsAcceptance.ActorRole.ORG_ADMIN,
                    version=TERMS_VERSION,
                    ip_address=_get_ip(request),
                    user_agent=(request.META.get("HTTP_USER_AGENT") or "")[:255],
                )
            try:
                prof = org.screening_only_profile
                if not prof.onboarding_completed_at:
                    prof.onboarding_completed_at = timezone.now()
                    prof.save(update_fields=["onboarding_completed_at"])
            except Exception:
                pass

            return redirect("screening_only:admin_link_dashboard")
        messages.error(request, "You must accept the terms to continue.")

    guide_url = getattr(settings, "SCREENING_GUIDE_URL", "")
    training_url = getattr(settings, "SCREENING_TRAINING_VIDEO_URL", "")
    terms_url = getattr(settings, "SCREENING_TERMS_URL", "") or "#"

    return render(
        request,
        "screening_only/admin_onboarding.html",
        {
            "org": org,
            "accepted": accepted,
            "guide_url": guide_url,
            "training_url": training_url,
            "terms_url": terms_url,
        },
    )


@require_screening_only_admin
def admin_link_dashboard(request: HttpRequest) -> HttpResponse:
    """
    Admin sees pre-written teacher message and screening link to share:contentReference[oaicite:17]{index=17}.
    """
    org = request.org
    teacher_link = request.build_absolute_uri(reverse("screening_only:teacher_access_portal", args=[org.screening_link_token]))

    # You can tweak this content to exactly match your final comms.
    teacher_message = (
        f"Dear Teacher,\n\n"
        f"Our school is participating in the Nutrilift Growth & Nutrition Screening program.\n"
        f"Please use the link below to complete student screenings as per the schedule shared by the school.\n\n"
        f"Screening link: {teacher_link}\n\n"
        f"Thank you."
    )

    return render(
        request,
        "screening_only/admin_link_dashboard.html",
        {
            "org": org,
            "teacher_link": teacher_link,
            "teacher_message": teacher_message,
            "dashboard_url": reverse("screening_only:admin_performance_dashboard"),
        },
    )


@require_screening_only_admin
def admin_performance_dashboard(request: HttpRequest) -> HttpResponse:
    """
    Shows screening performance by class/division and academic year (once/twice):contentReference[oaicite:18]{index=18}.
    """
    org = request.org
    ay = request.GET.get("ay") or ""
    years = available_academic_years(org)
    if not ay:
        ay = years[0] if years else ""

    start_dt, end_dt = academic_year_range(ay)
    rows = screening_counts_by_class(org, start_dt, end_dt)

    return render(
        request,
        "screening_only/admin_performance_dashboard.html",
        {
            "org": org,
            "ay": ay,
            "years": years,
            "start_dt": start_dt,
            "end_dt": end_dt,
            "rows": rows,
            "link_dashboard_url": reverse("screening_only:admin_link_dashboard"),
        },
    )

@require_screening_only_teacher
def teacher_class_selection(request: HttpRequest) -> HttpResponse:
    """
    Mandatory class/section selection page for teachers (stores selection in session).
    """
    import json

    org = request.org
    classrooms_qs = Classroom.objects.filter(organization=org).order_by("grade", "division", "id")

    # Build divisions-by-grade mapping (for dependent dropdown)
    preferred_grade_order = ["Nursery", "K.G."] + [str(i) for i in range(1, 13)] + ["Other"]
    grade_rank = {g: i for i, g in enumerate(preferred_grade_order)}

    preferred_division_order = [chr(c) for c in range(ord("A"), ord("Z") + 1)] + ["Other"]
    division_rank = {d: i for i, d in enumerate(preferred_division_order)}

    divisions_by_grade = {}
    for c in classrooms_qs:
        g = c.grade or ""
        d = c.division or ""
        divisions_by_grade.setdefault(g, set()).add(d)

    # Sorted grades + sorted divisions per grade
    grades = sorted(divisions_by_grade.keys(), key=lambda g: (grade_rank.get(g, 999), str(g)))
    divisions_by_grade_sorted = {}
    for g in grades:
        divs = sorted(list(divisions_by_grade[g]), key=lambda d: (division_rank.get(d, 999), str(d)))
        divisions_by_grade_sorted[g] = divs

    # Default selection from session (if any)
    selected_grade = ""
    selected_division = ""
    selected_classroom_id = request.session.get(TEACHER_SELECTED_CLASSROOM_SESSION_KEY) or ""
    if selected_classroom_id:
        selected_classroom = classrooms_qs.filter(id=selected_classroom_id).first()
        if selected_classroom:
            selected_grade = selected_classroom.grade or ""
            selected_division = selected_classroom.division or ""
        else:
            # stale/invalid stored selection
            request.session.pop(TEACHER_SELECTED_CLASSROOM_SESSION_KEY, None)

    if request.method == "POST":
        grade = (request.POST.get("grade") or "").strip()
        division = (request.POST.get("division") or "").strip()

        classroom = Classroom.objects.filter(
            organization=org,
            grade=grade,
            division=division,
        ).first()

        if not classroom:
            messages.error(request, "Please select a valid Class and Section.")
            selected_grade = grade
            selected_division = division
        else:
            request.session[TEACHER_SELECTED_CLASSROOM_SESSION_KEY] = str(classroom.id)
            return redirect("screening_only:teacher_dashboard")

    return render(
        request,
        "screening_only/teacher_class_selection.html",
        {
            "org": org,
            "grades": grades,
            "divisions_by_grade": json.dumps(divisions_by_grade_sorted),
            "selected_grade": selected_grade,
            "selected_division": selected_division,
        },
    )

@require_screening_only_teacher
def teacher_dashboard(request: HttpRequest) -> HttpResponse:
    """
    Teacher dashboard: must have a selected class/section in session, then shows only those students.
    """
    org = request.org
    # Basic cycle concept: last 6 months
    cycle_start = timezone.now() - timedelta(days=183)

    classrooms = Classroom.objects.filter(organization=org).order_by("grade", "division")

    # NEW: enforce mandatory selection from session
    classroom_id = request.session.get(TEACHER_SELECTED_CLASSROOM_SESSION_KEY) or ""
    selected_classroom = classrooms.filter(id=classroom_id).first() if classroom_id else None
    if not selected_classroom:
        request.session.pop(TEACHER_SELECTED_CLASSROOM_SESSION_KEY, None)
        return redirect("screening_only:teacher_class_selection")

    q = (request.GET.get("q") or "").strip()
    lang = (request.GET.get("lang") or "en").strip().lower()

    students = (
        Student.objects.filter(organization=org, screenings__teacher=request.user)
        .distinct()
        .select_related("classroom")
    )

    # NEW: always filter by selected class/section
    students = students.filter(classroom_id=selected_classroom.id)

    if q:
        students = students.filter(
            Q(first_name__icontains=q) |
            Q(last_name__icontains=q) |
            Q(student_code__icontains=q)
        )

    # Annotate last screening
    from django.db.models import OuterRef, Subquery

    last_screening = (
        Screening.objects.filter(student=OuterRef("pk"), teacher=request.user)
        .order_by("-screened_at")
    )
    students = students.annotate(
        last_screening_id=Subquery(last_screening.values("id")[:1]),
        last_screened_at=Subquery(last_screening.values("screened_at")[:1]),
        last_risk=Subquery(last_screening.values("risk_level")[:1]),
    ).order_by("last_name", "first_name", "id")

    for s in students:
        s.screening_url = reverse("screening_create", args=[s.id]) + f"?lang={lang}"

    # Existing add-student flow (creates new Student + Screening) is in screening app.
    # Keep passing classroom id so teacher_add_student can prefill class/section.
    add_student_url = reverse("teacher_add_student") + f"?classroom={selected_classroom.id}"

    return render(
        request,
        "screening_only/teacher_dashboard.html",
        {
            "org": org,
            "classrooms": classrooms,
            "selected_classroom_id": str(selected_classroom.id),
            "selected_classroom": selected_classroom,
            "q": q,
            "lang": lang,
            "students": students,
            "add_student_url": add_student_url,
            "cycle_start": cycle_start,
        },
    )


def parent_video(request: HttpRequest, token: str) -> HttpResponse:
    """
    Public parent education video page (language switch + link to result):contentReference[oaicite:20]{index=20}.
    """
    from messaging.i18n import edu_video_url

    screening_id = parse_parent_token(token)
    s = get_object_or_404(Screening.objects.select_related("student", "organization"), id=screening_id)

    lang = (request.GET.get("lang") or "en").strip().lower()
    # Provide 3 options: en, hi, local
    try:
        local_code = (s.organization.screening_only_profile.local_language_code or "").strip().lower() or "local"
    except Exception:
        local_code = "local"

    if lang not in ("en", "hi", "local", local_code):
        lang = "en"

    # We reuse existing env-configured URLs
    video = edu_video_url("local" if lang == local_code else lang)

    return render(
        request,
        "screening_only/parent_video.html",
        {
            "screening": s,
            "token": token,
            "lang": lang,
            "local_code": local_code,
            "video_url": video,
            "result_url": reverse("screening_only:parent_result", args=[token]),
        },
    )


def parent_result(request: HttpRequest, token: str) -> HttpResponse:
    """
    Public parent screening result view (linked from WhatsApp and from video page).
    """
    screening_id = parse_parent_token(token)
    s = get_object_or_404(
        Screening.objects.select_related("student", "student__classroom", "organization"),
        id=screening_id,
    )

    lang = (request.GET.get("lang") or "en").strip().lower()
    try:
        local_code = (s.organization.screening_only_profile.local_language_code or "").strip().lower() or "local"
    except Exception:
        local_code = "local"

    if lang not in ("en", "hi", "local", local_code):
        lang = "en"

    flags = s.red_flags or []
    flags_text = (
        (flags_to_text(flags, local_code) if lang == local_code else flags_to_text(flags, lang))
        or flags_to_text(flags, "en")
        or ""
    )

    # Reuse the common screening_result template for parents as well.
    # We pass is_parent_view so the template can hide teacher-only actions.
    return render(
        request,
        "screening/screening_result.html",
        {
            "s": s,
            "token": token,
            "lang": lang,
            "local_code": local_code,
            "flags_text": flags_text,
            "video_url": reverse("screening_only:parent_video", args=[token]),
            "is_parent_view": True,
        },
    )


def logout_view(request: HttpRequest) -> HttpResponse:
    logout(request)
    messages.success(request, "Logged out.")
    return redirect("screening_only:enroll_school")


# ---------- Inditech ----------

from accounts.decorators import require_roles


@require_roles(Role.INDITECH)
def inditech_school_list(request: HttpRequest) -> HttpResponse:
    """
    Inditech – Registered Schools list:contentReference[oaicite:21]{index=21}.
    """
    schools = ScreeningSchoolProfile.objects.select_related("organization").order_by("-created_at")
    return render(
        request,
        "screening_only/inditech_school_list.html",
        {
            "schools": schools,
        },
    )


@require_roles(Role.INDITECH)
def inditech_school_dashboard(request: HttpRequest, org_id: int) -> HttpResponse:
    org = get_object_or_404(Organization, id=org_id)
    profile = getattr(org, "screening_only_profile", None)
    if not profile:
        return HttpResponseForbidden("Not a Screening Program school.")

    ay = request.GET.get("ay") or ""
    years = available_academic_years(org)
    if not ay:
        ay = years[0] if years else ""

    start_dt, end_dt = academic_year_range(ay)
    rows = screening_counts_by_class(org, start_dt, end_dt)

    return render(
        request,
        "screening_only/inditech_school_dashboard.html",
        {
            "org": org,
            "profile": profile,
            "ay": ay,
            "years": years,
            "start_dt": start_dt,
            "end_dt": end_dt,
            "rows": rows,
        },
    )

def existing_admin_login(request: HttpRequest) -> HttpResponse:
    """
    Allows existing school admins to sign in from the enrollment page.
    After OAuth, we'll find their organization by matching their email.
    """
    # Store pending OAuth context in session (no org_id yet - we'll find it after OAuth)
    request.session["sp_oauth_role"] = "existing_admin"
    request.session.modified = True
    
    return redirect("screening_only:google_oauth_start")
================================================================================
FILE: screening_only\__init__.py
================================================================================


================================================================================
FILE: templates\assist\applications_list.html
================================================================================

<html>
<head>
<h2>{{ org.name }} – Applications</h2>
<style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
  </style>
</head>
<body>
<form method="get" action="">
  <label>Filter by status:
    <select name="status" onchange="this.form.submit()">
      <option value="APPLIED"   {% if status == 'APPLIED' %}selected{% endif %}>Applied</option>
      <option value="FORWARDED" {% if status == 'FORWARDED' %}selected{% endif %}>Forwarded</option>
    </select>
  </label>
</form>

{% if status == 'APPLIED' and counts.APPLIED %}
    <form method="post" action="{% url 'assist:forward_all' %}">{% csrf_token %}
      <button class="btn btn-primary" type="submit">Forward All to SAPA</button>
    </form>
  {% endif %}

  <table style="margin-top:1rem">
    <thead>
      <tr>
        <th>Applied At</th>
        <th>Student</th>
        <th>Parent Phone</th>
        <th>Low-income?</th>
        <th>Income verification</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for a in applications %}
        <tr>
          <td>{{ a.applied_at|date:"Y-m-d H:i" }}</td>
          <td>{{ a.student.full_name }}</td>
          <td>{% if a.guardian %}{{ a.guardian.phone_e164 }}{% endif %}</td>
          <td>{% if a.low_income_declared %}Yes{% else %}No{% endif %}</td>
          <td>{{ a.income_verification_status }}</td>
          <td>{{ a.status }}</td>
          <td>
            {% if a.status == 'APPLIED' %}
              {% if not a.low_income_declared %}
                Not eligible (not low-income)
              {% else %}
                <form method="post" action="{% url 'assist:forward_one' a.id %}">{% csrf_token %}
                  <button class="btn" type="submit">Forward</button>
                </form>
              {% endif %}
            {% else %}-{% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7">No applications</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>
================================================================================
FILE: templates\assist\apply_form.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Parental Consent – {{ org.name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:680px;margin:0 auto;padding:1rem;}
    .card{border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0;}
    label{display:block;margin:.6rem 0;}
    input[type=text],input[type=tel]{width:100%;padding:.5rem;border:1px solid #d1d5db;border-radius:6px;}
    .btn{display:inline-block;padding:.6rem 1rem;border-radius:6px;background:#2563eb;color:#fff;text-decoration:none;border:0;}
    .btn-secondary{background:#6b7280}
  </style>
</head>
<body>
  <h2>Parental Consent for Monthly Nutrition Support</h2>
  <div class="card">
    <p><strong>School:</strong> {{ org.name }}</p>
    <p><strong>Child:</strong> {{ student.full_name }}</p>
    {% if existing and existing.status != 'FORWARDED' %}
      <p style="color:#92400e;background:#fef3c7;padding:.5rem;border-radius:6px;">
        A recent application exists (status: {{ existing.status }}). If you continue, a new submission will be recorded.
      </p>
    {% endif %}
  </div>

  <form method="post">{% csrf_token %}
    

    <div class="card">
      <h4>Consent</h4>
      <label><input type="checkbox" name="agree_consent" required> I agree to receive monthly nutrition support for my child for up to 6 months.</label>
      <label><input type="checkbox" name="confirm_understanding" required> I have read and understood the information shared by the school/SAPA.</label>
    </div>

    <button class="btn" type="submit">Approve Consent</button>
    <a class="btn btn-secondary" href="https://wa.me/">Decline</a>
  </form>
</body>
</html>

================================================================================
FILE: templates\assist\apply_success.html
================================================================================

<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Application Submitted</title>
<style>body{font-family:system-ui;max-width:680px;margin:0 auto;padding:1.5rem;} .pill{background:#ecfdf5;color:#065f46;padding:.6rem 1rem;border-radius:9999px;display:inline-block}</style>
</head>
<body>
  <h2 class="pill">Thank you! Your consent has been submitted.</h2>
  <p>The school administrator will review and forward your application to SAPA.</p>
</body>
</html>

================================================================================
FILE: templates\assist\metric_applications_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title }} – {{ org.name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #e5e7eb;text-align:left}
    .muted{color:#6b7280}
    .pill{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:.1rem .5rem;font-size:.9rem}
  </style>
</head>
<body>
  <p><a href="{% url 'assist:school_app_dashboard' %}">← Back to dashboard</a></p>
  <h2>{{ title }}</h2>
  <p class="muted">Matching period: <strong>{{ period|upper }}</strong> • {{ total }} records</p>

  <table>
    <thead>
      <tr>
        <th>Name of student</th>
        <th>Class &amp; division of student</th>
        <th>Age of student</th>
        <th>Parent’s phone number</th>
        <th>Applied at</th>
        <th>Forwarded at</th>
        <th>Application status</th>
        <th>Approved at</th>
      </tr>
    </thead>
    <tbody>
      {% for r in page_obj.object_list %}
        <tr>
          <td>{{ r.name }}</td>
          <td>{{ r.class_div }}</td>
          <td>{% if r.age %}{{ r.age }}{% else %}-{% endif %}</td>
          <td>{{ r.phone }}</td>
          <td>{{ r.applied_at|date:"Y-m-d H:i" }}</td>
          <td>{% if r.forwarded_at %}{{ r.forwarded_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
          <td>{{ r.status }}</td>
          <td>{% if r.approved_at != 'Pending' %}{{ r.approved_at|date:"Y-m-d H:i" }}{% else %}Pending{% endif %}</td>
        </tr>
      {% empty %}
        <tr><td colspan="8">No applications</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if page_obj.paginator.num_pages > 1 %}
    <p>
      {% if page_obj.has_previous %}
        <a class="pill" href="?period={{ period }}&page={{ page_obj.previous_page_number }}">Previous</a>
      {% endif %}
      <span class="muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="pill" href="?period={{ period }}&page={{ page_obj.next_page_number }}">Next</a>
      {% endif %}
    </p>
  {% endif %}
</body>
</html>

================================================================================
FILE: templates\assist\metric_students_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title }} – {{ org.name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #e5e7eb;text-align:left}
    .muted{color:#6b7280}
    .pill{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:.1rem .5rem;font-size:.9rem}
  </style>
</head>
<body>
  <p><a href="{% url 'assist:school_app_dashboard' %}">← Back to dashboard</a></p>
  <h2>{{ title }}</h2>
  <p class="muted">
    {% if title == 'Total students' %}Showing all students (filter does not apply).
    {% else %}Matching period: <strong>{{ period|upper }}</strong>{% endif %}
    • {{ total }} records
  </p>

  <table>
    <thead>
      <tr>
        <th>Name of student</th>
        <th>Class &amp; division</th>
        <th>Age</th>
        <th>Parent’s phone number</th>
        <th>Screening status</th>
        <th>Redflag status</th>
      </tr>
    </thead>
    <tbody>
      {% for r in page_obj.object_list %}
        <tr>
          <td>{{ r.name }}</td>
          <td>{{ r.class_div }}</td>
          <td>{% if r.age %}{{ r.age }}{% else %}-{% endif %}</td>
          <td>{{ r.phone }}</td>
          <td>{{ r.screened }}</td>
          <td>{{ r.redflag }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if page_obj.paginator.num_pages > 1 %}
    <p>
      {% if page_obj.has_previous %}
        <a class="pill" href="?period={{ period }}&page={{ page_obj.previous_page_number }}">Previous</a>
      {% endif %}
      <span class="muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="pill" href="?period={{ period }}&page={{ page_obj.next_page_number }}">Next</a>
      {% endif %}
    </p>
  {% endif %}
</body>
</html>

================================================================================
FILE: templates\assist\sapa_approvals.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SAPA – Approvals & Batching</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    select,input,button{padding:.5rem;border:1px solid #d1d5db;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    .pill{display:inline-block;padding:.25rem .5rem;border-radius:9999px;background:#eef2ff;color:#3730a3}
    .btn{padding:.5rem .8rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
    .btn-danger{background:#b91c1c;border-color:#b91c1c;color:#fff}
  </style>
</head>
<body>
  <h2>SAPA Approvals</h2>

  <form class="row" method="get" action="">
    <label>School:
      <select name="school" onchange="this.form.submit()">
        <option value="">Choose a school…</option>
        {% for s in schools %}
          <option value="{{ s.id }}" {% if selected_school and s.id == selected_school.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </label>
    {% if selected_school %}
      <span class="pill">Approved: {{ approved_count }}</span>
    {% endif %}
  </form>

  {% if selected_school %}
  <div class="row" style="margin-top:1rem">
    

    <form method="post" action="{% url 'assist:sapa_approve_all' %}">{% csrf_token %}
      <input type="hidden" name="school_id" value="{{ selected_school.id }}">
      
      <button class="btn btn-primary" type="submit">Approve ALL Pending</button>
    </form>

    <form method="post" action="{% url 'assist:sapa_approve_top_n' %}">{% csrf_token %}
      <input type="hidden" name="school_id" value="{{ selected_school.id }}">
      
      <input type="number" min="1" name="n" placeholder="Top N" required>
      <button class="btn btn-primary" type="submit">Approve Top‑N (alphabetic)</button>
    </form>

    <form method="post" action="{% url 'assist:sapa_reject_all' %}">{% csrf_token %}
      <input type="hidden" name="school_id" value="{{ selected_school.id }}">
      <button class="btn btn-danger" type="submit" onclick="return confirm('Reject ALL pending?')">Reject ALL Pending</button>
    </form>
  </div>

  

  <table>
    <thead><tr><th>Student</th><th>Parent Phone</th><th>Applied</th><th>Status</th></tr></thead>
    <tbody>
    {% for a in pending %}
      <tr>
        <td>{{ a.student.full_name }}</td>
        <td>{% if a.guardian %}{{ a.guardian.phone_e164 }}{% endif %}</td>
        <td>{{ a.applied_at|date:"Y-m-d H:i" }}</td>
        <td>{{ a.status }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="4">No pending applications.</td></tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if request.GET.ok %}
    <p class="pill" style="margin-top:1rem">
      Done: {{ request.GET.ok }} (n={{ request.GET.n|default:"0" }})
      {% if request.GET.skipped %} • skipped={{ request.GET.skipped }}{% endif %}
    </p>
  {% endif %}
</body>
</html>

================================================================================
FILE: templates\assist\school_admin_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Applications – {{ org.name }}</title>
  <div style="border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0">
    <strong>Teacher screening link</strong>
    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem">
      <input type="text" readonly value="{{ teacher_link }}" style="flex:1;padding:.5rem;border:1px solid #d1d5db;border-radius:6px" onclick="this.select()">
      <a class="btn" href="{{ teacher_link }}" target="_blank" rel="noopener">Open</a>
      <button class="btn" type="button" onclick="copyTeacherLink('{{ teacher_link|escapejs }}', this)">Copy</button>
    </div>
    <p style="color:#6b7280;margin:.5rem 0 0 0">Unique per organization. Share this with teachers (they must be logged in and have the Teacher role).</p>
  </div>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:1000px;margin:0 auto;padding:1rem;}
    .stats{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
    .stat{border:1px solid #e5e7eb;border-radius:8px;padding:.75rem 1rem;min-width:160px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  </style>
  <script>
    function _fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      let ok = false;
      try { ok = document.execCommand('copy'); } catch (e) { ok = false; }
      document.body.removeChild(ta);
      return ok;
    }
  
    function copyTeacherLink(text, btnEl) {
      const original =
        (btnEl && btnEl.dataset && btnEl.dataset.originalText)
          ? btnEl.dataset.originalText
          : (btnEl ? btnEl.textContent : 'Copy');
  
      if (btnEl && btnEl.dataset && !btnEl.dataset.originalText) {
        btnEl.dataset.originalText = original;
      }
  
      const setStatus = (label) => {
        if (!btnEl) return;
        btnEl.textContent = label;
        window.setTimeout(() => { btnEl.textContent = original; }, 1200);
      };
  
      // Prefer Clipboard API (works best on HTTPS).
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text)
          .then(() => setStatus('Copied'))
          .catch(() => setStatus(_fallbackCopy(text) ? 'Copied' : 'Copy failed'));
        return;
      }
  
      setStatus(_fallbackCopy(text) ? 'Copied' : 'Copy failed');
    }
  </script>
  
</head>
<body>
  <h2>{{ org.name }} – Assistance Applications</h2>
  <a href="{% url 'assist:assist_applications' %}"
   class="btn btn-primary"
   style="margin: 0 0 1rem 0;">Applications</a>
    <form method="get" action="" class="row" style="margin:.5rem 0 1rem 0">
        <label><strong>Filter</strong>&nbsp;
          <select name="period" onchange="this.form.submit()">
            <option value="3m"  {% if period == '3m' %}selected{% endif %}>Last 3 months</option>
            <option value="6m"  {% if period == '6m' %}selected{% endif %}>Last 6 months</option>
            <option value="12m" {% if period == '12m' %}selected{% endif %}>Last 12 months</option>
            <option value="18m" {% if period == '18m' %}selected{% endif %}>Last 18 months</option>
            <option value="all" {% if period == 'all' %}selected{% endif %}>All</option>
          </select>
        </label>
        <!-- Preserve current table status filter value when changing period -->
        <input type="hidden" name="status" value="{{ status }}">
      </form>
    
      <div class="stats">
        <a class="stat" href="{% url 'assist:metric_students' 'all' %}">
          <strong>Total students</strong><div>{{ summary.total_students }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'screened' %}?period={{ period }}">
          <strong>Total screened</strong><div>{{ summary.total_screened }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'redflag' %}?period={{ period }}">
          <strong>Total red‑flagged</strong><div>{{ summary.total_redflag }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_applications' 'pending' %}?period={{ period }}">
          <strong>Applications pending</strong><div>{{ summary.applications_pending }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_applications' 'approved' %}?period={{ period }}">
          <strong>Applications approved</strong><div>{{ summary.applications_approved }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'boys_screened' %}?period={{ period }}">
          <strong>Total boys screened</strong><div>{{ summary.boys_screened }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'boys_redflag' %}?period={{ period }}">
          <strong>Total boys red‑flagged</strong><div>{{ summary.boys_redflag }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'girls_screened' %}?period={{ period }}">
          <strong>Total girls screened</strong><div>{{ summary.girls_screened }}</div>
        </a>
      
        <a class="stat" href="{% url 'assist:metric_students' 'girls_redflag' %}?period={{ period }}">
          <strong>Total girls red‑flagged</strong><div>{{ summary.girls_redflag }}</div>
        </a>
      </div>
      <p style="color:#6b7280;margin:.25rem 0 1rem 0">Filter applies to all tiles above except “Total students”.</p>

</body>
</html>
================================================================================
FILE: templates\fulfillment\dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fulfillment</title>
  <style>
    body{font-family:system-ui;max-width:1150px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  </style>
</head>
<body>
  <h2>Fulfillment dashboard</h2>

  <div class="row">
    <a class="btn btn-primary" href="{% url 'fulfillment:production_order_create' %}">New production order</a>
    <a class="btn btn-primary" href="{% url 'fulfillment:shipment_create' %}">New shipment to school</a>
    <a class="btn" href="{% url 'fulfillment:manufacturer_po_list' %}">Manufacturer portal</a>
    <a class="btn" href="{% url 'fulfillment:logistics_shipments_list' %}">Logistics portal</a>
    <a class="btn" href="{% url 'fulfillment:school_incoming' %}">School shipments</a>
  </div>

  <h3 style="margin-top:1.5rem">Production orders</h3>
  <table>
    <thead><tr><th>ID</th><th>Month</th><th>Manufacturer</th><th>Packs</th><th>Status</th></tr></thead>
    <tbody>
      {% for po in pos %}
        <tr>
          <td>{{ po.id }}</td>
          <td>{{ po.month|date:"Y-m" }}</td>
          <td>{% if po.manufacturer %}{{ po.manufacturer.name }}{% endif %}</td>
          <td>{{ po.total_packs }}</td>
          <td>{{ po.status }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5">No production orders.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 style="margin-top:1.5rem">Shipments</h3>
  <table>
    <thead><tr><th>ID</th><th>School</th><th>Month</th><th>Status</th><th>Tracking</th><th></th></tr></thead>
    <tbody>
      {% for sh in shipments %}
        <tr>
          <td>{{ sh.id }}</td>
          <td>{{ sh.school.name }}</td>
          <td>M{{ sh.month_index }}</td>
          <td>{{ sh.status }}</td>
          <td>{{ sh.tracking_number }}</td>
          <td><a class="btn" href="{% url 'fulfillment:shipment_detail' sh.id %}">View</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No shipments.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\fulfillment\logistics_shipments_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Logistics Shipments</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    input,button{padding:.4rem;border:1px solid #d1d5db;border-radius:6px}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  </style>
</head>
<body>
  <h2>Logistics – Shipments ({{ org.name }})</h2>
  <p><a class="btn" href="{% url 'fulfillment:dashboard' %}">Back</a></p>

  <table>
    <thead><tr><th>ID</th><th>School</th><th>Month</th><th>Status</th><th>Tracking</th><th>Actions</th></tr></thead>
    <tbody>
      {% for sh in shipments %}
        <tr>
          <td>{{ sh.id }}</td>
          <td>{{ sh.school.name }}</td>
          <td>M{{ sh.month_index }}</td>
          <td>{{ sh.status }}</td>
          <td>{{ sh.tracking_number }}</td>
          <td>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <a class="btn" href="{% url 'fulfillment:shipment_detail' sh.id %}">View</a>
              {% if sh.status == 'PLANNED' %}
                <form method="post" action="{% url 'fulfillment:shipment_dispatch' sh.id %}">{% csrf_token %}
                  <input name="tracking_number" placeholder="Tracking" value="{{ sh.tracking_number }}">
                  <button class="btn btn-primary" type="submit">Dispatch</button>
                </form>
              {% elif sh.status == 'DISPATCHED' %}
                <form method="post" action="{% url 'fulfillment:shipment_deliver' sh.id %}">{% csrf_token %}
                  <button class="btn btn-primary" type="submit" onclick="return confirm('Mark delivered?')">Mark delivered</button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No shipments.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\fulfillment\manufacturer_po_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Manufacturer Production Orders</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    select,button{padding:.4rem;border:1px solid #d1d5db;border-radius:6px}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
  </style>
</head>
<body>
  <h2>Manufacturer – Production orders ({{ org.name }})</h2>
  <p><a class="btn" href="{% url 'fulfillment:dashboard' %}">Back</a></p>
  <table>
    <thead><tr><th>ID</th><th>Month</th><th>Packs</th><th>Status</th><th>Update</th></tr></thead>
    <tbody>
      {% for po in pos %}
        <tr>
          <td>{{ po.id }}</td>
          <td>{{ po.month|date:"Y-m" }}</td>
          <td>{{ po.total_packs }}</td>
          <td>{{ po.status }}</td>
          <td>
            <form method="post" action="{% url 'fulfillment:manufacturer_po_update_status' po.id %}">{% csrf_token %}
              <select name="status">
                {% for key,label in status_choices %}
                  <option value="{{ key }}" {% if key == po.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <button type="submit">Save</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="5">No production orders.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\fulfillment\po_form.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>New Production Order</title>
  <style>body{font-family:system-ui;max-width:700px;margin:0 auto;padding:1rem}label{display:block;margin-top:.75rem}input,select,textarea{width:100%;padding:.5rem} .btn{margin-top:1rem;padding:.5rem .8rem}</style>
</head>
<body>
  <h2>New production order</h2>
  <form method="post">{% csrf_token %}
    {{ form.as_p }}
    <button class="btn" type="submit">Create</button>
  </form>
  <p><a href="{% url 'fulfillment:dashboard' %}">Back</a></p>
</body>
</html>

================================================================================
FILE: templates\fulfillment\school_incoming.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>School Shipments</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    button{padding:.4rem;border:1px solid #d1d5db;border-radius:6px}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  </style>
</head>
<body>
  <h2>School – Shipments ({{ org.name }})</h2>
  <p><a class="btn" href="{% url 'fulfillment:dashboard' %}">Back</a></p>

  <table>
    <thead><tr><th>ID</th><th>Month</th><th>Status</th><th>Tracking</th><th>Delivered at</th><th>Actions</th></tr></thead>
    <tbody>
      {% for sh in shipments %}
        <tr>
          <td>{{ sh.id }}</td>
          <td>M{{ sh.month_index }}</td>
          <td>{{ sh.status }}</td>
          <td>{{ sh.tracking_number }}</td>
          <td>{{ sh.delivered_at|default:"-" }}</td>
          <td>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <a class="btn" href="{% url 'fulfillment:shipment_detail' sh.id %}">View</a>
              {% if sh.status != 'DELIVERED' %}
                <form method="post" action="{% url 'fulfillment:school_confirm_delivery' sh.id %}">{% csrf_token %}
                  <button class="btn btn-primary" type="submit" onclick="return confirm('Confirm delivery?')">Confirm delivered</button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No shipments.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\fulfillment\shipment_detail.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shipment {{ shipment.id }}</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    .btn{display:inline-block;padding:.35rem .7rem;border:1px solid #d1d5db;border-radius:6px;text-decoration:none}
    .btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}
  </style>
</head>
<body>
  <h2>Shipment {{ shipment.id }}</h2>
  <p><strong>School:</strong> {{ shipment.school.name }} | <strong>Month:</strong> M{{ shipment.month_index }} | <strong>Status:</strong> {{ shipment.status }}</p>
  <p><strong>Tracking:</strong> {{ shipment.tracking_number }}</p>

  <p><a class="btn" href="{% url 'fulfillment:dashboard' %}">Back to dashboard</a></p>

  <table>
    <thead><tr><th>Student</th><th>Supply month</th><th>QR token</th><th>Delivered on</th></tr></thead>
    <tbody>
      {% for it in items %}
        <tr>
          <td>{{ it.monthly_supply.enrollment.student.full_name }}</td>
          <td>M{{ it.monthly_supply.month_index }}</td>
          <td>{{ it.monthly_supply.qr_token }}</td>
          <td>{{ it.monthly_supply.delivered_on|default:"-" }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4">No items.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\fulfillment\shipment_form.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>New Shipment</title>
  <style>body{font-family:system-ui;max-width:700px;margin:0 auto;padding:1rem}label{display:block;margin-top:.75rem}input,select,textarea{width:100%;padding:.5rem} .btn{margin-top:1rem;padding:.5rem .8rem}</style>
</head>
<body>
  <h2>New shipment to school</h2>
  <p style="color:#6b7280">When you create a shipment, all eligible monthly supplies for the selected school & month are automatically attached.</p>
  <form method="post">{% csrf_token %}
    {{ form.as_p }}
    <button class="btn" type="submit">Create shipment</button>
  </form>
  <p><a href="{% url 'fulfillment:dashboard' %}">Back</a></p>
</body>
</html>

================================================================================
FILE: templates\orgs\start.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Get started</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:720px;margin:0 auto;padding:1.5rem;}
    .tabs{display:flex;gap:1rem;margin-bottom:1rem}
    .tab{padding:.5rem 1rem;border:1px solid #e5e7eb;border-radius:8px;text-decoration:none}
    .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
    form{display:grid;gap:.75rem}
    label{display:block;font-weight:600}
    input,select{width:100%;padding:.5rem;border:1px solid #d1d5db;border-radius:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .actions{margin-top:1rem}
    .btn{padding:.5rem 1rem;border:1px solid #2563eb;background:#2563eb;color:#fff;border-radius:6px}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <h1>Welcome to Nutrilift</h1>
  <p>Create your school organization or sign in to continue.</p>

  <div class="tabs">
    <a class="tab {% if mode == 'signup' %}active{% endif %}" href="?mode=signup">Create organization</a>
    <a class="tab {% if mode == 'login' %}active{% endif %}" href="?mode=login">Log in</a>
  </div>

  {% if mode == 'login' %}
    <form method="post">
      {% csrf_token %}<input type="hidden" name="mode" value="login">
      {% if login_form.non_field_errors %}<div class="err">{{ login_form.non_field_errors }}</div>{% endif %}
      <div>
        <label>Email</label>{{ login_form.email }}
        {% for e in login_form.email.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div>
        <label>Password</label>{{ login_form.password }}
        {% for e in login_form.password.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="actions"><button class="btn" type="submit">Log in</button></div>
    </form>
  {% else %}
    <form method="post">
      {% csrf_token %}<input type="hidden" name="mode" value="signup">
      {% if signup_form.non_field_errors %}<div class="err">{{ signup_form.non_field_errors }}</div>{% endif %}
      <div>
        <label>Organization name</label>{{ signup_form.name }}
        {% for e in signup_form.name.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
      <div class="row">
        <div>
          <label>Organization type</label>{{ signup_form.org_type }}
          {% for e in signup_form.org_type.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>
      </div>
      <div class="row">
        <div><label>City</label>{{ signup_form.city }}</div>
        <div><label>State</label>{{ signup_form.state }}</div>
      </div>
      <div><label>Country</label>{{ signup_form.country }}</div>

      <hr>
      <div><label>Admin email</label>{{ signup_form.admin_email }}</div>
      <div class="row">
        <div><label>Password</label>{{ signup_form.password1 }}</div>
        <div><label>Confirm password</label>{{ signup_form.password2 }}</div>
      </div>

      <p style="color:#6b7280">Timezone defaults to “Asia/Kolkata”. Link token is generated automatically. “Is active” is true by default.</p>
      <div class="actions"><button class="btn" type="submit">Create & continue</button></div>
    </form>
  {% endif %}
</body>
</html>

================================================================================
FILE: templates\program\compliance_form.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Monthly Compliance – {{ supply.enrollment.student.full_name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:680px;margin:0 auto;padding:1rem}
    .card{border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0}
    .btn{padding:.6rem 1rem;border-radius:8px;background:#2563eb;color:#fff;border:0}
    label{display:block;margin:.5rem 0}
    textarea{width:100%;min-height:100px}
  </style>
</head>
<body>
  <h2>Monthly Compliance – Month {{ supply.month_index }} of 6</h2>
  <div class="card">
    <p><strong>Child:</strong> {{ supply.enrollment.student.full_name }}</p>
    <p><strong>Delivered on:</strong> {{ delivered_on|default:"(pending logistics)" }}</p>
    <p><strong>Due:</strong> {{ due|date:"Y-m-d H:i" }}</p>
  </div>

  <form method="post">{% csrf_token %}
    <div class="card">
      <h3>Were you able to give the supplement daily (or almost daily)?</h3>
      {{ form.status }}
    </div>
    <div class="card">
      <label>{{ form.notes.label }}</label>
      {{ form.notes }}
    </div>
    <button class="btn" type="submit">Submit</button>
  </form>
</body>
</html>

================================================================================
FILE: templates\program\compliance_start.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Compliance Check</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:680px;margin:0 auto;padding:1rem;}
    .note{background:#eef2ff;color:#3730a3;padding:.75rem;border-radius:8px;margin:.75rem 0;}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <h2>Compliance Check – Month {{ supply.month_index }}</h2>
  {% if not supplied_on %}
  {% endif %}
  <p class="muted">Delivered on: {{ delivered_on|default:"(pending logistics)" }}</p>
  <p class="muted">Due on: {{ due|date:"Y-m-d H:i" }}</p>

  <div class="note">
    This is a placeholder page for Sprint 5. The actual compliance form and submission will be implemented in <strong>Sprint 6</strong>.
  </div>

  <p>You may close this page for now. We will remind you again on Day 27.</p>
</body>
</html>

================================================================================
FILE: templates\program\compliance_success.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Thank you</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>body{font-family:system-ui;max-width:680px;margin:0 auto;padding:1rem}.pill{background:#ecfdf5;color:#065f46;padding:.6rem 1rem;border-radius:9999px;display:inline-block}</style>
</head>
<body>
  <h2 class="pill">Thanks for your response!</h2>
  {% if comp %}
    <p>Status recorded: <strong>{{ comp.status }}</strong></p>
  {% endif %}
  <p>Your school will continue your child’s supply if eligible.</p>
</body>
</html>

================================================================================
FILE: templates\program\milestones_sapa.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SAPA – Milestones</title>
  <style>
    body{font-family:system-ui;max-width:1000px;margin:0 auto;padding:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
  </style>
</head>
<body>
  <h2>SAPA – Milestones Overview</h2>
  <table>
    <thead><tr><th>School</th><th>Overdue</th><th>Due</th><th>Completed</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.enrollment__organization__name }}</td>
        <td>{{ r.overdue }}</td>
        <td>{{ r.due }}</td>
        <td>{{ r.completed }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">No data</td></tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\program\milestones_school.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Milestones – {{ org.name }}</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem}
    .stats{display:flex;gap:1rem;flex-wrap:wrap;margin:.5rem 0}
    .stat{border:1px solid #e5e7eb;border-radius:8px;padding:.75rem 1rem;min-width:160px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    .warn{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:.7rem;border-radius:8px}
    .err{background:#fee2e2;border:1px solid #ef4444;color:#991b1b;padding:.7rem;border-radius:8px}
  </style>
</head>
<body>
  <h2>{{ org.name }} – Screening Milestones</h2>

  {% if suspended %}
  <div class="err">
    <strong>Access suspended:</strong> {{ reason }}<br>
    Please complete overdue milestones to restore access.
  </div>
  {% endif %}

  <div class="stats">
    <div class="stat"><strong>Due in ≤14 days</strong><div>{{ counts.due }}</div></div>
    <div class="stat"><strong>Overdue</strong><div>{{ counts.overdue }}</div></div>
    <div class="stat"><strong>Completed</strong><div>{{ counts.completed }}</div></div>
  </div>

  <h3>Overdue</h3>
  <table>
    <thead><tr><th>Student</th><th>Milestone</th><th>Due on</th></tr></thead>
    <tbody>
    {% for m in overdue_list %}
      <tr><td>{{ m.enrollment.student.full_name }}</td><td>{{ m.milestone }}</td><td>{{ m.due_on }}</td></tr>
    {% empty %}
      <tr><td colspan="3">None 🎉</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <h3>Due soon (≤14 days)</h3>
  <table>
    <thead><tr><th>Student</th><th>Milestone</th><th>Due on</th></tr></thead>
    <tbody>
    {% for m in due_list %}
      <tr><td>{{ m.enrollment.student.full_name }}</td><td>{{ m.milestone }}</td><td>{{ m.due_on }}</td></tr>
    {% empty %}
      <tr><td colspan="3">No upcoming milestones within 14 days.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</body>
</html>

================================================================================
FILE: templates\program\qr_landing.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pack Instructions – {{ org.name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;max-width:680px;margin:0 auto;padding:1rem;}
    .card{border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0;}
    .btn{display:inline-block;padding:.6rem 1rem;border-radius:6px;background:#2563eb;color:#fff;text-decoration:none;border:0;}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <h2>Nutrition Support Pack – Month {{ supply.month_index }}</h2>
  <div class="card">
    <p><strong>School:</strong> {{ org.name }}</p>
    <p><strong>Child:</strong> {{ student.full_name }}</p>
    {% if is_delivered %}
      <p class="muted">Delivered on <strong>{{ supply.delivered_on }}</strong>. Your compliance check is due on <strong>{{ supply.compliance_due_at|date:"Y-m-d H:i" }}</strong>.</p>
    {% else %}
      <p class="muted">This pack has not been marked as delivered yet by the school/SAPA logistics.</p>
    {% endif %}
  </div>

  <div class="card">
    <h4>How to use</h4>
    <ol>
      <li>Give the daily supplement as advised by the school/pediatrician.</li>
      <li>Keep the pack in a cool and dry place.</li>
      <li>On Day 27, please complete the short compliance check.</li>
    </ol>
  </div>

  <p>
    <a class="btn" href="{% url 'program:compliance_start' %}?token={{ supply.qr_token }}">Go to Compliance Form</a>
  </p>
</body>
</html>

================================================================================
FILE: templates\screening\add_student.html
================================================================================

{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Add student & complete screening</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    /* backend/screening/static/screening/screening_i18n.js
   Client-side i18n for Screening forms.
   - Only changes displayed strings (labels/questions/options/titles).
   - Does NOT change field names, values, r handlers.
*/

(function () {
  "use strict";

  const STORAGE_KEY = "nutrilift_lang";
  const DEFAULT_LANG = "mr";
  const SUPPORTED = ["en", "mr", "hi", "te", "ta", "ml", "kn", "bn"];

  // ---- TRANSLATIONS (from your Screening-form-8-languages.xlsx + a few UI strings) ----
  // Keys match the data-i18n attributes added in templates.
  const I18N = {
    "en": {
      "option.grade.K.G.": "K.G.",
      "ui.language.label": "Language",
      "page.add_student.heading": "Add student & complete screening",
      "page.add_student.browser_title": "Add student & complete screening",
      "page.screening.heading_prefix": "Screening",
      "page.screening.browser_title_prefix": "Screening",
      "button.create_student_complete_screening": "Create Student & Complete Screening",
      "button.complete_screening": "Complete Screening",
      "button.cancel": "Cancel",
      "hint.select_dob_first": "Select Date of Birth first to enable this field.",
      "field.grade.label": "Class",
      "field.division.label": "Section",
      "field.is_low_income.label": "Low income family",
      "field.deworming_date.label": "How many months ago?",
      "placeholder.select": "Select",
      "placeholder.select_grade": "Select class",
      "placeholder.select_division": "Select section",
      "placeholder.select_sex": "Select sex",
      "placeholder.select_age": "Select age",
      "placeholder.select_months": "Select months",
      "age.year_singular": "year",
      "age.year_plural": "years",
      "age.month_singular": "month",
      "age.month_plural": "months",

      /* --- Spreadsheet driven keys (English sheet) --- */
      "legend.class_assignment": "School / Class / Section",
      "legend.section_a": "SECTION A: PARTICULARS",
      "legend.section_b": "SECTION B: ANTHROPOMETRY",
      "legend.section_c": "SECTION C: QUICK HEALTH RED FLAGS",
      "legend.girls_only": "Adolescent Girls (Age ≥10 only)",
      "legend.section_d": "SECTION D: USUAL DIET TYPE AND 24-HOUR DIETARY RECALL (Yesterday)",
      "legend.section_e": "SECTION E: PROGRAM ENABLERS",
      "legend.section_f": "SECTION F: FOOD SECURITY",
      "hint.diet_24h": "24-hour recall (Yesterday): Did the student eat the following yesterday?",

      "field.student_name.label": "Student Name",
      "field.unique_student_id.label": "Roll Number",
      "field.dob.label": "Date of Birth",
      "field.sex.label": "Sex",
      "field.parent_phone_e164.label": "Parent’s phone number (WhatsApp number preferred)",
      "field.weight_kg_r1.label": "1. Weight (kg)",
      "field.height_cm_r1.label": "2. Height (cm)",
      "field.muac_tape_color.label": "3. MUAC Tape Colour",

      "field.health_general_poor.label": "Overall health not good",
      "field.health_pallor.label": "Pallor (Pale appearance)",
      "field.health_fatigue_dizzy_faint.label": "Fatigue / dizziness / fainting",
      "field.health_breathlessness.label": "Breathlessness",
      "field.health_frequent_infections.label": "Frequent infections",
      "field.health_chronic_cough_or_diarrhea.label": "Chronic cough/diarrhea",
      "field.health_visible_worms.label": "Visible worms in stool",
      "field.health_dental_or_gum_or_ulcers.label": "Dental/gum issues or mouth ulcers",
      "field.health_night_vision_difficulty.label": "Difficulty seeing at night",
      "field.health_bone_or_joint_pain.label": "Bone/joint pain",
      "field.appetite.label": "Does the child have a good appetite?",
      "field.menarche_started.label": "Has menstruation started?",
      "field.menarche_age_years.label": "Age at first menstruation (years)",
      "field.pads_per_day.label": "Number of pads used per day on heavy bleeding days",
      "field.bleeding_clots.label": "Does she pass clots while bleeding?",
      "field.cycle_length_days.label": "Cycle length",
      "field.diet_type.label": "Usual Diet Type",
      "field.breakfast_eaten.label": "Breakfast",
      "field.lunch_eaten.label": "Lunch",
      "field.green_leafy_veg.label": "Green leafy vegetables",
      "field.other_vegetables.label": "Other vegetables",
      "field.fruits.label": "Fruits",
      "field.dal_pulses_beans.label": "Dal / pulses / beans",
      "field.milk_curd.label": "Milk / curd",
      "field.egg.label": "Egg",
      "field.fish_chicken_meat.label": "Fish / chicken / meat",
      "field.nuts_groundnuts.label": "Nuts / groundnuts",
      "field.ssb_or_packaged_snacks.label": "SSB or packaged snacks",
      "field.deworming_taken.label": "Have you taken deworming tablet?",
      "field.hunger_vital_sign.label": "Do you get enough food to eat at home?",

      "ask.health_general_poor": "Do you feel healthy?",
      "ask.health_pallor": "Do you have pale appearance?",
      "ask.health_fatigue_dizzy_faint": "Have you felt tired, dizzy or fainted?",
      "ask.health_breathlessness": "Have you felt breathlessness?",
      "ask.health_frequent_infections": "Do you fall sick often?",
      "ask.health_chronic_cough_or_diarrhea": "Do you have chronic cough or diarrhea?",
      "ask.health_visible_worms": "Have you seen worms in stool?",
      "ask.health_dental_or_gum_or_ulcers": "Do you have dental problems / bleeding gums / mouth ulcers?",
      "ask.health_night_vision_difficulty": "Do you have difficulty seeing at night?",
      "ask.health_bone_or_joint_pain": "Do you have bone or joint pains?",
      "ask.menarche_started": "Has your menstruation started?",
      "ask.menarche_age_years": "At what age did it start?",
      "ask.pads_per_day": "How many pads per day on heavy bleeding days?",
      "ask.bleeding_clots": "Do you pass clots while bleeding?",
      "ask.cycle_length_days": "After how many days do your menses happen again?",
      "ask.diet_type.LACTO_VEG": "Do you drink milk or eat dahi or paneer at home?",
      "ask.diet_type.LACTO_OVO": "Do you eat eggs at home?",
      "ask.diet_type.NON_VEG": "Do you eat Fish, Chicken or Meat at home?",
      "ask.breakfast_eaten": "Did you eat breakfast?",
      "ask.lunch_eaten": "Did you eat lunch?",
      "ask.green_leafy_veg": "Did you eat green leafy vegetables in your last meal?",
      "ask.other_vegetables": "Did you eat any other vegetable in your last meal?",
      "ask.fruits": "Did you eat fruits yesterday?",
      "ask.dal_pulses_beans": "Did you eat Dal / Pulses / Beans yesterday?",
      "ask.milk_curd": "Did you drink milk or eat curd yesterday?",
      "ask.egg": "Did you eat egg yesterday?",
      "ask.fish_chicken_meat": "Did you eat Fish / Chicken / Meat in the last 3 days?",
      "ask.nuts_groundnuts": "Did you eat Nuts / Groundnuts yesterday?",
      "ask.ssb_or_packaged_snacks": "Do you drink soft drinks/packaged juice or eat packaged snacks (biscuits/chips/chocolates/cakes)?",
      "ask.deworming_taken": "Did you take the big pill for deworming?",

      "option.sex.M": "Male",
      "option.sex.F": "Female",
      "option.muac_tape_color.RED": "Red",
      "option.muac_tape_color.YELLOW": "Yellow",
      "option.muac_tape_color.GREEN": "Green",
      "option.diet_type.LACTO_VEG": "Lacto-vegetarian",
      "option.diet_type.LACTO_OVO": "Lacto-ovo vegetarian",
      "option.diet_type.NON_VEG": "Non-vegetarian",
      "option.yes": "Yes",
      "option.no": "No",
      "option.dont_know": "Don't know",
      "option.hunger_vital_sign.OFTEN_TRUE": "Often true",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "Sometimes true",
      "option.hunger_vital_sign.NEVER_TRUE": "Never true",
      "option.cycle_length_days.LT_45": "Less than 45 days",
      "option.cycle_length_days.GT_45": "More than 45 days",

      "option.grade.Nursery": "Nursery",
      "option.grade.Other": "Other"
    },
    "mr":{
      "option.grade.K.G.": "K.G.",
      "age.month_plural": "महिने",
      "age.month_singular": "महिना",
      "age.year_plural": "वर्षे",
      "age.year_singular": "वर्ष",
      "ask.bleeding_clots": "रक्तस्रावात गुठळ्या (क्लॉट्स) येतात का?",
      "ask.breakfast_eaten": "विद्यार्थ्याला विचारा: नाश्ता केला का?",
      "ask.cycle_length_days": "पाळी पुन्हा येण्यासाठी साधारण किती दिवसांनी येते?",
      "ask.dal_pulses_beans": "काल डाळ/कडधान्य/बीन्स खाल्ले का?",
      "ask.deworming_taken": "कृमिनाशकासाठी मोठी गोळी घेतली का?",
      "ask.diet_type.LACTO_OVO": "घरी अंडं खातात का?",
      "ask.diet_type.LACTO_VEG": "घरी दूध/दही/पनीर खातात का?",
      "ask.diet_type.NON_VEG": "घरी मासे/चिकन/मटण खातात का?",
      "ask.egg": "काल अंडं खाल्लं का?",
      "ask.fish_chicken_meat": "मागच्या 3 दिवसांत मासे/चिकन/मांस खाल्लं का?",
      "ask.fruits": "काल फळं खाल्ली का?",
      "ask.green_leafy_veg": "शेवटच्या जेवणात पालेभाज्या खाल्ल्या का?",
      "ask.health_bone_or_joint_pain": "इजा न होता आणि जास्त खेळ/काम न करता सुद्धा हात/पाय/सांध्यांमध्ये दुखतं का, असे विचारा.",
      "ask.health_breathlessness": "साधारण काम करताना किंवा चालताना दम लागतो का?",
      "ask.health_chronic_cough_or_diarrhea": "मुलाला/मुलीला खोकला आहे का आणि तो 4 आठवड्यांपेक्षा जास्त काळ आहे का? किंवा जुलाब/लूज मोशन होऊन ते 2 आठवड्यांपेक्षा जास्त चालू आहेत का?",
      "ask.health_dental_or_gum_or_ulcers": "दात दुखणे, हिरड्यांतून रक्त येणे, किंवा तोंडात फोड/अल्सर आहेत का, असे विचारा.",
      "ask.health_fatigue_dizzy_faint": "नेहमीसारखं काम/खेळताना कधी बेशुद्ध पडलात का, किंवा रोजची कामं/खेळ करण्यासाठी खूपच थकवा येतो का, असे विचारा.",
      "ask.health_frequent_infections": "मुलाला/मुलीला वारंवार आजार होतो का? मागच्या महिन्यात 3 वेळा किंवा जास्त वेळा आजारी पडलात का?",
      "ask.health_general_poor": "विद्यार्थ्याला विचारा: तुम्हाला स्वतःला निरोगी वाटतं का?",
      "ask.health_night_vision_difficulty": "अंधारात नीट दिसत नाही म्हणून चालताना ठेचकाळतो/ठेचकाळते का, असे विचारा.",
      "ask.health_pallor": "मुलाला/मुलीला फिकटपणा (pallor) आहे का?",
      "ask.health_visible_worms": "मलात कधी छोटे किडे दिसले आहेत का, असे विचारा.",
      "ask.lunch_eaten": "विद्यार्थ्याला विचारा: लंच खाल्लं का?",
      "ask.menarche_age_years": "विद्यार्थिनीला विचारा: पाळी कोणत्या वयात सुरू झाली?",
      "ask.menarche_started": "विद्यार्थिनीला विचारा: मासिक पाळी (पीरियड्स) सुरू झाली आहे का?",
      "ask.milk_curd": "काल दूध पिलं किंवा दही खाल्लं का?",
      "ask.nuts_groundnuts": "काल सुकामेवा/शेंगदाणे खाल्ले का?",
      "ask.other_vegetables": "शेवटच्या जेवणात इतर भाज्या खाल्ल्या का?",
      "ask.pads_per_day": "जास्त रक्तस्रावाच्या दिवशी दिवसाला किती पॅड्स वापरावे लागतात?",
      "ask.ssb_or_packaged_snacks": "तुम्ही कोका कोला, पेप्सी, मिरिंडा, फॅन्टा, लिम्का असे सॉफ्ट ड्रिंक्स पिता का? घराबाहेरचा पॅकेट ज्यूस पिता का? बिस्किटे, चॉकलेट, चिप्स, केक असे पॅकेट स्नॅक्स खातात का?",
      "button.cancel": "रद्द करा",
      "button.complete_screening": "स्क्रीनिंग पूर्ण करा",
      "button.create_student_complete_screening": "विद्यार्थी तयार करा व स्क्रीनिंग पूर्ण करा",
      "field.appetite.label": "भूक चांगली आहे का?",
      "field.bleeding_clots.label": "रक्तस्रावात गुठळ्या (क्लॉट्स) येतात का?",
      "field.breakfast_eaten.label": "नाश्ता",
      "field.cycle_length_days.label": "पाळीचे अंतर",
      "field.dal_pulses_beans.label": "डाळ / कडधान्य / बीन्स",
      "field.deworming_date.label": "किती महिन्यांपूर्वी?",
      "field.deworming_taken.label": "कृमिनाशक (Deworming)",
      "field.diet_type.label": "नेहमीचा आहार प्रकार",
      "field.division.label": "तुकडी",
      "field.dob.label": "जन्मतारीख (DOB)",
      "field.egg.label": "अंडं",
      "field.fish_chicken_meat.label": "मासे / चिकन / मांस",
      "field.fruits.label": "फळं",
      "field.grade.label": "इयत्ता",
      "field.green_leafy_veg.label": "पालेभाज्या (पालक/मेथी/चवळी)",
      "field.health_bone_or_joint_pain.label": "हाडं किंवा सांधे दुखणे",
      "field.health_breathlessness.label": "मेहनत/चालण्यात दम लागणे",
      "field.health_chronic_cough_or_diarrhea.label": "दीर्घकाळ खोकला किंवा जुलाब",
      "field.health_dental_or_gum_or_ulcers.label": "दात किडणे/कॅव्हिटी, हिरड्यांतून रक्त, किंवा तोंडात अल्सर",
      "field.health_fatigue_dizzy_faint.label": "थकवा, चक्कर येणे, किंवा बेशुद्ध पडणे",
      "field.health_frequent_infections.label": "वारंवार इन्फेक्शन (मागच्या महिन्यात 3 वेळा किंवा जास्त)",
      "field.health_general_poor.label": "एकूण आरोग्य ठीक नाही",
      "field.health_night_vision_difficulty.label": "रात्री दिसण्यात अडचण (कमी प्रकाशात ठेचकाळणे)",
      "field.health_pallor.label": "फिकटपणा (पापणी/तळहात आतून फिकट)",
      "field.health_visible_worms.label": "मलातून किडे दिसणे",
      "field.height_cm_r1.label": "2. उंची (सेमी)",
      "field.hunger_vital_sign.label": "घरात पुरेसं अन्न मिळतं का?",
      "field.is_low_income.label": "कमी उत्पन्न कुटुंब",
      "field.lunch_eaten.label": "लंच",
      "field.menarche_age_years.label": "पहिल्या पाळीचे वय (वर्षे)",
      "field.menarche_started.label": "मासिक पाळी सुरू झाली आहे का?",
      "field.muac_tape_color.label": "3. MUAC टेपचा रंग",
      "field.milk_curd.label": "दूध / दही",
      "field.nuts_groundnuts.label": "सुकामेवा / शेंगदाणे",
      "field.other_vegetables.label": "इतर भाज्या",
      "field.pads_per_day.label": "जास्त रक्तस्रावाच्या दिवशी दिवसाला किती पॅड्स लागतात",
      "field.parent_phone_e164.label": "पालकांचा WhatsApp नंबर",
      "field.sex.label": "लिंग",
      "field.ssb_or_packaged_snacks.label": "गोड पेये (SSB) किंवा पॅकेट स्नॅक्स",
      "field.student_name.label": "विद्यार्थ्याचे नाव",
      "field.unique_student_id.label": "युनिक स्टुडंट ID",
      "field.weight_kg_r1.label": "1. वजन (किलो)",
      "hint.diet_24h": "24 तासांची आठवण (काल): विद्यार्थ्याने/विद्यार्थिनीने काल खालील पदार्थ खाल्ले का?",
      "hint.select_dob_first": "लिंग निवडण्यासाठी आधी जन्मतारीख निवडा.",
      "legend.class_assignment": "शाळा / वर्ग / सेक्शन",
      "legend.girls_only": "किशोरी मुली (वय ≥10 फक्त)",
      "legend.section_a": "सेक्शन A: तपशील",
      "legend.section_b": "सेक्शन B: शरीर मोजमाप (Anthropometry)",
      "legend.section_c": "सेक्शन C: झटपट आरोग्य रेड फ्लॅग्स",
      "legend.section_d": "सेक्शन D: आहार प्रकार आणि विविधता",
      "legend.section_e": "सेक्शन E: कार्यक्रमासाठी मदत",
      "legend.section_f": "सेक्शन F: अन्नसुरक्षा",
      "option.cycle_length_days.GT_45": "45 दिवसांपेक्षा जास्त",
      "option.cycle_length_days.LT_45": "45 दिवसांपेक्षा कमी",
      "option.diet_type.LACTO_OVO": "लॅक्टो-ओव्हो व्हेज (अंडं खातात)",
      "option.diet_type.LACTO_VEG": "लॅक्टो व्हेज (दूध/दही घेतात)",
      "option.diet_type.NON_VEG": "नॉन-व्हेज (मासे/चिकन/मांस)",
      "option.dont_know": "माहित नाही",
      "option.grade.Nursery": "नर्सरी",
      "option.grade.Other": "इतर",
      "option.hunger_vital_sign.NEVER_TRUE": "कधीच खरे नाही",
      "option.hunger_vital_sign.OFTEN_TRUE": "अनेकदा खरे",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "कधी कधी खरे",
      "option.muac_tape_color.GREEN": "हिरवा",
      "option.muac_tape_color.RED": "लाल",
      "option.muac_tape_color.YELLOW": "पिवळा",
      "option.no": "नाही",
      "option.sex.F": "मुलगी",
      "option.sex.M": "मुलगा",
      "option.yes": "होय",
      "page.add_student.browser_title": "विद्यार्थी जोडा व स्क्रीनिंग पूर्ण करा",
      "page.add_student.heading": "विद्यार्थी जोडा व स्क्रीनिंग पूर्ण करा",
      "page.screening.browser_title_prefix": "स्क्रीनिंग",
      "page.screening.heading_prefix": "स्क्रीनिंग",
      "placeholder.select": "निवडा",
      "placeholder.select_age": "वय निवडा",
      "placeholder.select_division": "तुकडी निवडा",
      "placeholder.select_grade": "इयत्ता निवडा",
      "placeholder.select_months": "महिने निवडा",
      "placeholder.select_sex": "लिंग निवडा",
      "ui.language.label": "भाषा"
    },
    "hi": {
      "option.grade.K.G.": "K.G.",
      "age.month_plural": "महीने",
      "age.month_singular": "महीना",
      "age.year_plural": "साल",
      "age.year_singular": "साल",
      "ask.bleeding_clots": "क्या ब्लीडिंग के दौरान थक्के (क्लॉट्स) आते हैं?",
      "ask.breakfast_eaten": "बच्चे से पूछें: नाश्ता किया?",
      "ask.cycle_length_days": "पीरियड फिर से आने में आमतौर पर कितने दिनों का अंतर होता है?",
      "ask.dal_pulses_beans": "कल दाल/चना/राजमा खाए?",
      "ask.deworming_taken": "डी-वर्मिंग की बड़ी गोली ली?",
      "ask.diet_type.LACTO_OVO": "घर पर अंडा खाते हो?",
      "ask.diet_type.LACTO_VEG": "घर पर दूध/दही/पनीर लेते हो?",
      "ask.diet_type.NON_VEG": "घर पर मछली/चिकन/मटन खाते हो?",
      "ask.egg": "कल अंडा खाया?",
      "ask.fish_chicken_meat": "पिछले 3 दिनों में मछली/चिकन/मांस खाया?",
      "ask.fruits": "कल फल खाए?",
      "ask.green_leafy_veg": "पिछले भोजन में हरी पत्तेदार सब्ज़ी खाई?",
      "ask.health_bone_or_joint_pain": "बच्चे से पूछें: बिना चोट लगे और बिना ज्यादा खेल/काम के भी हाथ/पैर/जोड़ों में दर्द होता है क्या?",
      "ask.health_breathlessness": "बच्चे से पूछें: सामान्य काम करते या सामान्य चलने पर सांस फूलती है क्या?",
      "ask.health_chronic_cough_or_diarrhea": "क्या बच्चे को खांसी है और 4 हफ्तों से ज्यादा से चल रही है, या बच्चे को दस्त हैं और 2 हफ्तों से ज्यादा से चल रहे हैं?",
      "ask.health_dental_or_gum_or_ulcers": "बच्चे से पूछें: दांत दर्द, मसूड़ों से खून, या मुंह में छाले हैं क्या?",
      "ask.health_fatigue_dizzy_faint": "बच्चे से पूछें: सामान्य काम/खेलते समय कभी बेहोशी आई है, या रोज़मर्रा के काम/खेल के लिए बहुत ज्यादा थकान लगती है?",
      "ask.health_frequent_infections": "क्या बच्चा बहुत बार बीमार पड़ता है? क्या पिछले महीने में 3 बार या उससे ज्यादा बीमार हुआ है?",
      "ask.health_general_poor": "बच्चे से पूछें: क्या तुम खुद को स्वस्थ महसूस करते/करती हो?",
      "ask.health_night_vision_difficulty": "बच्चे से पूछें: अंधेरे/कम रोशनी में चलते समय ठोकर लगती है क्या?",
      "ask.health_pallor": "क्या बच्चे में पीलापन है?",
      "ask.health_visible_worms": "बच्चे से पूछें: क्या कभी पाखाने में छोटे कीड़े देखे हैं?",
      "ask.lunch_eaten": "बच्चे से पूछें: लंच खाया?",
      "ask.menarche_age_years": "बच्ची से पूछें: पीरियड्स किस उम्र में शुरू हुए?",
      "ask.menarche_started": "बच्ची से पूछें: क्या पीरियड्स शुरू हुए हैं?",
      "ask.milk_curd": "कल दूध पिया या दही खाया?",
      "ask.nuts_groundnuts": "कल मेवे/मूंगफली खाए?",
      "ask.other_vegetables": "पिछले भोजन में कोई अन्य सब्ज़ी खाई?",
      "ask.pads_per_day": "ज्यादा ब्लीडिंग वाले दिनों में दिन में कितने पैड इस्तेमाल होते हैं?",
      "ask.ssb_or_packaged_snacks": "क्या तुम कोक/पेप्सी/मिरिंडा/फैंटा/लिम्का जैसे सॉफ्ट ड्रिंक पीते हो? क्या तुम बाहर का पैकेट जूस पीते हो? क्या तुम बिस्किट, चॉकलेट, चिप्स, केक जैसे पैकेट स्नैक्स खाते हो?",
      "button.cancel": "रद्द करें",
      "button.complete_screening": "स्क्रीनिंग पूरा करें",
      "button.create_student_complete_screening": "छात्र बनाएँ और स्क्रीनिंग पूरा करें",
      "field.appetite.label": "क्या भूख अच्छी है?",
      "field.bleeding_clots.label": "ब्लीडिंग के दौरान थक्के (क्लॉट्स) आते हैं क्या?",
      "field.breakfast_eaten.label": "नाश्ता",
      "field.cycle_length_days.label": "पीरियड का अंतर",
      "field.dal_pulses_beans.label": "दाल / चना / राजमा",
      "field.deworming_date.label": "कितने महीने पहले?",
      "field.deworming_taken.label": "कृमिनाशक (Deworming)",
      "field.diet_type.label": "सामान्य डाइट का प्रकार",
      "field.division.label": "सेक्शन",
      "field.dob.label": "जन्म तिथि (DOB)",
      "field.egg.label": "अंडा",
      "field.fish_chicken_meat.label": "मछली / चिकन / मांस",
      "field.fruits.label": "फल",
      "field.grade.label": "कक्षा",
      "field.green_leafy_veg.label": "हरी पत्तेदार सब्ज़ी (पालक/मेथी/चौलाई)",
      "field.health_bone_or_joint_pain.label": "हड्डी या जोड़ों में दर्द",
      "field.health_breathlessness.label": "चलने/मेहनत पर सांस फूलना",
      "field.health_chronic_cough_or_diarrhea.label": "लंबे समय से खांसी या दस्त",
      "field.health_dental_or_gum_or_ulcers.label": "दांत में कीड़ा/कैविटी, मसूड़ों से खून, या मुंह में छाले",
      "field.health_fatigue_dizzy_faint.label": "थकान, चक्कर, या बेहोशी",
      "field.health_frequent_infections.label": "बार-बार इंफेक्शन (पिछले महीने में 3 या ज्यादा)",
      "field.health_general_poor.label": "सामान्य सेहत ठीक नहीं",
      "field.health_night_vision_difficulty.label": "रात में देखने में दिक्कत (कम रोशनी में ठोकर लगना)",
      "field.health_pallor.label": "पीलापन (पलक/हथेली अंदर से पीली)",
      "field.health_visible_worms.label": "पाखाने में कीड़े दिखना",
      "field.height_cm_r1.label": "2. लंबाई (सेमी)",
      "field.hunger_vital_sign.label": "क्या घर पर पर्याप्त खाना मिलता है?",
      "field.is_low_income.label": "कम आय वाला परिवार",
      "field.lunch_eaten.label": "लंच",
      "field.menarche_age_years.label": "पहली माहवारी की उम्र (साल)",
      "field.menarche_started.label": "क्या पीरियड्स शुरू हुए हैं?",
      "field.muac_tape_color.label": "3. MUAC टेप का रंग",
      "field.milk_curd.label": "दूध / दही",
      "field.nuts_groundnuts.label": "मेवे / मूंगफली",
      "field.other_vegetables.label": "अन्य सब्ज़ियाँ",
      "field.pads_per_day.label": "ज्यादा ब्लीडिंग वाले दिनों में दिन में कितने पैड लगते हैं",
      "field.parent_phone_e164.label": "अभिभावक का WhatsApp नंबर",
      "field.sex.label": "लिंग",
      "field.ssb_or_packaged_snacks.label": "मीठे ड्रिंक (SSB) या पैकेट स्नैक",
      "field.student_name.label": "छात्र का नाम",
      "field.unique_student_id.label": "यूनिक स्टूडेंट ID",
      "field.weight_kg_r1.label": "1. वजन (किलो)",
      "hint.diet_24h": "24-घंटे की याद (कल): क्या बच्चे ने कल नीचे की चीजें खाईं?",
      "hint.select_dob_first": "लिंग चुनने के लिए पहले जन्म तिथि चुनें।",
      "legend.class_assignment": "स्कूल / कक्षा / सेक्शन",
      "legend.girls_only": "किशोरी लड़कियाँ (उम्र ≥10 साल)",
      "legend.section_a": "सेक्शन A: विवरण",
      "legend.section_b": "सेक्शन B: शरीर माप (Anthropometry)",
      "legend.section_c": "सेक्शन C: जल्दी स्वास्थ्य रेड फ्लैग",
      "legend.section_d": "सेक्शन D: डाइट का प्रकार और विविधता",
      "legend.section_e": "सेक्शन E: प्रोग्राम सपोर्ट",
      "legend.section_f": "सेक्शन F: फूड सिक्योरिटी (खाने की उपलब्धता)",
      "option.cycle_length_days.GT_45": "45 दिनों से अधिक",
      "option.cycle_length_days.LT_45": "45 दिनों से कम",
      "option.diet_type.LACTO_OVO": "शाकाहारी + अंडा (अंडा खाते हैं)",
      "option.diet_type.LACTO_VEG": "शाकाहारी (दूध/दही लेते हैं)",
      "option.diet_type.NON_VEG": "नॉन-वेज (मांस/मछली खाते हैं)",
      "option.dont_know": "पता नहीं",
      "option.grade.Nursery": "नर्सरी",
      "option.grade.Other": "अन्य",
      "option.hunger_vital_sign.NEVER_TRUE": "कभी भी सही नहीं",
      "option.hunger_vital_sign.OFTEN_TRUE": "अक्सर सही",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "कभी-कभी सही",
      "option.muac_tape_color.GREEN": "हरा",
      "option.muac_tape_color.RED": "लाल",
      "option.muac_tape_color.YELLOW": "पीला",
      "option.no": "नहीं",
      "option.sex.F": "लड़की",
      "option.sex.M": "लड़का",
      "option.yes": "हाँ",
      "page.add_student.browser_title": "छात्र जोड़ें और स्क्रीनिंग पूरा करें",
      "page.add_student.heading": "छात्र जोड़ें और स्क्रीनिंग पूरा करें",
      "page.screening.browser_title_prefix": "स्क्रीनिंग",
      "page.screening.heading_prefix": "स्क्रीनिंग",
      "placeholder.select": "चुनें",
      "placeholder.select_age": "उम्र चुनें",
      "placeholder.select_division": "सेक्शन चुनें",
      "placeholder.select_grade": "कक्षा चुनें",
      "placeholder.select_months": "महीने चुनें",
      "placeholder.select_sex": "लिंग चुनें",
      "ui.language.label": "भाषा"
    },
    "te": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "మొదటి రజస్వల ప్రారంభమైన వయసు (సంవత్సరాలలో)",
  "ask.menarche_started": "మీకు రజస్వల ప్రారంభమైందా?",
  "ask.menarche_age_years": "ఎన్ని ఏళ్ల వయసులో ప్రారంభమైంది?",
      "field.menarche_started.label": "రజస్వల ప్రారంభమైందా?",
      "field.grade.label": "తరగతి",
  "field.division.label": "విభాగం",
  "field.is_low_income.label": "తక్కువ ఆదాయ కుటుంబం",
  "field.deworming_date.label": "ఎన్ని నెలల క్రితం?",
      "page.add_student.heading": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.add_student.browser_title": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.screening.heading_prefix": "స్క్రీనింగ్",
  "page.screening.browser_title_prefix": "స్క్రీనింగ్",
  "button.create_student_complete_screening": "విద్యార్థిని సృష్టించి స్క్రీనింగ్ పూర్తి చేయండి",
  "button.complete_screening": "స్క్రీనింగ్ పూర్తి చేయండి",
  "button.cancel": "రద్దు చేయండి",
  "hint.select_dob_first": "ఈ ఫీల్డ్‌ను ప్రారంభించడానికి ముందుగా పుట్టిన తేదీని ఎంచుకోండి",
  "age.month_plural": "నెలలు",
"age.month_singular": "నెల",
"age.year_plural": "సంవత్సరాలు",
"age.year_singular": "సంవత్సరం",
  "ask.bleeding_clots": "డ్రాప్‌డౌన్ అవును/కాదు - బ్లీడింగ్ సమయంలో గడ్డలు (క్లాట్స్) పడతాయా?",
  "ask.breakfast_eaten": "నువ్వు బ్రేక్‌ఫాస్ట్ తిన్నావా?",
  "ask.cycle_length_days": "డ్రాప్‌డౌన్ - 45 రోజులు కన్నా తక్కువ / 45 రోజులు కన్నా ఎక్కువ - పీరియడ్స్ మళ్లీ ఎన్ని రోజుల తర్వాత వస్తాయి?",
  "ask.dal_pulses_beans": "నువ్వు నిన్న పప్పు/పప్పుదినుసులు/బీన్స్ తిన్నావా?",
  "ask.deworming_taken": "పురుగు మందు కోసం ఇచ్చిన పెద్ద మాత్ర తీసుకున్నావా?",
  "ask.diet_type.LACTO_OVO": "ఇంట్లో గుడ్డు తింటావా?",
  "ask.diet_type.LACTO_VEG": "ఇంట్లో పాలు తాగుతావా లేదా పెరుగు/పనీర్ తింటావా?",
  "ask.diet_type.NON_VEG": "ఇంట్లో చేపలు లేదా చికెన్ లేదా మటన్ తింటావా?",
  "ask.egg": "నువ్వు నిన్న గుడ్డు తిన్నావా?",
  "ask.fish_chicken_meat": "నువ్వు గత 3 రోజుల్లో చేపలు / చికెన్ / మాంసం తిన్నావా?",
  "ask.fruits": "నువ్వు నిన్న పండ్లు తిన్నావా?",
  "ask.green_leafy_veg": "నువ్వు చివరి భోజనంలో పచ్చి ఆకు కూరలు తిన్నావా?",
  "ask.health_bone_or_joint_pain": "బిడ్డ చేతులు/కాళ్లు/జాయింట్స్‌లో నొప్పి ఉందో లేదో అడగండి.",
  "ask.health_breathlessness": "చిన్న శారీరక శ్రమకు కూడా త్వరగా అలసిపోతాడా/అలసిపోతుందా అని అడగండి.",
  "ask.health_chronic_cough_or_diarrhea": "4 వారాల కంటే ఎక్కువగా దగ్గు లేదా 2 వారాల కంటే ఎక్కువగా విరేచనాలు ఉన్నాయా అని అడగండి.",
  "ask.health_dental_or_gum_or_ulcers": "పళ్లలో రంధ్రాలు, పళ్ళ నొప్పి, చిగుళ్ళ నుండి రక్తం, లేదా నోటిలో పుండ్లు ఉన్నాయా అని అడగండి.",
  "ask.health_fatigue_dizzy_faint": "ఆడేటప్పుడు లేదా పని చేస్తూ అలసట, తల తిరగడం వల్ల స్పృహ కోల్పోయినట్లు (సొమ్మసిల్లినట్లు) గుర్తుందా అని అడగండి",
  "ask.health_frequent_infections": "బిడ్డకి తరచూ అనారోగ్యం వస్తుందా? గత 1 నెలలో 3 సార్లు లేదా అంతకంటే ఎక్కువ సార్లు అనారోగ్యం వచ్చిందా?",
  "ask.health_general_poor": "బిడ్డ తన ఆరోగ్య స్థితి బాగోలేదని అనుకుంటున్నాడా/అనుకుంటుందా?",
  "ask.health_night_vision_difficulty": "చీకట్లో నడిచేటప్పుడు తడబడతాడా/తడబడుతుందా అని అడగండి",
  "ask.health_pallor": "బిడ్డకి పాలర్ (పసుపు / వెలితి) ఉందా?",
  "ask.health_visible_worms": "మలంలో పురుగులు (చిన్న క్రిములు) చూసానని బిడ్డ చెప్తున్నాడా/చెప్తుందా అని అడగండి.",
  "ask.lunch_eaten": "నువ్వు లంచ్ తిన్నావా?",
  "ask.milk_curd": "నువ్వు నిన్న పాలు తాగావా లేదా పెరుగు తిన్నావా?",
  "ask.nuts_groundnuts": "నువ్వు నిన్న గింజలు / వేరుశెనగలు తిన్నావా?",
  "ask.other_vegetables": "నువ్వు చివరి భోజనంలో ఏమైనా ఇతర కూరగాయలు తిన్నావా?",
  "ask.pads_per_day": "డ్రాప్‌డౌన్ 1-10 - బిడ్డను అడగండి: బ్లీడింగ్ ఎక్కువగా ఉన్న రోజుల్లో రోజుకు ఎన్ని ప్యాడ్‌లు అవసరం అవుతాయి?",
  "ask.ssb_or_packaged_snacks": "మీరు కోకాకోలా, పెప్సీ, మిరిండా, ఫాంటా, లిమ్కా వంటి సాఫ్ట్ డ్రింక్స్ తాగుతారా? దుకాణంలో దొరికే ప్యాకేజ్డ్ జ్యూస్ తాగుతారా? బిస్కెట్లు, చాక్లెట్స్, చిప్స్, కేక్ వంటి ప్యాకేజ్డ్ స్నాక్స్ తింటారా?",
  "field.appetite.label": "ఆకలి",
  "field.bleeding_clots.label": "డ్రాప్‌డౌన్ అవును/కాదు - బ్లీడింగ్ సమయంలో గడ్డలు (క్లాట్స్) పడతాయా?",
  "field.breakfast_eaten.label": "బ్రేక్‌ఫాస్ట్ తిన్నావా?",
  "field.cycle_length_days.label": "అనియమిత పీరియడ్స్ (>45 రోజులు గ్యాప్)?",
  "field.dal_pulses_beans.label": "డాల్/పప్పుదినుసులు/బీన్స్",
  "field.deworming_taken.label": "పురుగుల మందు",
  "field.diet_type.label": "ఆహారపు రకం",
  "field.dob.label": "పుట్టిన తేదీ (DOB)",
  "field.egg.label": "గుడ్డు",
  "field.fish_chicken_meat.label": "చేపలు / చికెన్ / మాంసం",
  "field.fruits.label": "పండ్లు",
  "field.green_leafy_veg.label": "పచ్చి ఆకు కూరలు (పాలకూర/మెంతి/తోటకూర)",
  "field.health_bone_or_joint_pain.label": "ఎముకల / జాయింట్ నొప్పులు",
  "field.health_breathlessness.label": "కొంచెం శ్రమతోనే ఆయాసపడటం",
  "field.health_chronic_cough_or_diarrhea.label": "దీర్ఘకాలిక దగ్గు (>4 వారాలు)/విరేచనాలు (>2 వారాలు)",
  "field.health_dental_or_gum_or_ulcers.label": "పళ్ల సమస్యలు / చిగుళ్ళ నుండి రక్తం / నోటిలో పుండ్లు",
  "field.health_fatigue_dizzy_faint.label": "అలసట, తల తిరగడం, లేదా స్పృహ కోల్పోవడం",
  "field.health_frequent_infections.label": "తరచూ ఇన్ఫెక్షన్లు (గత 1 నెలలో 3 సార్లు లేదా అంతకంటే ఎక్కువ)",
  "field.health_general_poor.label": "ఆరోగ్యం బాగా లేదు",
  "field.health_night_vision_difficulty.label": "వెలుతురు తక్కువగా ఉన్నప్పుడు చూడడంలో కష్టం",
  "field.health_pallor.label": "పాలర్ (కనురెప్పలు/అరికాళ్లు లోపల భాగం తెల్లబడటం)",
  "field.health_visible_worms.label": "పురుగులు కనిపించడం",
  "field.height_cm_r1.label": "2. ఎత్తు (cm)",
  "field.hunger_vital_sign.label": "ఆకలి సంబంధిత ప్రశ్న (గత 12 నెలలు)",
  "field.lunch_eaten.label": "స్కూల్లో లంచ్ తిన్నావా?",
  "field.milk_curd.label": "పాలు / పెరుగు",
  "field.muac_tape_color.label": "3. MUACలో టేపు రంగు",
  "field.nuts_groundnuts.label": "గింజలు / వేరుశెనగలు",
  "field.other_vegetables.label": "ఇతర కూరగాయలు",
  "field.pads_per_day.label": "అధిక బ్లీడింగ్ (≥5 ప్యాడ్లు/రోజు లేదా గడ్డలు)?",
  "field.parent_phone_e164.label": "తల్లిదండ్రుల వాట్సాప్ నంబర్",
  "field.sex.label": "లింగం",
  "field.ssb_or_packaged_snacks.label": "చక్కెర పానీయాలు (SSB) లేదా ప్యాకెట్ స్నాక్స్ తిన్నావా?",
  "field.student_name.label": "విద్యార్థి పేరు",
  "field.unique_student_id.label": "యూనిక్ స్టూడెంట్ ID",
  "field.weight_kg_r1.label": "1. బరువు (kg)",
  "hint.diet_24h": "24-గంటల ఆహార సమాచారం (నిన్న) విద్యార్థి నిన్న క్రిందివి తిన్నాడా?",
  "legend.class_assignment": "పాఠశాల/తరగతి/సెక్షన్",
  "legend.girls_only": "కిశోరి బాలికలు (10 ఏళ్లు పైబడినవి మాత్రమే)",
  "legend.section_a": "సెక్షన్ A: వివరాలు",
  "legend.section_b": "సెక్షన్ B: శరీర కొలతలు",
  "legend.section_c": "సెక్షన్ C: త్వరిత ఆరోగ్య సమస్యలు",
  "legend.section_d": "సెక్షన్ D: ఆహార రకం & వైవిధ్యం",
  "legend.section_e": "సెక్షన్ E: కార్యక్రమానికి తోడ్పాటు",
  "legend.section_f": "సెక్షన్ F: ఆహార భద్రత",
  "option.cycle_length_days.GT_45": "45 రోజులు కన్నా ఎక్కువ",
  "option.cycle_length_days.LT_45": "45 రోజులు కన్నా తక్కువ",
  "option.diet_type.LACTO_OVO": "( ) లాక్టో-ఓవో-వెజిటేరియన్ (గుడ్డు తింటారు)",
  "option.diet_type.LACTO_VEG": "( ) లాక్టో-వెజిటేరియన్",
  "option.diet_type.NON_VEG": "( ) నాన్-వెజిటేరియన్",
  "option.dont_know": "తెలియదు",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ఎప్పుడూ నిజం కాదు (రెడ్ ఫ్లాగ్)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) ఎక్కువగా నిజం",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) కొన్నిసార్లు నిజం (రెడ్ ఫ్లాగ్)",
  "option.no": "కాదు",
  "option.muac_tape_color.GREEN": "చెక్ బాక్స్ - టేపు రంగు ఆకుపచ్చ",
  "option.muac_tape_color.RED": "చెక్ బాక్స్ - టేపు రంగు ఎరుపు",
  "option.muac_tape_color.YELLOW": "చెక్ బాక్స్ - టేపు రంగు పసుపు",
  "option.sex.F": "అమ్మాయి",
  "option.sex.M": "అబ్బాయి",
  "option.yes": "అవును",
  "page.add_student.browser_title": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.add_student.heading": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.screening.browser_title_prefix": "స్క్రీనింగ్",
  "page.screening.heading_prefix": "స్క్రీనింగ్",
  "placeholder.select": "ఎంచుకోండి",
  "placeholder.select_age": "వయసు ఎంచుకోండి",
  "placeholder.select_division": "విభాగాన్ని ఎంచుకోండి",
  "placeholder.select_grade": "తరగతి ఎంచుకోండి",
  "placeholder.select_months": "నెలలను ఎంచుకోండి",
  "placeholder.select_sex": "లింగాన్ని ఎంచుకోండి",
  "ui.language.label": "భాష",
},

"ta": {
  "option.grade.K.G.": "K.G.",
  "placeholder.select_sex": "பாலினத்தை தேர்ந்தெடுக்கவும்",
  "ui.language.label": "மொழி",
  "field.menarche_age_years.label": "முதல் மாதவிடாய் தொடங்கிய வயது (ஆண்டுகளில்)",
  "ask.menarche_started": "உங்களுக்கு மாதவிடாய் தொடங்கியுள்ளதா?",
  "ask.menarche_age_years": "எந்த வயதில் தொடங்கியது?",
  "field.menarche_started.label": "மாதவிடாய் தொடங்கியுள்ளதா?",
  "placeholder.select_age": "வயதை தேர்ந்தெடுக்கவும்",
  "field.grade.label": "வகுப்பு",
  "field.division.label": "பிரிவு",
  "field.is_low_income.label": "குறைந்த வருமான குடும்பம்",
  "field.deworming_date.label": "எத்தனை மாதங்களுக்கு முன்பு?",
  "placeholder.select_division": "பிரிவை தேர்ந்தெடுக்கவும்",
"placeholder.select_grade": "வகுப்பை தேர்ந்தெடுக்கவும்",
  "placeholder.select": "தேர்ந்தெடுக்கவும்",
  "page.add_student.heading": "மாணவரை சேர்த்து பரிசோதனை முடிக்கவும்",
  "page.add_student.browser_title": "மாணவரை சேர்த்து பரிசோதனை முடிக்கவும்",
  "page.screening.heading_prefix": "திரையிடல்",
  "page.screening.browser_title_prefix": "திரையிடல்",
  "button.create_student_complete_screening": "மாணவரை உருவாக்கி பரிசோதனை முடிக்கவும்",
  "button.complete_screening": "பரிசோதனை முடிக்கவும்",
  "button.cancel": "ரத்து செய்யவும்",
  "hint.select_dob_first": "இந்த புலத்தை செயல்படுத்த முதலில் பிறந்த தேதியை தேர்ந்தெடுக்கவும்",
  "age.month_plural": "மாதங்கள்",
"age.month_singular": "மாதம்",
"age.year_plural": "ஆண்டுகள்",
"age.year_singular": "ஆண்டு",
  "ask.bleeding_clots": "ட்ராப்-டவுன் ஆம்/இல்லை - ரத்தப்போக்கு போது இரத்தக் கட்டிகள் (clots) வருகிறதா?",
  "ask.breakfast_eaten": "நீ பிரேக்பாஸ்ட் சாப்பிட்டாயா?",
  "ask.cycle_length_days": "ட்ராப்-டவுன் - 45 நாட்களுக்கு குறைவு / 45 நாட்களுக்கு மேல் - பீரியட் மீண்டும் எத்தனை நாட்களுக்கு பிறகு வருகிறது?",
  "ask.dal_pulses_beans": "நீ நேற்று பருப்பு/பயறு/பீன்ஸ் சாப்பிட்டாயா?",
  "ask.deworming_taken": "புழு மருந்துக்காக கொடுக்கப்பட்ட பெரிய மாத்திரை எடுத்தாயா?",
  "ask.diet_type.LACTO_OVO": "வீட்டில் முட்டை சாப்பிடுவாயா?",
  "ask.diet_type.LACTO_VEG": "வீட்டில் பால் குடிப்பாயா அல்லது தயிர்/பன்னீர் சாப்பிடுவாயா?",
  "ask.diet_type.NON_VEG": "வீட்டில் மீன் அல்லது சிக்கன் அல்லது மட்டன் சாப்பிடுவாயா?",
  "ask.egg": "நீ நேற்று முட்டை சாப்பிட்டாயா?",
  "ask.fish_chicken_meat": "கடந்த 3 நாட்களில் மீன் / சிக்கன் / இறைச்சி சாப்பிட்டாயா?",
  "ask.fruits": "நீ நேற்று பழங்கள் சாப்பிட்டாயா?",
  "ask.green_leafy_veg": "கடைசி உணவில் கீரை வகைகள் சாப்பிட்டாயா?",
  "ask.health_bone_or_joint_pain": "குழந்தைக்கு கை/கால்/மூட்டுகளில் வலி இருக்கிறதா என்று கேளுங்கள்.",
  "ask.health_breathlessness": "சிறிது உடல் உழைப்பிலேயே விரைவில் களைப்படைகிறானா/களைப்படைகிறாளா என்று கேளுங்கள்.",
  "ask.health_chronic_cough_or_diarrhea": "4 வாரங்களுக்கு மேல் நீடிக்கும் இருமல் அல்லது 2 வாரங்களுக்கு மேல் நீடிக்கும் வயிற்றுப்போக்கு உள்ளதா என்று கேளுங்கள்.",
  "ask.health_dental_or_gum_or_ulcers": "பல் சொத்தை, ஈறில் ரத்தம், அல்லது வாய் புண்கள் உள்ளதா என்று கேளுங்கள்.",
  "ask.health_fatigue_dizzy_faint": "விளையாடும்போது அல்லது வேலை செய்யும்போது சோர்வு/தலைச்சுற்றல் காரணமாக மயக்கம் வந்ததா என்று கேளுங்கள்.",
  "ask.health_frequent_infections": "குழந்தைக்கு அடிக்கடி உடல் நலம் சரியில்லாமல் இருக்கிறதா? கடந்த 1 மாதத்தில் 3 முறை அல்லது அதற்கு மேல் நோய்வாய்ப்பட்டதா?",
  "ask.health_general_poor": "குழந்தைக்கு பொதுவான உடல் நலம் சரியில்லை என்று தோன்றுகிறதா?",
  "ask.health_night_vision_difficulty": "இருட்டில் நடக்கும் போது தடுமாறுகிறாயா என்று கேளுங்கள்",
  "ask.health_pallor": "குழந்தைக்கு வெளிறிப்போவது (pallor) இருக்கிறதா?",
  "ask.health_visible_worms": "மலத்தில் புழுக்கள் (சிறிய பூச்சிகள்) பார்த்தாயா என்று கேளுங்கள்.",
  "ask.lunch_eaten": "நீ லஞ்ச் சாப்பிட்டாயா?",
  "ask.milk_curd": "நீ நேற்று பால் குடித்தாயா அல்லது தயிர் சாப்பிட்டாயா?",
  "ask.nuts_groundnuts": "நீ நேற்று பருப்பு/வேர்க்கடலை சாப்பிட்டாயா?",
  "ask.other_vegetables": "கடைசி உணவில் வேறு காய்கறிகள் ஏதாவது சாப்பிட்டாயா?",
  "ask.pads_per_day": "ட்ராப்-டவுன் 1-10 - குழந்தையிடம் கேளுங்கள்: அதிக ரத்தப்போக்கு நாட்களில் ஒரு நாளில் எத்தனை பேட்கள் தேவைப்படும்?",
  "ask.ssb_or_packaged_snacks": "நீங்கள் கோகா கோலா, பெப்சி, மிரிந்தா, ஃபான்டா, லிம்கா போன்ற சாப்ட் டிரின்க்ஸ் குடிப்பீர்களா? கடையில் கிடைக்கும் பேக்கேஜ் ஜூஸ் குடிப்பீர்களா? பிஸ்கட், சாக்லேட், சிப்ஸ், கேக் போன்ற பேக்கேஜ் ஸ்நாக்ஸ் சாப்பிடுவீர்களா?",
  "field.appetite.label": "பசி",
  "field.bleeding_clots.label": "ட்ராப்-டவுன் ஆம்/இல்லை - ரத்தப்போக்கு போது இரத்தக் கட்டிகள் (clots) வருகிறதா?",
  "field.breakfast_eaten.label": "காலை உணவு சாப்பிட்டாயா?",
  "field.cycle_length_days.label": "மாதவிடாய் ஒழுங்கில்லை (>45 நாட்கள் இடைவெளி)?",
  "field.dal_pulses_beans.label": "பருப்பு / பயறு / பீன்ஸ்",
  "field.deworming_taken.label": "புழு மருந்து",
  "field.diet_type.label": "உணவு வகை",
  "field.dob.label": "பிறந்த தேதி (DOB)",
  "field.egg.label": "முட்டை",
  "field.fish_chicken_meat.label": "மீன் / சிக்கன் / இறைச்சி",
  "field.fruits.label": "பழங்கள்",
  "field.green_leafy_veg.label": "கீரை வகைகள் (பாலக்/வெந்தயம்/அமராந்த்)",
  "field.health_bone_or_joint_pain.label": "எலும்பு அல்லது மூட்டு வலி",
  "field.health_breathlessness.label": "சிறிது உழைப்பிலேயே மூச்சுத்திணறல்",
  "field.health_chronic_cough_or_diarrhea.label": "நீடித்த இருமல் (>4 வாரங்கள்)/வயிற்றுப்போக்கு (>2 வாரங்கள்)",
  "field.health_dental_or_gum_or_ulcers.label": "பல்/ஈறு பிரச்சினைகள்/வாய் புண்கள்",
  "field.health_fatigue_dizzy_faint.label": "சோர்வு, தலைச்சுற்றல், அல்லது மயக்கம்",
  "field.health_frequent_infections.label": "அடிக்கடி தொற்றுகள் (கடந்த 1 மாதத்தில் 3 அல்லது அதற்கு மேல்)",
  "field.health_general_poor.label": "உடல் நலம் சரியில்லை",
  "field.health_night_vision_difficulty.label": "குறைந்த வெளிச்சத்தில் பார்க்க சிரமம்",
  "field.health_pallor.label": "வெளிறிப்போவது (கண் இமை/கைத் தளிர் உள்ளே வெளிறுதல்)",
  "field.health_visible_worms.label": "புழுக்கள் தெரிதல்",
  "field.height_cm_r1.label": "2. உயரம் (cm)",
  "field.hunger_vital_sign.label": "பசி தொடர்பான கேள்வி (கடந்த 12 மாதங்கள்)",
  "field.lunch_eaten.label": "பள்ளியில் மதிய உணவு சாப்பிட்டாயா?",
  "field.milk_curd.label": "பால் / தயிர்",
  "field.muac_tape_color.label": "3. MUAC டேப்பின் நிறம்",
  "field.nuts_groundnuts.label": "பருப்பு / வேர்க்கடலை",
  "field.other_vegetables.label": "மற்ற காய்கறிகள்",
  "field.pads_per_day.label": "அதிக ரத்தப்போக்கு (≥5 பேட்கள்/நாள் அல்லது கட்டிகள்)?",
  "field.parent_phone_e164.label": "பெற்றோர் WhatsApp எண்",
  "field.sex.label": "பாலினம்",
  "field.ssb_or_packaged_snacks.label": "சர்க்கரை பானங்கள் (SSB) அல்லது பேக்கேஜ் ஸ்நாக்ஸ் சாப்பிட்டதா?",
  "field.student_name.label": "மாணவரின் பெயர்",
  "field.unique_student_id.label": "யூனிக் மாணவர் ID",
  "field.weight_kg_r1.label": "1. எடை (kg)",
  "hint.diet_24h": "24-மணி நேர உணவு (நேற்று) மாணவர் நேற்று கீழ்கண்டவற்றை சாப்பிட்டாரா?",
  "legend.class_assignment": "பள்ளி / வகுப்பு / பிரிவு",
  "legend.girls_only": "கிஷோரி பெண்கள் (வயது ≥10 மட்டும்)",
  "legend.section_a": "பகுதி A: விவரங்கள்		",
  "legend.section_b": "பகுதி B: உடல் அளவீடு",
  "legend.section_c": "பகுதி C: உடனடி உடல் நல ரெட் ஃப்ளாக்ஸ்",
  "legend.section_d": "பகுதி D: உணவு வகை & பல்வகை",
  "legend.section_e": "பகுதி E: திட்ட உதவிகள்",
  "legend.section_f": "பகுதி F: உணவு பாதுகாப்பு",
  "option.cycle_length_days.GT_45": "45 நாட்களுக்கு மேல்",
  "option.cycle_length_days.LT_45": "45 நாட்களுக்கு குறைவு",
  "option.diet_type.LACTO_OVO": "( ) லாக்டோ-ஓவோ-சைவம் (முட்டை சாப்பிடுவர்)",
  "option.diet_type.LACTO_VEG": "( ) லாக்டோ-சைவம்",
  "option.diet_type.NON_VEG": "( ) நான்-வெஜ்",
  "option.dont_know": "தெரியாது",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ஒருபோதும் சரியில்லை (ரெட் ஃப்ளாக்)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) அதிகமாக சரி",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) சில நேரம் சரி (ரெட் ஃப்ளாக்)",
  "option.no": "இல்லை",
  "option.muac_tape_color.GREEN": "Check box - டேப்பின் நிறம் பச்சை",
  "option.muac_tape_color.RED": "Check box - டேப்பின் நிறம் சிவப்பு",
  "option.muac_tape_color.YELLOW": "Check box - டேப்பின் நிறம் மஞ்சள்",
  "option.yes": "ஆம்",
  "option.sex.F": "பெண்",
  "option.sex.M": "ஆண்",
},

    "ml": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "ആദ്യ മാസവിരാമം ആരംഭിച്ച പ്രായം (വർഷങ്ങളിൽ)",
  "ask.menarche_started": "നിങ്ങൾക്ക് മാസവിരാമം ആരംഭിച്ചിട്ടുണ്ടോ?",
  "ask.menarche_age_years": "എത്ര വയസ്സിലാണ് തുടങ്ങിയത്?",
      "field.menarche_started.label": "മാസവിരാമം ആരംഭിച്ചിട്ടുണ്ടോ?",
      "field.grade.label": "ക്ലാസ്",
  "field.division.label": "വിഭാഗം",
  "field.is_low_income.label": "കുറഞ്ഞ വരുമാന കുടുംബം",
  "field.deworming_date.label": "എത്ര മാസം മുമ്പ്?",
      "page.add_student.heading": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.add_student.browser_title": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.screening.heading_prefix": "സ്ക്രീനിംഗ്",
  "page.screening.browser_title_prefix": "സ്ക്രീനിംഗ്",
  "button.create_student_complete_screening": "വിദ്യാർത്ഥിയെ സൃഷ്ടിച്ച് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "button.complete_screening": "സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "button.cancel": "റദ്ദാക്കുക",
  "hint.select_dob_first": "ഈ ഫീൽഡ് പ്രവർത്തിപ്പിക്കാൻ ആദ്യം ജനനത്തീയതി തിരഞ്ഞെടുക്കുക",
      "option.no": "ഇല്ല",
  "option.sex.F": "പെൺകുട്ടി",
  "option.sex.M": "ആൺകുട്ടി",
  "option.yes": "അതെ",
  "page.add_student.browser_title": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.add_student.heading": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.screening.browser_title_prefix": "സ്ക്രീനിംഗ്",
  "page.screening.heading_prefix": "സ്ക്രീനിംഗ്",
  "placeholder.select": "തിരഞ്ഞെടുക്കുക",
  "placeholder.select_age": "പ്രായം തിരഞ്ഞെടുക്കുക",
  "placeholder.select_division": "വിഭാഗം തിരഞ്ഞെടുക്കുക",
  "placeholder.select_grade": "ക്ലാസ് തിരഞ്ഞെടുക്കുക",
  "placeholder.select_months": "മാസങ്ങൾ തിരഞ്ഞെടുക്കുക",
  "placeholder.select_sex": "ലിംഗം തിരഞ്ഞെടുക്കുക",
  "ui.language.label": "ഭാഷ",
  "age.month_plural": "മാസങ്ങൾ",
  "age.month_singular": "മാസം",
  "age.year_plural": "വർഷങ്ങൾ",
  "age.year_singular": "വർഷം",
  "ask.bleeding_clots": "ഡ്രോപ്പ്‌ഡൗൺ അതെ/ഇല്ല - രക്തസ്രാവത്തിൽ കട്ടകൾ (clots) വരാറുണ്ടോ?",
  "ask.breakfast_eaten": "നീ പ്രഭാതഭക്ഷണം കഴിച്ചോ?",
  "ask.cycle_length_days": "ഡ്രോപ്പ്‌ഡൗൺ - 45 ദിവസത്തിന് താഴെ / 45 ദിവസത്തിന് മേൽ - പീരിയഡ് വീണ്ടും എത്ര ദിവസത്തിന് ശേഷം വരുന്നു?",
  "ask.dal_pulses_beans": "നീ ഇന്നലെ ദാൽ/പയർവർഗങ്ങൾ/ബീൻസ് കഴിച്ചോ?",
  "ask.deworming_taken": "പുഴു മരുന്നിന്റെ വലിയ ഗുളിക എടുത്തോ?",
  "ask.diet_type.LACTO_OVO": "വീട്ടിൽ മുട്ട കഴിക്കുമോ?",
  "ask.diet_type.LACTO_VEG": "വീട്ടിൽ പാൽ കുടിക്കുമോ അല്ലെങ്കിൽ തൈര്/പനീർ കഴിക്കുമോ?",
  "ask.diet_type.NON_VEG": "വീട്ടിൽ മീൻ, ചിക്കൻ അല്ലെങ്കിൽ മട്ടൺ കഴിക്കുമോ?",
  "ask.egg": "നീ ഇന്നലെ മുട്ട കഴിച്ചോ?",
  "ask.fish_chicken_meat": "കഴിഞ്ഞ 3 ദിവസത്തിനുള്ളിൽ നീ മീൻ/ചിക്കൻ/മാംസം കഴിച്ചോ?",
  "ask.fruits": "നീ ഇന്നലെ പഴം കഴിച്ചോ?",
  "ask.green_leafy_veg": "നിന്റെ അവസാന ഭക്ഷണത്തിൽ ഇലക്കറികൾ (കീര) കഴിച്ചോ?",
  "ask.health_bone_or_joint_pain": "പരിക്ക് ഇല്ലാതെയും കഠിനമായ കളി/ജോലി ഇല്ലാതെയും കൈ/കാലുകൾ/സന്ധികളിൽ വേദന ഉണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_breathlessness": "സാധാരണ ജോലികൾ ചെയ്യുമ്പോൾ അല്ലെങ്കിൽ സാധാരണ നടക്കുമ്പോൾ ശ്വാസം മുട്ടുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_chronic_cough_or_diarrhea": "കുട്ടിക്ക് ചുമ ഉണ്ടോ, അത് കഴിഞ്ഞ 4 ആഴ്ചയോ അതിൽ കൂടുതലോ തുടരുന്നുണ്ടോ? അല്ലെങ്കിൽ വയറിളക്കം 2 ആഴ്ചയ്ക്ക് മേൽ നീളുന്നുണ്ടോ?",
  "ask.health_dental_or_gum_or_ulcers": "പല്ലുവേദന, പല്ലുമംസത്തിൽ നിന്ന് രക്തം വരുക, അല്ലെങ്കിൽ വായിൽ പുണ്ണുകൾ ഉണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_fatigue_dizzy_faint": "സാധാരണ ജോലി/കളിക്കുമ്പോൾ ബോധക്ഷയം ഉണ്ടായിട്ടുണ്ടോ, അല്ലെങ്കിൽ സാധാരണ ജോലി/കളി ചെയ്യാൻ പറ്റാത്തത്ര ക്ഷീണം തോന്നുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_frequent_infections": "കുട്ടിക്ക് വളരെ പലപ്പോഴും അസുഖം വരാറുണ്ടോ? കഴിഞ്ഞ മാസത്തിൽ 3 പ്രാവശ്യം അല്ലെങ്കിൽ അതിലധികം അസുഖപ്പെട്ടിട്ടുണ്ടോ?",
  "ask.health_general_poor": "കുട്ടിയോട് ചോദിക്കുക: നിനക്ക് നിന്റെ ആരോഗ്യം നന്നാണ് എന്ന് തോന്നുന്നുണ്ടോ?",
  "ask.health_night_vision_difficulty": "ഇരുട്ടിൽ ശരിയായി കാണാൻ പറ്റാത്തതിനാൽ നടക്കുമ്പോൾ ഇടറുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_pallor": "കുട്ടിക്ക് വിളർച്ച (pallor) ഉണ്ടോ?",
  "ask.health_visible_worms": "മലത്തിൽ ചെറിയ പുഴുക്കൾ കണ്ടിട്ടുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.lunch_eaten": "നീ ഉച്ചഭക്ഷണം കഴിച്ചോ?",
  "ask.milk_curd": "നീ ഇന്നലെ പാൽ കുടിച്ചോ അല്ലെങ്കിൽ തൈര് കഴിച്ചോ?",
  "ask.nuts_groundnuts": "നീ ഇന്നലെ കായ്കൾ/വേര്ക്കടല കഴിച്ചോ?",
  "ask.other_vegetables": "നിന്റെ അവസാന ഭക്ഷണത്തിൽ വേറേതെങ്കിലും പച്ചക്കറി കഴിച്ചോ?",
  "ask.pads_per_day": "ഡ്രോപ്പ്‌ഡൗൺ 1-10 - കൂടുതൽ രക്തസ്രാവമുള്ള ദിവസങ്ങളിൽ ദിവസത്തിൽ എത്ര പാഡ് വേണം എന്ന് കുട്ടിയോട് ചോദിക്കുക.",
  "ask.ssb_or_packaged_snacks": "നീ കൊക്കാകോള, പെപ്സി, മിറിൻഡ, ഫാന്റ, ലിംക തുടങ്ങിയ സോഫ്റ്റ് ഡ്രിങ്ക്സ് കുടിക്കുമോ? വീട്ടിൽ ഉണ്ടാക്കാത്ത ഫ്രൂട്ട് ജ്യൂസ് കുടിക്കുമോ? ബിസ്കറ്റ്, ചോക്ലേറ്റ്, ചിപ്സ്, കേക്ക് പോലുള്ള സ്നാക്സ് കഴിക്കുമോ?",
  "field.appetite.label": "വിശപ്പ്",
  "field.bleeding_clots.label": "ഡ്രോപ്പ്‌ഡൗൺ അതെ/ഇല്ല - രക്തസ്രാവത്തിൽ കട്ടകൾ (clots) വരാറുണ്ടോ?",
  "field.breakfast_eaten.label": "പ്രഭാത ഭക്ഷണം കഴിച്ചോ?",
  "field.cycle_length_days.label": "അനിയമിത പീരിയഡ് (>45 ദിവസത്തിന് മേൽ ഇടവേള)?",
  "field.dal_pulses_beans.label": "ദാൽ/പയർവർഗങ്ങൾ/ബീൻസ്",
  "field.deworming_taken.label": "പുഴുവിന് മരുന്ന് (Deworming)",
  "field.diet_type.label": "സാധാരണ ഡയറ്റ് തരം",
  "field.dob.label": "ജനന തീയതി (DOB)",
  "field.egg.label": "മുട്ട",
  "field.fish_chicken_meat.label": "മീൻ / ചിക്കൻ / മാംസം",
  "field.fruits.label": "പഴങ്ങൾ",
  "field.green_leafy_veg.label": "ഇലക്കറി (പാലക്/മേത്തി/അമരാന്ത്)",
  "field.health_bone_or_joint_pain.label": "എല്ല്/സന്ധി വേദന",
  "field.health_breathlessness.label": "പ്രയത്നത്തിൽ ശ്വാസം മുട്ടൽ",
  "field.health_chronic_cough_or_diarrhea.label": "ദീർഘകാല ചുമ അല്ലെങ്കിൽ തുടർച്ചയായ വയറിളക്കം",
  "field.health_dental_or_gum_or_ulcers.label": "പല്ല് പൊള്ളി/കുഴി, മംസത്തിൽ നിന്ന് രക്തം, അല്ലെങ്കിൽ വായിലെ പുണ്ണുകൾ",
  "field.health_fatigue_dizzy_faint.label": "ക്ഷീണം, തലചുറ്റൽ, അല്ലെങ്കിൽ ബോധക്ഷയം",
  "field.health_frequent_infections.label": "തുടർച്ചയായ ഇൻഫെക്ഷൻ (കഴിഞ്ഞ മാസത്തിൽ 3 പ്രാവശ്യം അല്ലെങ്കിൽ അധികം)",
  "field.health_general_poor.label": "പൊതു ആരോഗ്യം നല്ലതല്ല",
  "field.health_night_vision_difficulty.label": "രാത്രി കാഴ്ച പ്രശ്നം (കുറഞ്ഞ വെളിച്ചത്തിൽ ഇടറൽ)",
  "field.health_pallor.label": "വിളർച്ച (കണ്ണിന്റെ ഇമ/കൈപ്പത്തി ഉള്ളിൽ മങ്ങി തോന്നൽ)",
  "field.health_visible_worms.label": "മലത്തിൽ പുഴു കാണുക",
  "field.height_cm_r1.label": "2. ഉയരം (cm)",
  "field.hunger_vital_sign.label": "വിശപ്പ് സംബന്ധിച്ച ചോദ്യം (കഴിഞ്ഞ 12 മാസം)",
  "field.lunch_eaten.label": "സ്കൂളിൽ ഉച്ചഭക്ഷണം കഴിച്ചോ?",
  "field.milk_curd.label": "പാൽ / തൈര്",
  "field.muac_tape_color.label": "3. MUAC ടേപ്പിന്റെ നിറം",
  "field.nuts_groundnuts.label": "കായ്കൾ / വേര്ക്കടല",
  "field.other_vegetables.label": "മറ്റു പച്ചക്കറികൾ",
  "field.pads_per_day.label": "കൂടുതൽ രക്തസ്രാവം (ദിവസം ≥5 പാഡ് നനയുക അല്ലെങ്കിൽ കട്ടകൾ വരുക)?",
  "field.parent_phone_e164.label": "രക്ഷിതാവിന്റെ WhatsApp നമ്പർ",
  "field.sex.label": "ലിംഗം",
  "field.ssb_or_packaged_snacks.label": "പഞ്ചസാര പാനീയങ്ങൾ (SSB) അല്ലെങ്കിൽ പാക്കറ്റ് സ്നാക്സ് കഴിച്ചോ?",
  "field.student_name.label": "വിദ്യാർത്ഥിയുടെ പേര്",
  "field.unique_student_id.label": "യൂണിക് സ്റ്റുഡന്റ് ID",
  "field.weight_kg_r1.label": "1. ഭാരം (kg)",
  "hint.diet_24h": "24 മണിക്കൂർ ഓർമ്മ (ഇന്നലെ): കുട്ടി ഇന്നലെ താഴെ പറയുന്നവ കഴിച്ചോ?",
  "legend.class_assignment": "സ്കൂൾ / ക്ലാസ് / സെക്ഷൻ",
  "legend.girls_only": "കിശോരി പെൺകുട്ടികൾ (വയസ് ≥10 മാത്രം)",
  "legend.section_a": "വിഭാഗം A: വിവരങ്ങൾ",
  "legend.section_b": "വിഭാഗം B: ശരീര അളവുകൾ (Anthropometry)",
  "legend.section_c": "വിഭാഗം C: ഹെൽത്ത് റെഡ് ഫ്ലാഗുകൾ (വേഗം)",
  "legend.section_d": "വിഭാഗം D: ഡയറ്റ് തരം & വൈവിധ്യം",
  "legend.section_e": "വിഭാഗം E: പ്രോഗ്രാം സഹായങ്ങൾ",
  "legend.section_f": "വിഭാഗം F: ഭക്ഷ്യ സുരക്ഷ",
  "option.cycle_length_days.GT_45": "45 ദിവസത്തിന് മേൽ",
  "option.cycle_length_days.LT_45": "45 ദിവസത്തിന് താഴെ",
  "option.diet_type.LACTO_OVO": "( ) ലാക്ടോ-ഓവോ വെജ് (മുട്ട കഴിക്കും)",
  "option.diet_type.LACTO_VEG": "( ) ലാക്ടോ വെജ് (പാൽ/തൈര് കഴിക്കും)",
  "option.diet_type.NON_VEG": "( ) നോൺ-വെജ് (മീൻ/ചിക്കൻ/മാംസം)",
  "option.dont_know": "അറിയില്ല",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ഒരിക്കലും ശരിയല്ല (റെഡ് ഫ്ലാഗ്)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) പലപ്പോഴും ശരി",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) ചിലപ്പോഴൊക്കെ ശരി (റെഡ് ഫ്ലാഗ്)",
  "option.muac_tape_color.GREEN": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: പച്ച",
  "option.muac_tape_color.RED": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: ചുവപ്പ്",
  "option.muac_tape_color.YELLOW": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: മഞ്ഞ",
  "option.no": "ഇല്ല",
  "option.yes": "അതെ"
},
    
    "kn": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "ಮೊದಲ ಮಾಸಿಕ ಪ್ರಾರಂಭವಾದ ವಯಸ್ಸು (ವರ್ಷಗಳಲ್ಲಿ)",
  "ask.menarche_started": "ನಿಮಗೆ ಮಾಸಿಕ ಪ್ರಾರಂಭವಾಗಿದೆಯೇ?",
  "ask.menarche_age_years": "ಯಾವ ವಯಸ್ಸಿನಲ್ಲಿ ಪ್ರಾರಂಭವಾಯಿತು?",
      "field.menarche_started.label": "ಮಾಸಿಕ ಪ್ರಾರಂಭವಾಗಿದೆಯೇ?",
      "field.grade.label": "ತರಗತಿ",
  "field.division.label": "ವಿಭಾಗ",
  "field.is_low_income.label": "ಕಡಿಮೆ ಆದಾಯದ ಕುಟುಂಬ",
  "field.deworming_date.label": "ಎಷ್ಟು ತಿಂಗಳುಗಳ ಹಿಂದೆ?",
      "page.add_student.heading": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.add_student.browser_title": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.screening.heading_prefix": "ತಪಾಸಣೆ",
  "page.screening.browser_title_prefix": "ತಪಾಸಣೆ",
  "button.create_student_complete_screening": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ರಚಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "button.complete_screening": "ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "button.cancel": "ರದ್ದುಮಾಡಿ",
  "hint.select_dob_first": "ಈ ಫೀಲ್ಡ್ ಸಕ್ರಿಯಗೊಳಿಸಲು ಮೊದಲು ಜನ್ಮ ದಿನಾಂಕವನ್ನು ಆಯ್ಕೆಮಾಡಿ",
      "option.no": "ಇಲ್ಲ",
  "option.sex.F": "ಹುಡುಗಿ",
  "option.sex.M": "ಹುಡುಗ",
  "option.yes": "ಹೌದು",
  "page.add_student.browser_title": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.add_student.heading": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.screening.browser_title_prefix": "ತಪಾಸಣೆ",
  "page.screening.heading_prefix": "ತಪಾಸಣೆ",
  "placeholder.select": "ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_age": "ವಯಸ್ಸು ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_division": "ವಿಭಾಗ ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_grade": "ತರಗತಿ ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_months": "ತಿಂಗಳುಗಳನ್ನು ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_sex": "ಲಿಂಗ ಆಯ್ಕೆಮಾಡಿ",
  "ui.language.label": "ಭಾಷೆ",
  "age.month_plural": "ತಿಂಗಳುಗಳು",
  "age.month_singular": "ತಿಂಗಳು",
  "age.year_plural": "ವರ್ಷಗಳು",
  "age.year_singular": "ವರ್ಷ",
  "ask.bleeding_clots": "ಡ್ರಾಪ್‌ಡೌನ್ ಹೌದು/ಇಲ್ಲ - ರಕ್ತಸ್ರಾವವಾಗುವಾಗ ಗಟ್ಟೆಗಳು (clots) ಬರುತ್ತವೆಯೇ?",
  "ask.breakfast_eaten": "ನೀ ಬೆಳಗಿನ ತಿಂಡಿ ತಿಂದೆಯಾ?",
  "ask.cycle_length_days": "ಡ್ರಾಪ್‌ಡೌನ್ - 45 ದಿನಕ್ಕಿಂತ ಕಡಿಮೆ / 45 ದಿನಕ್ಕಿಂತ ಹೆಚ್ಚು - ಪೀರಿಯಡ್ಸ್ ಮತ್ತೆ ಎಷ್ಟು ದಿನಗಳ ನಂತರ ಬರುತ್ತದೆ?",
  "ask.dal_pulses_beans": "ನೀ ನಿನ್ನೆ ದಾಲ್/ಬೇಳೆ/ಬೀನ್ಸ್ ತಿಂದೆಯಾ?",
  "ask.deworming_taken": "ಹುಳುಮಾತ್ರೆಯ ದೊಡ್ಡ ಗೊಳಿಗೆಯನ್ನು ತೆಗೆದುಕೊಂಡೆಯಾ?",
  "ask.diet_type.LACTO_OVO": "ಮನೆಯಲ್ಲಿ ಮೊಟ್ಟೆ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.diet_type.LACTO_VEG": "ಮನೆಯಲ್ಲಿ ಹಾಲು ಕುಡಿಯುತ್ತೀಯಾ ಅಥವಾ ಮೊಸರು/ಪನೀರ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.diet_type.NON_VEG": "ಮನೆಯಲ್ಲಿ ಮೀನು, ಚಿಕನ್ ಅಥವಾ ಮಟನ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.egg": "ನೀ ನಿನ್ನೆ ಮೊಟ್ಟೆ ತಿಂದೆಯಾ?",
  "ask.fish_chicken_meat": "ಕಳೆದ 3 ದಿನಗಳಲ್ಲಿ ನೀ ಮೀನು/ಚಿಕನ್/ಮಾಂಸ ತಿಂದೆಯಾ?",
  "ask.fruits": "ನೀ ನಿನ್ನೆ ಹಣ್ಣು ತಿಂದೆಯಾ?",
  "ask.green_leafy_veg": "ನಿನ್ನ ಕೊನೆಯ ಊಟದಲ್ಲಿ ಸೊಪ್ಪು/ಹಸಿರು ಎಲೆ ತರಕಾರಿ ತಿಂದೆಯಾ?",
  "ask.health_bone_or_joint_pain": "ಗಾಯವಾಗದೆ ಮತ್ತು ಹೆಚ್ಚಾಗಿ ಆಟ/ಕೆಲಸ ಮಾಡದೇ ಇದ್ದರೂ ಕೈ/ಕಾಲು/ಸಂಧಿಗಳಲ್ಲಿ ನೋವು ಇದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_breathlessness": "ಸಾಮಾನ್ಯ ಕೆಲಸ ಮಾಡುವಾಗ ಅಥವಾ ಸಾಮಾನ್ಯವಾಗಿ ನಡೆಯುವಾಗ ಉಸಿರಾಟ ಕಷ್ಟವಾಗುತ್ತದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_chronic_cough_or_diarrhea": "ಮಗುಗೆ ಕೆಮ್ಮು ಇದೆಯೇ ಮತ್ತು ಅದು 4 ವಾರಗಳಿಗಿಂತ ಹೆಚ್ಚು ಮುಂದುವರಿದಿದೆಯೇ? ಅಥವಾ ಲೂಸ್ ಮೋಶನ್ 2 ವಾರಗಳಿಗಿಂತ ಹೆಚ್ಚು ಮುಂದುವರಿದಿದೆಯೇ?",
  "ask.health_dental_or_gum_or_ulcers": "ಹಲ್ಲು ನೋವು, ಹಲ್ಲುಮಾಂಸ ರಕ್ತಸ್ರಾವ, ಅಥವಾ ಬಾಯಿಯಲ್ಲಿ ಹುಣ್ಣುಗಳಿವೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_fatigue_dizzy_faint": "ಸಾಮಾನ್ಯ ಕೆಲಸ/ಆಟ ಮಾಡುವಾಗ ಎಂದಾದರೂ ಮೂರ್ಚೆ ಬಂದಿತ್ತೇ, ಅಥವಾ ರೂಟಿನ್ ಕೆಲಸ/ಆಟ ಮಾಡಲು ತುಂಬಾ ದಣಿವಾಗುತ್ತದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_frequent_infections": "ಮಗು ತುಂಬಾ ಸಲ ಅನಾರೋಗ್ಯವಾಗುತ್ತದೆಯೇ? ಕಳೆದ ತಿಂಗಳಲ್ಲಿ 3 ಬಾರಿ ಅಥವಾ ಹೆಚ್ಚು ಅಸ್ವಸ್ಥವಾಗಿತ್ತೇ?",
  "ask.health_general_poor": "ಮಗುಗೆ ಕೇಳಿ: ನೀನು ನಿನ್ನನ್ನು ಆರೋಗ್ಯವಾಗಿಯೇ ಅನಿಸುತ್ತಿದೆಯಾ?",
  "ask.health_night_vision_difficulty": "ಕತ್ತಲೆಯಲ್ಲಿ ಸರಿಯಾಗಿ ಕಾಣದೆ ನಡೆಯುವಾಗ ಅಡ್ಡಬೀಳುತ್ತೀಯಾ ಎಂದು ಕೇಳಿ.",
  "ask.health_pallor": "ಮಗುವಿಗೆ ಬಿಳಿಬಣ್ಣ/ವಿಳರ್ಚೆ (pallor) ಇದೆಯೇ?",
  "ask.health_visible_worms": "ಮಲದಲ್ಲಿ ಚಿಕ್ಕ ಹುಳುಗಳು ಕಂಡಿದ್ದೀಯಾ ಎಂದು ಕೇಳಿ.",
  "ask.lunch_eaten": "ನೀ ಮಧ್ಯಾಹ್ನ ಊಟ ತಿಂದೆಯಾ?",
  "ask.milk_curd": "ನೀ ನಿನ್ನೆ ಹಾಲು ಕುಡಿದೆಯಾ ಅಥವಾ ಮೊಸರು ತಿಂದೆಯಾ?",
  "ask.nuts_groundnuts": "ನೀ ನಿನ್ನೆ ಕಾಯಿ/ಕಡಲೆಕಾಯಿ ತಿಂದೆಯಾ?",
  "ask.other_vegetables": "ನಿನ್ನ ಕೊನೆಯ ಊಟದಲ್ಲಿ ಬೇರೆ ಯಾವುದಾದರೂ ತರಕಾರಿ ತಿಂದೆಯಾ?",
  "ask.pads_per_day": "ಡ್ರಾಪ್‌ಡೌನ್ 1-10 - ಹೆಚ್ಚಿನ ರಕ್ತಸ್ರಾವದ ದಿನಗಳಲ್ಲಿ ದಿನಕ್ಕೆ ಎಷ್ಟು ಪ್ಯಾಡ್ ಬೇಕಾಗುತ್ತದೆ ಎಂದು ಮಗುವಿಗೆ ಕೇಳಿ.",
  "ask.ssb_or_packaged_snacks": "ನೀ ಕೋಕಾಕೋಲಾ, ಪೆಪ್ಸಿ, ಮಿರಿಂಡಾ, ಫಾಂಟಾ, ಲಿಮ್ಕಾ ಹಾಗೆ ಸಾಫ್ಟ್ ಡ್ರಿಂಕ್ಸ್ ಕುಡಿಯುತ್ತೀಯಾ? ಮನೆಯಲ್ಲಿ ಮಾಡದ ಹಣ್ಣು ಜ್ಯೂಸ್ ಕುಡಿಯುತ್ತೀಯಾ? ಬಿಸ್ಕಟ್, ಚಾಕ್ಲೇಟ್, ಚಿಪ್ಸ್, ಕೇಕ್ ಹಾಗೆ ಸ್ನ್ಯಾಕ್ಸ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "field.appetite.label": "ಭೂಕು/ಆಹಾರ ಇಷ್ಟ",
  "field.bleeding_clots.label": "ಡ್ರಾಪ್‌ಡೌನ್ ಹೌದು/ಇಲ್ಲ - ರಕ್ತಸ್ರಾವವಾಗುವಾಗ ಗಟ್ಟೆಗಳು (clots) ಬರುತ್ತವೆಯೇ?",
  "field.breakfast_eaten.label": "ಬೆಳಗಿನ ತಿಂಡಿ ತಿಂದೆಯಾ?",
  "field.cycle_length_days.label": "ಅನಿಯಮಿತ ಪೀರಿಯಡ್ಸ್ (>45 ದಿನಗಳಿಗಿಂತ ಹೆಚ್ಚು ಗ್ಯಾಪ್)?",
  "field.dal_pulses_beans.label": "ದಾಲ್ / ಬೇಳೆ / ಬೀನ್ಸ್",
  "field.deworming_taken.label": "ಹುಳು ಮಾತ್ರೆ (Deworming)",
  "field.diet_type.label": "ಸಾಧಾರಣ ಆಹಾರ ಪ್ರಕಾರ",
  "field.dob.label": "ಜನ್ಮ ದಿನಾಂಕ (DOB)",
  "field.egg.label": "ಮೊಟ್ಟೆ",
  "field.fish_chicken_meat.label": "ಮೀನು / ಚಿಕನ್ / ಮಾಂಸ",
  "field.fruits.label": "ಹಣ್ಣುಗಳು",
  "field.green_leafy_veg.label": "ಹಸಿರು ಎಲೆ ತರಕಾರಿ (ಪಾಲಕ್/ಮೆಂತ್ಯೆ/ಅಮರಾಂತ್)",
  "field.health_bone_or_joint_pain.label": "ಎಲುಬು ಅಥವಾ ಸಂಧಿ ನೋವು",
  "field.health_breathlessness.label": "ಪ್ರಯತ್ನದಲ್ಲಿ ಉಸಿರಾಟ ತೊಂದರೆ",
  "field.health_chronic_cough_or_diarrhea.label": "ದೀರ್ಘಕಾಲದ ಕೆಮ್ಮು ಅಥವಾ ಅತಿಸಾರ",
  "field.health_dental_or_gum_or_ulcers.label": "ಹಲ್ಲು ಕುಳು (ಕ್ಯಾವಿಟಿ), ಹಲ್ಲುಮಾಂಸದಿಂದ ರಕ್ತ, ಅಥವಾ ಬಾಯಿಯಲ್ಲಿ ಹುಣ್ಣು",
  "field.health_fatigue_dizzy_faint.label": "ದಣಿವು, ತಲೆಸುತ್ತು, ಅಥವಾ ಮೂರ್ಚೆ",
  "field.health_frequent_infections.label": "ಮರುಮರು ಇನ್ಫೆಕ್ಷನ್ (ಕಳೆದ ತಿಂಗಳಲ್ಲಿ 3 ಬಾರಿ ಅಥವಾ ಹೆಚ್ಚು)",
  "field.health_general_poor.label": "ಸಾಮಾನ್ಯ ಆರೋಗ್ಯ ಚೆನ್ನಾಗಿಲ್ಲ",
  "field.health_night_vision_difficulty.label": "ರಾತ್ರಿ ಕಾಣುವಲ್ಲಿ ತೊಂದರೆ (ಕಡಿಮೆ ಬೆಳಕಿನಲ್ಲಿ ಅಡ್ಡಬೀಳುವುದು)",
  "field.health_pallor.label": "ವಿಳರ್ಚೆ (ಕಣ್ತುಪ್ಪು/ಕೈತಳದಲ್ಲಿ ಬಿಳಿಬಣ್ಣ)",
  "field.health_visible_worms.label": "ಮಲದಲ್ಲಿ ಹುಳು ಕಾಣುವುದು",
  "field.height_cm_r1.label": "2. ಎತ್ತರ (cm)",
  "field.hunger_vital_sign.label": "ಹಸಿವು ಪ್ರಶ್ನೆ (ಕಳೆದ 12 ತಿಂಗಳು)",
  "field.lunch_eaten.label": "ಶಾಲೆಯಲ್ಲಿ ಮಧ್ಯಾಹ್ನ ಊಟ ತಿಂದೆಯಾ?",
  "field.milk_curd.label": "ಹಾಲು / ಮೊಸರು",
  "field.muac_tape_color.label": "3. MUAC ಟೇಪ್‌ನ ಬಣ್ಣ",
  "field.nuts_groundnuts.label": "ಕಾಯಿ / ಕಡಲೆಕಾಯಿ",
  "field.other_vegetables.label": "ಇತರೆ ತರಕಾರಿಗಳು",
  "field.pads_per_day.label": "ಹೆಚ್ಚು ರಕ್ತಸ್ರಾವ (ದಿನಕ್ಕೆ ≥5 ಪ್ಯಾಡ್ ಅಥವಾ ಗಟ್ಟೆಗಳು)?",
  "field.parent_phone_e164.label": "ಪೋಷಕರ WhatsApp ನಂಬರ್",
  "field.sex.label": "ಲಿಂಗ",
  "field.ssb_or_packaged_snacks.label": "ಸಿಹಿ ಪಾನೀಯಗಳು (SSB) ಅಥವಾ ಪ್ಯಾಕೆಟ್ ಸ್ನ್ಯಾಕ್ಸ್ ತಿಂದೆಯಾ?",
  "field.student_name.label": "ವಿದ್ಯಾರ್ಥಿಯ ಹೆಸರು",
  "field.unique_student_id.label": "ಯೂನಿಕ್ ಸ್ಟುಡೆಂಟ್ ID",
  "field.weight_kg_r1.label": "1. ತೂಕ (kg)",
  "hint.diet_24h": "24-ಗಂಟೆಗಳ ನೆನಪು (ನಿನ್ನೆ): ಮಗು ನಿನ್ನೆ ಕೆಳಗಿನವುಗಳನ್ನು ತಿಂದಿತೇ?",
  "legend.class_assignment": "ಶಾಲೆ / ತರಗತಿ / ವಿಭಾಗ",
  "legend.girls_only": "ಕಿಶೋರಿ ಬಾಲಕಿಯರು (ವಯಸ್ಸು ≥10 ಮಾತ್ರ)",
  "legend.section_a": "ವಿಭಾಗ A: ವಿವರಗಳು",
  "legend.section_b": "ವಿಭಾಗ B: ದೇಹದ ಅಳತೆಗಳು (Anthropometry)",
  "legend.section_c": "ವಿಭಾಗ C: ತ್ವರಿತ ಆರೋಗ್ಯ ರೆಡ್ ಫ್ಲ್ಯಾಗ್ಸ್",
  "legend.section_d": "ವಿಭಾಗ D: ಆಹಾರ ಪ್ರಕಾರ & ವೈವಿಧ್ಯ",
  "legend.section_e": "ವಿಭಾಗ E: ಪ್ರೋಗ್ರಾಂ ಬೆಂಬಲ",
  "legend.section_f": "ವಿಭಾಗ F: ಆಹಾರ ಭದ್ರತೆ",
  "option.cycle_length_days.GT_45": "45 ದಿನಕ್ಕಿಂತ ಹೆಚ್ಚು",
  "option.cycle_length_days.LT_45": "45 ದಿನಕ್ಕಿಂತ ಕಡಿಮೆ",
  "option.diet_type.LACTO_OVO": "( ) ಲ್ಯಾಕ್ಟೋ-ಓವೋ ವೆಜ್ (ಮೊಟ್ಟೆ ತಿನ್ನುತ್ತಾರೆ)",
  "option.diet_type.LACTO_VEG": "( ) ಲ್ಯಾಕ್ಟೋ ವೆಜ್ (ಹಾಲು/ಮೊಸರು ತೆಗೆದುಕೊಳ್ಳುತ್ತಾರೆ)",
  "option.diet_type.NON_VEG": "( ) ನಾನ್-ವೆಜ್ (ಮೀನು/ಚಿಕನ್/ಮಾಂಸ)",
  "option.dont_know": "ಗೊತ್ತಿಲ್ಲ",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ಎಂದಿಗೂ ಸರಿ ಇಲ್ಲ (ರೆಡ್ ಫ್ಲ್ಯಾಗ್)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) ಹೆಚ್ಚಾಗಿ ಸರಿ",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) ಕೆಲವೊಮ್ಮೆ ಸರಿ (ರೆಡ್ ಫ್ಲ್ಯಾಗ್)",
  "option.muac_tape_color.GREEN": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಹಸಿರು",
  "option.muac_tape_color.RED": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಕೆಂಪು",
  "option.muac_tape_color.YELLOW": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಹಳದಿ",
},

"bn": {
  "option.grade.K.G.": "K.G.",
  "field.grade.label": "শ্রেণি",
  "field.division.label": "বিভাগ",
  "field.is_low_income.label": "নিম্ন আয়ের পরিবার",
  "field.deworming_date.label": "কয় মাস আগে?",
  "page.add_student.heading": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.add_student.browser_title": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.screening.heading_prefix": "স্ক্রিনিং",
  "page.screening.browser_title_prefix": "স্ক্রিনিং",
  "button.create_student_complete_screening": "শিক্ষার্থী তৈরি করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "button.complete_screening": "স্ক্রিনিং সম্পন্ন করুন",
  "button.cancel": "বাতিল করুন",
  "hint.select_dob_first": "এই ফিল্ডটি সক্রিয় করতে আগে জন্ম তারিখ নির্বাচন করুন",
  "option.no": "না",
  "option.yes": "হ্যাঁ",
  "page.add_student.browser_title": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.add_student.heading": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.screening.browser_title_prefix": "স্ক্রিনিং",
  "page.screening.heading_prefix": "স্ক্রিনিং",
  "placeholder.select": "নির্বাচন করুন",
  "placeholder.select_age": "বয়স নির্বাচন করুন",
  "placeholder.select_division": "বিভাগ নির্বাচন করুন",
  "placeholder.select_grade": "শ্রেণি নির্বাচন করুন",
  "placeholder.select_months": "মাস নির্বাচন করুন",
  "placeholder.select_sex": "লিঙ্গ নির্বাচন করুন",
  "ui.language.label": "ভাষা",
  "age.month_plural": "মাস",
  "age.month_singular": "মাস",
  "age.year_plural": "বছর",
  "age.year_singular": "বছর",
  "legend.section_a": "সেকশন A: বিবরণ",
  "legend.section_b": "সেকশন B: শরীরের মাপ (Anthropometry)",
  "legend.section_c": "সেকশন C: দ্রুত স্বাস্থ্য রেড ফ্ল্যাগ",
  "legend.section_d": "সেকশন D: ডায়েটের ধরন ও বৈচিত্র্য",
  "legend.section_e": "সেকশন E: প্রোগ্রাম সহায়তা",
  "legend.section_f": "সেকশন F: খাদ্য নিরাপত্তা",
  "legend.girls_only": "কিশোরী মেয়েরা (বয়স ≥10 শুধু)",
  "legend.class_assignment": "স্কুল / ক্লাস / সেকশন",

  "field.student_name.label": "শিক্ষার্থীর নাম",
  "field.unique_student_id.label": "ইউনিক স্টুডেন্ট ID",
  "field.dob.label": "জন্মতারিখ (DOB)",
  "field.sex.label": "লিঙ্গ",
  "field.parent_phone_e164.label": "অভিভাবকের WhatsApp নম্বর",

  "field.weight_kg_r1.label": "1. ওজন (kg)",
  "field.height_cm_r1.label": "2. উচ্চতা (cm)",
  "field.muac_tape_color.label": "3. MUAC টেপের রং",

  "option.muac_tape_color.RED": "চেকবক্স - টেপের রং: লাল",
  "option.muac_tape_color.YELLOW": "চেকবক্স - টেপের রং: হলুদ",
  "option.muac_tape_color.GREEN": "চেকবক্স - টেপের রং: সবুজ",

  "field.health_general_poor.label": "সাধারণ স্বাস্থ্য ভালো নয়",
  "ask.health_general_poor": "শিশুকে জিজ্ঞেস করুন: তুমি কি নিজেকে সুস্থ মনে করো?",

  "field.health_pallor.label": "ফ্যাকাশে ভাব (চোখের পাতা/হাতের তালুর ভেতরে ফ্যাকাশে)",
  "ask.health_pallor": "শিশুর ফ্যাকাশে ভাব (pallor) আছে কি?",

  "field.health_fatigue_dizzy_faint.label": "ক্লান্তি, মাথা ঘোরা, বা অজ্ঞান হওয়া",
  "ask.health_fatigue_dizzy_faint": "স্বাভাবিক কাজ/খেলার সময় কখনো অজ্ঞান হয়েছ কি না, বা স্বাভাবিক কাজ/খেলা করতে খুব বেশি ক্লান্ত লাগে কি না জিজ্ঞেস করুন।",

  "field.health_breathlessness.label": "পরিশ্রমে শ্বাসকষ্ট",
  "ask.health_breathlessness": "সাধারণ কাজ করতে বা স্বাভাবিকভাবে হাঁটলে কি শ্বাসকষ্ট হয়—এটা জিজ্ঞেস করুন।",

  "field.health_frequent_infections.label": "ঘন ঘন ইনফেকশন (গত মাসে ৩ বার বা বেশি)",
  "ask.health_frequent_infections": "শিশুটি কি খুব ঘন ঘন অসুস্থ হয়? গত মাসে ৩ বার বা তার বেশি অসুস্থ হয়েছিল কি?",

  "field.health_chronic_cough_or_diarrhea.label": "দীর্ঘদিনের কাশি বা ডায়রিয়া",
  "ask.health_chronic_cough_or_diarrhea": "শিশুর কি কাশি আছে এবং তা কি গত ৪ সপ্তাহ বা তার বেশি সময় ধরে আছে? অথবা পাতলা পায়খানা (লুজ মোশন) কি ২ সপ্তাহের বেশি চলছে?",

  "field.health_visible_worms.label": "মলে কৃমি দেখা যাওয়া",
  "ask.health_visible_worms": "মলে কখনো ছোট কৃমি/পোকা দেখেছ কি না জিজ্ঞেস করুন।",

  "field.health_dental_or_gum_or_ulcers.label": "দাঁতের ক্ষয়/ক্যাভিটি, মাড়ি থেকে রক্ত, বা মুখে ঘা",
  "ask.health_dental_or_gum_or_ulcers": "দাঁত ব্যথা, মাড়ি থেকে রক্ত পড়া, বা মুখে ঘা আছে কি না জিজ্ঞেস করুন।",

  "field.health_night_vision_difficulty.label": "রাতে দেখতে সমস্যা (কম আলোতে হোঁচট খাওয়া)",
  "ask.health_night_vision_difficulty": "অন্ধকারে ঠিকমতো না দেখায় হাঁটার সময় হোঁচট খাও কি না জিজ্ঞেস করুন।",

  "field.health_bone_or_joint_pain.label": "হাড় বা জয়েন্টে ব্যথা",
  "ask.health_bone_or_joint_pain": "চোট না লাগলেও আর বেশি খেলাধুলা/কাজ না করলেও হাত/পা/জয়েন্টে ব্যথা হয় কি না জিজ্ঞেস করুন।",

  "field.appetite.label": "খিদে",

  "field.menarche_started.label": "পিরিয়ড/মাসিক শুরু হয়েছে কি?",
  "ask.menarche_started": "চেকবক্স - মেয়েটির পিরিয়ড/মাসিক শুরু হয়েছে কি না জিজ্ঞেস করুন।",

  "field.menarche_age_years.label": "প্রথম পিরিয়ডের বয়স (বছর)",
  "ask.menarche_age_years": "বয়স ড্রপডাউন (বছর) - মাসিক/পিরিয়ড কত বয়সে শুরু হয়েছে? জিজ্ঞেস করুন।",

  "field.pads_per_day.label": "অতিরিক্ত ব্লিডিং (দিনে ≥৫টি প্যাড ভিজে যাওয়া বা জমাট/ক্লটস পড়া)?",
  "ask.pads_per_day": "ড্রপডাউন 1-10 - বেশি ব্লিডিংয়ের দিনে দিনে কতগুলো প্যাড লাগে, শিশুটিকে জিজ্ঞেস করুন।",

  "field.bleeding_clots.label": "ড্রপডাউন হ্যাঁ/না - ব্লিডিংয়ের সময় জমাট (clots) পড়ে কি?",
  "ask.bleeding_clots": "ড্রপডাউন হ্যাঁ/না - ব্লিডিংয়ের সময় জমাট (clots) পড়ে কি?",

  "field.cycle_length_days.label": "অনিয়মিত পিরিয়ড (>৪৫ দিনের বেশি বিরতি)?",
  "ask.cycle_length_days": "ড্রপডাউন - ৪৫ দিনের কম / ৪৫ দিনের বেশি - পিরিয়ড আবার কত দিন পর হয়?",

  "field.diet_type.label": "সাধারণত ডায়েটের ধরন",
  "option.diet_type.LACTO_VEG": "( ) ল্যাক্টো ভেজ (দুধ/দই খায়)",
  "ask.diet_type.LACTO_VEG": "বাড়িতে দুধ খাও বা দই/পনির খাও কি?",
  "option.diet_type.LACTO_OVO": "( ) ল্যাক্টো-ওভো ভেজ (ডিম খায়)",
  "ask.diet_type.LACTO_OVO": "বাড়িতে ডিম খাও কি?",
  "option.diet_type.NON_VEG": "( ) নন-ভেজ (মাছ/চিকেন/মাংস)",
  "ask.diet_type.NON_VEG": "বাড়িতে মাছ, চিকেন বা মাটন খাও কি?",

  "hint.diet_24h": "২৪ ঘণ্টার স্মরণ (গতকাল): শিক্ষার্থী কি গতকাল নিচের খাবারগুলো খেয়েছিল?",

  "field.breakfast_eaten.label": "নাশতা খেয়েছ?",
  "ask.breakfast_eaten": "তুমি কি নাশতা খেয়েছ?",

  "field.lunch_eaten.label": "স্কুলে দুপুরের খাবার/লাঞ্চ খেয়েছ?",
  "ask.lunch_eaten": "তুমি কি দুপুরের খাবার/লাঞ্চ খেয়েছ?",

  "field.green_leafy_veg.label": "পাতা শাক (পালং/মেথি/আমরান্থ)",
  "ask.green_leafy_veg": "তোমার শেষ খাবারে শাকসবজি (পাতা শাক) খেয়েছ কি?",

  "field.other_vegetables.label": "অন্যান্য সবজি",
  "ask.other_vegetables": "তোমার শেষ খাবারে অন্য কোনো সবজি খেয়েছ কি?",

  "field.fruits.label": "ফল",
  "ask.fruits": "তুমি কি গতকাল ফল খেয়েছ?",

  "field.dal_pulses_beans.label": "ডাল / ডালজাতীয় / বিনস",
  "ask.dal_pulses_beans": "তুমি কি গতকাল ডাল/ডালজাতীয়/বিনস খেয়েছ?",

  "field.milk_curd.label": "দুধ / দই",
  "ask.milk_curd": "তুমি কি গতকাল দুধ খেয়েছ বা দই খেয়েছ?",

  "field.egg.label": "ডিম",
  "ask.egg": "তুমি কি গতকাল ডিম খেয়েছ?",

  "field.fish_chicken_meat.label": "মাছ / চিকেন / মাংস",
  "ask.fish_chicken_meat": "গত ৩ দিনে তুমি কি মাছ/চিকেন/মাংস খেয়েছ?",

  "field.nuts_groundnuts.label": "বাদাম / চিনাবাদাম",
  "ask.nuts_groundnuts": "তুমি কি গতকাল বাদাম/চিনাবাদাম খেয়েছ?",

  "field.ssb_or_packaged_snacks.label": "চিনি দেওয়া পানীয় (SSB) বা প্যাকেট স্ন্যাকস খেয়েছ?",
  "ask.ssb_or_packaged_snacks": "তুমি কি কোকা কোলা, পেপসি, মিরিন্ডা, ফ্যান্টা, লিমকা ইত্যাদি সফট ড্রিংকস খাও? বাড়িতে বানানো নয় এমন ফলের জুস খাও? বিস্কুট, চকলেট, চিপস, কেক ইত্যাদি স্ন্যাকস খাও?",

  "field.deworming_taken.label": "কৃমিনাশক (Deworming)",
  "ask.deworming_taken": "কৃমিনাশকের বড় ট্যাবলেটটা নিয়েছ কি?",

  "option.dont_know": "জানি না",

  "field.hunger_vital_sign.label": "ক্ষুধা সম্পর্কিত প্রশ্ন (গত ১২ মাস)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) বেশিরভাগ সময় সত্য",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) কখনো কখনো সত্য (রেড ফ্ল্যাগ)",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) কখনোই সত্য নয় (রেড ফ্ল্যাগ)",

  "option.sex.M": "ছেলে",
  "option.sex.F": "মেয়ে",

  "option.cycle_length_days.LT_45": "৪৫ দিনের কম",
  "option.cycle_length_days.GT_45": "৪৫ দিনের বেশি"
},

    
    
    /* --------------------------------------------------------------------------------
       IMPORTANT:
       The remaining 7 languages (mr, hi, te, ta, ml, kn, bn) are required.
       They are large (~120 keys each) and must be pasted exactly.

       I have prepared them from your uploaded spreadsheet,
       but the tool session ended before I could print the entire JSON here.

       ✅ NEXT STEP FOR YOU:
       I will provide the full 8-language JSON block in the next message if you want,
       OR you can tell me to output only mr/hi first, then continue in chunks.

       For now this file must contain ALL 8 languages to meet your requirement.
    -------------------------------------------------------------------------------- */
  };

  function safeGetLang() {
    var sel = document.getElementById("language-select");
    return sel && sel.value ? sel.value : "en";
  }
  

  function safeSetLang(lang) {
    // Disabled: do not save language
  }

  function t(key, langOverride) {
    const lang = langOverride || safeGetLang();
    return (I18N[lang] && I18N[lang][key]) || (I18N.en && I18N.en[key]) || "";
  }

  function setLabelTextPreserveInput(label, input, text) {
    if (!label) return;
    if (input && label.contains(input)) {
      Array.from(label.childNodes).forEach((n) => {
        if (n !== input) label.removeChild(n);
      });
      label.appendChild(document.createTextNode(" " + text));
    } else {
      label.textContent = text;
    }
  }

  function translateSelect(name, map, lang) {
    document.querySelectorAll(`select[name="${name}"]`).forEach((sel) => {
      Array.from(sel.options).forEach((opt) => {
        if (opt.value === "" && map.__empty__) opt.textContent = map.__empty__;
        else if (map[opt.value] != null) opt.textContent = map[opt.value];
      });
    });
  }

  function translateRadio(name, map) {
    document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach((input) => {
      const val = input.value;
      const text = map[val];
      if (!text) return;

      let label = input.closest("label");
      if (!label && input.id) label = document.querySelector(`label[for="${input.id}"]`);
      setLabelTextPreserveInput(label, input, text);
    });
  }

  function translateYesNoProxy(lang) {
    document.querySelectorAll("select.yn-proxy").forEach((sel) => {
      Array.from(sel.options).forEach((opt) => {
        if (opt.value === "") opt.textContent = t("placeholder.select", lang);
        if (opt.value === "yes") opt.textContent = t("option.yes", lang);
        if (opt.value === "no") opt.textContent = t("option.no", lang);
      });
    });
  }

  function translateBoolSelects(lang) {
    const boolSelectFields = [
      "breakfast_eaten",
      "lunch_eaten",
      "green_leafy_veg",
      "other_vegetables",
      "fruits",
      "dal_pulses_beans",
      "milk_curd",
      "egg",
      "fish_chicken_meat",
      "nuts_groundnuts",
      "ssb_or_packaged_snacks",
      "menarche_started",
      "bleeding_clots"
    ];

    boolSelectFields.forEach((f) => {
      translateSelect(f, {
        __empty__: t("placeholder.select", lang),
        yes: t("option.yes", lang),
        no: t("option.no", lang)
      }, lang);
    });
  }

  function translateCycleLength(lang) {
    translateSelect("cycle_length_days", {
      __empty__: t("placeholder.select", lang),
      LT_45: t("option.cycle_length_days.LT_45", lang),
      GT_45: t("option.cycle_length_days.GT_45", lang)
    }, lang);
  }

  function translateDewormingMonths(lang) {
    const one = t("age.month_singular", lang);
    const many = t("age.month_plural", lang);

    const map = { __empty__: t("placeholder.select_months", lang) };
    for (let i = 1; i <= 12; i++) {
      map[String(i)] = `${i} ${i === 1 ? one : many}`;
    }
    translateSelect("deworming_date", map, lang);
  }

  

  function apply(lang) {
    document.documentElement.lang = lang;

    document.querySelectorAll("[data-i18n]").forEach((el) => {
      const key = el.getAttribute("data-i18n");
      const val = t(key, lang);
      if (val) el.textContent = val;
    });

    // Title handling (screening page includes student name dynamically)
    const page = document.body && document.body.getAttribute("data-page");
    if (page === "add_student") {
      document.title = t("page.add_student.browser_title", lang);
    } else if (page === "screening_form") {
      const name = document.body.getAttribute("data-student-name") || "";
      const prefix = t("page.screening.browser_title_prefix", lang) || t("page.screening.heading_prefix", lang) || "";
      document.title = name ? `${prefix} – ${name}` : prefix;
    }

    // Choices / options
    translateSelect("sex", {
      __empty__: t("placeholder.select_sex", lang),
      M: t("option.sex.M", lang),
      F: t("option.sex.F", lang)
    }, lang);

    translateSelect("grade", {
      __empty__: t("placeholder.select_grade", lang),
      Nursery: t("option.grade.Nursery", lang),
      "K.G.": t("option.grade.K.G.", lang),
      Other: t("option.grade.Other", lang)
    }, lang);

    translateSelect("division", { __empty__: t("placeholder.select_division", lang) }, lang);

    translateRadio("muac_tape_color", {
      RED: t("option.muac_tape_color.RED", lang),
      YELLOW: t("option.muac_tape_color.YELLOW", lang),
      GREEN: t("option.muac_tape_color.GREEN", lang)
    });

    translateRadio("diet_type", {
      LACTO_VEG: t("option.diet_type.LACTO_VEG", lang),
      LACTO_OVO: t("option.diet_type.LACTO_OVO", lang),
      NON_VEG: t("option.diet_type.NON_VEG", lang)
    });

    translateRadio("appetite", {
      yes: t("option.yes", lang),
      no: t("option.no", lang)
    });

    translateRadio("deworming_taken", {
      yes: t("option.yes", lang),
      no: t("option.no", lang),
      dont_know: t("option.dont_know", lang)
    });

    translateRadio("hunger_vital_sign", {
      OFTEN_TRUE: t("option.hunger_vital_sign.OFTEN_TRUE", lang),
      SOMETIMES_TRUE: t("option.hunger_vital_sign.SOMETIMES_TRUE", lang),
      NEVER_TRUE: t("option.hunger_vital_sign.NEVER_TRUE", lang)
    });

    translateYesNoProxy(lang);
    translateBoolSelects(lang);
    translateCycleLength(lang);
    translateDewormingMonths(lang);
    translateSelect("menarche_age_years", {
      __empty__: t("placeholder.select_age", lang)
    }, lang);
  
    translateSelect("pads_per_day", {
      __empty__: t("placeholder.select", lang)
    }, lang);
    // retrigger DOB change to reformat age string if page script listens to it
    const dob = document.querySelector('input[name="dob"]');
    if (dob) dob.dispatchEvent(new Event("change", { bubbles: true }));
  }

  // Export a small API used by template JS (division placeholder, formatAge fallback)
  window.NUTRILIFT_I18N = {
    getLang: safeGetLang,
    setLang: safeSetLang,
    t: (key) => t(key, safeGetLang()),
    apply: () => apply(safeGetLang()),
    formatAge: function (months) {
      const lang = safeGetLang();
      if (months == null || isNaN(months)) return "";
      const years = Math.floor(months / 12);
      const rem = months % 12;

      const y1 = t("age.year_singular", lang);
      const yN = t("age.year_plural", lang);
      const m1 = t("age.month_singular", lang);
      const mN = t("age.month_plural", lang);

      if (years <= 0) return `${rem} ${rem === 1 ? m1 : mN}`;
      return `${years} ${years === 1 ? y1 : yN} ${rem} ${rem === 1 ? m1 : mN}`;
    }
  };

  document.addEventListener("DOMContentLoaded", function () {
    const sel = document.getElementById("language-select");
    const current = safeGetLang();

    if (sel) {
      sel.value = current;
      sel.addEventListener("change", function () {
        safeSetLang(sel.value);
        apply(sel.value);
      });
    }

    apply(current);
  });
})();

  </script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 980px; margin: 0 auto; }
    .langbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin: 8px 0 14px 0;
    }
    .langbar .lang-label {
      font-size: 13px;
      color: #222;
      font-weight: 600;
    }
    .langbar select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e8e8e8;
      background: #fafafa;
      font-size: 14px;
    }

    h2 { margin: 0 0 4px 0; }
    .muted { color: #666; font-size: 14px; margin: 4px 0 0 0; }
    form { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; }

    fieldset { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin: 14px 0; }
    legend { padding: 0 8px; font-weight: 700; }
    .section-hint { margin: 8px 0 0 0; color: #666; font-size: 13px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    .field { margin: 8px 0; }
    .field label { display: block; font-size: 13px; color: #222; font-weight: 600; margin-bottom: 4px; }
    .field input[type="text"], .field input[type="number"], .field input[type="date"], .field select {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    .field select, .qrow select, select.yn-proxy {
      border: 1px solid #e8e8e8;
      background: #fafafa;
    }

    .radio ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 14px; flex-wrap: wrap; }
    .radio li { margin: 0; }
    .radio label { display: inline; font-size: 14px; color: #111; margin: 0; }

    .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; margin-top: 6px; }
    @media (max-width: 720px) { .checks { grid-template-columns: 1fr; } }
    .check { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid #f0f0f0; border-radius: 10px; background: #fcfcfc; }
    .check label { margin: 0; display: inline; font-size: 14px; color: #111; }

    .errors { color: #b00020; font-size: 13px; margin-top: 6px; }
    .nonfield { color: #b00020; background: #fff2f2; border: 1px solid #ffd0d0; padding: 10px 12px; border-radius: 10px; margin: 10px 0; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button, a.button {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      text-decoration: none;
      cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }

    .ask-child { color: #888; font-size: 12px; margin: 2px 0 6px 0; }
    .qrow { border: 1px solid #f0f0f0; border-radius: 12px; background: #fcfcfc; padding: 10px 12px; margin: 10px 0; }
    .qrow .qtitle { font-size: 14px; font-weight: 700; color: #111; margin: 0 0 4px 0; }
    .qrow .qtitle label { font-size: 14px; font-weight: 700; color: #111; margin: 0; display: inline; }
    .qrow select { margin-top: 4px; }
  </style>
</head>

<body data-page="add_student">
  <div class="container">
    <h2 data-i18n="page.add_student.heading">Add student & complete screening</h2>
    
    <div class="langbar">
      <div class="lang-label" data-i18n="ui.language.label">Language</div>
      <select id="language-select" aria-label="Language">
        <option value="en">English</option>
        <option value="mr" selected>मराठी</option>
        <option value="hi">हिन्दी</option>
        <option value="te">తెలుగు</option>
        <option value="ta">தமிழ்</option>
        <option value="ml">മലയാളം</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="bn">বাংলা</option>
      </select>
    </div>
    
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="form_language" id="form-language-input" value="">
      <input type="hidden" name="wa_questions_and_answers" id="wa-qa-input" value="">
    
      {% if student_form.non_field_errors %}
        <div class="nonfield">{{ student_form.non_field_errors }}</div>
      {% endif %}
      {% if screening_form.non_field_errors %}
        <div class="nonfield">{{ screening_form.non_field_errors }}</div>
      {% endif %}

      <!-- CLASS DETAILS -->
    {% comment %} <fieldset>
    <legend>Class assignment</legend>

    {% if student_form.initial.grade and student_form.initial.division %}
      {{ student_form.grade.as_hidden }}
      {{ student_form.division.as_hidden }}

      <p style="margin: 0 0 10px; color: #444;">
        <strong>Class &amp; Section:</strong>
        {{ student_form.initial.grade }} - {{ student_form.initial.division }}
      </p>
    {% else %}
      <div class="row">
        <div>
          <label for="id_grade">Grade / Class</label>
          {{ student_form.grade }}
          {% if student_form.grade.errors %}<p class="error">{{ student_form.grade.errors.0 }}</p>{% endif %}
        </div>

        <div>
          <label for="id_division">Division / Section</label>
          {{ student_form.division }}
          {% if student_form.division.errors %}<p class="error">{{ student_form.division.errors.0 }}</p>{% endif %}
        </div>
      </div>
    {% endif %}

    <div class="row">
      <div>
        <label>{{ student_form.is_low_income.label }}</label>
        {{ student_form.is_low_income }}
        {% if student_form.is_low_income.errors %}<p class="error">{{ student_form.is_low_income.errors.0 }}</p>{% endif %}
        <p class="hint">Used for program prioritization; does not affect growth calculations.</p>
      </div>
    </div>
  </fieldset> {% endcomment %}

      <!--SECTION A -->
      <fieldset>
        <legend data-i18n="legend.section_a">Section A: Particulars</legend>


        <div class="grid">
          <div class="field">
            <label for="{{ screening_form.student_name.id_for_label }}" data-i18n="field.student_name.label">{{ screening_form.student_name.label }}</label>

            {{ screening_form.student_name }}
            {% if screening_form.student_name.errors %}<div class="errors">{{ screening_form.student_name.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ screening_form.unique_student_id.id_for_label }}" data-i18n="field.unique_student_id.label">{{ screening_form.unique_student_id.label }}</label>

            {{ screening_form.unique_student_id }}
            {% if screening_form.unique_student_id.errors %}<div class="errors">{{ screening_form.unique_student_id.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ screening_form.dob.id_for_label }}" data-i18n="field.dob.label">{{ screening_form.dob.label }}</label>

            {{ screening_form.dob }}
            {% if screening_form.dob.errors %}<div class="errors">{{ screening_form.dob.errors }}</div>{% endif %}
            <div id="age-display" class="muted" style="margin-top: 4px;"></div>
          </div>

          <div class="field">
            <label for="{{ screening_form.sex.id_for_label }}" data-i18n="field.sex.label">{{ screening_form.sex.label }}</label>

            {{ screening_form.sex }}
            {% if screening_form.sex.errors %}<div class="errors">{{ screening_form.sex.errors }}</div>{% endif %}
            <div id="sex-disabled-hint" class="muted" style="display:none; margin-top:4px;" data-i18n="hint.select_dob_first">
              Select Date of Birth first to enable this field.
            </div>


          </div>

          <div class="field">
            <label for="{{ screening_form.parent_phone_e164.id_for_label }}" data-i18n="field.parent_phone_e164.label">{{ screening_form.parent_phone_e164.label }}</label>

            {{ screening_form.parent_phone_e164 }}
            {% if screening_form.parent_phone_e164.errors %}<div class="errors">{{ screening_form.parent_phone_e164.errors }}</div>{% endif %}
          </div>

          <div class="field radio">
            <label data-i18n="field.is_low_income.label">{{ student_form.is_low_income.label }}</label>
            {{ student_form.is_low_income }}
            {% if student_form.is_low_income.errors %}
              <div class="errors">{{ student_form.is_low_income.errors }}</div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- SECTION B -->
      <fieldset>
        <legend data-i18n="legend.section_b">Section B: Anthropometry</legend>


        <div class="grid">
          <div class="field">
            <label for="{{ screening_form.weight_kg_r1.id_for_label }}" data-i18n="field.weight_kg_r1.label">{{ screening_form.weight_kg_r1.label }}</label>

            {{ screening_form.weight_kg_r1 }}
            {% if screening_form.weight_kg_r1.errors %}<div class="errors">{{ screening_form.weight_kg_r1.errors }}</div>{% endif %}
          </div>
          <div class="field">
            <label for="{{ screening_form.height_cm_r1.id_for_label }}" data-i18n="field.height_cm_r1.label">{{ screening_form.height_cm_r1.label }}</label>

            {{ screening_form.height_cm_r1 }}
            {% if screening_form.height_cm_r1.errors %}<div class="errors">{{ screening_form.height_cm_r1.errors }}</div>{% endif %}
          </div>

          <div class="field radio" id="muac-field">
            <label for="{{ screening_form.muac_tape_color.id_for_label }}" data-i18n="field.muac_tape_color.label">{{ screening_form.muac_tape_color.label }}</label>

            {{ screening_form.muac_tape_color }}
            {% if screening_form.muac_tape_color.errors %}<div class="errors">{{ screening_form.muac_tape_color.errors }}</div>{% endif %}
          </div>
          
          
        </div>
      </fieldset>


      <!-- SECTION C -->
      <fieldset>
        <legend data-i18n="legend.section_c">Section C: Quick Health Red Flags</legend>



      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_general_poor.id_for_label }}" data-i18n="field.health_general_poor.label">{{ screening_form.health_general_poor.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_general_poor">Ask the child- Do you feel healthy?</div>


        <div style="display:none;">
          {{ screening_form.health_general_poor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_general_poor.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_general_poor.errors %}<div class="errors">{{ screening_form.health_general_poor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_pallor.id_for_label }}" data-i18n="field.health_pallor.label">{{ screening_form.health_pallor.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_pallor">Ask the child- Does the child have pallor?</div>

        <div style="display:none;">
          {{ screening_form.health_pallor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_pallor.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_pallor.errors %}<div class="errors">{{ screening_form.health_pallor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_fatigue_dizzy_faint.id_for_label }}" data-i18n="field.health_fatigue_dizzy_faint.label">{{ screening_form.health_fatigue_dizzy_faint.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_fatigue_dizzy_faint">Ask the child- If they remember having fainted while doing normal work/play, or if the child feels very too tired to do routine work/play?</div>

        <div style="display:none;">
          {{ screening_form.health_fatigue_dizzy_faint }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_fatigue_dizzy_faint.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_fatigue_dizzy_faint.errors %}<div class="errors">{{ screening_form.health_fatigue_dizzy_faint.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_breathlessness.id_for_label }}" data-i18n="field.health_breathlessness.label">{{ screening_form.health_breathlessness.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_breathlessness">Ask the child- If they feel breathless on doing routine activities or while walking normally?</div>

        <div style="display:none;">
          {{ screening_form.health_breathlessness }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_breathlessness.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_breathlessness.errors %}<div class="errors">{{ screening_form.health_breathlessness.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_frequent_infections.id_for_label }}" data-i18n="field.health_frequent_infections.label">{{ screening_form.health_frequent_infections.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_frequent_infections">Ask the child- Does the child fall sick very often? Has been ill 3 times or more in the last month?</div>

        <div style="display:none;">
          {{ screening_form.health_frequent_infections }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_frequent_infections.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_frequent_infections.errors %}<div class="errors">{{ screening_form.health_frequent_infections.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_chronic_cough_or_diarrhea.id_for_label }}" data-i18n="field.health_chronic_cough_or_diarrhea.label">{{ screening_form.health_chronic_cough_or_diarrhea.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_chronic_cough_or_diarrhea">Ask the child- Does the child have cough and has had it for last 4 weeks or more, or does the child have loose motions and it has lasted more than 2 weeks?</div>

        <div style="display:none;">
          {{ screening_form.health_chronic_cough_or_diarrhea }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_chronic_cough_or_diarrhea.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_chronic_cough_or_diarrhea.errors %}<div class="errors">{{ screening_form.health_chronic_cough_or_diarrhea.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_visible_worms.id_for_label }}" data-i18n="field.health_visible_worms.label">{{ screening_form.health_visible_worms.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_visible_worms">Ask the child- If they have ever seen small worms in their stool.</div>

        <div style="display:none;">
          {{ screening_form.health_visible_worms }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_visible_worms.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_visible_worms.errors %}<div class="errors">{{ screening_form.health_visible_worms.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_dental_or_gum_or_ulcers.id_for_label }}" data-i18n="field.health_dental_or_gum_or_ulcers.label">{{ screening_form.health_dental_or_gum_or_ulcers.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_dental_or_gum_or_ulcers">Ask the child- If they have teeth pain, gum bleeding or mouth ulcers?</div>

        <div style="display:none;">
          {{ screening_form.health_dental_or_gum_or_ulcers }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_dental_or_gum_or_ulcers.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_dental_or_gum_or_ulcers.errors %}<div class="errors">{{ screening_form.health_dental_or_gum_or_ulcers.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_night_vision_difficulty.id_for_label }}" data-i18n="field.health_night_vision_difficulty.label">{{ screening_form.health_night_vision_difficulty.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_night_vision_difficulty">Ask the child- If they stumble while walking in the dark since they can't see properly</div>

        <div style="display:none;">
          {{ screening_form.health_night_vision_difficulty }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_night_vision_difficulty.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_night_vision_difficulty.errors %}<div class="errors">{{ screening_form.health_night_vision_difficulty.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.health_bone_or_joint_pain.id_for_label }}" data-i18n="field.health_bone_or_joint_pain.label">{{ screening_form.health_bone_or_joint_pain.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_bone_or_joint_pain">Ask the child- If they have pain in their arms/legs/joints, although they haven't been hurt and even without hard work/play?</div>

        <div style="display:none;">
          {{ screening_form.health_bone_or_joint_pain }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ screening_form.health_bone_or_joint_pain.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if screening_form.health_bone_or_joint_pain.errors %}<div class="errors">{{ screening_form.health_bone_or_joint_pain.errors }}</div>{% endif %}
      </div>


      <div class="field radio" style="margin-top: 12px;">
        <label for="{{ screening_form.appetite.id_for_label }}" data-i18n="field.appetite.label">{{ screening_form.appetite.label }}</label>
        {{ screening_form.appetite }}
        {% if screening_form.appetite.errors %}<div class="errors">{{ screening_form.appetite.errors }}</div>{% endif %}
      </div>


      <fieldset id="girls-only-section" style="margin-top: 12px;">
        <legend data-i18n="legend.girls_only">Girls only</legend>


        <div class="qrow" style="margin-top: 10px;">
          <div class="qtitle">
            <label for="{{ screening_form.menarche_started.id_for_label }}" data-i18n="field.menarche_started.label">{{ screening_form.menarche_started.label }}</label>
          </div>
          <div class="ask-child" data-i18n="ask.menarche_started">Ask the child- If her menstruation has started.</div>

          <div style="display:none;">
            {{ screening_form.menarche_started }}
          </div>

          <select class="yn-proxy" data-checkbox-id="{{ screening_form.menarche_started.id_for_label }}">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>

          {% if screening_form.menarche_started.errors %}<div class="errors">{{ screening_form.menarche_started.errors }}</div>{% endif %}
        </div>

        <div id="girls-menarche-details" style="margin-top: 8px;">
          <div class="qrow">
            <div class="qtitle">
              <label for="{{ screening_form.menarche_age_years.id_for_label }}" data-i18n="field.menarche_age_years.label">{{ screening_form.menarche_age_years.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.menarche_age_years">Ask the child- Menstruation started at what age?</div>
            {{ screening_form.menarche_age_years }}
            {% if screening_form.menarche_age_years.errors %}<div class="errors">{{ screening_form.menarche_age_years.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ screening_form.pads_per_day.id_for_label }}" data-i18n="field.pads_per_day.label">{{ screening_form.pads_per_day.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.pads_per_day">Ask the child- How many pads per day does she need on heavy bleeding days?</div>
            {{ screening_form.pads_per_day }}
            {% if screening_form.pads_per_day.errors %}<div class="errors">{{ screening_form.pads_per_day.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ screening_form.cycle_length_days.id_for_label }}" data-i18n="field.cycle_length_days.label">{{ screening_form.cycle_length_days.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.cycle_length_days">Ask the child- After how many days do your menses happen again?</div>
            {{ screening_form.cycle_length_days }}
            {% if screening_form.cycle_length_days.errors %}<div class="errors">{{ screening_form.cycle_length_days.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ screening_form.bleeding_clots.id_for_label }}" data-i18n="field.bleeding_clots.label">{{ screening_form.bleeding_clots.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.bleeding_clots">Ask the child- Does the child pass clots while bleeding?</div>

            <div style="display:none;">
              {{ screening_form.bleeding_clots }}
            </div>

            <select class="yn-proxy" data-checkbox-id="{{ screening_form.bleeding_clots.id_for_label }}">
              <option value="">Select</option>
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>

            {% if screening_form.bleeding_clots.errors %}<div class="errors">{{ screening_form.bleeding_clots.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>
      </fieldset>

<!-- SECTION D -->
      <fieldset>
        <legend data-i18n="legend.section_d">Section D: Diet Type & Diversity</legend>



      <div class="field radio">
        <label for="{{ screening_form.diet_type.id_for_label }}" data-i18n="field.diet_type.label">{{ screening_form.diet_type.label }}</label>

        <div class="qrow" style="margin-top: 8px;">
          {% for radio in screening_form.diet_type %}
            <div style="margin: 10px 0;">
              <div style="display:flex; gap:10px; align-items:center;">
                {{ radio.tag }}
                <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>

              {% if radio.data.value == "LACTO_VEG" %}
                <div class="ask-child" data-i18n="ask.diet_type.LACTO_VEG">Ask the child- Do you drink milk or eat dahi or paneer at home?</div>
              {% elif radio.data.value == "LACTO_OVO" %}
                <div class="ask-child" data-i18n="ask.diet_type.LACTO_OVO">Ask the child- Do you eat eggs at home?</div>
              {% elif radio.data.value == "NON_VEG" %}
                <div class="ask-child" data-i18n="ask.diet_type.NON_VEG">Ask the child- Do you eat fish, chicken or mutton at home?</div>
              {% endif %}

            </div>
          {% endfor %}
        </div>

        {% if screening_form.diet_type.errors %}<div class="errors">{{ screening_form.diet_type.errors }}</div>{% endif %}
      </div>

        <p class="section-hint" style="margin-top: 12px; font-weight: 700; color: #111;" data-i18n="hint.diet_24h">
          Did the student have the following in last 24 hours?
        </p>



      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.breakfast_eaten.id_for_label }}" data-i18n="field.breakfast_eaten.label">{{ screening_form.breakfast_eaten.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.breakfast_eaten">Ask the child- Did you eat Breakfast?</div>
        {{ screening_form.breakfast_eaten }}
        {% if screening_form.breakfast_eaten.errors %}<div class="errors">{{ screening_form.breakfast_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.lunch_eaten.id_for_label }}" data-i18n="field.lunch_eaten.label">{{ screening_form.lunch_eaten.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.lunch_eaten">Ask the child- Did you eat Lunch?</div>
        {{ screening_form.lunch_eaten }}
        {% if screening_form.lunch_eaten.errors %}<div class="errors">{{ screening_form.lunch_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.green_leafy_veg.id_for_label }}" data-i18n="field.green_leafy_veg.label">{{ screening_form.green_leafy_veg.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.green_leafy_veg">Ask the child- Did you eat green leafy vegetables in your last meal?</div>
        {{ screening_form.green_leafy_veg }}
        {% if screening_form.green_leafy_veg.errors %}<div class="errors">{{ screening_form.green_leafy_veg.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.other_vegetables.id_for_label }}" data-i18n="field.other_vegetables.label">{{ screening_form.other_vegetables.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.other_vegetables">Ask the child- Did you eat any other vegetable in your last meal?</div>
        {{ screening_form.other_vegetables }}
        {% if screening_form.other_vegetables.errors %}<div class="errors">{{ screening_form.other_vegetables.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.fruits.id_for_label }}" data-i18n="field.fruits.label">{{ screening_form.fruits.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.fruits">Ask the child- Did you eat fruits yesterday?</div>
        {{ screening_form.fruits }}
        {% if screening_form.fruits.errors %}<div class="errors">{{ screening_form.fruits.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.dal_pulses_beans.id_for_label }}" data-i18n="field.dal_pulses_beans.label">{{ screening_form.dal_pulses_beans.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.dal_pulses_beans">Ask the child- Did you eat Dal / Pulses / Beans yesterday?</div>
        {{ screening_form.dal_pulses_beans }}
        {% if screening_form.dal_pulses_beans.errors %}<div class="errors">{{ screening_form.dal_pulses_beans.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.milk_curd.id_for_label }}" data-i18n="field.milk_curd.label">{{ screening_form.milk_curd.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.milk_curd">Ask the child- Did you drink milk or eat curd yesterday?</div>
        {{ screening_form.milk_curd }}
        {% if screening_form.milk_curd.errors %}<div class="errors">{{ screening_form.milk_curd.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-egg-field">
        <div class="qtitle">
          <label for="{{ screening_form.egg.id_for_label }}" data-i18n="field.egg.label">{{ screening_form.egg.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.egg">Ask the child- Did you eat egg yesterday?</div>
        {{ screening_form.egg }}
        {% if screening_form.egg.errors %}<div class="errors">{{ screening_form.egg.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-meat-field">
        <div class="qtitle">
          <label for="{{ screening_form.fish_chicken_meat.id_for_label }}" data-i18n="field.fish_chicken_meat.label">{{ screening_form.fish_chicken_meat.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.fish_chicken_meat">Ask the child- Did you eat Fish / Chicken / Meat in the the last 3 days?</div>
        {{ screening_form.fish_chicken_meat }}
        {% if screening_form.fish_chicken_meat.errors %}<div class="errors">{{ screening_form.fish_chicken_meat.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.nuts_groundnuts.id_for_label }}" data-i18n="field.nuts_groundnuts.label">{{ screening_form.nuts_groundnuts.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.nuts_groundnuts">Ask the child- Did you eat Nuts / Groundnuts yesterday?</div>
        {{ screening_form.nuts_groundnuts }}
        {% if screening_form.nuts_groundnuts.errors %}<div class="errors">{{ screening_form.nuts_groundnuts.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ screening_form.ssb_or_packaged_snacks.id_for_label }}" data-i18n="field.ssb_or_packaged_snacks.label">{{ screening_form.ssb_or_packaged_snacks.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.ssb_or_packaged_snacks">Ask the child- Do you drink soft drinks like coca cola, pepsi, mirinda, fanta, limca etc.? Do you drink fruit juice that is not made at home? Do you eat snacks like biscuits, chocolates, chips, cakes etc.?</div>
        {{ screening_form.ssb_or_packaged_snacks }}
        {% if screening_form.ssb_or_packaged_snacks.errors %}<div class="errors">{{ screening_form.ssb_or_packaged_snacks.errors }}</div>{% endif %}
      </div>
      </fieldset>

<!-- SECTION E -->
      <fieldset>
        <legend data-i18n="legend.section_e">Section E: Program Enablers</legend>



        <div class="grid">
          <div class="field radio">
            <label for="{{ screening_form.deworming_taken.id_for_label }}" data-i18n="field.deworming_taken.label">{{ screening_form.deworming_taken.label }}</label>
            <div class="ask-child" data-i18n="ask.deworming_taken">Ask the child- Did you take the big pill for deworming?</div>
            {{ screening_form.deworming_taken }}
            
            {% if screening_form.deworming_taken.errors %}<div class="errors">{{ screening_form.deworming_taken.errors }}</div>{% endif %}
          </div>
          <div class="field" id="deworming-months-field">
            <label for="{{ screening_form.deworming_date.id_for_label }}" data-i18n="field.deworming_date.label">{{ screening_form.deworming_date.label }}</label>
            {{ screening_form.deworming_date }}
            {% if screening_form.deworming_date.errors %}<div class="errors">{{ screening_form.deworming_date.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

<!-- SECTION F -->
      <fieldset>
        <legend data-i18n="legend.section_f">Section F: Food Security</legend>


        <div class="field radio">
          <label for="{{ screening_form.hunger_vital_sign.id_for_label }}" data-i18n="field.hunger_vital_sign.label">{{ screening_form.hunger_vital_sign.label }}</label>
          {{ screening_form.hunger_vital_sign }}
          {% if screening_form.hunger_vital_sign.errors %}<div class="errors">{{ screening_form.hunger_vital_sign.errors }}</div>{% endif %}
        </div>
      </fieldset>

      <div class="actions">
        <button class="primary" type="submit" data-i18n="button.create_student_complete_screening">Create Student & Complete Screening</button>
        <a class="button" href="{% url 'teacher_portal' %}" data-i18n="button.cancel">Cancel</a>

      </div>
    </form>
  </div>

  <script>
    const divisionsByGrade = {{ divisions_by_grade|safe }};
    var $grade = document.getElementById("id_grade");
    var $division = document.getElementById("id_division");

    function isSelect(el) {
      return el && el.tagName && el.tagName.toUpperCase() === "SELECT";
    }

    function syncDivision() {
      if (!isSelect($grade) || !isSelect($division)) return;

      var grade = $grade.value || "";
      var divisions = divisionsByGrade[grade] || [];

      $division.innerHTML = "";
      var placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select division";
      $division.appendChild(placeholder);

      divisions.forEach(function(d) {
        var opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        $division.appendChild(opt);
      });
    }

    if (isSelect($grade) && isSelect($division)) {
      $grade.addEventListener("change", syncDivision);
      syncDivision();
    }
  </script>
  <script>
    (function () {
      'use strict';
    
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
    
      // ---------- Age calculation helpers ----------
      function parseISODateToLocal(iso) {
        // Expect yyyy-mm-dd (from <input type="date">)
        if (!iso) return null;
        var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso));
        if (!m) return null;
        var y = Number(m[1]);
        var mo = Number(m[2]) - 1;
        var d = Number(m[3]);
        var dt = new Date(y, mo, d);
        if (isNaN(dt.getTime())) return null;
        // Validate round-trip (guards invalid dates like 2024-02-31)
        if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
        return dt;
      }
    
      function computeAgeMonths(dob, today) {
        if (!dob || !today) return null;
        var months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
        if (today.getDate() < dob.getDate()) months -= 1; // not completed the month yet
        if (months < 0) return null;
        return months;
      }
    
      function formatAge(months) {
        if (window.NUTRILIFT_I18N && typeof window.NUTRILIFT_I18N.formatAge === "function") {
          return window.NUTRILIFT_I18N.formatAge(months);
        }
        // fallback
        var y = Math.floor(months / 12);
        var m = months % 12;
        var yLabel = (y === 1) ? 'year' : 'years';
        var mLabel = (m === 1) ? 'month' : 'months';
        return y + ' ' + yLabel + ' ' + m + ' ' + mLabel;
      }

    
      // ---------- Generic helpers ----------
      function clearInputs(root) {
        if (!root) return;
        qsa('input, select, textarea', root).forEach(function (el) {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
          } else {
            el.value = '';
          }
        });
      }
    
      function getCheckedValue(name) {
        var el = qs('input[name="' + name + '"]:checked');
        return el ? el.value : '';
      }
    
      function setRadioChecked(name, value) {
        var el = qs('input[name="' + name + '"][value="' + value + '"]');
        if (el) el.checked = true;
      }
    
      function setSelectValueByName(name, value) {
        var el = qs('select[name="' + name + '"]');
        if (el) el.value = value;
      }
    
      // ---------- DOM refs (shared by both templates) ----------
      var dobEl = qs('[name="dob"]');
      var ageDisplayEl = document.getElementById('age-display');
    
      var sexEl = qs('[name="sex"]');
      var sexHintEl = document.getElementById('sex-disabled-hint');
    
      var muacWrapper = document.getElementById('muac-field');
      var girlsSection = document.getElementById('girls-only-section');
      var menarcheDetails = document.getElementById('girls-menarche-details');
      var menarcheStartedEl = qs('[name="menarche_started"]');
    
      var dewormingMonthsWrapper = document.getElementById('deworming-months-field');
    
      var eggField = document.getElementById('diet-egg-field');
      var meatField = document.getElementById('diet-meat-field');
    
      // ---------- Sync functions ----------
      function syncAgeAndSexLock() {
        var today = new Date();
        var dob = dobEl ? parseISODateToLocal(dobEl.value) : null;
        var ageMonths = dob ? computeAgeMonths(dob, today) : null;
    
        // Age display (below DOB)
        if (ageDisplayEl) {
          ageDisplayEl.textContent = (typeof ageMonths === 'number') ? formatAge(ageMonths) : '';
        }
    
        // Enforce: DOB required before Sex
        if (sexEl) {
          var enableSex = (typeof ageMonths === 'number');
          sexEl.disabled = !enableSex;
    
          if (!enableSex) {
            sexEl.value = '';
          }
    
          if (sexHintEl) {
            sexHintEl.style.display = enableSex ? 'none' : '';
          }
        }
    
        return ageMonths;
      }
    
      function syncMuacVisibility(ageMonths) {
        if (!muacWrapper) return;
    
        // Only hide MUAC for age >= 5 years (>= 60 months)
        var hide = (typeof ageMonths === 'number') && (ageMonths >= 60);
    
        muacWrapper.style.display = hide ? 'none' : '';
    
        if (hide) {
          // Auto-select GREEN so no red/yellow flags occur
          // Support either radio or select (in case rendering changes)
          setRadioChecked('muac_tape_color', 'GREEN');
          setSelectValueByName('muac_tape_color', 'GREEN');
        }
      }
    
      function syncGirlsVisibility(ageMonths) {
        if (!girlsSection) return;
    
        var sex = sexEl ? String(sexEl.value || '').toUpperCase() : '';
        var isGirl = (sex === 'F' || sex === 'FEMALE');
        var is10Plus = (typeof ageMonths === 'number') && (ageMonths >= 120);
    
        var showGirls = isGirl && is10Plus;
    
        girlsSection.style.display = showGirls ? '' : 'none';
    
        if (!showGirls) {
          clearInputs(girlsSection);
          // also hide details wrapper if present
          if (menarcheDetails) menarcheDetails.style.display = 'none';
        }
      }
    
      function syncMenarcheDetailsVisibility() {
        if (!girlsSection || !menarcheDetails) return;
    
        // If girls section is hidden, keep details hidden and cleared.
        if (girlsSection.style.display === 'none') {
          menarcheDetails.style.display = 'none';
          clearInputs(menarcheDetails);
          return;
        }
    
        var started = !!(menarcheStartedEl && menarcheStartedEl.checked);
        menarcheDetails.style.display = started ? '' : 'none';
    
        if (!started) {
          clearInputs(menarcheDetails);
        }
      }
    
      function syncDewormingMonthsVisibility() {
        if (!dewormingMonthsWrapper) return;
    
        var v = getCheckedValue('deworming_taken'); // 'yes' | 'no' | 'dont_know'
        var show = (String(v || '').toLowerCase() === 'yes');
    
        dewormingMonthsWrapper.style.display = show ? '' : 'none';
    
        if (!show) {
          // clear follow-up field when hidden
          clearInputs(dewormingMonthsWrapper);
          // If wrapper contains only the months select, this is enough.
          // If needed, also explicitly clear by name:
          setSelectValueByName('deworming_date', '');
        }
      }
    
      function forceNoAnswer(fieldWrapper, fieldName) {
        if (!fieldWrapper) return;
    
        // New behavior: Yes/No may be a <select>
        var sel = fieldWrapper.querySelector('select[name="' + fieldName + '"]');
        if (sel) {
          sel.value = 'no';
          return;
        }
    
        // Old behavior: Yes/No as radios
        var no = fieldWrapper.querySelector('input[name="' + fieldName + '"][value="no"]');
        if (no) no.checked = true;
      }
    
      function syncDietVisibility() {
        var dietTypeRadios = qsa('input[name="diet_type"]');
        if (!dietTypeRadios.length) return;
    
        var checked = qs('input[name="diet_type"]:checked');
        var dietType = String(checked ? checked.value : '').toUpperCase();
    
        var knownTypes = { 'LACTO_VEG': true, 'LACTO_OVO': true, 'NON_VEG': true };
    
        // Keep default UI unchanged until diet type is chosen.
        var showEgg = !knownTypes[dietType] || dietType === 'LACTO_OVO' || dietType === 'NON_VEG';
        var showMeat = !knownTypes[dietType] || dietType === 'NON_VEG';
    
        if (eggField) {
          eggField.style.display = showEgg ? '' : 'none';
          if (!showEgg) forceNoAnswer(eggField, 'egg');
        }
    
        if (meatField) {
          meatField.style.display = showMeat ? '' : 'none';
          if (!showMeat) forceNoAnswer(meatField, 'fish_chicken_meat');
        }
      }
    
      function syncAll() {
        var ageMonths = syncAgeAndSexLock();
        syncMuacVisibility(ageMonths);
        syncGirlsVisibility(ageMonths);
        syncMenarcheDetailsVisibility();
        syncDewormingMonthsVisibility();
        syncDietVisibility();
      }
    
      // ---------- Wire events ----------
      if (dobEl) dobEl.addEventListener('change', syncAll);
      if (sexEl) sexEl.addEventListener('change', syncAll);
    
      // Menarche checkbox toggles details
      if (menarcheStartedEl) menarcheStartedEl.addEventListener('change', syncMenarcheDetailsVisibility);
    
      // Deworming radios toggle months
      qsa('input[name="deworming_taken"]').forEach(function (el) {
        el.addEventListener('change', syncDewormingMonthsVisibility);
      });
    
      // Diet type radios toggle egg/meat fields
      qsa('input[name="diet_type"]').forEach(function (el) {
        el.addEventListener('change', syncDietVisibility);
      });
    
      // Initial state
      syncAll();
    })();
    </script>
    
  

  <script>
    (function () {
      'use strict';

      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

      function setSelectFromCheckbox(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;
        // Only sync if checkbox is checked
        if (cb.checked) {
          sel.value = 'yes';
        } else if (sel.value === '') {
          // keep placeholder if nothing chosen
          return;
        } else {
          sel.value = 'no';
        }

      }

      function setCheckboxFromSelect(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;

        cb.checked = (String(sel.value).toLowerCase() === 'yes');

        // Trigger change so existing scripts (e.g. menarche details) react.
        try { cb.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
      }

      function syncYesNoProxies() {
        var sels = qsa('select.yn-proxy[data-checkbox-id]');
        sels.forEach(function (sel) {
          setSelectFromCheckbox(sel);
          sel.addEventListener('change', function () { setCheckboxFromSelect(sel); });
        });
      }

      syncYesNoProxies();
    })();
  </script>

  <script>
    (function () {
      "use strict";
    
      // Keep this list in the order you want it to appear in WhatsApp.
      // These names match the Django form field names.
      var QA_FIELDS = [
        "weight_kg_r1",
        "height_cm_r1",
        "muac_tape_color",
    
        "health_general_poor",
        "health_pallor",
        "health_fatigue_dizzy_faint",
        "health_breathlessness",
        "health_frequent_infections",
        "health_chronic_cough_or_diarrhea",
        "health_visible_worms",
        "health_dental_or_gum_or_ulcers",
        "health_night_vision_difficulty",
        "health_bone_or_joint_pain",
    
        "appetite",
    
        // Adolescent girls section (will be skipped automatically if hidden/empty)
        "menarche_started",
        "menarche_age_years",
        "pads_per_day",
        "bleeding_clots",
        "cycle_length_days",
    
        // Diet section
        "diet_type",
        "breakfast_eaten",
        "lunch_eaten",
        "green_leafy_veg",
        "other_vegetables",
        "fruits",
        "dal_pulses_beans",
        "milk_curd",
        "egg",
        "fish_chicken_meat",
        "nuts_groundnuts",
        "ssb_or_packaged_snacks",
    
        // Deworming + hunger vital sign
        "deworming_taken",
        "deworming_date",
        "hunger_vital_sign"
      ];
    
      function isVisible(el) {
        if (!el) return false;
        // offsetParent = null for display:none; getClientRects catches some edge cases
        return !!(el.offsetParent || el.getClientRects().length);
      }
    
      function labelTextFor(name) {
        // Preferred: labels in these templates have data-i18n="field.<name>.label"
        var lbl = document.querySelector('[data-i18n="field.' + name + '.label"]');
        if (lbl) return (lbl.textContent || "").trim();
    
        // Fallback: label[for=id]
        var el = document.querySelector('[name="' + name + '"]');
        if (el && el.id) {
          lbl = document.querySelector('label[for="' + el.id + '"]');
          if (lbl) return (lbl.textContent || "").trim();
        }
        return name;
      }
    
      function dispatchChange(el) {
        if (!el) return;
        var evt;
        if (typeof Event === "function") {
          evt = new Event("change", { bubbles: true });
        } else {
          evt = document.createEvent("Event");
          evt.initEvent("change", true, true);
        }
        el.dispatchEvent(evt);
      }
    
      function radioAnswer(name) {
        var checked = document.querySelector('input[name="' + name + '"][type="radio"]:checked');
        if (!checked) return "";
        if (!isVisible(checked)) return "";
    
        var lbl = checked.closest ? checked.closest("label") : null;
        if (!lbl && checked.id) lbl = document.querySelector('label[for="' + checked.id + '"]');
    
        var txt = lbl ? (lbl.textContent || "") : (checked.value || "");
        return txt.replace(/\s+/g, " ").trim();
      }
    
      function selectAnswer(sel) {
        if (!sel || !isVisible(sel)) return "";
        if (!sel.value) return "";
        var opt = sel.options[sel.selectedIndex];
        return opt ? (opt.textContent || "").trim() : "";
      }
    
      function inputAnswer(inp) {
        if (!inp || !isVisible(inp)) return "";
        return (inp.value || "").trim();
      }
    
      function checkboxProxyAnswer(cb) {
        // These templates use proxy selects for many checkboxes (health + some girls fields)
        var proxy = cb && cb.id ? document.querySelector('select.yn-proxy[data-checkbox-id="' + cb.id + '"]') : null;
        if (!proxy || !isVisible(proxy)) return "";
    
        // If proxy is still on placeholder (value=""), fall back to checkbox state
        if (!proxy.value) {
          var optFallback = proxy.querySelector('option[value="' + (cb.checked ? "yes" : "no") + '"]');
          return optFallback ? (optFallback.textContent || "").trim() : "";
        }
    
        var opt = proxy.options[proxy.selectedIndex];
        return opt ? (opt.textContent || "").trim() : "";
      }
    
      function answerForField(name) {
        // 1) Proxy checkbox fields
        var cb = document.querySelector('input[name="' + name + '"][type="checkbox"]');
        if (cb) {
          var proxyTxt = checkboxProxyAnswer(cb);
          if (proxyTxt) return proxyTxt;
    
          // If it’s a real visible checkbox (rare here), return Yes/No in English as fallback
          // (in practice, your checkbox fields here should have proxies)
          if (isVisible(cb)) return cb.checked ? "Yes" : "No";
          return "";
        }
    
        // 2) Radio groups
        var anyRadio = document.querySelector('input[name="' + name + '"][type="radio"]');
        if (anyRadio) return radioAnswer(name);
    
        // 3) Selects
        var sel = document.querySelector('select[name="' + name + '"]');
        if (sel) return selectAnswer(sel);
    
        // 4) Inputs/textareas
        var inp = document.querySelector('input[name="' + name + '"]');
        if (inp) return inputAnswer(inp);
    
        var ta = document.querySelector('textarea[name="' + name + '"]');
        if (ta) return inputAnswer(ta);
    
        return "";
      }
    
      function buildQuestionsAndAnswers() {
        var lines = [];
        for (var i = 0; i < QA_FIELDS.length; i++) {
          var name = QA_FIELDS[i];
    
          var answer = answerForField(name);
          if (!answer) continue;
    
          var q = labelTextFor(name);
          if (!q) continue;
    
          lines.push("- " + q + ": " + answer);
        }
        return lines.join("\n");
      }
    
      document.addEventListener("DOMContentLoaded", function () {
        // If the teacher dashboard opens the form with ?lang=xx, honor it.
        try {
          var params = new URLSearchParams(window.location.search);
          var qLang = (params.get("lang") || "").toLowerCase();
          if (qLang) {
            var selLang = document.getElementById("language-select");
            if (selLang && selLang.value !== qLang) {
              selLang.value = qLang;
              dispatchChange(selLang); // triggers your existing i18n handler
            }
          }
        } catch (e) {}
        
        var formEl = document.querySelector("form");
        if (!formEl) return;
    
        formEl.addEventListener("submit", function () {
          // Validate Section C yes/no selects
          var invalid = false;

          document.querySelectorAll('.qrow select.yn-proxy').forEach(function(sel){
            if (sel.hasAttribute('required') && !sel.value) {
              invalid = true;
              sel.style.borderColor = '#b00020';
            } else {
              sel.style.borderColor = '';
            }
          });

          if (invalid) {
            e.preventDefault();
            alert("Please answer all health questions in Section C.");
            return;
          }
          var sel = document.getElementById("language-select");
          var lang = (sel && sel.value) ? sel.value :
                     ((window.localStorage && window.localStorage.getItem("nutrilift_lang")) || "mr");
    
          var langInput = document.getElementById("form-language-input");
          if (langInput) langInput.value = lang;
    
          var qaInput = document.getElementById("wa-qa-input");
          if (qaInput) qaInput.value = buildQuestionsAndAnswers();
        });
      });
    })();
    </script>
    
</body>
</html>

================================================================================
FILE: templates\screening\screening_form.html
================================================================================

{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Screening – {{ student.full_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    /* backend/screening/static/screening/screening_i18n.js
   Client-side i18n for Screening forms.
   - Only changes displayed strings (labels/questions/options/titles).
   - Does NOT change field names, values, r handlers.
*/

(function () {
  "use strict";

  const STORAGE_KEY = "nutrilift_lang";
  const DEFAULT_LANG = "mr";
  const SUPPORTED = ["en", "mr", "hi", "te", "ta", "ml", "kn", "bn"];

  // ---- TRANSLATIONS (from your Screening-form-8-languages.xlsx + a few UI strings) ----
  // Keys match the data-i18n attributes added in templates.
  const I18N = {
    "en": {
      "option.grade.K.G.": "K.G.",
      "ui.language.label": "Language",
      "page.add_student.heading": "Add student & complete screening",
      "page.add_student.browser_title": "Add student & complete screening",
      "page.screening.heading_prefix": "Screening",
      "page.screening.browser_title_prefix": "Screening",
      "button.create_student_complete_screening": "Create Student & Complete Screening",
      "button.complete_screening": "Complete Screening",
      "button.cancel": "Cancel",
      "hint.select_dob_first": "Select Date of Birth first to enable this field.",
      "field.grade.label": "Class",
      "field.division.label": "Section",
      "field.is_low_income.label": "Low income family",
      "field.deworming_date.label": "How many months ago?",
      "placeholder.select": "Select",
      "placeholder.select_grade": "Select Class",
      "placeholder.select_division": "Select section",
      "placeholder.select_sex": "Select sex",
      "placeholder.select_age": "Select age",
      "placeholder.select_months": "Select months",
      "age.year_singular": "year",
      "age.year_plural": "years",
      "age.month_singular": "month",
      "age.month_plural": "months",

      /* --- Spreadsheet driven keys (English sheet) --- */
      "legend.class_assignment": "School / Class / Section",
      "legend.section_a": "SECTION A: PARTICULARS",
      "legend.section_b": "SECTION B: ANTHROPOMETRY",
      "legend.section_c": "SECTION C: QUICK HEALTH RED FLAGS",
      "legend.girls_only": "Adolescent Girls (Age ≥10 only)",
      "legend.section_d": "SECTION D: USUAL DIET TYPE AND 24-HOUR DIETARY RECALL (Yesterday)",
      "legend.section_e": "SECTION E: PROGRAM ENABLERS",
      "legend.section_f": "SECTION F: FOOD SECURITY",
      "hint.diet_24h": "24-hour recall (Yesterday): Did the student eat the following yesterday?",

      "field.student_name.label": "Student Name",
      "field.unique_student_id.label": "Roll Number",
      "field.dob.label": "Date of Birth",
      "field.sex.label": "Sex",
      "field.parent_phone_e164.label": "Parent’s phone number (WhatsApp number preferred)",
      "field.weight_kg_r1.label": "1. Weight (kg)",
      "field.height_cm_r1.label": "2. Height (cm)",
      "field.muac_tape_color.label": "3. MUAC Tape Colour",

      "field.health_general_poor.label": "Overall health not good",
      "field.health_pallor.label": "Pallor (Pale appearance)",
      "field.health_fatigue_dizzy_faint.label": "Fatigue / dizziness / fainting",
      "field.health_breathlessness.label": "Breathlessness",
      "field.health_frequent_infections.label": "Frequent infections",
      "field.health_chronic_cough_or_diarrhea.label": "Chronic cough/diarrhea",
      "field.health_visible_worms.label": "Visible worms in stool",
      "field.health_dental_or_gum_or_ulcers.label": "Dental/gum issues or mouth ulcers",
      "field.health_night_vision_difficulty.label": "Difficulty seeing at night",
      "field.health_bone_or_joint_pain.label": "Bone/joint pain",
      "field.appetite.label": "Does the child have a good appetite?",
      "field.menarche_started.label": "Has menstruation started?",
      "field.menarche_age_years.label": "Age at first menstruation (years)",
      "field.pads_per_day.label": "Number of pads used per day on heavy bleeding days",
      "field.bleeding_clots.label": "Does she pass clots while bleeding?",
      "field.cycle_length_days.label": "Cycle length",
      "field.diet_type.label": "Usual Diet Type",
      "field.breakfast_eaten.label": "Breakfast",
      "field.lunch_eaten.label": "Lunch",
      "field.green_leafy_veg.label": "Green leafy vegetables",
      "field.other_vegetables.label": "Other vegetables",
      "field.fruits.label": "Fruits",
      "field.dal_pulses_beans.label": "Dal / pulses / beans",
      "field.milk_curd.label": "Milk / curd",
      "field.egg.label": "Egg",
      "field.fish_chicken_meat.label": "Fish / chicken / meat",
      "field.nuts_groundnuts.label": "Nuts / groundnuts",
      "field.ssb_or_packaged_snacks.label": "SSB or packaged snacks",
      "field.deworming_taken.label": "Have you taken deworming tablet?",
      "field.hunger_vital_sign.label": "Do you get enough food to eat at home?",

      "ask.health_general_poor": "Do you feel healthy?",
      "ask.health_pallor": "Do you have pale appearance?",
      "ask.health_fatigue_dizzy_faint": "Have you felt tired, dizzy or fainted?",
      "ask.health_breathlessness": "Have you felt breathlessness?",
      "ask.health_frequent_infections": "Do you fall sick often?",
      "ask.health_chronic_cough_or_diarrhea": "Do you have chronic cough or diarrhea?",
      "ask.health_visible_worms": "Have you seen worms in stool?",
      "ask.health_dental_or_gum_or_ulcers": "Do you have dental problems / bleeding gums / mouth ulcers?",
      "ask.health_night_vision_difficulty": "Do you have difficulty seeing at night?",
      "ask.health_bone_or_joint_pain": "Do you have bone or joint pains?",
      "ask.menarche_started": "Has your menstruation started?",
      "ask.menarche_age_years": "At what age did it start?",
      "ask.pads_per_day": "How many pads per day on heavy bleeding days?",
      "ask.bleeding_clots": "Do you pass clots while bleeding?",
      "ask.cycle_length_days": "After how many days do your menses happen again?",
      "ask.diet_type.LACTO_VEG": "Do you drink milk or eat dahi or paneer at home?",
      "ask.diet_type.LACTO_OVO": "Do you eat eggs at home?",
      "ask.diet_type.NON_VEG": "Do you eat Fish, Chicken or Meat at home?",
      "ask.breakfast_eaten": "Did you eat breakfast?",
      "ask.lunch_eaten": "Did you eat lunch?",
      "ask.green_leafy_veg": "Did you eat green leafy vegetables in your last meal?",
      "ask.other_vegetables": "Did you eat any other vegetable in your last meal?",
      "ask.fruits": "Did you eat fruits yesterday?",
      "ask.dal_pulses_beans": "Did you eat Dal / Pulses / Beans yesterday?",
      "ask.milk_curd": "Did you drink milk or eat curd yesterday?",
      "ask.egg": "Did you eat egg yesterday?",
      "ask.fish_chicken_meat": "Did you eat Fish / Chicken / Meat in the last 3 days?",
      "ask.nuts_groundnuts": "Did you eat Nuts / Groundnuts yesterday?",
      "ask.ssb_or_packaged_snacks": "Do you drink soft drinks/packaged juice or eat packaged snacks (biscuits/chips/chocolates/cakes)?",
      "ask.deworming_taken": "Did you take the big pill for deworming?",

      "option.sex.M": "Male",
      "option.sex.F": "Female",
      "option.muac_tape_color.RED": "Red",
      "option.muac_tape_color.YELLOW": "Yellow",
      "option.muac_tape_color.GREEN": "Green",
      "option.diet_type.LACTO_VEG": "Lacto-vegetarian",
      "option.diet_type.LACTO_OVO": "Lacto-ovo vegetarian",
      "option.diet_type.NON_VEG": "Non-vegetarian",
      "option.yes": "Yes",
      "option.no": "No",
      "option.dont_know": "Don't know",
      "option.hunger_vital_sign.OFTEN_TRUE": "Often true",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "Sometimes true",
      "option.hunger_vital_sign.NEVER_TRUE": "Never true",
      "option.cycle_length_days.LT_45": "Less than 45 days",
      "option.cycle_length_days.GT_45": "More than 45 days",

      "option.grade.Nursery": "Nursery",
      "option.grade.Other": "Other"
    },
    "mr":{
      "option.grade.K.G.": "K.G.",
      "age.month_plural": "महिने",
      "age.month_singular": "महिना",
      "age.year_plural": "वर्षे",
      "age.year_singular": "वर्ष",
      "ask.bleeding_clots": "रक्तस्रावात गुठळ्या (क्लॉट्स) येतात का?",
      "ask.breakfast_eaten": "विद्यार्थ्याला विचारा: नाश्ता केला का?",
      "ask.cycle_length_days": "पाळी पुन्हा येण्यासाठी साधारण किती दिवसांनी येते?",
      "ask.dal_pulses_beans": "काल डाळ/कडधान्य/बीन्स खाल्ले का?",
      "ask.deworming_taken": "कृमिनाशकासाठी मोठी गोळी घेतली का?",
      "ask.diet_type.LACTO_OVO": "घरी अंडं खातात का?",
      "ask.diet_type.LACTO_VEG": "घरी दूध/दही/पनीर खातात का?",
      "ask.diet_type.NON_VEG": "घरी मासे/चिकन/मटण खातात का?",
      "ask.egg": "काल अंडं खाल्लं का?",
      "ask.fish_chicken_meat": "मागच्या 3 दिवसांत मासे/चिकन/मांस खाल्लं का?",
      "ask.fruits": "काल फळं खाल्ली का?",
      "ask.green_leafy_veg": "शेवटच्या जेवणात पालेभाज्या खाल्ल्या का?",
      "ask.health_bone_or_joint_pain": "इजा न होता आणि जास्त खेळ/काम न करता सुद्धा हात/पाय/सांध्यांमध्ये दुखतं का, असे विचारा.",
      "ask.health_breathlessness": "साधारण काम करताना किंवा चालताना दम लागतो का?",
      "ask.health_chronic_cough_or_diarrhea": "मुलाला/मुलीला खोकला आहे का आणि तो 4 आठवड्यांपेक्षा जास्त काळ आहे का? किंवा जुलाब/लूज मोशन होऊन ते 2 आठवड्यांपेक्षा जास्त चालू आहेत का?",
      "ask.health_dental_or_gum_or_ulcers": "दात दुखणे, हिरड्यांतून रक्त येणे, किंवा तोंडात फोड/अल्सर आहेत का, असे विचारा.",
      "ask.health_fatigue_dizzy_faint": "नेहमीसारखं काम/खेळताना कधी बेशुद्ध पडलात का, किंवा रोजची कामं/खेळ करण्यासाठी खूपच थकवा येतो का, असे विचारा.",
      "ask.health_frequent_infections": "मुलाला/मुलीला वारंवार आजार होतो का? मागच्या महिन्यात 3 वेळा किंवा जास्त वेळा आजारी पडलात का?",
      "ask.health_general_poor": "विद्यार्थ्याला विचारा: तुम्हाला स्वतःला निरोगी वाटतं का?",
      "ask.health_night_vision_difficulty": "अंधारात नीट दिसत नाही म्हणून चालताना ठेचकाळतो/ठेचकाळते का, असे विचारा.",
      "ask.health_pallor": "मुलाला/मुलीला फिकटपणा (pallor) आहे का?",
      "ask.health_visible_worms": "मलात कधी छोटे किडे दिसले आहेत का, असे विचारा.",
      "ask.lunch_eaten": "विद्यार्थ्याला विचारा: लंच खाल्लं का?",
      "ask.menarche_age_years": "विद्यार्थिनीला विचारा: पाळी कोणत्या वयात सुरू झाली?",
      "ask.menarche_started": "विद्यार्थिनीला विचारा: मासिक पाळी (पीरियड्स) सुरू झाली आहे का?",
      "ask.milk_curd": "काल दूध पिलं किंवा दही खाल्लं का?",
      "ask.nuts_groundnuts": "काल सुकामेवा/शेंगदाणे खाल्ले का?",
      "ask.other_vegetables": "शेवटच्या जेवणात इतर भाज्या खाल्ल्या का?",
      "ask.pads_per_day": "जास्त रक्तस्रावाच्या दिवशी दिवसाला किती पॅड्स वापरावे लागतात?",
      "ask.ssb_or_packaged_snacks": "तुम्ही कोका कोला, पेप्सी, मिरिंडा, फॅन्टा, लिम्का असे सॉफ्ट ड्रिंक्स पिता का? घराबाहेरचा पॅकेट ज्यूस पिता का? बिस्किटे, चॉकलेट, चिप्स, केक असे पॅकेट स्नॅक्स खातात का?",
      "button.cancel": "रद्द करा",
      "button.complete_screening": "स्क्रीनिंग पूर्ण करा",
      "button.create_student_complete_screening": "विद्यार्थी तयार करा व स्क्रीनिंग पूर्ण करा",
      "field.appetite.label": "भूक चांगली आहे का?",
      "field.bleeding_clots.label": "रक्तस्रावात गुठळ्या (क्लॉट्स) येतात का?",
      "field.breakfast_eaten.label": "नाश्ता",
      "field.cycle_length_days.label": "पाळीचे अंतर",
      "field.dal_pulses_beans.label": "डाळ / कडधान्य / बीन्स",
      "field.deworming_date.label": "किती महिन्यांपूर्वी?",
      "field.deworming_taken.label": "कृमिनाशक (Deworming)",
      "field.diet_type.label": "नेहमीचा आहार प्रकार",
      "field.division.label": "तुकडी",
      "field.dob.label": "जन्मतारीख (DOB)",
      "field.egg.label": "अंडं",
      "field.fish_chicken_meat.label": "मासे / चिकन / मांस",
      "field.fruits.label": "फळं",
      "field.grade.label": "इयत्ता",
      "field.green_leafy_veg.label": "पालेभाज्या (पालक/मेथी/चवळी)",
      "field.health_bone_or_joint_pain.label": "हाडं किंवा सांधे दुखणे",
      "field.health_breathlessness.label": "मेहनत/चालण्यात दम लागणे",
      "field.health_chronic_cough_or_diarrhea.label": "दीर्घकाळ खोकला किंवा जुलाब",
      "field.health_dental_or_gum_or_ulcers.label": "दात किडणे/कॅव्हिटी, हिरड्यांतून रक्त, किंवा तोंडात अल्सर",
      "field.health_fatigue_dizzy_faint.label": "थकवा, चक्कर येणे, किंवा बेशुद्ध पडणे",
      "field.health_frequent_infections.label": "वारंवार इन्फेक्शन (मागच्या महिन्यात 3 वेळा किंवा जास्त)",
      "field.health_general_poor.label": "एकूण आरोग्य ठीक नाही",
      "field.health_night_vision_difficulty.label": "रात्री दिसण्यात अडचण (कमी प्रकाशात ठेचकाळणे)",
      "field.health_pallor.label": "फिकटपणा (पापणी/तळहात आतून फिकट)",
      "field.health_visible_worms.label": "मलातून किडे दिसणे",
      "field.height_cm_r1.label": "2. उंची (सेमी)",
      "field.hunger_vital_sign.label": "घरात पुरेसं अन्न मिळतं का?",
      "field.is_low_income.label": "कमी उत्पन्न कुटुंब",
      "field.lunch_eaten.label": "लंच",
      "field.menarche_age_years.label": "पहिल्या पाळीचे वय (वर्षे)",
      "field.menarche_started.label": "मासिक पाळी सुरू झाली आहे का?",
      "field.muac_tape_color.label": "3. MUAC टेपचा रंग",
      "field.milk_curd.label": "दूध / दही",
      "field.nuts_groundnuts.label": "सुकामेवा / शेंगदाणे",
      "field.other_vegetables.label": "इतर भाज्या",
      "field.pads_per_day.label": "जास्त रक्तस्रावाच्या दिवशी दिवसाला किती पॅड्स लागतात",
      "field.parent_phone_e164.label": "पालकांचा WhatsApp नंबर",
      "field.sex.label": "लिंग",
      "field.ssb_or_packaged_snacks.label": "गोड पेये (SSB) किंवा पॅकेट स्नॅक्स",
      "field.student_name.label": "विद्यार्थ्याचे नाव",
      "field.unique_student_id.label": "युनिक स्टुडंट ID",
      "field.weight_kg_r1.label": "1. वजन (किलो)",
      "hint.diet_24h": "24 तासांची आठवण (काल): विद्यार्थ्याने/विद्यार्थिनीने काल खालील पदार्थ खाल्ले का?",
      "hint.select_dob_first": "लिंग निवडण्यासाठी आधी जन्मतारीख निवडा.",
      "legend.class_assignment": "शाळा / वर्ग / सेक्शन",
      "legend.girls_only": "किशोरी मुली (वय ≥10 फक्त)",
      "legend.section_a": "सेक्शन A: तपशील",
      "legend.section_b": "सेक्शन B: शरीर मोजमाप (Anthropometry)",
      "legend.section_c": "सेक्शन C: झटपट आरोग्य रेड फ्लॅग्स",
      "legend.section_d": "सेक्शन D: आहार प्रकार आणि विविधता",
      "legend.section_e": "सेक्शन E: कार्यक्रमासाठी मदत",
      "legend.section_f": "सेक्शन F: अन्नसुरक्षा",
      "option.cycle_length_days.GT_45": "45 दिवसांपेक्षा जास्त",
      "option.cycle_length_days.LT_45": "45 दिवसांपेक्षा कमी",
      "option.diet_type.LACTO_OVO": "लॅक्टो-ओव्हो व्हेज (अंडं खातात)",
      "option.diet_type.LACTO_VEG": "लॅक्टो व्हेज (दूध/दही घेतात)",
      "option.diet_type.NON_VEG": "नॉन-व्हेज (मासे/चिकन/मांस)",
      "option.dont_know": "माहित नाही",
      "option.grade.Nursery": "नर्सरी",
      "option.grade.Other": "इतर",
      "option.hunger_vital_sign.NEVER_TRUE": "कधीच खरे नाही",
      "option.hunger_vital_sign.OFTEN_TRUE": "अनेकदा खरे",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "कधी कधी खरे",
      "option.muac_tape_color.GREEN": "हिरवा",
      "option.muac_tape_color.RED": "लाल",
      "option.muac_tape_color.YELLOW": "पिवळा",
      "option.no": "नाही",
      "option.sex.F": "मुलगी",
      "option.sex.M": "मुलगा",
      "option.yes": "होय",
      "page.add_student.browser_title": "विद्यार्थी जोडा व स्क्रीनिंग पूर्ण करा",
      "page.add_student.heading": "विद्यार्थी जोडा व स्क्रीनिंग पूर्ण करा",
      "page.screening.browser_title_prefix": "स्क्रीनिंग",
      "page.screening.heading_prefix": "स्क्रीनिंग",
      "placeholder.select": "निवडा",
      "placeholder.select_age": "वय निवडा",
      "placeholder.select_division": "तुकडी निवडा",
      "placeholder.select_grade": "इयत्ता निवडा",
      "placeholder.select_months": "महिने निवडा",
      "placeholder.select_sex": "लिंग निवडा",
      "ui.language.label": "भाषा"
    },
    "hi": {
      "option.grade.K.G.": "K.G.",
      "age.month_plural": "महीने",
      "age.month_singular": "महीना",
      "age.year_plural": "साल",
      "age.year_singular": "साल",
      "ask.bleeding_clots": "क्या ब्लीडिंग के दौरान थक्के (क्लॉट्स) आते हैं?",
      "ask.breakfast_eaten": "बच्चे से पूछें: नाश्ता किया?",
      "ask.cycle_length_days": "पीरियड फिर से आने में आमतौर पर कितने दिनों का अंतर होता है?",
      "ask.dal_pulses_beans": "कल दाल/चना/राजमा खाए?",
      "ask.deworming_taken": "डी-वर्मिंग की बड़ी गोली ली?",
      "ask.diet_type.LACTO_OVO": "घर पर अंडा खाते हो?",
      "ask.diet_type.LACTO_VEG": "घर पर दूध/दही/पनीर लेते हो?",
      "ask.diet_type.NON_VEG": "घर पर मछली/चिकन/मटन खाते हो?",
      "ask.egg": "कल अंडा खाया?",
      "ask.fish_chicken_meat": "पिछले 3 दिनों में मछली/चिकन/मांस खाया?",
      "ask.fruits": "कल फल खाए?",
      "ask.green_leafy_veg": "पिछले भोजन में हरी पत्तेदार सब्ज़ी खाई?",
      "ask.health_bone_or_joint_pain": "बच्चे से पूछें: बिना चोट लगे और बिना ज्यादा खेल/काम के भी हाथ/पैर/जोड़ों में दर्द होता है क्या?",
      "ask.health_breathlessness": "बच्चे से पूछें: सामान्य काम करते या सामान्य चलने पर सांस फूलती है क्या?",
      "ask.health_chronic_cough_or_diarrhea": "क्या बच्चे को खांसी है और 4 हफ्तों से ज्यादा से चल रही है, या बच्चे को दस्त हैं और 2 हफ्तों से ज्यादा से चल रहे हैं?",
      "ask.health_dental_or_gum_or_ulcers": "बच्चे से पूछें: दांत दर्द, मसूड़ों से खून, या मुंह में छाले हैं क्या?",
      "ask.health_fatigue_dizzy_faint": "बच्चे से पूछें: सामान्य काम/खेलते समय कभी बेहोशी आई है, या रोज़मर्रा के काम/खेल के लिए बहुत ज्यादा थकान लगती है?",
      "ask.health_frequent_infections": "क्या बच्चा बहुत बार बीमार पड़ता है? क्या पिछले महीने में 3 बार या उससे ज्यादा बीमार हुआ है?",
      "ask.health_general_poor": "बच्चे से पूछें: क्या तुम खुद को स्वस्थ महसूस करते/करती हो?",
      "ask.health_night_vision_difficulty": "बच्चे से पूछें: अंधेरे/कम रोशनी में चलते समय ठोकर लगती है क्या?",
      "ask.health_pallor": "क्या बच्चे में पीलापन है?",
      "ask.health_visible_worms": "बच्चे से पूछें: क्या कभी पाखाने में छोटे कीड़े देखे हैं?",
      "ask.lunch_eaten": "बच्चे से पूछें: लंच खाया?",
      "ask.menarche_age_years": "बच्ची से पूछें: पीरियड्स किस उम्र में शुरू हुए?",
      "ask.menarche_started": "बच्ची से पूछें: क्या पीरियड्स शुरू हुए हैं?",
      "ask.milk_curd": "कल दूध पिया या दही खाया?",
      "ask.nuts_groundnuts": "कल मेवे/मूंगफली खाए?",
      "ask.other_vegetables": "पिछले भोजन में कोई अन्य सब्ज़ी खाई?",
      "ask.pads_per_day": "ज्यादा ब्लीडिंग वाले दिनों में दिन में कितने पैड इस्तेमाल होते हैं?",
      "ask.ssb_or_packaged_snacks": "क्या तुम कोक/पेप्सी/मिरिंडा/फैंटा/लिम्का जैसे सॉफ्ट ड्रिंक पीते हो? क्या तुम बाहर का पैकेट जूस पीते हो? क्या तुम बिस्किट, चॉकलेट, चिप्स, केक जैसे पैकेट स्नैक्स खाते हो?",
      "button.cancel": "रद्द करें",
      "button.complete_screening": "स्क्रीनिंग पूरा करें",
      "button.create_student_complete_screening": "छात्र बनाएँ और स्क्रीनिंग पूरा करें",
      "field.appetite.label": "क्या भूख अच्छी है?",
      "field.bleeding_clots.label": "ब्लीडिंग के दौरान थक्के (क्लॉट्स) आते हैं क्या?",
      "field.breakfast_eaten.label": "नाश्ता",
      "field.cycle_length_days.label": "पीरियड का अंतर",
      "field.dal_pulses_beans.label": "दाल / चना / राजमा",
      "field.deworming_date.label": "कितने महीने पहले?",
      "field.deworming_taken.label": "कृमिनाशक (Deworming)",
      "field.diet_type.label": "सामान्य डाइट का प्रकार",
      "field.division.label": "सेक्शन",
      "field.dob.label": "जन्म तिथि (DOB)",
      "field.egg.label": "अंडा",
      "field.fish_chicken_meat.label": "मछली / चिकन / मांस",
      "field.fruits.label": "फल",
      "field.grade.label": "कक्षा",
      "field.green_leafy_veg.label": "हरी पत्तेदार सब्ज़ी (पालक/मेथी/चौलाई)",
      "field.health_bone_or_joint_pain.label": "हड्डी या जोड़ों में दर्द",
      "field.health_breathlessness.label": "चलने/मेहनत पर सांस फूलना",
      "field.health_chronic_cough_or_diarrhea.label": "लंबे समय से खांसी या दस्त",
      "field.health_dental_or_gum_or_ulcers.label": "दांत में कीड़ा/कैविटी, मसूड़ों से खून, या मुंह में छाले",
      "field.health_fatigue_dizzy_faint.label": "थकान, चक्कर, या बेहोशी",
      "field.health_frequent_infections.label": "बार-बार इंफेक्शन (पिछले महीने में 3 या ज्यादा)",
      "field.health_general_poor.label": "सामान्य सेहत ठीक नहीं",
      "field.health_night_vision_difficulty.label": "रात में देखने में दिक्कत (कम रोशनी में ठोकर लगना)",
      "field.health_pallor.label": "पीलापन (पलक/हथेली अंदर से पीली)",
      "field.health_visible_worms.label": "पाखाने में कीड़े दिखना",
      "field.height_cm_r1.label": "2. लंबाई (सेमी)",
      "field.hunger_vital_sign.label": "क्या घर पर पर्याप्त खाना मिलता है?",
      "field.is_low_income.label": "कम आय वाला परिवार",
      "field.lunch_eaten.label": "लंच",
      "field.menarche_age_years.label": "पहली माहवारी की उम्र (साल)",
      "field.menarche_started.label": "क्या पीरियड्स शुरू हुए हैं?",
      "field.muac_tape_color.label": "3. MUAC टेप का रंग",
      "field.milk_curd.label": "दूध / दही",
      "field.nuts_groundnuts.label": "मेवे / मूंगफली",
      "field.other_vegetables.label": "अन्य सब्ज़ियाँ",
      "field.pads_per_day.label": "ज्यादा ब्लीडिंग वाले दिनों में दिन में कितने पैड लगते हैं",
      "field.parent_phone_e164.label": "अभिभावक का WhatsApp नंबर",
      "field.sex.label": "लिंग",
      "field.ssb_or_packaged_snacks.label": "मीठे ड्रिंक (SSB) या पैकेट स्नैक",
      "field.student_name.label": "छात्र का नाम",
      "field.unique_student_id.label": "यूनिक स्टूडेंट ID",
      "field.weight_kg_r1.label": "1. वजन (किलो)",
      "hint.diet_24h": "24-घंटे की याद (कल): क्या बच्चे ने कल नीचे की चीजें खाईं?",
      "hint.select_dob_first": "लिंग चुनने के लिए पहले जन्म तिथि चुनें।",
      "legend.class_assignment": "स्कूल / कक्षा / सेक्शन",
      "legend.girls_only": "किशोरी लड़कियाँ (उम्र ≥10 साल)",
      "legend.section_a": "सेक्शन A: विवरण",
      "legend.section_b": "सेक्शन B: शरीर माप (Anthropometry)",
      "legend.section_c": "सेक्शन C: जल्दी स्वास्थ्य रेड फ्लैग",
      "legend.section_d": "सेक्शन D: डाइट का प्रकार और विविधता",
      "legend.section_e": "सेक्शन E: प्रोग्राम सपोर्ट",
      "legend.section_f": "सेक्शन F: फूड सिक्योरिटी (खाने की उपलब्धता)",
      "option.cycle_length_days.GT_45": "45 दिनों से अधिक",
      "option.cycle_length_days.LT_45": "45 दिनों से कम",
      "option.diet_type.LACTO_OVO": "शाकाहारी + अंडा (अंडा खाते हैं)",
      "option.diet_type.LACTO_VEG": "शाकाहारी (दूध/दही लेते हैं)",
      "option.diet_type.NON_VEG": "नॉन-वेज (मांस/मछली खाते हैं)",
      "option.dont_know": "पता नहीं",
      "option.grade.Nursery": "नर्सरी",
      "option.grade.Other": "अन्य",
      "option.hunger_vital_sign.NEVER_TRUE": "कभी भी सही नहीं",
      "option.hunger_vital_sign.OFTEN_TRUE": "अक्सर सही",
      "option.hunger_vital_sign.SOMETIMES_TRUE": "कभी-कभी सही",
      "option.muac_tape_color.GREEN": "हरा",
      "option.muac_tape_color.RED": "लाल",
      "option.muac_tape_color.YELLOW": "पीला",
      "option.no": "नहीं",
      "option.sex.F": "लड़की",
      "option.sex.M": "लड़का",
      "option.yes": "हाँ",
      "page.add_student.browser_title": "छात्र जोड़ें और स्क्रीनिंग पूरा करें",
      "page.add_student.heading": "छात्र जोड़ें और स्क्रीनिंग पूरा करें",
      "page.screening.browser_title_prefix": "स्क्रीनिंग",
      "page.screening.heading_prefix": "स्क्रीनिंग",
      "placeholder.select": "चुनें",
      "placeholder.select_age": "उम्र चुनें",
      "placeholder.select_division": "सेक्शन चुनें",
      "placeholder.select_grade": "कक्षा चुनें",
      "placeholder.select_months": "महीने चुनें",
      "placeholder.select_sex": "लिंग चुनें",
      "ui.language.label": "भाषा"
    },
    "te": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "మొదటి రజస్వల ప్రారంభమైన వయసు (సంవత్సరాలలో)",
  "ask.menarche_started": "మీకు రజస్వల ప్రారంభమైందా?",
  "ask.menarche_age_years": "ఎన్ని ఏళ్ల వయసులో ప్రారంభమైంది?",
      "field.menarche_started.label": "రజస్వల ప్రారంభమైందా?",
      "field.grade.label": "తరగతి",
  "field.division.label": "విభాగం",
  "field.is_low_income.label": "తక్కువ ఆదాయ కుటుంబం",
  "field.deworming_date.label": "ఎన్ని నెలల క్రితం?",
      "page.add_student.heading": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.add_student.browser_title": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.screening.heading_prefix": "స్క్రీనింగ్",
  "page.screening.browser_title_prefix": "స్క్రీనింగ్",
  "button.create_student_complete_screening": "విద్యార్థిని సృష్టించి స్క్రీనింగ్ పూర్తి చేయండి",
  "button.complete_screening": "స్క్రీనింగ్ పూర్తి చేయండి",
  "button.cancel": "రద్దు చేయండి",
  "hint.select_dob_first": "ఈ ఫీల్డ్‌ను ప్రారంభించడానికి ముందుగా పుట్టిన తేదీని ఎంచుకోండి",
  "age.month_plural": "నెలలు",
"age.month_singular": "నెల",
"age.year_plural": "సంవత్సరాలు",
"age.year_singular": "సంవత్సరం",
  "ask.bleeding_clots": "డ్రాప్‌డౌన్ అవును/కాదు - బ్లీడింగ్ సమయంలో గడ్డలు (క్లాట్స్) పడతాయా?",
  "ask.breakfast_eaten": "నువ్వు బ్రేక్‌ఫాస్ట్ తిన్నావా?",
  "ask.cycle_length_days": "డ్రాప్‌డౌన్ - 45 రోజులు కన్నా తక్కువ / 45 రోజులు కన్నా ఎక్కువ - పీరియడ్స్ మళ్లీ ఎన్ని రోజుల తర్వాత వస్తాయి?",
  "ask.dal_pulses_beans": "నువ్వు నిన్న పప్పు/పప్పుదినుసులు/బీన్స్ తిన్నావా?",
  "ask.deworming_taken": "పురుగు మందు కోసం ఇచ్చిన పెద్ద మాత్ర తీసుకున్నావా?",
  "ask.diet_type.LACTO_OVO": "ఇంట్లో గుడ్డు తింటావా?",
  "ask.diet_type.LACTO_VEG": "ఇంట్లో పాలు తాగుతావా లేదా పెరుగు/పనీర్ తింటావా?",
  "ask.diet_type.NON_VEG": "ఇంట్లో చేపలు లేదా చికెన్ లేదా మటన్ తింటావా?",
  "ask.egg": "నువ్వు నిన్న గుడ్డు తిన్నావా?",
  "ask.fish_chicken_meat": "నువ్వు గత 3 రోజుల్లో చేపలు / చికెన్ / మాంసం తిన్నావా?",
  "ask.fruits": "నువ్వు నిన్న పండ్లు తిన్నావా?",
  "ask.green_leafy_veg": "నువ్వు చివరి భోజనంలో పచ్చి ఆకు కూరలు తిన్నావా?",
  "ask.health_bone_or_joint_pain": "బిడ్డ చేతులు/కాళ్లు/జాయింట్స్‌లో నొప్పి ఉందో లేదో అడగండి.",
  "ask.health_breathlessness": "చిన్న శారీరక శ్రమకు కూడా త్వరగా అలసిపోతాడా/అలసిపోతుందా అని అడగండి.",
  "ask.health_chronic_cough_or_diarrhea": "4 వారాల కంటే ఎక్కువగా దగ్గు లేదా 2 వారాల కంటే ఎక్కువగా విరేచనాలు ఉన్నాయా అని అడగండి.",
  "ask.health_dental_or_gum_or_ulcers": "పళ్లలో రంధ్రాలు, పళ్ళ నొప్పి, చిగుళ్ళ నుండి రక్తం, లేదా నోటిలో పుండ్లు ఉన్నాయా అని అడగండి.",
  "ask.health_fatigue_dizzy_faint": "ఆడేటప్పుడు లేదా పని చేస్తూ అలసట, తల తిరగడం వల్ల స్పృహ కోల్పోయినట్లు (సొమ్మసిల్లినట్లు) గుర్తుందా అని అడగండి",
  "ask.health_frequent_infections": "బిడ్డకి తరచూ అనారోగ్యం వస్తుందా? గత 1 నెలలో 3 సార్లు లేదా అంతకంటే ఎక్కువ సార్లు అనారోగ్యం వచ్చిందా?",
  "ask.health_general_poor": "బిడ్డ తన ఆరోగ్య స్థితి బాగోలేదని అనుకుంటున్నాడా/అనుకుంటుందా?",
  "ask.health_night_vision_difficulty": "చీకట్లో నడిచేటప్పుడు తడబడతాడా/తడబడుతుందా అని అడగండి",
  "ask.health_pallor": "బిడ్డకి పాలర్ (పసుపు / వెలితి) ఉందా?",
  "ask.health_visible_worms": "మలంలో పురుగులు (చిన్న క్రిములు) చూసానని బిడ్డ చెప్తున్నాడా/చెప్తుందా అని అడగండి.",
  "ask.lunch_eaten": "నువ్వు లంచ్ తిన్నావా?",
  "ask.milk_curd": "నువ్వు నిన్న పాలు తాగావా లేదా పెరుగు తిన్నావా?",
  "ask.nuts_groundnuts": "నువ్వు నిన్న గింజలు / వేరుశెనగలు తిన్నావా?",
  "ask.other_vegetables": "నువ్వు చివరి భోజనంలో ఏమైనా ఇతర కూరగాయలు తిన్నావా?",
  "ask.pads_per_day": "డ్రాప్‌డౌన్ 1-10 - బిడ్డను అడగండి: బ్లీడింగ్ ఎక్కువగా ఉన్న రోజుల్లో రోజుకు ఎన్ని ప్యాడ్‌లు అవసరం అవుతాయి?",
  "ask.ssb_or_packaged_snacks": "మీరు కోకాకోలా, పెప్సీ, మిరిండా, ఫాంటా, లిమ్కా వంటి సాఫ్ట్ డ్రింక్స్ తాగుతారా? దుకాణంలో దొరికే ప్యాకేజ్డ్ జ్యూస్ తాగుతారా? బిస్కెట్లు, చాక్లెట్స్, చిప్స్, కేక్ వంటి ప్యాకేజ్డ్ స్నాక్స్ తింటారా?",
  "field.appetite.label": "ఆకలి",
  "field.bleeding_clots.label": "డ్రాప్‌డౌన్ అవును/కాదు - బ్లీడింగ్ సమయంలో గడ్డలు (క్లాట్స్) పడతాయా?",
  "field.breakfast_eaten.label": "బ్రేక్‌ఫాస్ట్ తిన్నావా?",
  "field.cycle_length_days.label": "అనియమిత పీరియడ్స్ (>45 రోజులు గ్యాప్)?",
  "field.dal_pulses_beans.label": "డాల్/పప్పుదినుసులు/బీన్స్",
  "field.deworming_taken.label": "పురుగుల మందు",
  "field.diet_type.label": "ఆహారపు రకం",
  "field.dob.label": "పుట్టిన తేదీ (DOB)",
  "field.egg.label": "గుడ్డు",
  "field.fish_chicken_meat.label": "చేపలు / చికెన్ / మాంసం",
  "field.fruits.label": "పండ్లు",
  "field.green_leafy_veg.label": "పచ్చి ఆకు కూరలు (పాలకూర/మెంతి/తోటకూర)",
  "field.health_bone_or_joint_pain.label": "ఎముకల / జాయింట్ నొప్పులు",
  "field.health_breathlessness.label": "కొంచెం శ్రమతోనే ఆయాసపడటం",
  "field.health_chronic_cough_or_diarrhea.label": "దీర్ఘకాలిక దగ్గు (>4 వారాలు)/విరేచనాలు (>2 వారాలు)",
  "field.health_dental_or_gum_or_ulcers.label": "పళ్ల సమస్యలు / చిగుళ్ళ నుండి రక్తం / నోటిలో పుండ్లు",
  "field.health_fatigue_dizzy_faint.label": "అలసట, తల తిరగడం, లేదా స్పృహ కోల్పోవడం",
  "field.health_frequent_infections.label": "తరచూ ఇన్ఫెక్షన్లు (గత 1 నెలలో 3 సార్లు లేదా అంతకంటే ఎక్కువ)",
  "field.health_general_poor.label": "ఆరోగ్యం బాగా లేదు",
  "field.health_night_vision_difficulty.label": "వెలుతురు తక్కువగా ఉన్నప్పుడు చూడడంలో కష్టం",
  "field.health_pallor.label": "పాలర్ (కనురెప్పలు/అరికాళ్లు లోపల భాగం తెల్లబడటం)",
  "field.health_visible_worms.label": "పురుగులు కనిపించడం",
  "field.height_cm_r1.label": "2. ఎత్తు (cm)",
  "field.hunger_vital_sign.label": "ఆకలి సంబంధిత ప్రశ్న (గత 12 నెలలు)",
  "field.lunch_eaten.label": "స్కూల్లో లంచ్ తిన్నావా?",
  "field.milk_curd.label": "పాలు / పెరుగు",
  "field.muac_tape_color.label": "3. MUACలో టేపు రంగు",
  "field.nuts_groundnuts.label": "గింజలు / వేరుశెనగలు",
  "field.other_vegetables.label": "ఇతర కూరగాయలు",
  "field.pads_per_day.label": "అధిక బ్లీడింగ్ (≥5 ప్యాడ్లు/రోజు లేదా గడ్డలు)?",
  "field.parent_phone_e164.label": "తల్లిదండ్రుల వాట్సాప్ నంబర్",
  "field.sex.label": "లింగం",
  "field.ssb_or_packaged_snacks.label": "చక్కెర పానీయాలు (SSB) లేదా ప్యాకెట్ స్నాక్స్ తిన్నావా?",
  "field.student_name.label": "విద్యార్థి పేరు",
  "field.unique_student_id.label": "యూనిక్ స్టూడెంట్ ID",
  "field.weight_kg_r1.label": "1. బరువు (kg)",
  "hint.diet_24h": "24-గంటల ఆహార సమాచారం (నిన్న) విద్యార్థి నిన్న క్రిందివి తిన్నాడా?",
  "legend.class_assignment": "పాఠశాల/తరగతి/సెక్షన్",
  "legend.girls_only": "కిశోరి బాలికలు (10 ఏళ్లు పైబడినవి మాత్రమే)",
  "legend.section_a": "సెక్షన్ A: వివరాలు",
  "legend.section_b": "సెక్షన్ B: శరీర కొలతలు",
  "legend.section_c": "సెక్షన్ C: త్వరిత ఆరోగ్య సమస్యలు",
  "legend.section_d": "సెక్షన్ D: ఆహార రకం & వైవిధ్యం",
  "legend.section_e": "సెక్షన్ E: కార్యక్రమానికి తోడ్పాటు",
  "legend.section_f": "సెక్షన్ F: ఆహార భద్రత",
  "option.cycle_length_days.GT_45": "45 రోజులు కన్నా ఎక్కువ",
  "option.cycle_length_days.LT_45": "45 రోజులు కన్నా తక్కువ",
  "option.diet_type.LACTO_OVO": "( ) లాక్టో-ఓవో-వెజిటేరియన్ (గుడ్డు తింటారు)",
  "option.diet_type.LACTO_VEG": "( ) లాక్టో-వెజిటేరియన్",
  "option.diet_type.NON_VEG": "( ) నాన్-వెజిటేరియన్",
  "option.dont_know": "తెలియదు",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ఎప్పుడూ నిజం కాదు (రెడ్ ఫ్లాగ్)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) ఎక్కువగా నిజం",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) కొన్నిసార్లు నిజం (రెడ్ ఫ్లాగ్)",
  "option.no": "కాదు",
  "option.muac_tape_color.GREEN": "చెక్ బాక్స్ - టేపు రంగు ఆకుపచ్చ",
  "option.muac_tape_color.RED": "చెక్ బాక్స్ - టేపు రంగు ఎరుపు",
  "option.muac_tape_color.YELLOW": "చెక్ బాక్స్ - టేపు రంగు పసుపు",
  "option.sex.F": "అమ్మాయి",
  "option.sex.M": "అబ్బాయి",
  "option.yes": "అవును",
  "page.add_student.browser_title": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.add_student.heading": "విద్యార్థిని జోడించి స్క్రీనింగ్ పూర్తి చేయండి",
  "page.screening.browser_title_prefix": "స్క్రీనింగ్",
  "page.screening.heading_prefix": "స్క్రీనింగ్",
  "placeholder.select": "ఎంచుకోండి",
  "placeholder.select_age": "వయసు ఎంచుకోండి",
  "placeholder.select_division": "విభాగాన్ని ఎంచుకోండి",
  "placeholder.select_grade": "తరగతి ఎంచుకోండి",
  "placeholder.select_months": "నెలలను ఎంచుకోండి",
  "placeholder.select_sex": "లింగాన్ని ఎంచుకోండి",
  "ui.language.label": "భాష",
},

"ta": {
  "option.grade.K.G.": "K.G.",
  "placeholder.select_sex": "பாலினத்தை தேர்ந்தெடுக்கவும்",
  "ui.language.label": "மொழி",
  "field.menarche_age_years.label": "முதல் மாதவிடாய் தொடங்கிய வயது (ஆண்டுகளில்)",
  "ask.menarche_started": "உங்களுக்கு மாதவிடாய் தொடங்கியுள்ளதா?",
  "ask.menarche_age_years": "எந்த வயதில் தொடங்கியது?",
  "field.menarche_started.label": "மாதவிடாய் தொடங்கியுள்ளதா?",
  "placeholder.select_age": "வயதை தேர்ந்தெடுக்கவும்",
  "field.grade.label": "வகுப்பு",
  "field.division.label": "பிரிவு",
  "field.is_low_income.label": "குறைந்த வருமான குடும்பம்",
  "field.deworming_date.label": "எத்தனை மாதங்களுக்கு முன்பு?",
  "placeholder.select_division": "பிரிவை தேர்ந்தெடுக்கவும்",
"placeholder.select_grade": "வகுப்பை தேர்ந்தெடுக்கவும்",
  "placeholder.select": "தேர்ந்தெடுக்கவும்",
  "page.add_student.heading": "மாணவரை சேர்த்து பரிசோதனை முடிக்கவும்",
  "page.add_student.browser_title": "மாணவரை சேர்த்து பரிசோதனை முடிக்கவும்",
  "page.screening.heading_prefix": "திரையிடல்",
  "page.screening.browser_title_prefix": "திரையிடல்",
  "button.create_student_complete_screening": "மாணவரை உருவாக்கி பரிசோதனை முடிக்கவும்",
  "button.complete_screening": "பரிசோதனை முடிக்கவும்",
  "button.cancel": "ரத்து செய்யவும்",
  "hint.select_dob_first": "இந்த புலத்தை செயல்படுத்த முதலில் பிறந்த தேதியை தேர்ந்தெடுக்கவும்",
  "age.month_plural": "மாதங்கள்",
"age.month_singular": "மாதம்",
"age.year_plural": "ஆண்டுகள்",
"age.year_singular": "ஆண்டு",
  "ask.bleeding_clots": "ட்ராப்-டவுன் ஆம்/இல்லை - ரத்தப்போக்கு போது இரத்தக் கட்டிகள் (clots) வருகிறதா?",
  "ask.breakfast_eaten": "நீ பிரேக்பாஸ்ட் சாப்பிட்டாயா?",
  "ask.cycle_length_days": "ட்ராப்-டவுன் - 45 நாட்களுக்கு குறைவு / 45 நாட்களுக்கு மேல் - பீரியட் மீண்டும் எத்தனை நாட்களுக்கு பிறகு வருகிறது?",
  "ask.dal_pulses_beans": "நீ நேற்று பருப்பு/பயறு/பீன்ஸ் சாப்பிட்டாயா?",
  "ask.deworming_taken": "புழு மருந்துக்காக கொடுக்கப்பட்ட பெரிய மாத்திரை எடுத்தாயா?",
  "ask.diet_type.LACTO_OVO": "வீட்டில் முட்டை சாப்பிடுவாயா?",
  "ask.diet_type.LACTO_VEG": "வீட்டில் பால் குடிப்பாயா அல்லது தயிர்/பன்னீர் சாப்பிடுவாயா?",
  "ask.diet_type.NON_VEG": "வீட்டில் மீன் அல்லது சிக்கன் அல்லது மட்டன் சாப்பிடுவாயா?",
  "ask.egg": "நீ நேற்று முட்டை சாப்பிட்டாயா?",
  "ask.fish_chicken_meat": "கடந்த 3 நாட்களில் மீன் / சிக்கன் / இறைச்சி சாப்பிட்டாயா?",
  "ask.fruits": "நீ நேற்று பழங்கள் சாப்பிட்டாயா?",
  "ask.green_leafy_veg": "கடைசி உணவில் கீரை வகைகள் சாப்பிட்டாயா?",
  "ask.health_bone_or_joint_pain": "குழந்தைக்கு கை/கால்/மூட்டுகளில் வலி இருக்கிறதா என்று கேளுங்கள்.",
  "ask.health_breathlessness": "சிறிது உடல் உழைப்பிலேயே விரைவில் களைப்படைகிறானா/களைப்படைகிறாளா என்று கேளுங்கள்.",
  "ask.health_chronic_cough_or_diarrhea": "4 வாரங்களுக்கு மேல் நீடிக்கும் இருமல் அல்லது 2 வாரங்களுக்கு மேல் நீடிக்கும் வயிற்றுப்போக்கு உள்ளதா என்று கேளுங்கள்.",
  "ask.health_dental_or_gum_or_ulcers": "பல் சொத்தை, ஈறில் ரத்தம், அல்லது வாய் புண்கள் உள்ளதா என்று கேளுங்கள்.",
  "ask.health_fatigue_dizzy_faint": "விளையாடும்போது அல்லது வேலை செய்யும்போது சோர்வு/தலைச்சுற்றல் காரணமாக மயக்கம் வந்ததா என்று கேளுங்கள்.",
  "ask.health_frequent_infections": "குழந்தைக்கு அடிக்கடி உடல் நலம் சரியில்லாமல் இருக்கிறதா? கடந்த 1 மாதத்தில் 3 முறை அல்லது அதற்கு மேல் நோய்வாய்ப்பட்டதா?",
  "ask.health_general_poor": "குழந்தைக்கு பொதுவான உடல் நலம் சரியில்லை என்று தோன்றுகிறதா?",
  "ask.health_night_vision_difficulty": "இருட்டில் நடக்கும் போது தடுமாறுகிறாயா என்று கேளுங்கள்",
  "ask.health_pallor": "குழந்தைக்கு வெளிறிப்போவது (pallor) இருக்கிறதா?",
  "ask.health_visible_worms": "மலத்தில் புழுக்கள் (சிறிய பூச்சிகள்) பார்த்தாயா என்று கேளுங்கள்.",
  "ask.lunch_eaten": "நீ லஞ்ச் சாப்பிட்டாயா?",
  "ask.milk_curd": "நீ நேற்று பால் குடித்தாயா அல்லது தயிர் சாப்பிட்டாயா?",
  "ask.nuts_groundnuts": "நீ நேற்று பருப்பு/வேர்க்கடலை சாப்பிட்டாயா?",
  "ask.other_vegetables": "கடைசி உணவில் வேறு காய்கறிகள் ஏதாவது சாப்பிட்டாயா?",
  "ask.pads_per_day": "ட்ராப்-டவுன் 1-10 - குழந்தையிடம் கேளுங்கள்: அதிக ரத்தப்போக்கு நாட்களில் ஒரு நாளில் எத்தனை பேட்கள் தேவைப்படும்?",
  "ask.ssb_or_packaged_snacks": "நீங்கள் கோகா கோலா, பெப்சி, மிரிந்தா, ஃபான்டா, லிம்கா போன்ற சாப்ட் டிரின்க்ஸ் குடிப்பீர்களா? கடையில் கிடைக்கும் பேக்கேஜ் ஜூஸ் குடிப்பீர்களா? பிஸ்கட், சாக்லேட், சிப்ஸ், கேக் போன்ற பேக்கேஜ் ஸ்நாக்ஸ் சாப்பிடுவீர்களா?",
  "field.appetite.label": "பசி",
  "field.bleeding_clots.label": "ட்ராப்-டவுன் ஆம்/இல்லை - ரத்தப்போக்கு போது இரத்தக் கட்டிகள் (clots) வருகிறதா?",
  "field.breakfast_eaten.label": "காலை உணவு சாப்பிட்டாயா?",
  "field.cycle_length_days.label": "மாதவிடாய் ஒழுங்கில்லை (>45 நாட்கள் இடைவெளி)?",
  "field.dal_pulses_beans.label": "பருப்பு / பயறு / பீன்ஸ்",
  "field.deworming_taken.label": "புழு மருந்து",
  "field.diet_type.label": "உணவு வகை",
  "field.dob.label": "பிறந்த தேதி (DOB)",
  "field.egg.label": "முட்டை",
  "field.fish_chicken_meat.label": "மீன் / சிக்கன் / இறைச்சி",
  "field.fruits.label": "பழங்கள்",
  "field.green_leafy_veg.label": "கீரை வகைகள் (பாலக்/வெந்தயம்/அமராந்த்)",
  "field.health_bone_or_joint_pain.label": "எலும்பு அல்லது மூட்டு வலி",
  "field.health_breathlessness.label": "சிறிது உழைப்பிலேயே மூச்சுத்திணறல்",
  "field.health_chronic_cough_or_diarrhea.label": "நீடித்த இருமல் (>4 வாரங்கள்)/வயிற்றுப்போக்கு (>2 வாரங்கள்)",
  "field.health_dental_or_gum_or_ulcers.label": "பல்/ஈறு பிரச்சினைகள்/வாய் புண்கள்",
  "field.health_fatigue_dizzy_faint.label": "சோர்வு, தலைச்சுற்றல், அல்லது மயக்கம்",
  "field.health_frequent_infections.label": "அடிக்கடி தொற்றுகள் (கடந்த 1 மாதத்தில் 3 அல்லது அதற்கு மேல்)",
  "field.health_general_poor.label": "உடல் நலம் சரியில்லை",
  "field.health_night_vision_difficulty.label": "குறைந்த வெளிச்சத்தில் பார்க்க சிரமம்",
  "field.health_pallor.label": "வெளிறிப்போவது (கண் இமை/கைத் தளிர் உள்ளே வெளிறுதல்)",
  "field.health_visible_worms.label": "புழுக்கள் தெரிதல்",
  "field.height_cm_r1.label": "2. உயரம் (cm)",
  "field.hunger_vital_sign.label": "பசி தொடர்பான கேள்வி (கடந்த 12 மாதங்கள்)",
  "field.lunch_eaten.label": "பள்ளியில் மதிய உணவு சாப்பிட்டாயா?",
  "field.milk_curd.label": "பால் / தயிர்",
  "field.muac_tape_color.label": "3. MUAC டேப்பின் நிறம்",
  "field.nuts_groundnuts.label": "பருப்பு / வேர்க்கடலை",
  "field.other_vegetables.label": "மற்ற காய்கறிகள்",
  "field.pads_per_day.label": "அதிக ரத்தப்போக்கு (≥5 பேட்கள்/நாள் அல்லது கட்டிகள்)?",
  "field.parent_phone_e164.label": "பெற்றோர் WhatsApp எண்",
  "field.sex.label": "பாலினம்",
  "field.ssb_or_packaged_snacks.label": "சர்க்கரை பானங்கள் (SSB) அல்லது பேக்கேஜ் ஸ்நாக்ஸ் சாப்பிட்டதா?",
  "field.student_name.label": "மாணவரின் பெயர்",
  "field.unique_student_id.label": "யூனிக் மாணவர் ID",
  "field.weight_kg_r1.label": "1. எடை (kg)",
  "hint.diet_24h": "24-மணி நேர உணவு (நேற்று) மாணவர் நேற்று கீழ்கண்டவற்றை சாப்பிட்டாரா?",
  "legend.class_assignment": "பள்ளி / வகுப்பு / பிரிவு",
  "legend.girls_only": "கிஷோரி பெண்கள் (வயது ≥10 மட்டும்)",
  "legend.section_a": "பகுதி A: விவரங்கள்		",
  "legend.section_b": "பகுதி B: உடல் அளவீடு",
  "legend.section_c": "பகுதி C: உடனடி உடல் நல ரெட் ஃப்ளாக்ஸ்",
  "legend.section_d": "பகுதி D: உணவு வகை & பல்வகை",
  "legend.section_e": "பகுதி E: திட்ட உதவிகள்",
  "legend.section_f": "பகுதி F: உணவு பாதுகாப்பு",
  "option.cycle_length_days.GT_45": "45 நாட்களுக்கு மேல்",
  "option.cycle_length_days.LT_45": "45 நாட்களுக்கு குறைவு",
  "option.diet_type.LACTO_OVO": "( ) லாக்டோ-ஓவோ-சைவம் (முட்டை சாப்பிடுவர்)",
  "option.diet_type.LACTO_VEG": "( ) லாக்டோ-சைவம்",
  "option.diet_type.NON_VEG": "( ) நான்-வெஜ்",
  "option.dont_know": "தெரியாது",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ஒருபோதும் சரியில்லை (ரெட் ஃப்ளாக்)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) அதிகமாக சரி",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) சில நேரம் சரி (ரெட் ஃப்ளாக்)",
  "option.no": "இல்லை",
  "option.muac_tape_color.GREEN": "Check box - டேப்பின் நிறம் பச்சை",
  "option.muac_tape_color.RED": "Check box - டேப்பின் நிறம் சிவப்பு",
  "option.muac_tape_color.YELLOW": "Check box - டேப்பின் நிறம் மஞ்சள்",
  "option.yes": "ஆம்",
  "option.sex.F": "பெண்",
  "option.sex.M": "ஆண்",
},

    "ml": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "ആദ്യ മാസവിരാമം ആരംഭിച്ച പ്രായം (വർഷങ്ങളിൽ)",
  "ask.menarche_started": "നിങ്ങൾക്ക് മാസവിരാമം ആരംഭിച്ചിട്ടുണ്ടോ?",
  "ask.menarche_age_years": "എത്ര വയസ്സിലാണ് തുടങ്ങിയത്?",
      "field.menarche_started.label": "മാസവിരാമം ആരംഭിച്ചിട്ടുണ്ടോ?",
      "field.grade.label": "ക്ലാസ്",
  "field.division.label": "വിഭാഗം",
  "field.is_low_income.label": "കുറഞ്ഞ വരുമാന കുടുംബം",
  "field.deworming_date.label": "എത്ര മാസം മുമ്പ്?",
      "page.add_student.heading": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.add_student.browser_title": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.screening.heading_prefix": "സ്ക്രീനിംഗ്",
  "page.screening.browser_title_prefix": "സ്ക്രീനിംഗ്",
  "button.create_student_complete_screening": "വിദ്യാർത്ഥിയെ സൃഷ്ടിച്ച് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "button.complete_screening": "സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "button.cancel": "റദ്ദാക്കുക",
  "hint.select_dob_first": "ഈ ഫീൽഡ് പ്രവർത്തിപ്പിക്കാൻ ആദ്യം ജനനത്തീയതി തിരഞ്ഞെടുക്കുക",
      "option.no": "ഇല്ല",
  "option.sex.F": "പെൺകുട്ടി",
  "option.sex.M": "ആൺകുട്ടി",
  "option.yes": "അതെ",
  "page.add_student.browser_title": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.add_student.heading": "വിദ്യാർത്ഥിയെ ചേർത്ത് സ്ക്രീനിംഗ് പൂർത്തിയാക്കുക",
  "page.screening.browser_title_prefix": "സ്ക്രീനിംഗ്",
  "page.screening.heading_prefix": "സ്ക്രീനിംഗ്",
  "placeholder.select": "തിരഞ്ഞെടുക്കുക",
  "placeholder.select_age": "പ്രായം തിരഞ്ഞെടുക്കുക",
  "placeholder.select_division": "വിഭാഗം തിരഞ്ഞെടുക്കുക",
  "placeholder.select_grade": "ക്ലാസ് തിരഞ്ഞെടുക്കുക",
  "placeholder.select_months": "മാസങ്ങൾ തിരഞ്ഞെടുക്കുക",
  "placeholder.select_sex": "ലിംഗം തിരഞ്ഞെടുക്കുക",
  "ui.language.label": "ഭാഷ",
  "age.month_plural": "മാസങ്ങൾ",
  "age.month_singular": "മാസം",
  "age.year_plural": "വർഷങ്ങൾ",
  "age.year_singular": "വർഷം",
  "ask.bleeding_clots": "ഡ്രോപ്പ്‌ഡൗൺ അതെ/ഇല്ല - രക്തസ്രാവത്തിൽ കട്ടകൾ (clots) വരാറുണ്ടോ?",
  "ask.breakfast_eaten": "നീ പ്രഭാതഭക്ഷണം കഴിച്ചോ?",
  "ask.cycle_length_days": "ഡ്രോപ്പ്‌ഡൗൺ - 45 ദിവസത്തിന് താഴെ / 45 ദിവസത്തിന് മേൽ - പീരിയഡ് വീണ്ടും എത്ര ദിവസത്തിന് ശേഷം വരുന്നു?",
  "ask.dal_pulses_beans": "നീ ഇന്നലെ ദാൽ/പയർവർഗങ്ങൾ/ബീൻസ് കഴിച്ചോ?",
  "ask.deworming_taken": "പുഴു മരുന്നിന്റെ വലിയ ഗുളിക എടുത്തോ?",
  "ask.diet_type.LACTO_OVO": "വീട്ടിൽ മുട്ട കഴിക്കുമോ?",
  "ask.diet_type.LACTO_VEG": "വീട്ടിൽ പാൽ കുടിക്കുമോ അല്ലെങ്കിൽ തൈര്/പനീർ കഴിക്കുമോ?",
  "ask.diet_type.NON_VEG": "വീട്ടിൽ മീൻ, ചിക്കൻ അല്ലെങ്കിൽ മട്ടൺ കഴിക്കുമോ?",
  "ask.egg": "നീ ഇന്നലെ മുട്ട കഴിച്ചോ?",
  "ask.fish_chicken_meat": "കഴിഞ്ഞ 3 ദിവസത്തിനുള്ളിൽ നീ മീൻ/ചിക്കൻ/മാംസം കഴിച്ചോ?",
  "ask.fruits": "നീ ഇന്നലെ പഴം കഴിച്ചോ?",
  "ask.green_leafy_veg": "നിന്റെ അവസാന ഭക്ഷണത്തിൽ ഇലക്കറികൾ (കീര) കഴിച്ചോ?",
  "ask.health_bone_or_joint_pain": "പരിക്ക് ഇല്ലാതെയും കഠിനമായ കളി/ജോലി ഇല്ലാതെയും കൈ/കാലുകൾ/സന്ധികളിൽ വേദന ഉണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_breathlessness": "സാധാരണ ജോലികൾ ചെയ്യുമ്പോൾ അല്ലെങ്കിൽ സാധാരണ നടക്കുമ്പോൾ ശ്വാസം മുട്ടുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_chronic_cough_or_diarrhea": "കുട്ടിക്ക് ചുമ ഉണ്ടോ, അത് കഴിഞ്ഞ 4 ആഴ്ചയോ അതിൽ കൂടുതലോ തുടരുന്നുണ്ടോ? അല്ലെങ്കിൽ വയറിളക്കം 2 ആഴ്ചയ്ക്ക് മേൽ നീളുന്നുണ്ടോ?",
  "ask.health_dental_or_gum_or_ulcers": "പല്ലുവേദന, പല്ലുമംസത്തിൽ നിന്ന് രക്തം വരുക, അല്ലെങ്കിൽ വായിൽ പുണ്ണുകൾ ഉണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_fatigue_dizzy_faint": "സാധാരണ ജോലി/കളിക്കുമ്പോൾ ബോധക്ഷയം ഉണ്ടായിട്ടുണ്ടോ, അല്ലെങ്കിൽ സാധാരണ ജോലി/കളി ചെയ്യാൻ പറ്റാത്തത്ര ക്ഷീണം തോന്നുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_frequent_infections": "കുട്ടിക്ക് വളരെ പലപ്പോഴും അസുഖം വരാറുണ്ടോ? കഴിഞ്ഞ മാസത്തിൽ 3 പ്രാവശ്യം അല്ലെങ്കിൽ അതിലധികം അസുഖപ്പെട്ടിട്ടുണ്ടോ?",
  "ask.health_general_poor": "കുട്ടിയോട് ചോദിക്കുക: നിനക്ക് നിന്റെ ആരോഗ്യം നന്നാണ് എന്ന് തോന്നുന്നുണ്ടോ?",
  "ask.health_night_vision_difficulty": "ഇരുട്ടിൽ ശരിയായി കാണാൻ പറ്റാത്തതിനാൽ നടക്കുമ്പോൾ ഇടറുന്നുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.health_pallor": "കുട്ടിക്ക് വിളർച്ച (pallor) ഉണ്ടോ?",
  "ask.health_visible_worms": "മലത്തിൽ ചെറിയ പുഴുക്കൾ കണ്ടിട്ടുണ്ടോ എന്ന് ചോദിക്കുക.",
  "ask.lunch_eaten": "നീ ഉച്ചഭക്ഷണം കഴിച്ചോ?",
  "ask.milk_curd": "നീ ഇന്നലെ പാൽ കുടിച്ചോ അല്ലെങ്കിൽ തൈര് കഴിച്ചോ?",
  "ask.nuts_groundnuts": "നീ ഇന്നലെ കായ്കൾ/വേര്ക്കടല കഴിച്ചോ?",
  "ask.other_vegetables": "നിന്റെ അവസാന ഭക്ഷണത്തിൽ വേറേതെങ്കിലും പച്ചക്കറി കഴിച്ചോ?",
  "ask.pads_per_day": "ഡ്രോപ്പ്‌ഡൗൺ 1-10 - കൂടുതൽ രക്തസ്രാവമുള്ള ദിവസങ്ങളിൽ ദിവസത്തിൽ എത്ര പാഡ് വേണം എന്ന് കുട്ടിയോട് ചോദിക്കുക.",
  "ask.ssb_or_packaged_snacks": "നീ കൊക്കാകോള, പെപ്സി, മിറിൻഡ, ഫാന്റ, ലിംക തുടങ്ങിയ സോഫ്റ്റ് ഡ്രിങ്ക്സ് കുടിക്കുമോ? വീട്ടിൽ ഉണ്ടാക്കാത്ത ഫ്രൂട്ട് ജ്യൂസ് കുടിക്കുമോ? ബിസ്കറ്റ്, ചോക്ലേറ്റ്, ചിപ്സ്, കേക്ക് പോലുള്ള സ്നാക്സ് കഴിക്കുമോ?",
  "field.appetite.label": "വിശപ്പ്",
  "field.bleeding_clots.label": "ഡ്രോപ്പ്‌ഡൗൺ അതെ/ഇല്ല - രക്തസ്രാവത്തിൽ കട്ടകൾ (clots) വരാറുണ്ടോ?",
  "field.breakfast_eaten.label": "പ്രഭാത ഭക്ഷണം കഴിച്ചോ?",
  "field.cycle_length_days.label": "അനിയമിത പീരിയഡ് (>45 ദിവസത്തിന് മേൽ ഇടവേള)?",
  "field.dal_pulses_beans.label": "ദാൽ/പയർവർഗങ്ങൾ/ബീൻസ്",
  "field.deworming_taken.label": "പുഴുവിന് മരുന്ന് (Deworming)",
  "field.diet_type.label": "സാധാരണ ഡയറ്റ് തരം",
  "field.dob.label": "ജനന തീയതി (DOB)",
  "field.egg.label": "മുട്ട",
  "field.fish_chicken_meat.label": "മീൻ / ചിക്കൻ / മാംസം",
  "field.fruits.label": "പഴങ്ങൾ",
  "field.green_leafy_veg.label": "ഇലക്കറി (പാലക്/മേത്തി/അമരാന്ത്)",
  "field.health_bone_or_joint_pain.label": "എല്ല്/സന്ധി വേദന",
  "field.health_breathlessness.label": "പ്രയത്നത്തിൽ ശ്വാസം മുട്ടൽ",
  "field.health_chronic_cough_or_diarrhea.label": "ദീർഘകാല ചുമ അല്ലെങ്കിൽ തുടർച്ചയായ വയറിളക്കം",
  "field.health_dental_or_gum_or_ulcers.label": "പല്ല് പൊള്ളി/കുഴി, മംസത്തിൽ നിന്ന് രക്തം, അല്ലെങ്കിൽ വായിലെ പുണ്ണുകൾ",
  "field.health_fatigue_dizzy_faint.label": "ക്ഷീണം, തലചുറ്റൽ, അല്ലെങ്കിൽ ബോധക്ഷയം",
  "field.health_frequent_infections.label": "തുടർച്ചയായ ഇൻഫെക്ഷൻ (കഴിഞ്ഞ മാസത്തിൽ 3 പ്രാവശ്യം അല്ലെങ്കിൽ അധികം)",
  "field.health_general_poor.label": "പൊതു ആരോഗ്യം നല്ലതല്ല",
  "field.health_night_vision_difficulty.label": "രാത്രി കാഴ്ച പ്രശ്നം (കുറഞ്ഞ വെളിച്ചത്തിൽ ഇടറൽ)",
  "field.health_pallor.label": "വിളർച്ച (കണ്ണിന്റെ ഇമ/കൈപ്പത്തി ഉള്ളിൽ മങ്ങി തോന്നൽ)",
  "field.health_visible_worms.label": "മലത്തിൽ പുഴു കാണുക",
  "field.height_cm_r1.label": "2. ഉയരം (cm)",
  "field.hunger_vital_sign.label": "വിശപ്പ് സംബന്ധിച്ച ചോദ്യം (കഴിഞ്ഞ 12 മാസം)",
  "field.lunch_eaten.label": "സ്കൂളിൽ ഉച്ചഭക്ഷണം കഴിച്ചോ?",
  "field.milk_curd.label": "പാൽ / തൈര്",
  "field.muac_tape_color.label": "3. MUAC ടേപ്പിന്റെ നിറം",
  "field.nuts_groundnuts.label": "കായ്കൾ / വേര്ക്കടല",
  "field.other_vegetables.label": "മറ്റു പച്ചക്കറികൾ",
  "field.pads_per_day.label": "കൂടുതൽ രക്തസ്രാവം (ദിവസം ≥5 പാഡ് നനയുക അല്ലെങ്കിൽ കട്ടകൾ വരുക)?",
  "field.parent_phone_e164.label": "രക്ഷിതാവിന്റെ WhatsApp നമ്പർ",
  "field.sex.label": "ലിംഗം",
  "field.ssb_or_packaged_snacks.label": "പഞ്ചസാര പാനീയങ്ങൾ (SSB) അല്ലെങ്കിൽ പാക്കറ്റ് സ്നാക്സ് കഴിച്ചോ?",
  "field.student_name.label": "വിദ്യാർത്ഥിയുടെ പേര്",
  "field.unique_student_id.label": "യൂണിക് സ്റ്റുഡന്റ് ID",
  "field.weight_kg_r1.label": "1. ഭാരം (kg)",
  "hint.diet_24h": "24 മണിക്കൂർ ഓർമ്മ (ഇന്നലെ): കുട്ടി ഇന്നലെ താഴെ പറയുന്നവ കഴിച്ചോ?",
  "legend.class_assignment": "സ്കൂൾ / ക്ലാസ് / സെക്ഷൻ",
  "legend.girls_only": "കിശോരി പെൺകുട്ടികൾ (വയസ് ≥10 മാത്രം)",
  "legend.section_a": "വിഭാഗം A: വിവരങ്ങൾ",
  "legend.section_b": "വിഭാഗം B: ശരീര അളവുകൾ (Anthropometry)",
  "legend.section_c": "വിഭാഗം C: ഹെൽത്ത് റെഡ് ഫ്ലാഗുകൾ (വേഗം)",
  "legend.section_d": "വിഭാഗം D: ഡയറ്റ് തരം & വൈവിധ്യം",
  "legend.section_e": "വിഭാഗം E: പ്രോഗ്രാം സഹായങ്ങൾ",
  "legend.section_f": "വിഭാഗം F: ഭക്ഷ്യ സുരക്ഷ",
  "option.cycle_length_days.GT_45": "45 ദിവസത്തിന് മേൽ",
  "option.cycle_length_days.LT_45": "45 ദിവസത്തിന് താഴെ",
  "option.diet_type.LACTO_OVO": "( ) ലാക്ടോ-ഓവോ വെജ് (മുട്ട കഴിക്കും)",
  "option.diet_type.LACTO_VEG": "( ) ലാക്ടോ വെജ് (പാൽ/തൈര് കഴിക്കും)",
  "option.diet_type.NON_VEG": "( ) നോൺ-വെജ് (മീൻ/ചിക്കൻ/മാംസം)",
  "option.dont_know": "അറിയില്ല",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ഒരിക്കലും ശരിയല്ല (റെഡ് ഫ്ലാഗ്)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) പലപ്പോഴും ശരി",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) ചിലപ്പോഴൊക്കെ ശരി (റെഡ് ഫ്ലാഗ്)",
  "option.muac_tape_color.GREEN": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: പച്ച",
  "option.muac_tape_color.RED": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: ചുവപ്പ്",
  "option.muac_tape_color.YELLOW": "ചെക്ക് ബോക്സ് - ടേപ്പ് നിറം: മഞ്ഞ",
  "option.no": "ഇല്ല",
  "option.yes": "അതെ"
},
    
    "kn": {
      "option.grade.K.G.": "K.G.",
      "field.menarche_age_years.label": "ಮೊದಲ ಮಾಸಿಕ ಪ್ರಾರಂಭವಾದ ವಯಸ್ಸು (ವರ್ಷಗಳಲ್ಲಿ)",
  "ask.menarche_started": "ನಿಮಗೆ ಮಾಸಿಕ ಪ್ರಾರಂಭವಾಗಿದೆಯೇ?",
  "ask.menarche_age_years": "ಯಾವ ವಯಸ್ಸಿನಲ್ಲಿ ಪ್ರಾರಂಭವಾಯಿತು?",
      "field.menarche_started.label": "ಮಾಸಿಕ ಪ್ರಾರಂಭವಾಗಿದೆಯೇ?",
      "field.grade.label": "ತರಗತಿ",
  "field.division.label": "ವಿಭಾಗ",
  "field.is_low_income.label": "ಕಡಿಮೆ ಆದಾಯದ ಕುಟುಂಬ",
  "field.deworming_date.label": "ಎಷ್ಟು ತಿಂಗಳುಗಳ ಹಿಂದೆ?",
      "page.add_student.heading": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.add_student.browser_title": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.screening.heading_prefix": "ತಪಾಸಣೆ",
  "page.screening.browser_title_prefix": "ತಪಾಸಣೆ",
  "button.create_student_complete_screening": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ರಚಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "button.complete_screening": "ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "button.cancel": "ರದ್ದುಮಾಡಿ",
  "hint.select_dob_first": "ಈ ಫೀಲ್ಡ್ ಸಕ್ರಿಯಗೊಳಿಸಲು ಮೊದಲು ಜನ್ಮ ದಿನಾಂಕವನ್ನು ಆಯ್ಕೆಮಾಡಿ",
      "option.no": "ಇಲ್ಲ",
  "option.sex.F": "ಹುಡುಗಿ",
  "option.sex.M": "ಹುಡುಗ",
  "option.yes": "ಹೌದು",
  "page.add_student.browser_title": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.add_student.heading": "ವಿದ್ಯಾರ್ಥಿಯನ್ನು ಸೇರಿಸಿ ತಪಾಸಣೆ ಪೂರ್ಣಗೊಳಿಸಿ",
  "page.screening.browser_title_prefix": "ತಪಾಸಣೆ",
  "page.screening.heading_prefix": "ತಪಾಸಣೆ",
  "placeholder.select": "ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_age": "ವಯಸ್ಸು ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_division": "ವಿಭಾಗ ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_grade": "ತರಗತಿ ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_months": "ತಿಂಗಳುಗಳನ್ನು ಆಯ್ಕೆಮಾಡಿ",
  "placeholder.select_sex": "ಲಿಂಗ ಆಯ್ಕೆಮಾಡಿ",
  "ui.language.label": "ಭಾಷೆ",
  "age.month_plural": "ತಿಂಗಳುಗಳು",
  "age.month_singular": "ತಿಂಗಳು",
  "age.year_plural": "ವರ್ಷಗಳು",
  "age.year_singular": "ವರ್ಷ",
  "ask.bleeding_clots": "ಡ್ರಾಪ್‌ಡೌನ್ ಹೌದು/ಇಲ್ಲ - ರಕ್ತಸ್ರಾವವಾಗುವಾಗ ಗಟ್ಟೆಗಳು (clots) ಬರುತ್ತವೆಯೇ?",
  "ask.breakfast_eaten": "ನೀ ಬೆಳಗಿನ ತಿಂಡಿ ತಿಂದೆಯಾ?",
  "ask.cycle_length_days": "ಡ್ರಾಪ್‌ಡೌನ್ - 45 ದಿನಕ್ಕಿಂತ ಕಡಿಮೆ / 45 ದಿನಕ್ಕಿಂತ ಹೆಚ್ಚು - ಪೀರಿಯಡ್ಸ್ ಮತ್ತೆ ಎಷ್ಟು ದಿನಗಳ ನಂತರ ಬರುತ್ತದೆ?",
  "ask.dal_pulses_beans": "ನೀ ನಿನ್ನೆ ದಾಲ್/ಬೇಳೆ/ಬೀನ್ಸ್ ತಿಂದೆಯಾ?",
  "ask.deworming_taken": "ಹುಳುಮಾತ್ರೆಯ ದೊಡ್ಡ ಗೊಳಿಗೆಯನ್ನು ತೆಗೆದುಕೊಂಡೆಯಾ?",
  "ask.diet_type.LACTO_OVO": "ಮನೆಯಲ್ಲಿ ಮೊಟ್ಟೆ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.diet_type.LACTO_VEG": "ಮನೆಯಲ್ಲಿ ಹಾಲು ಕುಡಿಯುತ್ತೀಯಾ ಅಥವಾ ಮೊಸರು/ಪನೀರ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.diet_type.NON_VEG": "ಮನೆಯಲ್ಲಿ ಮೀನು, ಚಿಕನ್ ಅಥವಾ ಮಟನ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "ask.egg": "ನೀ ನಿನ್ನೆ ಮೊಟ್ಟೆ ತಿಂದೆಯಾ?",
  "ask.fish_chicken_meat": "ಕಳೆದ 3 ದಿನಗಳಲ್ಲಿ ನೀ ಮೀನು/ಚಿಕನ್/ಮಾಂಸ ತಿಂದೆಯಾ?",
  "ask.fruits": "ನೀ ನಿನ್ನೆ ಹಣ್ಣು ತಿಂದೆಯಾ?",
  "ask.green_leafy_veg": "ನಿನ್ನ ಕೊನೆಯ ಊಟದಲ್ಲಿ ಸೊಪ್ಪು/ಹಸಿರು ಎಲೆ ತರಕಾರಿ ತಿಂದೆಯಾ?",
  "ask.health_bone_or_joint_pain": "ಗಾಯವಾಗದೆ ಮತ್ತು ಹೆಚ್ಚಾಗಿ ಆಟ/ಕೆಲಸ ಮಾಡದೇ ಇದ್ದರೂ ಕೈ/ಕಾಲು/ಸಂಧಿಗಳಲ್ಲಿ ನೋವು ಇದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_breathlessness": "ಸಾಮಾನ್ಯ ಕೆಲಸ ಮಾಡುವಾಗ ಅಥವಾ ಸಾಮಾನ್ಯವಾಗಿ ನಡೆಯುವಾಗ ಉಸಿರಾಟ ಕಷ್ಟವಾಗುತ್ತದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_chronic_cough_or_diarrhea": "ಮಗುಗೆ ಕೆಮ್ಮು ಇದೆಯೇ ಮತ್ತು ಅದು 4 ವಾರಗಳಿಗಿಂತ ಹೆಚ್ಚು ಮುಂದುವರಿದಿದೆಯೇ? ಅಥವಾ ಲೂಸ್ ಮೋಶನ್ 2 ವಾರಗಳಿಗಿಂತ ಹೆಚ್ಚು ಮುಂದುವರಿದಿದೆಯೇ?",
  "ask.health_dental_or_gum_or_ulcers": "ಹಲ್ಲು ನೋವು, ಹಲ್ಲುಮಾಂಸ ರಕ್ತಸ್ರಾವ, ಅಥವಾ ಬಾಯಿಯಲ್ಲಿ ಹುಣ್ಣುಗಳಿವೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_fatigue_dizzy_faint": "ಸಾಮಾನ್ಯ ಕೆಲಸ/ಆಟ ಮಾಡುವಾಗ ಎಂದಾದರೂ ಮೂರ್ಚೆ ಬಂದಿತ್ತೇ, ಅಥವಾ ರೂಟಿನ್ ಕೆಲಸ/ಆಟ ಮಾಡಲು ತುಂಬಾ ದಣಿವಾಗುತ್ತದೆಯೇ ಎಂದು ಕೇಳಿ.",
  "ask.health_frequent_infections": "ಮಗು ತುಂಬಾ ಸಲ ಅನಾರೋಗ್ಯವಾಗುತ್ತದೆಯೇ? ಕಳೆದ ತಿಂಗಳಲ್ಲಿ 3 ಬಾರಿ ಅಥವಾ ಹೆಚ್ಚು ಅಸ್ವಸ್ಥವಾಗಿತ್ತೇ?",
  "ask.health_general_poor": "ಮಗುಗೆ ಕೇಳಿ: ನೀನು ನಿನ್ನನ್ನು ಆರೋಗ್ಯವಾಗಿಯೇ ಅನಿಸುತ್ತಿದೆಯಾ?",
  "ask.health_night_vision_difficulty": "ಕತ್ತಲೆಯಲ್ಲಿ ಸರಿಯಾಗಿ ಕಾಣದೆ ನಡೆಯುವಾಗ ಅಡ್ಡಬೀಳುತ್ತೀಯಾ ಎಂದು ಕೇಳಿ.",
  "ask.health_pallor": "ಮಗುವಿಗೆ ಬಿಳಿಬಣ್ಣ/ವಿಳರ್ಚೆ (pallor) ಇದೆಯೇ?",
  "ask.health_visible_worms": "ಮಲದಲ್ಲಿ ಚಿಕ್ಕ ಹುಳುಗಳು ಕಂಡಿದ್ದೀಯಾ ಎಂದು ಕೇಳಿ.",
  "ask.lunch_eaten": "ನೀ ಮಧ್ಯಾಹ್ನ ಊಟ ತಿಂದೆಯಾ?",
  "ask.milk_curd": "ನೀ ನಿನ್ನೆ ಹಾಲು ಕುಡಿದೆಯಾ ಅಥವಾ ಮೊಸರು ತಿಂದೆಯಾ?",
  "ask.nuts_groundnuts": "ನೀ ನಿನ್ನೆ ಕಾಯಿ/ಕಡಲೆಕಾಯಿ ತಿಂದೆಯಾ?",
  "ask.other_vegetables": "ನಿನ್ನ ಕೊನೆಯ ಊಟದಲ್ಲಿ ಬೇರೆ ಯಾವುದಾದರೂ ತರಕಾರಿ ತಿಂದೆಯಾ?",
  "ask.pads_per_day": "ಡ್ರಾಪ್‌ಡೌನ್ 1-10 - ಹೆಚ್ಚಿನ ರಕ್ತಸ್ರಾವದ ದಿನಗಳಲ್ಲಿ ದಿನಕ್ಕೆ ಎಷ್ಟು ಪ್ಯಾಡ್ ಬೇಕಾಗುತ್ತದೆ ಎಂದು ಮಗುವಿಗೆ ಕೇಳಿ.",
  "ask.ssb_or_packaged_snacks": "ನೀ ಕೋಕಾಕೋಲಾ, ಪೆಪ್ಸಿ, ಮಿರಿಂಡಾ, ಫಾಂಟಾ, ಲಿಮ್ಕಾ ಹಾಗೆ ಸಾಫ್ಟ್ ಡ್ರಿಂಕ್ಸ್ ಕುಡಿಯುತ್ತೀಯಾ? ಮನೆಯಲ್ಲಿ ಮಾಡದ ಹಣ್ಣು ಜ್ಯೂಸ್ ಕುಡಿಯುತ್ತೀಯಾ? ಬಿಸ್ಕಟ್, ಚಾಕ್ಲೇಟ್, ಚಿಪ್ಸ್, ಕೇಕ್ ಹಾಗೆ ಸ್ನ್ಯಾಕ್ಸ್ ತಿನ್ನುತ್ತೀಯಾ?",
  "field.appetite.label": "ಭೂಕು/ಆಹಾರ ಇಷ್ಟ",
  "field.bleeding_clots.label": "ಡ್ರಾಪ್‌ಡೌನ್ ಹೌದು/ಇಲ್ಲ - ರಕ್ತಸ್ರಾವವಾಗುವಾಗ ಗಟ್ಟೆಗಳು (clots) ಬರುತ್ತವೆಯೇ?",
  "field.breakfast_eaten.label": "ಬೆಳಗಿನ ತಿಂಡಿ ತಿಂದೆಯಾ?",
  "field.cycle_length_days.label": "ಅನಿಯಮಿತ ಪೀರಿಯಡ್ಸ್ (>45 ದಿನಗಳಿಗಿಂತ ಹೆಚ್ಚು ಗ್ಯಾಪ್)?",
  "field.dal_pulses_beans.label": "ದಾಲ್ / ಬೇಳೆ / ಬೀನ್ಸ್",
  "field.deworming_taken.label": "ಹುಳು ಮಾತ್ರೆ (Deworming)",
  "field.diet_type.label": "ಸಾಧಾರಣ ಆಹಾರ ಪ್ರಕಾರ",
  "field.dob.label": "ಜನ್ಮ ದಿನಾಂಕ (DOB)",
  "field.egg.label": "ಮೊಟ್ಟೆ",
  "field.fish_chicken_meat.label": "ಮೀನು / ಚಿಕನ್ / ಮಾಂಸ",
  "field.fruits.label": "ಹಣ್ಣುಗಳು",
  "field.green_leafy_veg.label": "ಹಸಿರು ಎಲೆ ತರಕಾರಿ (ಪಾಲಕ್/ಮೆಂತ್ಯೆ/ಅಮರಾಂತ್)",
  "field.health_bone_or_joint_pain.label": "ಎಲುಬು ಅಥವಾ ಸಂಧಿ ನೋವು",
  "field.health_breathlessness.label": "ಪ್ರಯತ್ನದಲ್ಲಿ ಉಸಿರಾಟ ತೊಂದರೆ",
  "field.health_chronic_cough_or_diarrhea.label": "ದೀರ್ಘಕಾಲದ ಕೆಮ್ಮು ಅಥವಾ ಅತಿಸಾರ",
  "field.health_dental_or_gum_or_ulcers.label": "ಹಲ್ಲು ಕುಳು (ಕ್ಯಾವಿಟಿ), ಹಲ್ಲುಮಾಂಸದಿಂದ ರಕ್ತ, ಅಥವಾ ಬಾಯಿಯಲ್ಲಿ ಹುಣ್ಣು",
  "field.health_fatigue_dizzy_faint.label": "ದಣಿವು, ತಲೆಸುತ್ತು, ಅಥವಾ ಮೂರ್ಚೆ",
  "field.health_frequent_infections.label": "ಮರುಮರು ಇನ್ಫೆಕ್ಷನ್ (ಕಳೆದ ತಿಂಗಳಲ್ಲಿ 3 ಬಾರಿ ಅಥವಾ ಹೆಚ್ಚು)",
  "field.health_general_poor.label": "ಸಾಮಾನ್ಯ ಆರೋಗ್ಯ ಚೆನ್ನಾಗಿಲ್ಲ",
  "field.health_night_vision_difficulty.label": "ರಾತ್ರಿ ಕಾಣುವಲ್ಲಿ ತೊಂದರೆ (ಕಡಿಮೆ ಬೆಳಕಿನಲ್ಲಿ ಅಡ್ಡಬೀಳುವುದು)",
  "field.health_pallor.label": "ವಿಳರ್ಚೆ (ಕಣ್ತುಪ್ಪು/ಕೈತಳದಲ್ಲಿ ಬಿಳಿಬಣ್ಣ)",
  "field.health_visible_worms.label": "ಮಲದಲ್ಲಿ ಹುಳು ಕಾಣುವುದು",
  "field.height_cm_r1.label": "2. ಎತ್ತರ (cm)",
  "field.hunger_vital_sign.label": "ಹಸಿವು ಪ್ರಶ್ನೆ (ಕಳೆದ 12 ತಿಂಗಳು)",
  "field.lunch_eaten.label": "ಶಾಲೆಯಲ್ಲಿ ಮಧ್ಯಾಹ್ನ ಊಟ ತಿಂದೆಯಾ?",
  "field.milk_curd.label": "ಹಾಲು / ಮೊಸರು",
  "field.muac_tape_color.label": "3. MUAC ಟೇಪ್‌ನ ಬಣ್ಣ",
  "field.nuts_groundnuts.label": "ಕಾಯಿ / ಕಡಲೆಕಾಯಿ",
  "field.other_vegetables.label": "ಇತರೆ ತರಕಾರಿಗಳು",
  "field.pads_per_day.label": "ಹೆಚ್ಚು ರಕ್ತಸ್ರಾವ (ದಿನಕ್ಕೆ ≥5 ಪ್ಯಾಡ್ ಅಥವಾ ಗಟ್ಟೆಗಳು)?",
  "field.parent_phone_e164.label": "ಪೋಷಕರ WhatsApp ನಂಬರ್",
  "field.sex.label": "ಲಿಂಗ",
  "field.ssb_or_packaged_snacks.label": "ಸಿಹಿ ಪಾನೀಯಗಳು (SSB) ಅಥವಾ ಪ್ಯಾಕೆಟ್ ಸ್ನ್ಯಾಕ್ಸ್ ತಿಂದೆಯಾ?",
  "field.student_name.label": "ವಿದ್ಯಾರ್ಥಿಯ ಹೆಸರು",
  "field.unique_student_id.label": "ಯೂನಿಕ್ ಸ್ಟುಡೆಂಟ್ ID",
  "field.weight_kg_r1.label": "1. ತೂಕ (kg)",
  "hint.diet_24h": "24-ಗಂಟೆಗಳ ನೆನಪು (ನಿನ್ನೆ): ಮಗು ನಿನ್ನೆ ಕೆಳಗಿನವುಗಳನ್ನು ತಿಂದಿತೇ?",
  "legend.class_assignment": "ಶಾಲೆ / ತರಗತಿ / ವಿಭಾಗ",
  "legend.girls_only": "ಕಿಶೋರಿ ಬಾಲಕಿಯರು (ವಯಸ್ಸು ≥10 ಮಾತ್ರ)",
  "legend.section_a": "ವಿಭಾಗ A: ವಿವರಗಳು",
  "legend.section_b": "ವಿಭಾಗ B: ದೇಹದ ಅಳತೆಗಳು (Anthropometry)",
  "legend.section_c": "ವಿಭಾಗ C: ತ್ವರಿತ ಆರೋಗ್ಯ ರೆಡ್ ಫ್ಲ್ಯಾಗ್ಸ್",
  "legend.section_d": "ವಿಭಾಗ D: ಆಹಾರ ಪ್ರಕಾರ & ವೈವಿಧ್ಯ",
  "legend.section_e": "ವಿಭಾಗ E: ಪ್ರೋಗ್ರಾಂ ಬೆಂಬಲ",
  "legend.section_f": "ವಿಭಾಗ F: ಆಹಾರ ಭದ್ರತೆ",
  "option.cycle_length_days.GT_45": "45 ದಿನಕ್ಕಿಂತ ಹೆಚ್ಚು",
  "option.cycle_length_days.LT_45": "45 ದಿನಕ್ಕಿಂತ ಕಡಿಮೆ",
  "option.diet_type.LACTO_OVO": "( ) ಲ್ಯಾಕ್ಟೋ-ಓವೋ ವೆಜ್ (ಮೊಟ್ಟೆ ತಿನ್ನುತ್ತಾರೆ)",
  "option.diet_type.LACTO_VEG": "( ) ಲ್ಯಾಕ್ಟೋ ವೆಜ್ (ಹಾಲು/ಮೊಸರು ತೆಗೆದುಕೊಳ್ಳುತ್ತಾರೆ)",
  "option.diet_type.NON_VEG": "( ) ನಾನ್-ವೆಜ್ (ಮೀನು/ಚಿಕನ್/ಮಾಂಸ)",
  "option.dont_know": "ಗೊತ್ತಿಲ್ಲ",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) ಎಂದಿಗೂ ಸರಿ ಇಲ್ಲ (ರೆಡ್ ಫ್ಲ್ಯಾಗ್)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) ಹೆಚ್ಚಾಗಿ ಸರಿ",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) ಕೆಲವೊಮ್ಮೆ ಸರಿ (ರೆಡ್ ಫ್ಲ್ಯಾಗ್)",
  "option.muac_tape_color.GREEN": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಹಸಿರು",
  "option.muac_tape_color.RED": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಕೆಂಪು",
  "option.muac_tape_color.YELLOW": "ಚೆಕ್‌ಬಾಕ್ಸ್ - ಟೇಪ್ ಬಣ್ಣ: ಹಳದಿ",
},

"bn": {
  "option.grade.K.G.": "K.G.",
  "field.grade.label": "শ্রেণি",
  "field.division.label": "বিভাগ",
  "field.is_low_income.label": "নিম্ন আয়ের পরিবার",
  "field.deworming_date.label": "কয় মাস আগে?",
  "page.add_student.heading": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.add_student.browser_title": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.screening.heading_prefix": "স্ক্রিনিং",
  "page.screening.browser_title_prefix": "স্ক্রিনিং",
  "button.create_student_complete_screening": "শিক্ষার্থী তৈরি করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "button.complete_screening": "স্ক্রিনিং সম্পন্ন করুন",
  "button.cancel": "বাতিল করুন",
  "hint.select_dob_first": "এই ফিল্ডটি সক্রিয় করতে আগে জন্ম তারিখ নির্বাচন করুন",
  "option.no": "না",
  "option.yes": "হ্যাঁ",
  "page.add_student.browser_title": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.add_student.heading": "শিক্ষার্থী যোগ করুন এবং স্ক্রিনিং সম্পন্ন করুন",
  "page.screening.browser_title_prefix": "স্ক্রিনিং",
  "page.screening.heading_prefix": "স্ক্রিনিং",
  "placeholder.select": "নির্বাচন করুন",
  "placeholder.select_age": "বয়স নির্বাচন করুন",
  "placeholder.select_division": "বিভাগ নির্বাচন করুন",
  "placeholder.select_grade": "শ্রেণি নির্বাচন করুন",
  "placeholder.select_months": "মাস নির্বাচন করুন",
  "placeholder.select_sex": "লিঙ্গ নির্বাচন করুন",
  "ui.language.label": "ভাষা",
  "age.month_plural": "মাস",
  "age.month_singular": "মাস",
  "age.year_plural": "বছর",
  "age.year_singular": "বছর",
  "legend.section_a": "সেকশন A: বিবরণ",
  "legend.section_b": "সেকশন B: শরীরের মাপ (Anthropometry)",
  "legend.section_c": "সেকশন C: দ্রুত স্বাস্থ্য রেড ফ্ল্যাগ",
  "legend.section_d": "সেকশন D: ডায়েটের ধরন ও বৈচিত্র্য",
  "legend.section_e": "সেকশন E: প্রোগ্রাম সহায়তা",
  "legend.section_f": "সেকশন F: খাদ্য নিরাপত্তা",
  "legend.girls_only": "কিশোরী মেয়েরা (বয়স ≥10 শুধু)",
  "legend.class_assignment": "স্কুল / ক্লাস / সেকশন",

  "field.student_name.label": "শিক্ষার্থীর নাম",
  "field.unique_student_id.label": "ইউনিক স্টুডেন্ট ID",
  "field.dob.label": "জন্মতারিখ (DOB)",
  "field.sex.label": "লিঙ্গ",
  "field.parent_phone_e164.label": "অভিভাবকের WhatsApp নম্বর",

  "field.weight_kg_r1.label": "1. ওজন (kg)",
  "field.height_cm_r1.label": "2. উচ্চতা (cm)",
  "field.muac_tape_color.label": "3. MUAC টেপের রং",

  "option.muac_tape_color.RED": "চেকবক্স - টেপের রং: লাল",
  "option.muac_tape_color.YELLOW": "চেকবক্স - টেপের রং: হলুদ",
  "option.muac_tape_color.GREEN": "চেকবক্স - টেপের রং: সবুজ",

  "field.health_general_poor.label": "সাধারণ স্বাস্থ্য ভালো নয়",
  "ask.health_general_poor": "শিশুকে জিজ্ঞেস করুন: তুমি কি নিজেকে সুস্থ মনে করো?",

  "field.health_pallor.label": "ফ্যাকাশে ভাব (চোখের পাতা/হাতের তালুর ভেতরে ফ্যাকাশে)",
  "ask.health_pallor": "শিশুর ফ্যাকাশে ভাব (pallor) আছে কি?",

  "field.health_fatigue_dizzy_faint.label": "ক্লান্তি, মাথা ঘোরা, বা অজ্ঞান হওয়া",
  "ask.health_fatigue_dizzy_faint": "স্বাভাবিক কাজ/খেলার সময় কখনো অজ্ঞান হয়েছ কি না, বা স্বাভাবিক কাজ/খেলা করতে খুব বেশি ক্লান্ত লাগে কি না জিজ্ঞেস করুন।",

  "field.health_breathlessness.label": "পরিশ্রমে শ্বাসকষ্ট",
  "ask.health_breathlessness": "সাধারণ কাজ করতে বা স্বাভাবিকভাবে হাঁটলে কি শ্বাসকষ্ট হয়—এটা জিজ্ঞেস করুন।",

  "field.health_frequent_infections.label": "ঘন ঘন ইনফেকশন (গত মাসে ৩ বার বা বেশি)",
  "ask.health_frequent_infections": "শিশুটি কি খুব ঘন ঘন অসুস্থ হয়? গত মাসে ৩ বার বা তার বেশি অসুস্থ হয়েছিল কি?",

  "field.health_chronic_cough_or_diarrhea.label": "দীর্ঘদিনের কাশি বা ডায়রিয়া",
  "ask.health_chronic_cough_or_diarrhea": "শিশুর কি কাশি আছে এবং তা কি গত ৪ সপ্তাহ বা তার বেশি সময় ধরে আছে? অথবা পাতলা পায়খানা (লুজ মোশন) কি ২ সপ্তাহের বেশি চলছে?",

  "field.health_visible_worms.label": "মলে কৃমি দেখা যাওয়া",
  "ask.health_visible_worms": "মলে কখনো ছোট কৃমি/পোকা দেখেছ কি না জিজ্ঞেস করুন।",

  "field.health_dental_or_gum_or_ulcers.label": "দাঁতের ক্ষয়/ক্যাভিটি, মাড়ি থেকে রক্ত, বা মুখে ঘা",
  "ask.health_dental_or_gum_or_ulcers": "দাঁত ব্যথা, মাড়ি থেকে রক্ত পড়া, বা মুখে ঘা আছে কি না জিজ্ঞেস করুন।",

  "field.health_night_vision_difficulty.label": "রাতে দেখতে সমস্যা (কম আলোতে হোঁচট খাওয়া)",
  "ask.health_night_vision_difficulty": "অন্ধকারে ঠিকমতো না দেখায় হাঁটার সময় হোঁচট খাও কি না জিজ্ঞেস করুন।",

  "field.health_bone_or_joint_pain.label": "হাড় বা জয়েন্টে ব্যথা",
  "ask.health_bone_or_joint_pain": "চোট না লাগলেও আর বেশি খেলাধুলা/কাজ না করলেও হাত/পা/জয়েন্টে ব্যথা হয় কি না জিজ্ঞেস করুন।",

  "field.appetite.label": "খিদে",

  "field.menarche_started.label": "পিরিয়ড/মাসিক শুরু হয়েছে কি?",
  "ask.menarche_started": "চেকবক্স - মেয়েটির পিরিয়ড/মাসিক শুরু হয়েছে কি না জিজ্ঞেস করুন।",

  "field.menarche_age_years.label": "প্রথম পিরিয়ডের বয়স (বছর)",
  "ask.menarche_age_years": "বয়স ড্রপডাউন (বছর) - মাসিক/পিরিয়ড কত বয়সে শুরু হয়েছে? জিজ্ঞেস করুন।",

  "field.pads_per_day.label": "অতিরিক্ত ব্লিডিং (দিনে ≥৫টি প্যাড ভিজে যাওয়া বা জমাট/ক্লটস পড়া)?",
  "ask.pads_per_day": "ড্রপডাউন 1-10 - বেশি ব্লিডিংয়ের দিনে দিনে কতগুলো প্যাড লাগে, শিশুটিকে জিজ্ঞেস করুন।",

  "field.bleeding_clots.label": "ড্রপডাউন হ্যাঁ/না - ব্লিডিংয়ের সময় জমাট (clots) পড়ে কি?",
  "ask.bleeding_clots": "ড্রপডাউন হ্যাঁ/না - ব্লিডিংয়ের সময় জমাট (clots) পড়ে কি?",

  "field.cycle_length_days.label": "অনিয়মিত পিরিয়ড (>৪৫ দিনের বেশি বিরতি)?",
  "ask.cycle_length_days": "ড্রপডাউন - ৪৫ দিনের কম / ৪৫ দিনের বেশি - পিরিয়ড আবার কত দিন পর হয়?",

  "field.diet_type.label": "সাধারণত ডায়েটের ধরন",
  "option.diet_type.LACTO_VEG": "( ) ল্যাক্টো ভেজ (দুধ/দই খায়)",
  "ask.diet_type.LACTO_VEG": "বাড়িতে দুধ খাও বা দই/পনির খাও কি?",
  "option.diet_type.LACTO_OVO": "( ) ল্যাক্টো-ওভো ভেজ (ডিম খায়)",
  "ask.diet_type.LACTO_OVO": "বাড়িতে ডিম খাও কি?",
  "option.diet_type.NON_VEG": "( ) নন-ভেজ (মাছ/চিকেন/মাংস)",
  "ask.diet_type.NON_VEG": "বাড়িতে মাছ, চিকেন বা মাটন খাও কি?",

  "hint.diet_24h": "২৪ ঘণ্টার স্মরণ (গতকাল): শিক্ষার্থী কি গতকাল নিচের খাবারগুলো খেয়েছিল?",

  "field.breakfast_eaten.label": "নাশতা খেয়েছ?",
  "ask.breakfast_eaten": "তুমি কি নাশতা খেয়েছ?",

  "field.lunch_eaten.label": "স্কুলে দুপুরের খাবার/লাঞ্চ খেয়েছ?",
  "ask.lunch_eaten": "তুমি কি দুপুরের খাবার/লাঞ্চ খেয়েছ?",

  "field.green_leafy_veg.label": "পাতা শাক (পালং/মেথি/আমরান্থ)",
  "ask.green_leafy_veg": "তোমার শেষ খাবারে শাকসবজি (পাতা শাক) খেয়েছ কি?",

  "field.other_vegetables.label": "অন্যান্য সবজি",
  "ask.other_vegetables": "তোমার শেষ খাবারে অন্য কোনো সবজি খেয়েছ কি?",

  "field.fruits.label": "ফল",
  "ask.fruits": "তুমি কি গতকাল ফল খেয়েছ?",

  "field.dal_pulses_beans.label": "ডাল / ডালজাতীয় / বিনস",
  "ask.dal_pulses_beans": "তুমি কি গতকাল ডাল/ডালজাতীয়/বিনস খেয়েছ?",

  "field.milk_curd.label": "দুধ / দই",
  "ask.milk_curd": "তুমি কি গতকাল দুধ খেয়েছ বা দই খেয়েছ?",

  "field.egg.label": "ডিম",
  "ask.egg": "তুমি কি গতকাল ডিম খেয়েছ?",

  "field.fish_chicken_meat.label": "মাছ / চিকেন / মাংস",
  "ask.fish_chicken_meat": "গত ৩ দিনে তুমি কি মাছ/চিকেন/মাংস খেয়েছ?",

  "field.nuts_groundnuts.label": "বাদাম / চিনাবাদাম",
  "ask.nuts_groundnuts": "তুমি কি গতকাল বাদাম/চিনাবাদাম খেয়েছ?",

  "field.ssb_or_packaged_snacks.label": "চিনি দেওয়া পানীয় (SSB) বা প্যাকেট স্ন্যাকস খেয়েছ?",
  "ask.ssb_or_packaged_snacks": "তুমি কি কোকা কোলা, পেপসি, মিরিন্ডা, ফ্যান্টা, লিমকা ইত্যাদি সফট ড্রিংকস খাও? বাড়িতে বানানো নয় এমন ফলের জুস খাও? বিস্কুট, চকলেট, চিপস, কেক ইত্যাদি স্ন্যাকস খাও?",

  "field.deworming_taken.label": "কৃমিনাশক (Deworming)",
  "ask.deworming_taken": "কৃমিনাশকের বড় ট্যাবলেটটা নিয়েছ কি?",

  "option.dont_know": "জানি না",

  "field.hunger_vital_sign.label": "ক্ষুধা সম্পর্কিত প্রশ্ন (গত ১২ মাস)",
  "option.hunger_vital_sign.OFTEN_TRUE": "( ) বেশিরভাগ সময় সত্য",
  "option.hunger_vital_sign.SOMETIMES_TRUE": "( ) কখনো কখনো সত্য (রেড ফ্ল্যাগ)",
  "option.hunger_vital_sign.NEVER_TRUE": "( ) কখনোই সত্য নয় (রেড ফ্ল্যাগ)",

  "option.sex.M": "ছেলে",
  "option.sex.F": "মেয়ে",

  "option.cycle_length_days.LT_45": "৪৫ দিনের কম",
  "option.cycle_length_days.GT_45": "৪৫ দিনের বেশি"
},

    
    /* --------------------------------------------------------------------------------
       IMPORTANT:
       The remaining 7 languages (mr, hi, te, ta, ml, kn, bn) are required.
       They are large (~120 keys each) and must be pasted exactly.

       I have prepared them from your uploaded spreadsheet,
       but the tool session ended before I could print the entire JSON here.

       ✅ NEXT STEP FOR YOU:
       I will provide the full 8-language JSON block in the next message if you want,
       OR you can tell me to output only mr/hi first, then continue in chunks.

       For now this file must contain ALL 8 languages to meet your requirement.
    -------------------------------------------------------------------------------- */
  };

  function safeGetLang() {
    var sel = document.getElementById("language-select");
    return sel && sel.value ? sel.value : "en";
  }
  

  function safeSetLang(lang) {
    // Disabled: do not save language
  }

  function t(key, langOverride) {
    const lang = langOverride || safeGetLang();
    return (I18N[lang] && I18N[lang][key]) || (I18N.en && I18N.en[key]) || "";
  }

  function setLabelTextPreserveInput(label, input, text) {
    if (!label) return;
    if (input && label.contains(input)) {
      Array.from(label.childNodes).forEach((n) => {
        if (n !== input) label.removeChild(n);
      });
      label.appendChild(document.createTextNode(" " + text));
    } else {
      label.textContent = text;
    }
  }

  function translateSelect(name, map, lang) {
    document.querySelectorAll(`select[name="${name}"]`).forEach((sel) => {
      Array.from(sel.options).forEach((opt) => {
        if (opt.value === "" && map.__empty__) opt.textContent = map.__empty__;
        else if (map[opt.value] != null) opt.textContent = map[opt.value];
      });
    });
  }

  function translateRadio(name, map) {
    document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach((input) => {
      const val = input.value;
      const text = map[val];
      if (!text) return;

      let label = input.closest("label");
      if (!label && input.id) label = document.querySelector(`label[for="${input.id}"]`);
      setLabelTextPreserveInput(label, input, text);
    });
  }

  function translateYesNoProxy(lang) {
    document.querySelectorAll("select.yn-proxy").forEach((sel) => {
      Array.from(sel.options).forEach((opt) => {
        if (opt.value === "") opt.textContent = t("placeholder.select", lang);
        if (opt.value === "yes") opt.textContent = t("option.yes", lang);
        if (opt.value === "no") opt.textContent = t("option.no", lang);
      });
    });
  }

  function translateBoolSelects(lang) {
    const boolSelectFields = [
      "breakfast_eaten",
      "lunch_eaten",
      "green_leafy_veg",
      "other_vegetables",
      "fruits",
      "dal_pulses_beans",
      "milk_curd",
      "egg",
      "fish_chicken_meat",
      "nuts_groundnuts",
      "ssb_or_packaged_snacks",
      "menarche_started",
      "bleeding_clots"
    ];

    boolSelectFields.forEach((f) => {
      translateSelect(f, {
        __empty__: t("placeholder.select", lang),
        yes: t("option.yes", lang),
        no: t("option.no", lang)
      }, lang);
    });
  }

  function translateCycleLength(lang) {
    translateSelect("cycle_length_days", {
      __empty__: t("placeholder.select", lang),
      LT_45: t("option.cycle_length_days.LT_45", lang),
      GT_45: t("option.cycle_length_days.GT_45", lang)
    }, lang);
  }

  function translateDewormingMonths(lang) {
    const one = t("age.month_singular", lang);
    const many = t("age.month_plural", lang);

    const map = { __empty__: t("placeholder.select_months", lang) };
    for (let i = 1; i <= 12; i++) {
      map[String(i)] = `${i} ${i === 1 ? one : many}`;
    }
    translateSelect("deworming_date", map, lang);
  }

  function apply(lang) {
    document.documentElement.lang = lang;

    document.querySelectorAll("[data-i18n]").forEach((el) => {
      const key = el.getAttribute("data-i18n");
      const val = t(key, lang);
      if (val) el.textContent = val;
    });

    // Title handling (screening page includes student name dynamically)
    const page = document.body && document.body.getAttribute("data-page");
    if (page === "add_student") {
      document.title = t("page.add_student.browser_title", lang);
    } else if (page === "screening_form") {
      const name = document.body.getAttribute("data-student-name") || "";
      const prefix = t("page.screening.browser_title_prefix", lang) || t("page.screening.heading_prefix", lang) || "";
      document.title = name ? `${prefix} – ${name}` : prefix;
    }

    // Choices / options
    translateSelect("sex", {
      __empty__: t("placeholder.select_sex", lang),
      M: t("option.sex.M", lang),
      F: t("option.sex.F", lang)
    }, lang);

    translateSelect("grade", {
      __empty__: t("placeholder.select_grade", lang),
      Nursery: t("option.grade.Nursery", lang),
      "K.G.": t("option.grade.K.G.", lang),
      Other: t("option.grade.Other", lang)
    }, lang);

    translateSelect("division", { __empty__: t("placeholder.select_division", lang) }, lang);
    translateSelect("menarche_age_years", {
      __empty__: t("placeholder.select_age", lang)
    }, lang);
    translateSelect("pads_per_day", {
      __empty__: t("placeholder.select", lang)
    }, lang);
    translateRadio("muac_tape_color", {
      RED: t("option.muac_tape_color.RED", lang),
      YELLOW: t("option.muac_tape_color.YELLOW", lang),
      GREEN: t("option.muac_tape_color.GREEN", lang)
    });

    translateRadio("diet_type", {
      LACTO_VEG: t("option.diet_type.LACTO_VEG", lang),
      LACTO_OVO: t("option.diet_type.LACTO_OVO", lang),
      NON_VEG: t("option.diet_type.NON_VEG", lang)
    });

    translateRadio("appetite", {
      yes: t("option.yes", lang),
      no: t("option.no", lang)
    });

    translateRadio("deworming_taken", {
      yes: t("option.yes", lang),
      no: t("option.no", lang),
      dont_know: t("option.dont_know", lang)
    });

    translateRadio("hunger_vital_sign", {
      OFTEN_TRUE: t("option.hunger_vital_sign.OFTEN_TRUE", lang),
      SOMETIMES_TRUE: t("option.hunger_vital_sign.SOMETIMES_TRUE", lang),
      NEVER_TRUE: t("option.hunger_vital_sign.NEVER_TRUE", lang)
    });

    translateYesNoProxy(lang);
    translateBoolSelects(lang);
    translateCycleLength(lang);
    translateDewormingMonths(lang);

    // retrigger DOB change to reformat age string if page script listens to it
    const dob = document.querySelector('input[name="dob"]');
    if (dob) dob.dispatchEvent(new Event("change", { bubbles: true }));
  }

  // Export a small API used by template JS (division placeholder, formatAge fallback)
  window.NUTRILIFT_I18N = {
    getLang: safeGetLang,
    setLang: safeSetLang,
    t: (key) => t(key, safeGetLang()),
    apply: () => apply(safeGetLang()),
    formatAge: function (months) {
      const lang = safeGetLang();
      if (months == null || isNaN(months)) return "";
      const years = Math.floor(months / 12);
      const rem = months % 12;

      const y1 = t("age.year_singular", lang);
      const yN = t("age.year_plural", lang);
      const m1 = t("age.month_singular", lang);
      const mN = t("age.month_plural", lang);

      if (years <= 0) return `${rem} ${rem === 1 ? m1 : mN}`;
      return `${years} ${years === 1 ? y1 : yN} ${rem} ${rem === 1 ? m1 : mN}`;
    }
  };

  document.addEventListener("DOMContentLoaded", function () {
    const sel = document.getElementById("language-select");
    const current = safeGetLang();

    if (sel) {
      sel.value = current;
      sel.addEventListener("change", function () {
        safeSetLang(sel.value);
        apply(sel.value);
      });
    }

    apply(current);
  });
})();

  </script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 980px; margin: 0 auto; }
    .langbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin: 8px 0 14px 0;
    }
    .langbar .lang-label {
      font-size: 13px;
      color: #222;
      font-weight: 600;
    }
    .langbar select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e8e8e8;
      background: #fafafa;
      font-size: 14px;
    }
    h2 { margin: 0 0 4px 0; }
    .muted { color: #666; font-size: 14px; margin: 4px 0 0 0; }
    form { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; }

    fieldset { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin: 14px 0; }
    legend { padding: 0 8px; font-weight: 700; }
    .section-hint { margin: 8px 0 0 0; color: #666; font-size: 13px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    .field { margin: 8px 0; }
    .field label { display: block; font-size: 13px; color: #222; font-weight: 600; margin-bottom: 4px; }
    .field input[type="text"], .field input[type="number"], .field input[type="date"], .field select, .field textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    .field select, .qrow select, select.yn-proxy {
      border: 1px solid #e8e8e8;
      background: #fafafa;
    }

    .radio ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 14px; flex-wrap: wrap; }
    .radio li { margin: 0; }
    .radio label { display: inline; font-size: 14px; color: #111; margin: 0; }

    .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; margin-top: 6px; }
    @media (max-width: 720px) { .checks { grid-template-columns: 1fr; } }
    .check { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid #f0f0f0; border-radius: 10px; background: #fcfcfc; }
    .check label { margin: 0; display: inline; font-size: 14px; color: #111; }

    .errors { color: #b00020; font-size: 13px; margin-top: 6px; }
    .nonfield { color: #b00020; background: #fff2f2; border: 1px solid #ffd0d0; padding: 10px 12px; border-radius: 10px; margin: 10px 0; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button, a.button {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      text-decoration: none;
      cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }

    .ask-child { color: #888; font-size: 12px; margin: 2px 0 6px 0; }
    .qrow { border: 1px solid #f0f0f0; border-radius: 12px; background: #fcfcfc; padding: 10px 12px; margin: 10px 0; }
    .qrow .qtitle { font-size: 14px; font-weight: 700; color: #111; margin: 0 0 4px 0; }
    .qrow .qtitle label { font-size: 14px; font-weight: 700; color: #111; margin: 0; display: inline; }
    .qrow select { margin-top: 4px; }
  </style>
</head>

<body data-page="screening_form" data-student-name="{{ student.full_name|escape }}">

  <div class="container">
    <h2><span data-i18n="page.screening.heading_prefix">Screening</span> – {{ student.full_name }}</h2>

    
    <div class="langbar">
      <div class="lang-label" data-i18n="ui.language.label">Language</div>
      <select id="language-select" aria-label="Language">
        <option value="en">English</option>
        <option value="mr" selected>मराठी</option>
        <option value="hi">हिन्दी</option>
        <option value="te">తెలుగు</option>
        <option value="ta">தமிழ்</option>
        <option value="ml">മലയാളം</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="bn">বাংলা</option>
      </select>
    </div>

    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="form_language" id="form-language-input" value="">
      <input type="hidden" name="wa_questions_and_answers" id="wa-qa-input" value="">
    
      {% if form.non_field_errors %}
        <div class="nonfield">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- SECTION A -->
      <fieldset>
        <legend data-i18n="legend.section_a">Section A: Particulars</legend>

        

        <div class="grid">
          <div class="field">
            <label for="{{ form.student_name.id_for_label }}" data-i18n="field.student_name.label">{{ form.student_name.label }}</label>
            {{ form.student_name }}
            {% if form.student_name.errors %}<div class="errors">{{ form.student_name.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.unique_student_id.id_for_label }}" data-i18n="field.unique_student_id.label">{{ form.unique_student_id.label }}</label>
            {{ form.unique_student_id }}
            {% if form.unique_student_id.errors %}<div class="errors">{{ form.unique_student_id.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.dob.id_for_label }}" data-i18n="field.dob.label">{{ form.dob.label }}</label>
            {{ form.dob }}
            {% if form.dob.errors %}<div class="errors">{{ form.dob.errors }}</div>{% endif %}
            <div id="age-display" class="muted" style="margin-top: 4px;"></div>
          </div>

          <div class="field">
            <label for="{{ form.sex.id_for_label }}" data-i18n="field.sex.label">{{ form.sex.label }}</label>
            {{ form.sex }}
            {% if form.sex.errors %}<div class="errors">{{ form.sex.errors }}</div>{% endif %}
            <div id="sex-disabled-hint" class="muted" style="display:none; margin-top:4px;" data-i18n="hint.select_dob_first">
              Select Date of Birth first to enable this field.
            </div> 
          </div>

          <div class="field">
            <label for="{{ form.parent_phone_e164.id_for_label }}" data-i18n="field.parent_phone_e164.label">{{ form.parent_phone_e164.label }}</label>
            {{ form.parent_phone_e164 }}
            {% if form.parent_phone_e164.errors %}<div class="errors">{{ form.parent_phone_e164.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

      <!-- SECTION B -->
      <fieldset>
        <legend data-i18n="legend.section_b">Section B: Anthropometry</legend>

        

        <div class="grid">
          <div class="field">
            <label for="{{ form.weight_kg_r1.id_for_label }}" data-i18n="field.weight_kg_r1.label">{{ form.weight_kg_r1.label }}</label>
            {{ form.weight_kg_r1 }}
            {% if form.weight_kg_r1.errors %}<div class="errors">{{ form.weight_kg_r1.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.height_cm_r1.id_for_label }}" data-i18n="field.height_cm_r1.label">{{ form.height_cm_r1.label }}</label>
            {{ form.height_cm_r1 }}
            {% if form.height_cm_r1.errors %}<div class="errors">{{ form.height_cm_r1.errors }}</div>{% endif %}
          </div>

          <div class="field radio" id="muac-field">
            <label for="{{ form.muac_tape_color.id_for_label }}" data-i18n="field.muac_tape_color.label">{{ form.muac_tape_color.label }}</label>
            {{ form.muac_tape_color }}
            {% if form.muac_tape_color.errors %}<div class="errors">{{ form.muac_tape_color.errors }}</div>{% endif %}
          </div>

        </div>
      </fieldset>


      <!-- SECTION C -->
      <fieldset>
        <legend data-i18n="legend.section_c">Section C: Quick Health Red Flags</legend>



      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_general_poor.id_for_label }}" data-i18n="field.health_general_poor.label">{{ form.health_general_poor.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_general_poor">Ask the child- Do you feel healthy?</div>

        <div style="display:none;">
          {{ form.health_general_poor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_general_poor.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_general_poor.errors %}<div class="errors">{{ form.health_general_poor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_pallor.id_for_label }}" data-i18n="field.health_pallor.label">{{ form.health_pallor.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_pallor">Ask the child- Does the child have pallor?</div>

        <div style="display:none;">
          {{ form.health_pallor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_pallor.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_pallor.errors %}<div class="errors">{{ form.health_pallor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_fatigue_dizzy_faint.id_for_label }}" data-i18n="field.health_fatigue_dizzy_faint.label">{{ form.health_fatigue_dizzy_faint.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_fatigue_dizzy_faint">Ask the child- If they remember having fainted while doing normal work/play, or if the child feels very too tired to do routine work/play?</div>

        <div style="display:none;">
          {{ form.health_fatigue_dizzy_faint }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_fatigue_dizzy_faint.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_fatigue_dizzy_faint.errors %}<div class="errors">{{ form.health_fatigue_dizzy_faint.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_breathlessness.id_for_label }}" data-i18n="field.health_breathlessness.label">{{ form.health_breathlessness.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_breathlessness">Ask the child- If they feel breathless on doing routine activities or while walking normally?</div>

        <div style="display:none;">
          {{ form.health_breathlessness }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_breathlessness.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_breathlessness.errors %}<div class="errors">{{ form.health_breathlessness.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_frequent_infections.id_for_label }}" data-i18n="field.health_frequent_infections.label">{{ form.health_frequent_infections.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_frequent_infections">Ask the child- Does the child fall sick very often? Has been ill 3 times or more in the last month?</div>

        <div style="display:none;">
          {{ form.health_frequent_infections }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_frequent_infections.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_frequent_infections.errors %}<div class="errors">{{ form.health_frequent_infections.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_chronic_cough_or_diarrhea.id_for_label }}" data-i18n="field.health_chronic_cough_or_diarrhea.label">{{ form.health_chronic_cough_or_diarrhea.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_chronic_cough_or_diarrhea">Ask the child- Does the child have cough and has had it for last 4 weeks or more, or does the child have loose motions and it has lasted more than 2 weeks?</div>

        <div style="display:none;">
          {{ form.health_chronic_cough_or_diarrhea }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_chronic_cough_or_diarrhea.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_chronic_cough_or_diarrhea.errors %}<div class="errors">{{ form.health_chronic_cough_or_diarrhea.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_visible_worms.id_for_label }}" data-i18n="field.health_visible_worms.label">{{ form.health_visible_worms.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_visible_worms">Ask the child- If they have ever seen small worms in their stool.</div>

        <div style="display:none;">
          {{ form.health_visible_worms }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_visible_worms.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_visible_worms.errors %}<div class="errors">{{ form.health_visible_worms.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_dental_or_gum_or_ulcers.id_for_label }}" data-i18n="field.health_dental_or_gum_or_ulcers.label">{{ form.health_dental_or_gum_or_ulcers.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_dental_or_gum_or_ulcers">Ask the child- If they have teeth pain, gum bleeding or mouth ulcers?</div>

        <div style="display:none;">
          {{ form.health_dental_or_gum_or_ulcers }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_dental_or_gum_or_ulcers.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_dental_or_gum_or_ulcers.errors %}<div class="errors">{{ form.health_dental_or_gum_or_ulcers.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_night_vision_difficulty.id_for_label }}" data-i18n="field.health_night_vision_difficulty.label">{{ form.health_night_vision_difficulty.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_night_vision_difficulty">Ask the child- If they stumble while walking in the dark since they can't see properly</div>

        <div style="display:none;">
          {{ form.health_night_vision_difficulty }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_night_vision_difficulty.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_night_vision_difficulty.errors %}<div class="errors">{{ form.health_night_vision_difficulty.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_bone_or_joint_pain.id_for_label }}" data-i18n="field.health_bone_or_joint_pain.label">{{ form.health_bone_or_joint_pain.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.health_bone_or_joint_pain">Ask the child- If they have pain in their arms/legs/joints, although they haven't been hurt and even without hard work/play?</div>

        <div style="display:none;">
          {{ form.health_bone_or_joint_pain }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_bone_or_joint_pain.id_for_label }}">
          <option value="">Select</option>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_bone_or_joint_pain.errors %}<div class="errors">{{ form.health_bone_or_joint_pain.errors }}</div>{% endif %}
      </div>


      <div class="field radio" style="margin-top: 12px;">
        <label for="{{ form.appetite.id_for_label }}" data-i18n="field.appetite.label">{{ form.appetite.label }}</label>
        {{ form.appetite }}
        {% if form.appetite.errors %}<div class="errors">{{ form.appetite.errors }}</div>{% endif %}
      </div>


      <fieldset id="girls-only-section" style="margin-top: 12px;">
        <legend data-i18n="legend.girls_only">Girls only</legend>


        <div class="qrow" style="margin-top: 10px;">
          <div class="qtitle">
            <label for="{{ form.menarche_started.id_for_label }}" data-i18n="field.menarche_started.label">{{ form.menarche_started.label }}</label>
          </div>
          <div class="ask-child" data-i18n="ask.menarche_started">Ask the child- If her menstruation has started.</div>

          <div style="display:none;">
            {{ form.menarche_started }}
          </div>

          <select class="yn-proxy" data-checkbox-id="{{ form.menarche_started.id_for_label }}">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>

          {% if form.menarche_started.errors %}<div class="errors">{{ form.menarche_started.errors }}</div>{% endif %}
        </div>

        <div id="girls-menarche-details" style="margin-top: 8px;">
          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.menarche_age_years.id_for_label }}" data-i18n="field.menarche_age_years.label">{{ form.menarche_age_years.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.menarche_age_years">Ask the child- Menstruation started at what age?</div>
            {{ form.menarche_age_years }}
            {% if form.menarche_age_years.errors %}<div class="errors">{{ form.menarche_age_years.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.pads_per_day.id_for_label }}" data-i18n="field.pads_per_day.label">{{ form.pads_per_day.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.pads_per_day">Ask the child- How many pads per day does she need on heavy bleeding days?</div>
            {{ form.pads_per_day }}
            {% if form.pads_per_day.errors %}<div class="errors">{{ form.pads_per_day.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.cycle_length_days.id_for_label }}" data-i18n="field.cycle_length_days.label">{{ form.cycle_length_days.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.cycle_length_days">Ask the child- After how many days do your menses happen again?</div>
            {{ form.cycle_length_days }}
            {% if form.cycle_length_days.errors %}<div class="errors">{{ form.cycle_length_days.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.bleeding_clots.id_for_label }}" data-i18n="field.bleeding_clots.label">{{ form.bleeding_clots.label }}</label>
            </div>
            <div class="ask-child" data-i18n="ask.bleeding_clots">Ask the child- Does the child pass clots while bleeding?</div>

            <div style="display:none;">
              {{ form.bleeding_clots }}
            </div>

            <select class="yn-proxy" data-checkbox-id="{{ form.bleeding_clots.id_for_label }}">
              <option value="">Select</option>
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>

            {% if form.bleeding_clots.errors %}<div class="errors">{{ form.bleeding_clots.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>
      </fieldset>

<!-- SECTION D -->
      <fieldset>
        <legend data-i18n="legend.section_d">Section D: Diet Type & Diversity</legend>



      <div class="field radio">
        <label for="{{ form.diet_type.id_for_label }}" data-i18n="field.diet_type.label">{{ form.diet_type.label }}</label>

        <div class="qrow" style="margin-top: 8px;">
          {% for radio in form.diet_type %}
            <div style="margin: 10px 0;">
              <div style="display:flex; gap:10px; align-items:center;">
                {{ radio.tag }}
                <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>

              {% if radio.data.value == "LACTO_VEG" %}
                <div class="ask-child" data-i18n="ask.diet_type.LACTO_VEG">Ask the child- Do you drink milk or eat dahi or paneer at home?</div>
              {% elif radio.data.value == "LACTO_OVO" %}
                <div class="ask-child" data-i18n="ask.diet_type.LACTO_OVO">Ask the child- Do you eat eggs at home?</div>
              {% elif radio.data.value == "NON_VEG" %}
                <div class="ask-child" data-i18n="ask.diet_type.NON_VEG">Ask the child- Do you eat fish, chicken or mutton at home?</div>
              {% endif %}

            </div>
          {% endfor %}
        </div>

        {% if form.diet_type.errors %}<div class="errors">{{ form.diet_type.errors }}</div>{% endif %}
      </div>

        <p class="section-hint" style="margin-top: 12px; font-weight: 700; color: #111;" data-i18n="hint.diet_24h">
          Did the student have the following in last 24 hours?
        </p>



      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.breakfast_eaten.id_for_label }}" data-i18n="field.breakfast_eaten.label">{{ form.breakfast_eaten.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.breakfast_eaten">Ask the child- Did you eat Breakfast?</div>
        {{ form.breakfast_eaten }}
        {% if form.breakfast_eaten.errors %}<div class="errors">{{ form.breakfast_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.lunch_eaten.id_for_label }}" data-i18n="field.lunch_eaten.label">{{ form.lunch_eaten.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.lunch_eaten">Ask the child- Did you eat Lunch?</div>
        {{ form.lunch_eaten }}
        {% if form.lunch_eaten.errors %}<div class="errors">{{ form.lunch_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.green_leafy_veg.id_for_label }}" data-i18n="field.green_leafy_veg.label">{{ form.green_leafy_veg.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.green_leafy_veg">Ask the child- Did you eat green leafy vegetables in your last meal?</div>
        {{ form.green_leafy_veg }}
        {% if form.green_leafy_veg.errors %}<div class="errors">{{ form.green_leafy_veg.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.other_vegetables.id_for_label }}" data-i18n="field.other_vegetables.label">{{ form.other_vegetables.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.other_vegetables">Ask the child- Did you eat any other vegetable in your last meal?</div>
        {{ form.other_vegetables }}
        {% if form.other_vegetables.errors %}<div class="errors">{{ form.other_vegetables.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.fruits.id_for_label }}" data-i18n="field.fruits.label">{{ form.fruits.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.fruits">Ask the child- Did you eat fruits yesterday?</div>
        {{ form.fruits }}
        {% if form.fruits.errors %}<div class="errors">{{ form.fruits.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.dal_pulses_beans.id_for_label }}" data-i18n="field.dal_pulses_beans.label">{{ form.dal_pulses_beans.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.dal_pulses_beans">Ask the child- Did you eat Dal / Pulses / Beans yesterday?</div>
        {{ form.dal_pulses_beans }}
        {% if form.dal_pulses_beans.errors %}<div class="errors">{{ form.dal_pulses_beans.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.milk_curd.id_for_label }}" data-i18n="field.milk_curd.label">{{ form.milk_curd.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.milk_curd">Ask the child- Did you drink milk or eat curd yesterday?</div>
        {{ form.milk_curd }}
        {% if form.milk_curd.errors %}<div class="errors">{{ form.milk_curd.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-egg-field">
        <div class="qtitle">
          <label for="{{ form.egg.id_for_label }}" data-i18n="field.egg.label">{{ form.egg.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.egg">Ask the child- Did you eat egg yesterday?</div>
        {{ form.egg }}
        {% if form.egg.errors %}<div class="errors">{{ form.egg.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-meat-field">
        <div class="qtitle">
          <label for="{{ form.fish_chicken_meat.id_for_label }}" data-i18n="field.fish_chicken_meat.label">{{ form.fish_chicken_meat.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.fish_chicken_meat">Ask the child- Did you eat Fish / Chicken / Meat in the the last 3 days?</div>
        {{ form.fish_chicken_meat }}
        {% if form.fish_chicken_meat.errors %}<div class="errors">{{ form.fish_chicken_meat.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.nuts_groundnuts.id_for_label }}" data-i18n="field.nuts_groundnuts.label">{{ form.nuts_groundnuts.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.nuts_groundnuts">Ask the child- Did you eat Nuts / Groundnuts yesterday?</div>
        {{ form.nuts_groundnuts }}
        {% if form.nuts_groundnuts.errors %}<div class="errors">{{ form.nuts_groundnuts.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.ssb_or_packaged_snacks.id_for_label }}" data-i18n="field.ssb_or_packaged_snacks.label">{{ form.ssb_or_packaged_snacks.label }}</label>
        </div>
        <div class="ask-child" data-i18n="ask.ssb_or_packaged_snacks">Ask the child- Do you drink soft drinks like coca cola, pepsi, mirinda, fanta, limca etc.? Do you drink fruit juice that is not made at home? Do you eat snacks like biscuits, chocolates, chips, cakes etc.?</div>
        {{ form.ssb_or_packaged_snacks }}
        {% if form.ssb_or_packaged_snacks.errors %}<div class="errors">{{ form.ssb_or_packaged_snacks.errors }}</div>{% endif %}
      </div>
      </fieldset>

<!-- SECTION E -->
      <fieldset>
        <legend data-i18n="legend.section_e">Section E: Program Enablers</legend>


        <div class="grid">
          <div class="field radio">
            <label for="{{ form.deworming_taken.id_for_label }}" data-i18n="field.deworming_taken.label">{{ form.deworming_taken.label }}</label>
            <div class="ask-child" data-i18n="ask.deworming_taken">Ask the child- Did you take the big pill for deworming?</div>
            {{ form.deworming_taken }}
            
            {% if form.deworming_taken.errors %}<div class="errors">{{ form.deworming_taken.errors }}</div>{% endif %}
          </div>
          <div class="field" id="deworming-months-field">
            <label for="{{ form.deworming_date.id_for_label }}" data-i18n="field.deworming_date.label">{{ form.deworming_date.label }}</label>
            {{ form.deworming_date }}
            {% if form.deworming_date.errors %}<div class="errors">{{ form.deworming_date.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

<!-- SECTION F -->
      <fieldset>
        <legend data-i18n="legend.section_f">Section F: Food Security</legend>


        <div class="field radio">
          <label for="{{ form.hunger_vital_sign.id_for_label }}" data-i18n="field.hunger_vital_sign.label">{{ form.hunger_vital_sign.label }}</label>
          {{ form.hunger_vital_sign }}
          {% if form.hunger_vital_sign.errors %}<div class="errors">{{ form.hunger_vital_sign.errors }}</div>{% endif %}
        </div>
      </fieldset>

      <div class="actions">
        <button class="primary" type="submit" data-i18n="button.complete_screening">Complete Screening</button>
        <a class="button" href="{% url 'teacher_portal' %}" data-i18n="button.cancel">Cancel</a>

      </div>
    </form>
  </div>
  
  <script>
    (function () {
      'use strict';
    
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
    
      // ---------- Age calculation helpers ----------
      function parseISODateToLocal(iso) {
        // Expect yyyy-mm-dd (from <input type="date">)
        if (!iso) return null;
        var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso));
        if (!m) return null;
        var y = Number(m[1]);
        var mo = Number(m[2]) - 1;
        var d = Number(m[3]);
        var dt = new Date(y, mo, d);
        if (isNaN(dt.getTime())) return null;
        // Validate round-trip (guards invalid dates like 2024-02-31)
        if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
        return dt;
      }
    
      function computeAgeMonths(dob, today) {
        if (!dob || !today) return null;
        var months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
        if (today.getDate() < dob.getDate()) months -= 1; // not completed the month yet
        if (months < 0) return null;
        return months;
      }
    
      function formatAge(months) {
        if (window.NUTRILIFT_I18N && typeof window.NUTRILIFT_I18N.formatAge === "function") {
          return window.NUTRILIFT_I18N.formatAge(months);
        }
        // fallback
        var y = Math.floor(months / 12);
        var m = months % 12;
        var yLabel = (y === 1) ? 'year' : 'years';
        var mLabel = (m === 1) ? 'month' : 'months';
        return y + ' ' + yLabel + ' ' + m + ' ' + mLabel;
      }

    
      // ---------- Generic helpers ----------
      function clearInputs(root) {
        if (!root) return;
        qsa('input, select, textarea', root).forEach(function (el) {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
          } else {
            el.value = '';
          }
        });
      }
    
      function getCheckedValue(name) {
        var el = qs('input[name="' + name + '"]:checked');
        return el ? el.value : '';
      }
    
      function setRadioChecked(name, value) {
        var el = qs('input[name="' + name + '"][value="' + value + '"]');
        if (el) el.checked = true;
      }
    
      function setSelectValueByName(name, value) {
        var el = qs('select[name="' + name + '"]');
        if (el) el.value = value;
      }
    
      // ---------- DOM refs (shared by both templates) ----------
      var dobEl = qs('[name="dob"]');
      var ageDisplayEl = document.getElementById('age-display');
    
      var sexEl = qs('[name="sex"]');
      var sexHintEl = document.getElementById('sex-disabled-hint');
    
      var muacWrapper = document.getElementById('muac-field');
      var girlsSection = document.getElementById('girls-only-section');
      var menarcheDetails = document.getElementById('girls-menarche-details');
      var menarcheStartedEl = qs('[name="menarche_started"]');
    
      var dewormingMonthsWrapper = document.getElementById('deworming-months-field');
    
      var eggField = document.getElementById('diet-egg-field');
      var meatField = document.getElementById('diet-meat-field');
    
      // ---------- Sync functions ----------
      function syncAgeAndSexLock() {
        var today = new Date();
        var dob = dobEl ? parseISODateToLocal(dobEl.value) : null;
        var ageMonths = dob ? computeAgeMonths(dob, today) : null;
    
        // Age display (below DOB)
        if (ageDisplayEl) {
          ageDisplayEl.textContent = (typeof ageMonths === 'number') ? formatAge(ageMonths) : '';
        }
    
        // Enforce: DOB required before Sex
        if (sexEl) {
          var enableSex = (typeof ageMonths === 'number');
          sexEl.disabled = !enableSex;
    
          if (!enableSex) {
            sexEl.value = '';
          }
    
          if (sexHintEl) {
            sexHintEl.style.display = enableSex ? 'none' : '';
          }
        }
    
        return ageMonths;
      }
    
      function syncMuacVisibility(ageMonths) {
        if (!muacWrapper) return;
    
        // Only hide MUAC for age >= 5 years (>= 60 months)
        var hide = (typeof ageMonths === 'number') && (ageMonths >= 60);
    
        muacWrapper.style.display = hide ? 'none' : '';
    
        if (hide) {
          // Auto-select GREEN so no red/yellow flags occur
          // Support either radio or select (in case rendering changes)
          setRadioChecked('muac_tape_color', 'GREEN');
          setSelectValueByName('muac_tape_color', 'GREEN');
        }
      }
    
      function syncGirlsVisibility(ageMonths) {
        if (!girlsSection) return;
    
        var sex = sexEl ? String(sexEl.value || '').toUpperCase() : '';
        var isGirl = (sex === 'F' || sex === 'FEMALE');
        var is10Plus = (typeof ageMonths === 'number') && (ageMonths >= 120);
    
        var showGirls = isGirl && is10Plus;
    
        girlsSection.style.display = showGirls ? '' : 'none';
    
        if (!showGirls) {
          clearInputs(girlsSection);
          // also hide details wrapper if present
          if (menarcheDetails) menarcheDetails.style.display = 'none';
        }
      }
    
      function syncMenarcheDetailsVisibility() {
        if (!girlsSection || !menarcheDetails) return;
    
        // If girls section is hidden, keep details hidden and cleared.
        if (girlsSection.style.display === 'none') {
          menarcheDetails.style.display = 'none';
          clearInputs(menarcheDetails);
          return;
        }
    
        var started = !!(menarcheStartedEl && menarcheStartedEl.checked);
        menarcheDetails.style.display = started ? '' : 'none';
    
        if (!started) {
          clearInputs(menarcheDetails);
        }
      }
    
      function syncDewormingMonthsVisibility() {
        if (!dewormingMonthsWrapper) return;
    
        var v = getCheckedValue('deworming_taken'); // 'yes' | 'no' | 'dont_know'
        var show = (String(v || '').toLowerCase() === 'yes');
    
        dewormingMonthsWrapper.style.display = show ? '' : 'none';
    
        if (!show) {
          // clear follow-up field when hidden
          clearInputs(dewormingMonthsWrapper);
          // If wrapper contains only the months select, this is enough.
          // If needed, also explicitly clear by name:
          setSelectValueByName('deworming_date', '');
        }
      }
    
      function forceNoAnswer(fieldWrapper, fieldName) {
        if (!fieldWrapper) return;
    
        // New behavior: Yes/No may be a <select>
        var sel = fieldWrapper.querySelector('select[name="' + fieldName + '"]');
        if (sel) {
          sel.value = 'no';
          return;
        }
    
        // Old behavior: Yes/No as radios
        var no = fieldWrapper.querySelector('input[name="' + fieldName + '"][value="no"]');
        if (no) no.checked = true;
      }
    
      function syncDietVisibility() {
        var dietTypeRadios = qsa('input[name="diet_type"]');
        if (!dietTypeRadios.length) return;
    
        var checked = qs('input[name="diet_type"]:checked');
        var dietType = String(checked ? checked.value : '').toUpperCase();
    
        var knownTypes = { 'LACTO_VEG': true, 'LACTO_OVO': true, 'NON_VEG': true };
    
        // Keep default UI unchanged until diet type is chosen.
        var showEgg = !knownTypes[dietType] || dietType === 'LACTO_OVO' || dietType === 'NON_VEG';
        var showMeat = !knownTypes[dietType] || dietType === 'NON_VEG';
    
        if (eggField) {
          eggField.style.display = showEgg ? '' : 'none';
          if (!showEgg) forceNoAnswer(eggField, 'egg');
        }
    
        if (meatField) {
          meatField.style.display = showMeat ? '' : 'none';
          if (!showMeat) forceNoAnswer(meatField, 'fish_chicken_meat');
        }
      }
    
      function syncAll() {
        var ageMonths = syncAgeAndSexLock();
        syncMuacVisibility(ageMonths);
        syncGirlsVisibility(ageMonths);
        syncMenarcheDetailsVisibility();
        syncDewormingMonthsVisibility();
        syncDietVisibility();
      }
    
      // ---------- Wire events ----------
      if (dobEl) dobEl.addEventListener('change', syncAll);
      if (sexEl) sexEl.addEventListener('change', syncAll);
    
      // Menarche checkbox toggles details
      if (menarcheStartedEl) menarcheStartedEl.addEventListener('change', syncMenarcheDetailsVisibility);
    
      // Deworming radios toggle months
      qsa('input[name="deworming_taken"]').forEach(function (el) {
        el.addEventListener('change', syncDewormingMonthsVisibility);
      });
    
      // Diet type radios toggle egg/meat fields
      qsa('input[name="diet_type"]').forEach(function (el) {
        el.addEventListener('change', syncDietVisibility);
      });
    
      // Initial state
      syncAll();
    })();
    </script>
    
  

  <script>
    (function () {
      'use strict';

      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

      function setSelectFromCheckbox(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;
        // Only sync if checkbox is checked
        if (cb.checked) {
          sel.value = 'yes';
        } else if (sel.value === '') {
          // keep placeholder if nothing chosen
          return;
        } else {
          sel.value = 'no';
        }
      }

      function setCheckboxFromSelect(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;

        cb.checked = (String(sel.value).toLowerCase() === 'yes');

        // Trigger change so existing scripts (e.g. menarche details) react.
        try { cb.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
      }

      function syncYesNoProxies() {
        var sels = qsa('select.yn-proxy[data-checkbox-id]');
        sels.forEach(function (sel) {
          setSelectFromCheckbox(sel);
          sel.addEventListener('change', function () { setCheckboxFromSelect(sel); });
        });
      }

      syncYesNoProxies();
    })();
  </script>

  <script>
    (function () {
      "use strict";
    
      // Keep this list in the order you want it to appear in WhatsApp.
      // These names match the Django form field names.
      var QA_FIELDS = [
        "weight_kg_r1",
        "height_cm_r1",
        "muac_tape_color",
    
        "health_general_poor",
        "health_pallor",
        "health_fatigue_dizzy_faint",
        "health_breathlessness",
        "health_frequent_infections",
        "health_chronic_cough_or_diarrhea",
        "health_visible_worms",
        "health_dental_or_gum_or_ulcers",
        "health_night_vision_difficulty",
        "health_bone_or_joint_pain",
    
        "appetite",
    
        // Adolescent girls section (will be skipped automatically if hidden/empty)
        "menarche_started",
        "menarche_age_years",
        "pads_per_day",
        "bleeding_clots",
        "cycle_length_days",
    
        // Diet section
        "diet_type",
        "breakfast_eaten",
        "lunch_eaten",
        "green_leafy_veg",
        "other_vegetables",
        "fruits",
        "dal_pulses_beans",
        "milk_curd",
        "egg",
        "fish_chicken_meat",
        "nuts_groundnuts",
        "ssb_or_packaged_snacks",
    
        // Deworming + hunger vital sign
        "deworming_taken",
        "deworming_date",
        "hunger_vital_sign"
      ];
    
      function isVisible(el) {
        if (!el) return false;
        // offsetParent = null for display:none; getClientRects catches some edge cases
        return !!(el.offsetParent || el.getClientRects().length);
      }
    
      function labelTextFor(name) {
        // Preferred: labels in these templates have data-i18n="field.<name>.label"
        var lbl = document.querySelector('[data-i18n="field.' + name + '.label"]');
        if (lbl) return (lbl.textContent || "").trim();
    
        // Fallback: label[for=id]
        var el = document.querySelector('[name="' + name + '"]');
        if (el && el.id) {
          lbl = document.querySelector('label[for="' + el.id + '"]');
          if (lbl) return (lbl.textContent || "").trim();
        }
        return name;
      }
    
      function dispatchChange(el) {
        if (!el) return;
        var evt;
        if (typeof Event === "function") {
          evt = new Event("change", { bubbles: true });
        } else {
          evt = document.createEvent("Event");
          evt.initEvent("change", true, true);
        }
        el.dispatchEvent(evt);
      }
    
      function radioAnswer(name) {
        var checked = document.querySelector('input[name="' + name + '"][type="radio"]:checked');
        if (!checked) return "";
        if (!isVisible(checked)) return "";
    
        var lbl = checked.closest ? checked.closest("label") : null;
        if (!lbl && checked.id) lbl = document.querySelector('label[for="' + checked.id + '"]');
    
        var txt = lbl ? (lbl.textContent || "") : (checked.value || "");
        return txt.replace(/\s+/g, " ").trim();
      }
    
      function selectAnswer(sel) {
        if (!sel || !isVisible(sel)) return "";
        if (!sel.value) return "";
        var opt = sel.options[sel.selectedIndex];
        return opt ? (opt.textContent || "").trim() : "";
      }
    
      function inputAnswer(inp) {
        if (!inp || !isVisible(inp)) return "";
        return (inp.value || "").trim();
      }
    
      function checkboxProxyAnswer(cb) {
        // These templates use proxy selects for many checkboxes (health + some girls fields)
        var proxy = cb && cb.id ? document.querySelector('select.yn-proxy[data-checkbox-id="' + cb.id + '"]') : null;
        if (!proxy || !isVisible(proxy)) return "";
    
        // If proxy is still on placeholder (value=""), fall back to checkbox state
        if (!proxy.value) {
          var optFallback = proxy.querySelector('option[value="' + (cb.checked ? "yes" : "no") + '"]');
          return optFallback ? (optFallback.textContent || "").trim() : "";
        }
    
        var opt = proxy.options[proxy.selectedIndex];
        return opt ? (opt.textContent || "").trim() : "";
      }
    
      function answerForField(name) {
        // 1) Proxy checkbox fields
        var cb = document.querySelector('input[name="' + name + '"][type="checkbox"]');
        if (cb) {
          var proxyTxt = checkboxProxyAnswer(cb);
          if (proxyTxt) return proxyTxt;
    
          // If it’s a real visible checkbox (rare here), return Yes/No in English as fallback
          // (in practice, your checkbox fields here should have proxies)
          if (isVisible(cb)) return cb.checked ? "Yes" : "No";
          return "";
        }
    
        // 2) Radio groups
        var anyRadio = document.querySelector('input[name="' + name + '"][type="radio"]');
        if (anyRadio) return radioAnswer(name);
    
        // 3) Selects
        var sel = document.querySelector('select[name="' + name + '"]');
        if (sel) return selectAnswer(sel);
    
        // 4) Inputs/textareas
        var inp = document.querySelector('input[name="' + name + '"]');
        if (inp) return inputAnswer(inp);
    
        var ta = document.querySelector('textarea[name="' + name + '"]');
        if (ta) return inputAnswer(ta);
    
        return "";
      }
    
      function buildQuestionsAndAnswers() {
        var lines = [];
        for (var i = 0; i < QA_FIELDS.length; i++) {
          var name = QA_FIELDS[i];
    
          var answer = answerForField(name);
          if (!answer) continue;
    
          var q = labelTextFor(name);
          if (!q) continue;
    
          lines.push("- " + q + ": " + answer);
        }
        return lines.join("\n");
      }
    
      document.addEventListener("DOMContentLoaded", function () {
        // If the teacher dashboard opens the form with ?lang=xx, honor it.
        //disabled
    
        var formEl = document.querySelector("form");
        if (!formEl) return;
    
        formEl.addEventListener("submit", function () {
          // Validate Section C yes/no selects
          var invalid = false;

          document.querySelectorAll('.qrow select.yn-proxy').forEach(function(sel){
            if (sel.hasAttribute('required') && !sel.value) {
              invalid = true;
              sel.style.borderColor = '#b00020';
            } else {
              sel.style.borderColor = '';
            }
          });

          if (invalid) {
            e.preventDefault();
            alert("Please answer all health questions in Section C.");
            return;
          }
          var sel = document.getElementById("language-select");
          var lang = "mr";
    
          var langInput = document.getElementById("form-language-input");
          if (langInput) langInput.value = lang;
    
          var qaInput = document.getElementById("wa-qa-input");
          if (qaInput) qaInput.value = buildQuestionsAndAnswers();
        });
      });
    })();
    </script>
    
</body>
</html>

================================================================================
FILE: templates\screening\screening_result.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Result – {{ s.student.full_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 900px; margin: 0 auto; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; margin: 12px 0; }
    h2 { margin: 0; }
    .muted { color: #666; font-size: 14px; margin: 6px 0 0 0; }

    .badge { display: inline-block; padding: 5px 10px; border-radius: 999px; font-size: 13px; border: 1px solid #ddd; background: #fff; font-weight: 650; }
    .green { border-color: #bfe8c6; background: #eefbf1; }
    .yellow { border-color: #ffe3b3; background: #fff8ea; }
    .red { border-color: #ffd0d0; background: #fff2f2; }

    .messages { margin: 12px 0; padding: 0; list-style: none; }
    .messages li { margin: 6px 0; padding: 10px 12px; border-radius: 10px; background: #fff; border: 1px solid #eee; }
    .messages li.success { border-color: #cfe9d6; background: #f2fbf5; }
    .messages li.warning { border-color: #ffe3b3; background: #fff8ea; }
    .messages li.error { border-color: #ffd0d0; background: #fff2f2; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 14px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
    .kv { font-size: 14px; }
    .kv strong { display: inline-block; min-width: 150px; color: #333; }

    ul.flags { margin: 10px 0 0 18px; }
    ul.flags li { margin: 4px 0; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    a.button {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      text-decoration: none;
    }
    a.button.primary { background: #111; color: #fff; border-color: #111; }
  </style>
</head>

<body>
  <div class="container">
    {% comment %} {% if messages %}
      <ul class="messages">
        {% for m in messages %}
          <li class="{{ m.tags }}">{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %} {% endcomment %}

    <div class="card">
      <h2>Screening Result – {{ s.student.full_name }}</h2>
      <p class="muted">Screened at: {{ s.screened_at }}</p>

      <div style="margin-top: 10px;">
        {% if s.risk_level == "GREEN" %}
          <span class="badge green">GREEN</span>
        {% elif s.risk_level == "YELLOW" %}
          <span class="badge yellow">YELLOW</span>
        {% elif s.risk_level == "RED" %}
          <span class="badge red">RED</span>
        {% else %}
          <span class="badge">{{ s.risk_level }}</span>
        {% endif %}
      </div>

      {% if teacher_view %}
        <p style="margin-top: 10px;"><strong>Teacher view:</strong> {{ teacher_view }}</p>
      {% endif %}
    </div>

    <div class="card">
      <h3 style="margin: 0 0 10px 0;">Student details</h3>
      <div class="grid">
        <div class="kv"><strong>Name:</strong> {{ s.student.full_name }}</div>
        <div class="kv">
          <strong>Class:</strong>
          {% if s.student.classroom %}
            {{ s.student.classroom.grade }} {{ s.student.classroom.division }}
          {% else %}
            -
          {% endif %}
        </div>
        <div class="kv"><strong>Student ID:</strong> {{ s.student.student_code|default:"-" }}</div>
        <div class="kv"><strong>Gender:</strong> {{ s.gender|default:s.student.gender|default:"-" }}</div>
        <div class="kv"><strong>Age (years):</strong> {{ s.age_years|default:"-" }}</div>
        <div class="kv"><strong>Age (months):</strong> {{ s.age_months|default:"-" }}</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 10px 0;">Key measurements</h3>
      <div class="grid">
        <div class="kv"><strong>Age (years):</strong> {{ s.age_years|default:"-" }}</div>
        <div class="kv"><strong>Age (months):</strong> {{ s.age_months|default:"-" }}</div>
        <div class="kv"><strong>Height (cm):</strong> {{ s.height_cm|default:"-" }}</div>
        <div class="kv"><strong>Weight (kg):</strong> {{ s.weight_kg|default:"-" }}</div>
        <div class="kv"><strong>BMI:</strong> {{ s.bmi|default:"-" }}</div>
        <div class="kv"><strong>BAZ:</strong> {{ s.baz|default:"-" }}</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 10px 0;">Triggers / flags</h3>

      {% if is_parent_view and flags_text %}
        <p>{{ flags_text }}</p>
      {% elif s.red_flags and s.red_flags|length > 0 %}
        <ul class="flags">
          {% for f in s.red_flags %}
            <li>{{ f }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No flags recorded.</p>
      {% endif %}
    </div>

    {% if not is_parent_view %}
  <div class="card">
    <h3 style="margin: 0 0 10px 0;">Parent WhatsApp</h3>

    <p class="muted">
      This system does not store parent phone numbers or message contents.
      WhatsApp is opened immediately when screening is completed.
      To re-open WhatsApp later, enter the parent number again:
    </p>

    <form method="get" action="{% url 'send_parent_whatsapp' s.id %}" target="_blank" style="margin-top: 10px;">
      <label for="id_phone_e164"><strong>Parent WhatsApp number (E.164)</strong></label>
      <input id="id_phone_e164" name="phone_e164" type="text" placeholder="+91..." required style="width: 100%; padding: 10px; margin: 6px 0 10px 0;">
      <div class="actions">
        <button class="button primary" type="submit">Open WhatsApp</button>
        <a class="button" href="{% url 'teacher_portal' %}">Back to Teacher Portal</a>
      </div>
    </form>

    {% if last_message %}
      <p class="muted" style="margin-top: 10px;">
        Last WhatsApp action logged for PID: <strong>{{ last_message.pid }}</strong>
        (template: <strong>{{ last_message.template_code }}</strong>, status: {{ last_message.get_status_display }})
      </p>
    {% endif %}
  </div>
{% endif %}

    {% if video_url %}
      <div class="card">
        <h3 style="margin: 0 0 10px 0;">Next steps for parents</h3>
        <p class="muted">
          You can go back to the education video to better understand your child's nutrition and the Nutrilift program.
        </p>
        <div class="actions">
          <a class="button primary" href="{{ video_url }}">Back to education video</a>
        </div>
      </div>
    {% endif %}
  </div>
</body>
</html>

================================================================================
FILE: templates\screening\teacher_portal.html
================================================================================

{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Teacher Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 1100px; margin: 0 auto; }
    header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    h2 { margin: 0 0 8px 0; }
    .muted { color: #666; font-size: 14px; margin: 4px 0 0 0; }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 14px 0; }
    .toolbar form { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    label { font-size: 13px; color: #333; display: block; margin-bottom: 4px; }
    select, input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: #fff; min-width: 180px; }
    button, a.button { display: inline-block; padding: 9px 12px; border: 1px solid #ddd; border-radius: 10px; background: #fff; color: #111; text-decoration: none; cursor: pointer; }
    button.primary, a.button.primary { border-color: #111; background: #111; color: #fff; }
    a.button:hover, button:hover { opacity: 0.92; }

    .messages { margin: 12px 0; padding: 0; list-style: none; }
    .messages li { margin: 6px 0; padding: 10px 12px; border-radius: 10px; background: #fff; border: 1px solid #eee; }
    .messages li.success { border-color: #cfe9d6; background: #f2fbf5; }
    .messages li.warning { border-color: #ffe3b3; background: #fff8ea; }
    .messages li.error { border-color: #ffd0d0; background: #fff2f2; }

    table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; vertical-align: top; }
    th { background: #fcfcfc; font-weight: 650; }
    tr:last-child td { border-bottom: none; }

    .badge { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; background: #fff; }
    .badge.green { border-color: #bfe8c6; background: #eefbf1; }
    .badge.yellow { border-color: #ffe3b3; background: #fff8ea; }
    .badge.red { border-color: #ffd0d0; background: #fff2f2; }

    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h2>Teacher Portal</h2>
        <p class="muted">Select a student to complete the new Growth & Health Screening (Sections A–F).</p>
      </div>

      <div>
        <a class="button primary"
           href="{% url 'teacher_add_student_token' teacher_token %}{% if selected_classroom %}?classroom={{ selected_classroom }}{% endif %}">
          + Add student
        </a>
      </div>
    </header>

    {% if messages %}
      <ul class="messages">
        {% for m in messages %}
          <li class="{{ m.tags }}">{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <div class="toolbar">
      <form method="get">
        <div>
          <label for="classroom">Classroom</label>
          <select id="classroom" name="classroom" onchange="this.form.submit()">

            <option value="">All</option>
            {% for c in classrooms %}
              <option value="{{ c.id }}" {% if selected_classroom == c.id %}selected{% endif %}>
                {{ c.grade }}{% if c.division %}-{{ c.division }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="risk">Last Status</label>
          <select id="risk" name="risk" onchange="this.form.submit()">
            <option value="" {% if not selected_risk %}selected{% endif %}>All</option>
            <option value="GREEN" {% if selected_risk == "GREEN" %}selected{% endif %}>GREEN</option>
            <option value="YELLOW" {% if selected_risk == "YELLOW" %}selected{% endif %}>YELLOW</option>
            <option value="RED" {% if selected_risk == "RED" %}selected{% endif %}>RED</option>
          </select>
        </div>

        <div>
          <label for="q">Search</label>
          <input id="q" type="text" name="q" value="{{ q|default:'' }}" placeholder="Name or Student ID">
        </div>

        <div>
          <button class="primary" type="submit">Apply</button>
          <a class="button" href="{% url 'teacher_portal' %}">Clear</a>
        </div>
      </form>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 34%;">Student</th>
          <th style="width: 22%;">Class</th>
          <th style="width: 16%;">Last Status</th>
          <th style="width: 14%;">Supplements</th>
          <th style="width: 28%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
          <tr>
            <td>
              <div style="font-weight: 650;">{{ s.full_name }}</div>
              {% if s.student_code %}<div class="muted">ID: {{ s.student_code }}</div>{% endif %}
            </td>
            <td>
              {% if s.classroom %}
                {{ s.classroom.grade }}{% if s.classroom.division %}-{{ s.classroom.division }}{% endif %}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if s.last_risk %}
                {% if s.last_risk == "GREEN" %}
                  <span class="badge green">GREEN</span>
                {% elif s.last_risk == "YELLOW" or s.last_risk == "AMBER" %}
                  <span class="badge yellow">YELLOW</span>
                {% elif s.last_risk == "RED" %}
                  <span class="badge red">RED</span>
                {% else %}
                  <span class="badge">{{ s.last_risk }}</span>
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if s.last_risk == "RED" and s.supplements_granted %}
                Granted
              {% else %}
                Not Granted
              {% endif %}
            </td>
            <td>
              <div class="row-actions">
                <a class="button primary" href="{% url 'screening_create' s.id %}">Fill Screening</a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5">No students found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening\whatsapp_preview.html
================================================================================

<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Open WhatsApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; background: #fafafa; color: #111; }
      .container { max-width: 820px; margin: 0 auto; }
      .card { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; margin: 12px 0; }
      pre { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 10px; border: 1px solid #eee; }
      a.button {
        display: inline-block;
        padding: 10px 16px;
        text-decoration: none;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #fff;
        color: #111;
      }
      a.button.primary { background: #111; color: #fff; border-color: #111; }
      .muted { color: #666; font-size: 14px; margin: 6px 0 0 0; }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <h2 style="margin: 0;">Ready to message the parent</h2>
        <p class="muted">If WhatsApp didn’t open automatically, tap the button below.</p>

        <div class="actions">
          <a
            id="open-wa-btn"
            class="button primary"
            href="{{ wa_url }}"
            target="_blank"
            rel="noopener noreferrer"
          >
            Open WhatsApp
          </a>
          <a class="button" href="{{ next_url }}">Continue</a>
        </div>
      </div>

      <div class="card">
        <h3 style="margin: 0 0 10px 0;">Message preview</h3>
        <pre>{{ message_text }}</pre>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("open-wa-btn");
        if (!btn) return;
    
        btn.addEventListener("click", function (e) {
          e.preventDefault();
    
          var waUrl = "{{ wa_url|escapejs }}";
          var nextUrl = "{{ next_url|escapejs }}";
    
          // Open WhatsApp in a new tab
          window.open(waUrl, "_blank");
    
          // Redirect current tab back (we will set next_url to the teacher dashboard)
          if (nextUrl) {
            window.location.href = nextUrl;
          }
        });
      });
    </script>
  </body>
</html>

================================================================================
FILE: templates\screening_only\admin_auth_required.html
================================================================================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>School Registered Successfully</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      font-family: "Inter", system-ui, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: #f6f8fb;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background: #fff;
      width: 100%;
      max-width: 420px;
      padding: 32px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      text-align: center;
    }

    /* Check Icon */
    .check-icon {
      width: 54px;
      height: 54px;
      background: #22c55e;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 16px;
    }

    h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: #111827;
    }

    .school-name {
      margin-top: 10px;
      font-size: 15px;
      color: #374151;
      line-height: 1.5;
    }

    .school-name strong {
      font-weight: 600;
    }

    .section {
      margin-top: 26px;
    }

    .section-title {
      font-weight: 600;
      font-size: 15px;
      color: #111827;
      margin-bottom: 6px;
    }

    .section-desc {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }

    /* Google Button */
    .google-btn {
      margin-top: 24px;
      width: 100%;
      height: 46px;
      background: #000;
      color: #fff;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      transition: background 0.2s ease;
    }

    .google-btn:hover {
      background: #1f1f1f;
    }

    .google-icon {
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: bold;
      font-size: 14px;
    }

    .footer-text {
      margin-top: 12px;
      font-size: 12px;
      color: #9ca3af;
    }

    /* Authorized Email Box */
    .auth-box {
      margin-top: 18px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      font-size: 13px;
      color: #4b5563;
      text-align: left;
    }

    .auth-box code {
      background: #eef2f7;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }

  </style>
</head>

<body>

  <div class="card">

    <!-- Success Icon -->
    

    <!-- Title -->
    <h2>School Registered Successfully</h2>
    <div class="check-icon">✓</div>
    <!-- Description -->
    <p class="school-name">
      <strong>{{ org.name }}</strong> is now enrolled in the Nutrilift screening program.
    </p>

    <!-- Next Step -->
    <div class="section">
      <div class="section-title">Next step:</div>
      <div class="section-desc">
        Please sign in using the same Gmail ID you entered during registration.
      </div>
    </div>


    <!-- Google Login Button -->
    <a href="{{ google_start_url }}" class="google-btn">

      <div class="google-icon">G</div>
      Continue with Google

    </a>

    <!-- Footer -->
    <div class="footer-text">
      Secure sign-in for school records
    </div>

  </div>

</body>
</html>

================================================================================
FILE: templates\screening_only\admin_link_dashboard.html
================================================================================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Start Student Screening</title>

  <style>
    /* Prevent overflow issues */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      background: #fafafa;
      color: #111;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 24px;
    }

    .card h3 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 16px;
    }

    .label {
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
      display: block;
      letter-spacing: 0.4px;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      text-decoration: none;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-outline {
      background: #f2f2f2;
      color: #333;
      border: 1px solid #ccc;
    }
    
    .btn-outline:hover {
      background: #e6e6e6;
    }
    

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      resize: vertical;
      font-size: 14px;
      line-height: 1.4;
      background: #fafafa;
    }

    .muted {
      color: #777;
      font-size: 13px;
      margin-top: 8px;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 6px;
    }

    .status-sub {
      color: #666;
      font-size: 14px;
      margin-bottom: 14px;
    }

    .btn-wrap {
      margin-top: 12px;
    }

    /* ================= MOBILE RESPONSIVE ================= */
@media (max-width: 600px) {

  /* Global Fix */
  * {
    box-sizing: border-box;
  }

  body {
    padding: 14px 10px;
    max-width: 100%;
    overflow-x: hidden;
  }

  /* Headings */
  h1 {
    font-size: 20px;
    line-height: 1.3;
  }

  .subtitle {
    font-size: 13px;
    margin-bottom: 16px;
  }

  /* Cards */
  .card {
    width: 100%;
    max-width: 100%;
    padding: 14px;
    border-radius: 10px;
    margin-bottom: 20px;
  }

  .card h3 {
    font-size: 16px;
    margin-bottom: 12px;
  }

  /* Labels */
  .label {
    font-size: 11px;
    margin-bottom: 5px;
  }

  /* Buttons */
  .btn {
    width: 100%;
    max-width: 100%;
    padding: 11px;
    font-size: 13.5px;
    border-radius: 7px;
    white-space: normal;
  }

  a.btn {
    display: block;
  }

  .btn-outline {
    font-size: 13.5px;
  }

  /* Textarea */
  textarea {
    width: 100%;
    max-width: 100%;
    min-height: 130px;
    font-size: 13px;
    padding: 10px;
    border-radius: 7px;
    resize: vertical;

    /* Prevent overflow from long text */
    word-break: break-word;
    overflow-wrap: break-word;
  }

  /* Helper text */
  .muted {
    font-size: 12px;
    margin-top: 6px;
  }

  /* Status section */
  .section-title {
    font-size: 18px;
  }

  .status-sub {
    font-size: 13px;
    margin-bottom: 12px;
  }

  /* Button wrapper */
  .btn-wrap {
    margin-top: 10px;
  }

}


  </style>

  <script>
    function copyMessage() {
      const el = document.getElementById("teacherMessage");
      el.select();
      el.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("Message copied!");
    }
  </script>
</head>

<body>

  <!-- PAGE HEADER -->
  <h1>Start Student Screening</h1>
  <p class="subtitle">
    Share the details below with teachers to start student screening.
  </p>


  <!-- SHARE WITH TEACHERS -->
  <div class="card">

    <h3>Share with Teachers</h3>

    <!-- Teacher Link -->
    <label class="label">TEACHER SCREENING LINK</label>

    <a class="btn" href="{{ teacher_link }}" target="_blank">
      Open Teacher Link
    </a>

    <p class="muted">
      Teachers will fill the screening form using this link.
    </p>


    <!-- Message Box -->
    <label class="label" style="margin-top:18px;">
      MESSAGE TO SHARE ON WHATSAPP
    </label>

    <textarea id="teacherMessage" readonly>{{ teacher_message }}</textarea>


    <!-- Copy Button -->
    <div class="btn-wrap">
      <button class="btn btn-outline" onclick="copyMessage()">
        Copy Message
      </button>
    </div>

  </div>


  <!-- SCREENING STATUS -->
  <h2 class="section-title">School Screening Status</h2>

  <p class="status-sub">
    Check screening progress after teachers start filling forms.
  </p>

  <a class="btn btn-outline" href="{{ dashboard_url }}">
    View School Screening Status
  </a>


</body>
</html>

================================================================================
FILE: templates\screening_only\admin_onboarding.html
================================================================================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pre-screening Onboarding</title>

  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 24px 12px;
      display: flex;
      justify-content: center;
    }
  
    .container {
      width: 100%;
      max-width: 480px;
    }
  
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 6px;
    }
  
    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 24px;
    }
  
    /* STEP CARD */
  
    .step-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
  
      display: flex;
      gap: 12px;
      align-items: flex-start; /* Important */
    }
  
    .step-number {
      width: 28px;
      height: 28px;
      background: #000;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
      margin-top: 2px;
    }
  
    .step-content {
      flex: 1;
    }
  
    .step-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
  
    .step-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }
  
    /* BUTTON */
  
    .step-btn {
      display: block;
    
      width: 100%;
      max-width: 420px;   /* Bigger on desktop */
    
      margin: 0 auto;
    
      padding: 10px 14px;
      border: 1px solid #000;
      border-radius: 8px;
      background: #fff;
      color: #000;
    
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
    
      transition: 0.15s ease;
    }
    
  
    .step-btn:hover {
      background: #000;
      color: #fff;
    }
  
    /* START BUTTON */
  
    .start-btn {
      display: block;
      width: 100%;
      margin-top: 24px;
      padding: 14px;
  
      background: #000;
      color: #fff;
      border-radius: 10px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
  
      border: none;
      cursor: pointer;
      transition: 0.15s ease;
    }
  
    .start-btn:hover {
      opacity: 0.9;
    }

    /* ---------- MOBILE RESPONSIVE ---------- */

@media (max-width: 600px) {

  body {
    padding: 16px 10px;
  }

  h1 {
    font-size: 20px;
  }

  .subtitle {
    font-size: 13px;
    margin-bottom: 20px;
  }

  .step-card {
    padding: 14px;
    gap: 10px;
  }

  .step-number {
    width: 26px;
    height: 26px;
    font-size: 13px;
  }

  .step-title {
    font-size: 14px;
  }

  .step-desc {
    font-size: 12.5px;
  }

  .step-btn {
    max-width: 100%;     /* Full width on mobile */
    font-size: 13.5px;
    padding: 9px 10px;
  }

  .start-btn {
    font-size: 14px;
    padding: 13px;
    border-radius: 9px;
  }

  .container {
    max-width: 100%;
  }
}

  </style>
  
</head>

<body>

  <div class="container">

    <!-- Heading -->
    <h1>Before You Start Screening</h1>
    <p class="subtitle">
      This will help you understand how to screen students.
    </p>


    <!-- Step 1 -->
    <div class="step-card">

      <div class="step-number">1</div>

      <div class="step-content">

        <div class="step-title">
          Watch the training video
        </div>

        <div class="step-desc">
          Explains how to screen students step by step.
        </div>

        <a href="{{ training_url }}" target="_blank" class="step-btn">
          Watch Training Video
        </a>

      </div>

    </div>


    <!-- Step 2 -->
    <div class="step-card">

      <div class="step-number">2</div>

      <div class="step-content">

        <div class="step-title">
          Download the screening guide
        </div>

        <div class="step-desc">
          You can refer to this anytime if needed.
        </div>

        <a href="{{ guide_url }}" target="_blank" class="step-btn">
          Download Screening Guide (PDF)
        </a>

      </div>

    </div>


    <!-- Continue Button -->
    <a href="{{ continue_url }}" class="start-btn">
      Start Student Screening
    </a>


  </div>

</body>
</html>

================================================================================
FILE: templates\screening_only\admin_performance_dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body{font-family:system-ui;max-width:980px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
    select{padding:8px;border:1px solid #ddd;border-radius:10px}
    .sub-heading {
      font-size: 15px;
      font-weight: 400;     /* Thin text */
      color: #888;          /* Grey */
      margin-top: 4px;
      margin-bottom: 12px;
    }
    /* ================= MOBILE RESPONSIVE ================= */
@media (max-width: 700px) {

  /* Prevent overflow */
  * {
    box-sizing: border-box;
  }

  body {
    padding: 12px 8px;
    overflow-x: hidden;
  }

  .card {
    width: 100%;
    max-width: 100%;
    padding: 12px;
    overflow: hidden;   /* Lock content inside */
  }

  /* Table Scroll Container */
  .table-wrap {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Table */
  table {
    width: 100%;
    min-width: 520px;   /* Force internal scroll */
    border-collapse: collapse;
  }

  th,
  td {
    padding: 6px 6px;
    font-size: 12px;
    line-height: 1.3;
    text-align: center;

    /* Allow text to wrap */
    white-space: normal;
    word-break: break-word;
  }

  th {
    font-size: 12.5px;
    font-weight: 600;
  }

  /* Reduce wide columns */
  th:nth-child(3),
  th:nth-child(4),
  th:nth-child(5),
  td:nth-child(3),
  td:nth-child(4),
  td:nth-child(5) {
    min-width: 80px;
  }

}

  </style>
</head>
<body>
  <div class="card">
    <h2>School Screening Status - {{ org.name }}</h2>
    <h3 class="sub-heading">Check screening status class-wise</h3>

    <form method="get">
      <label>Academic year:</label>
      <select name="ay" onchange="this.form.submit()">
        {% for y in years %}
          <option value="{{ y }}" {% if y == ay %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </form>

    <p><a class="btn" href="{{ link_dashboard_url }}">Back to Teacher Link</a></p>
  </div>

  <div class="card">
    <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Class</th>
          <th>Section</th>
          <th>Students screened once</th>
          <th>Students screened twice</th>
          <th>Total students screened</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.grade }}</td>
            <td>{{ r.division }}</td>
            <td>{{ r.screened_once }}</td>
            <td>{{ r.screened_twice }}</td>
            <td>{{ r.total_students }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5">No students screened yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\admin_unauthorized.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Access Denied</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Unauthorized login</h2>
    <p>Access is denied because the email used is not authorized for this school.</p>
    <p class="muted">Attempted: <code>{{ attempted_email }}</code></p>

    <p class="muted">Authorized emails:</p>
    <ul class="muted">
      <li><code>{{ principal_email }}</code></li>
      {% if operator_email %}<li><code>{{ operator_email }}</code></li>{% endif %}
    </ul>

    <a class="btn" href="{{ retry_url }}">Try again with authorized email</a>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\enroll_school.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nutrilift – School Enrollment</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    label{display:block;margin-top:10px;font-weight:600}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px}
    input[type="checkbox"]{width:auto;margin-right:8px;margin-top:0}
    button{margin-top:14px;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff}
    .muted{color:#666}
    .errorlist{margin:4px 0 0;padding:0;list-style:none;color:#c00;font-size:0.9em}
  </style>
</head>
<body>
  <hr style="margin:20px 0;border:none;border-top:2px solid #eee">
    
    <div style="text-align:center;padding:20px 0;">
      <h3 style="margin-bottom:10px;">Already Registered?</h3>
      <a href="{% url 'screening_only:existing_admin_login' %}" 
         style="display:inline-block;padding:12px 24px;background:#4285f4;color:#fff;text-decoration:none;border-radius:8px;font-weight:600;">
        Sign in with Google
      </a>
    </div>
  <div class="card">
    <h2>School Registration – Nutrilift Screening Program</h2>
    <p class="muted" style="margin-bottom:16px;">Register your school in Nutrilift. This will help you check children's growth and nutrition easily.</p>
    <form method="post">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <label for="{{ form.school_name.id_for_label }}">School Name</label>
      {{ form.school_name }}
      {{ form.school_name.errors }}

      <label for="{{ form.address.id_for_label }}">Address</label>
      {{ form.address }}
      {{ form.address.errors }}

      <label for="{{ form.city.id_for_label }}">City</label>
      {{ form.city }}
      {{ form.city.errors }}

      <label for="{{ form.state.id_for_label }}">State</label>
      {{ form.state }}
      {{ form.state.errors }}

      <label for="{{ form.country.id_for_label }}">Country</label>
      {{ form.country }}
      {{ form.country.errors }}

      <hr style="margin:14px 0;border:none;border-top:1px solid #eee">

      <label for="{{ form.principal_name.id_for_label }}">Principal Name</label>
      {{ form.principal_name }}
      {{ form.principal_name.errors }}

      <label for="{{ form.principal_email.id_for_label }}">Principal Email</label>
      {{ form.principal_email }}
      {{ form.principal_email.errors }}

      <label for="{{ form.operator_name.id_for_label }}">
        School In-charge
        <div class="muted" style="font-weight:400;font-size:0.9em;">
          Person managing Nutrilift in your school
        </div>
      </label>
      
      {{ form.operator_name }}
      {{ form.operator_name.errors }}

      <label for="{{ form.operator_email.id_for_label }}">School In-charge's email</label>
      {{ form.operator_email }}
      {{ form.operator_email.errors }}

      <div style="display:none;">
        <label for="{{ form.local_language_code.id_for_label }}">Local Language Code</label>
        {{ form.local_language_code }}
        {{ form.local_language_code.errors }}
      </div>
      

      <label style="display:flex;align-items:center;margin-top:16px;font-weight:400;">
        {{ form.terms_accepted }}
        <span>I agree to the <a href="#" onclick="window.open('https://example.com/terms', '_blank'); return false;" style="color:#4285f4;text-decoration:underline;">Terms and Conditions</a></span>
      </label>
      {{ form.terms_accepted.errors }}

      <button type="submit">Submit Registration</button>
    </form>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\enroll_success.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Enrollment Successful</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h2>Registration received</h2>
    <p class="muted"><strong>{{ org.name }}</strong> is now enrolled.</p>
    <p>Next step: Principal / Program Operator must sign in with the authorized Google email.</p>

    <a class="btn" href="{{ admin_auth_url }}">Continue to Google Sign-in</a>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\inditech_school_dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inditech – {{ org.name }}</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    select{padding:8px;border:1px solid #ddd;border-radius:10px}
    .muted{color:#666}
    a.btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <h2>{{ org.name }} – Screening Performance</h2>
    <p class="muted">District: {{ profile.district|default:"—" }} | Registered: {{ profile.created_at|date:"Y-m-d" }}</p>

    <form method="get">
      <label>Academic year:</label>
      <select name="ay" onchange="this.form.submit()">
        {% for y in years %}
          <option value="{{ y }}" {% if y == ay %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </form>

    <p class="muted">Period: {{ start_dt }} → {{ end_dt }}</p>

    <p><a class="btn" href="{% url 'screening_only:inditech_school_list' %}">Back to Registered Schools</a></p>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Class</th><th>Division</th><th>Screened once</th><th>Screened twice</th><th>Total students screened</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.grade }}</td>
            <td>{{ r.division }}</td>
            <td>{{ r.screened_once }}</td>
            <td>{{ r.screened_twice }}</td>
            <td>{{ r.total_students }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5">No data.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\inditech_school_list.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inditech – Registered Schools</title>
  <style>
    body{font-family:system-ui;max-width:1100px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:left}
    a.btn{display:inline-block;padding:6px 10px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h2>Inditech – Registered Schools</h2>
    <table>
      <thead>
        <tr><th>School</th><th>District</th><th>Registered</th><th></th></tr>
      </thead>
      <tbody>
        {% for s in schools %}
          <tr>
            <td>{{ s.organization.name }}</td>
            <td>{{ s.district|default:"—" }}</td>
            <td>{{ s.created_at|date:"Y-m-d" }}</td>
            <td><a class="btn" href="{% url 'screening_only:inditech_school_dashboard' s.organization.id %}">View dashboard</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No schools.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\parent_result.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Screening Result</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    .badge{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .red{background:#fee2e2;border-color:#fecaca}
    .green{background:#dcfce7;border-color:#bbf7d0}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h2>Screening Result</h2>
    <p><strong>Child:</strong> {{ screening.student.full_name }}</p>

    <p><strong>Date:</strong> {{ screening.screened_at|date:"Y-m-d" }}</p>

    <p>
      <strong>Status:</strong>
      {% if screening.risk_level == "RED" %}
        <span class="badge red">RED</span>
      {% else %}
        <span class="badge green">{{ screening.risk_level|default:"-" }}</span>
      {% endif %}
    </p>

    <p><strong>Findings:</strong> {{ flags_text|default:"—" }}</p>

    <p class="muted">This page is for informational purposes and does not constitute medical diagnosis.</p>

    <p style="margin-top:14px;">
      <a class="btn" href="{{ video_url }}">Back to education video</a>
    </p>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\parent_video.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Parent Education Video</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    select{padding:10px;border:1px solid #ddd;border-radius:10px}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none}
    .muted{color:#666}
    iframe{width:100%;height:360px;border:0;border-radius:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Understanding your child's nutrition & the Nutrilift program</h2>

    <form method="get">
      <label>Language:</label>
      <select name="lang" onchange="this.form.submit()">
        <option value="en" {% if lang == "en" %}selected{% endif %}>English</option>
        <option value="hi" {% if lang == "hi" %}selected{% endif %}>Hindi</option>
        <option value="{{ local_code }}" {% if lang == local_code %}selected{% endif %}>Local</option>
      </select>
    </form>

    <p class="muted">If the video does not load, open it directly: <a href="{{ video_url }}" target="_blank">{{ video_url }}</a></p>

    <!-- Works best if your EDU_VIDEO_URL_* are already "embed" URLs. Otherwise it still renders a player in many cases. -->
    <iframe src="{{ video_url }}" allowfullscreen></iframe>

    <p style="margin-top:14px;">
      <a class="btn" href="{{ result_url }}">Click here to view screening result of your child</a>
    </p>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\teacher_access_denied.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Access Denied</title>
  <style>
    body{font-family:system-ui;max-width:520px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none;width:100%;text-align:center;margin-top:10px}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Access Denied</h2>
    <p>Email mismatch error:</p>
    <p class="muted">Entered: <code>{{ expected_email }}</code></p>
    <p class="muted">Signed in as: <code>{{ attempted_email }}</code></p>

    <a class="btn" href="{{ retry_url }}">Try Logging In Again</a>
    <a class="btn" href="{{ change_email_url }}" style="background:#fff;color:#111;">Change Email Address</a>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\teacher_access_portal.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher Access Portal</title>
  <style>
    body{font-family:system-ui;max-width:520px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    label{display:block;margin-top:10px;font-weight:600}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px}
    button{margin-top:14px;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;width:100%}
    .muted{color:#666}
    a{color:#111;text-decoration:underline}
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 14px;
    }
    
    .checkbox-row input[type="checkbox"] {
      margin: 0;
      width: auto;
    }
    
  </style>
</head>
<body>
  <div class="card">
    <h2>Teacher Access Portal</h2>

    <form method="post">
      {% csrf_token %}
      <label>Full Name</label>{{ form.full_name }}
      <label>Email Address</label>{{ form.email }}

      <div class="checkbox-row">
        {{ form.accept_terms }}
      
        <span>
          I accept the 
          <a href="{% url 'screening_only:teacher_terms' %}?return_token={{ org.screening_link_token }}">
            terms and conditions
          </a>
        </span>
      </div>
      

      <button type="submit">Continue to Sign In</button>
    </form>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\teacher_auth_required.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sign in with Google</title>
  <style>
    body{font-family:system-ui;max-width:520px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;text-decoration:none;width:100%;text-align:center}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Sign in to Start Student Screening</h2>
    <div class="muted" style="font-size:0.9em;margin-top:4px;">
      Use the same Gmail ID you entered on the previous screen.
    </div>
    <p><code>{{ expected_email }}</code></p>
    <a class="btn" href="{{ google_start_url }}">Continue with Google</a>
  </div>
</body>
</html>

================================================================================
FILE: templates\screening_only\teacher_class_selection.html
================================================================================

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select Class and Section</title>
  <style>
    body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  max-width: 1000px;
  margin: 0 auto;
  padding: 24px;
  background: #fafafa;
  color:#111;
}

/* Container becomes card style */
.container{
  max-width: 520px;
  margin: 40px auto;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:24px;
}

/* Heading */
h1{
  font-size: 26px;
  font-weight: 700;
  margin-bottom: 20px;
}

/* Rows */
.row{
  margin:18px 0;
}

/* Labels */
label{
  display:block;
  font-weight:600;
  margin-bottom:6px;
  font-size:14px;
  color:#374151;
}

/* Select inputs */
select{
  width:100%;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:8px;
  font-size:14px;
  background:#fff;
}

/* Button – same as add-btn */
.btn{
  margin-top:20px;
  display:inline-block;
  padding:12px 20px;
  background:#000;
  color:#fff;
  border:1px solid #000;
  border-radius:10px;
  font-size:14px;
  font-weight:500;
  cursor:pointer;
}

.btn:hover{
  opacity:.9;
}
  </style>
</head>
<body>
  <div class="container">
    <h1>Select Class and Section</h1>

    <form method="post">
      {% csrf_token %}

      <div class="row">
        <label for="id_grade">Class</label>
        <select id="id_grade" name="grade" required>
          <option value="">Select class</option>
          {% for g in grades %}
            <option value="{{ g }}" {% if selected_grade == g %}selected{% endif %}>{{ g }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="row">
        <label for="id_division">Section</label>
        <select id="id_division" name="division" required>
          <option value="">Select section</option>
        </select>
      </div>

      <button class="btn" type="submit">Continue</button>
    </form>
  </div>

  <script>
    const divisionsByGrade = {{ divisions_by_grade|safe }};
    const gradeSelect = document.getElementById("id_grade");
    const divisionSelect = document.getElementById("id_division");

    let initialDivision = "{{ selected_division|escapejs }}";

    function syncDivisionOptions() {
      const grade = gradeSelect.value;

      divisionSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select section";
      divisionSelect.appendChild(placeholder);

      if (!grade || !divisionsByGrade[grade]) return;

      divisionsByGrade[grade].forEach(function(div) {
        const opt = document.createElement("option");
        opt.value = div;
        opt.textContent = div || "—";
        if (initialDivision && div === initialDivision) opt.selected = true;
        divisionSelect.appendChild(opt);
      });
    }

    gradeSelect.addEventListener("change", function() {
      initialDivision = "";   // user is changing grade; don't auto-select old division
      syncDivisionOptions();
    });

    // init
    syncDivisionOptions();
  </script>
</body>
</html>
================================================================================
FILE: templates\screening_only\teacher_dashboard.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Student Screening</title>

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
      background: #fafafa;
      color:#111;
    }

    /* Header */
    .page-header{
      margin-bottom: 24px;
    }

    .page-header h1{
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .page-header p{
      color:#555;
      margin:0;
      font-size:14px;
    }

    /* Add button section */
    .add-section{
      margin: 24px 0;
      text-align:center;
    }

    .add-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      background:#000;
      color:#fff;
      text-decoration:none;

      padding:14px 24px;
      border-radius:10px;
      font-size:15px;
      font-weight:500;
      border:1px solid #000;
    }

    .add-btn:hover{
      opacity:.9;
    }

    .helper-text{
      margin-top:8px;
      font-size:13px;
      color:#666;
    }

    /* Section title */
    .section-title{
      margin:32px 0 12px;
      font-size:18px;
      font-weight:600;
      letter-spacing:.5px;
    }

    /* Card */
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:16px;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th{
      text-align:left;
      padding:10px;
      background:#f9fafb;
      border-bottom:1px solid #e5e7eb;
      font-weight:600;
      color:#374151;
    }

    td{
      padding:12px 10px;
      border-bottom:1px solid #eee;
      vertical-align:middle;
    }

    tr:last-child td{
      border-bottom:none;
    }

    /* Badges */
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid transparent;
      font-weight:500;
    }

    .red{
      background:#fee2e2;
      border-color:#fecaca;
      color:#991b1b;
    }

    .green{
      background:#dcfce7;
      border-color:#bbf7d0;
      color:#166534;
    }

    .gray{
      background:#f3f4f6;
      border-color:#e5e7eb;
      color:#374151;
    }

    /* Action button */
    .table-btn{
      display:inline-block;
      padding:7px 12px;
      font-size:13px;
      border-radius:8px;
      background:#000;
      color:#fff;
      text-decoration:none;
      border:1px solid #000;
      white-space:nowrap;
    }

    .table-btn:hover{
      opacity:.9;
    }

    /* Footer note */
    .note{
      margin-top:24px;
      font-size:13px;
      color:#666;
      text-align:center;
    }
    .page-header{
  margin-bottom: 24px;
  position: relative;   /* important */
}

.back-btn{
  position: absolute;
  top: 0;
  right: 0;

  padding: 6px 12px;
  font-size: 13px;
  border-radius: 8px;

  background: #000;
  color: #fff;
  text-decoration: none;
  border: 1px solid #000;
}

.back-btn:hover{
  opacity: .9;
}
  </style>
</head>

<body>

  <!-- Header -->
  <div class="page-header">
    <h1>Student Screening – {{ org.name }}</h1>
    {% if selected_classroom %}
      <p style="margin: 6px 0 18px; color: #333;">
        <strong>Selected:</strong> Class {{ selected_classroom.grade }}{% if selected_classroom.division %} - {{ selected_classroom.division }}{% endif %}
      </p>
    {% endif %}
    <a href="{% url 'screening_only:teacher_class_selection' %}" class="back-btn">
        Back to class selection
    </a>
  </div>


  <!-- Add Student Button -->
  <div class="add-section">
    <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
        <a href="{{ add_student_url }}" class="add-btn">+ Add New Student for Screening</a>
    </div>

    <div class="helper-text">
      To update screening for a student, click on the roll number.
    </div>
  </div>


  <!-- Students Section -->
  <div class="section-title">
    STUDENTS SCREENED
  </div>

  <div class="card">

    <table>
      <thead>
        <tr>
          <th>Roll Number</th>
          <th>Class</th>
          <th>Last Screened</th>
          <th>Status</th>
        </tr>
      </thead>
    
      <tbody>
    
        {% for s in students %}
          <tr>
    
            <!-- Clickable Name -->
            <td>
              <a href="{{ s.screening_url }}"
                 style="
                   color:#111;
                   text-decoration:none;
                   font-weight:500;
                 "
                 onmouseover="this.style.textDecoration='underline'"
                 onmouseout="this.style.textDecoration='none'">
    
                 {{ s.student_code|default:"—" }}
    
              </a>
            </td>
    
            <!-- Class -->
            <td>
              {% if s.classroom %}
                {{ s.classroom.grade }} - {{ s.classroom.division }}
              {% else %}
                —
              {% endif %}
            </td>
    
            <!-- Last screened -->
            <td>
              {% if s.last_screened_at %}
                {{ s.last_screened_at|date:'Y-m-d' }}
              {% else %}
                —
              {% endif %}
            </td>
    
            <!-- Status -->
            <td>
              {% if s.last_risk == "RED" %}
                <span class="badge red">Needs Attention</span>
    
              {% elif s.last_risk %}
                <span class="badge green">Normal</span>
    
              {% else %}
                <span class="badge gray">Not Screened</span>
              {% endif %}
            </td>
    
          </tr>
    
        {% empty %}
          <tr>
            <td colspan="4">No students found.</td>
          </tr>
        {% endfor %}
    
      </tbody>
    </table>
    

  </div>

</body>
</html>

================================================================================
FILE: templates\screening_only\teacher_terms.html
================================================================================

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher Terms and Conditions</title>
  <style>
    body{font-family:system-ui;max-width:860px;margin:0 auto;padding:1rem;background:#fafafa}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    label{display:block;margin-top:10px;font-weight:600}
    select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px;background:#fff}
    .terms{margin-top:14px}
    .terms p{margin:0 0 10px 0;line-height:1.45}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    {% if return_token %}
    <p style="margin:0 0 12px 0;">
      <a href="{% url 'screening_only:teacher_access_portal' return_token %}" style="color:#4285f4;text-decoration:underline;">← Back to Teacher Portal</a>
    </p>
    {% endif %}
    <h2>Terms and Conditions</h2>
    
    <form method="get">
      {% if return_token %}<input type="hidden" name="return_token" value="{{ return_token }}"/>{% endif %}
      <label for="lang">Language</label>
      <select id="lang" name="lang" onchange="this.form.submit()">
        {% for code,label in languages %}
          <option value="{{ code }}" {% if code == lang %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
      <noscript style="display:block;margin-top:10px;">
        <button type="submit">Change language</button>
      </noscript>
    </form>

    <div class="terms">
      {% for para in terms_paragraphs %}
        <p>{{ para }}</p>
      {% endfor %}
    </div>
  </div>
</body>
</html>

================================================================================
FILE: tests\test_permissions.py
================================================================================

import pytest
from django.urls import reverse
from django.contrib.auth import get_user_model
from accounts.models import Organization, OrgMembership, Role

User = get_user_model()

@pytest.mark.django_db
def test_org_admin_can_see_school_reporting(client):
    org = Organization.objects.create(name="Test School", screening_link_token="test-123")
    u = User.objects.create_user(email="admin@test", password="x")
    OrgMembership.objects.create(user=u, organization=org, role=Role.ORG_ADMIN)
    client.login(email="admin@test", password="x")
    resp = client.get(reverse("reporting:school_dashboard") + f"?org={org.id}")
    assert resp.status_code in (200, 302)

@pytest.mark.django_db
def test_teacher_cannot_see_inditech_console(client):
    org = Organization.objects.create(name="Test School", screening_link_token="test-123")
    u = User.objects.create_user(email="t@test", password="x")
    OrgMembership.objects.create(user=u, organization=org, role=Role.TEACHER)
    client.login(email="t@test", password="x")
    resp = client.get(reverse("reporting:inditech_console"))
    assert resp.status_code == 403

@pytest.mark.django_db
def test_suspended_school_blocked_delivery(client):
    from program.models import Enrollment, MonthlySupply
    org = Organization.objects.create(name="Test School", screening_link_token="t-1", assistance_suspended=True)
    u = User.objects.create_user(email="admin@test", password="x", is_staff=True)
    OrgMembership.objects.create(user=u, organization=org, role=Role.ORG_ADMIN)
    client.login(email="admin@test", password="x")
    # fake supply row
    from roster.models import Student
    st = Student.objects.create(organization=org, first_name="A", gender="M")
    from assist.models import Application
    app = Application.objects.create(organization=org, student=st, status="APPROVED")
    from program.models import Enrollment
    e = Enrollment.objects.create(organization=org, application=app, student=st, start_date="2024-01-01", end_date="2024-07-01")
    from program.models import MonthlySupply
    ms = MonthlySupply.objects.create(enrollment=e, month_index=1, qr_token="q", delivered_on=None)
    resp = client.post(reverse("program:mark_delivered", args=[ms.id]) + f"?org={org.id}")
    assert resp.status_code == 403
