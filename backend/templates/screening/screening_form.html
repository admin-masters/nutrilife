<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Screening – {{ student.full_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 980px; margin: 0 auto; }
    h2 { margin: 0 0 4px 0; }
    .muted { color: #666; font-size: 14px; margin: 4px 0 0 0; }
    form { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; }

    fieldset { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin: 14px 0; }
    legend { padding: 0 8px; font-weight: 700; }
    .section-hint { margin: 8px 0 0 0; color: #666; font-size: 13px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    .field { margin: 8px 0; }
    .field label { display: block; font-size: 13px; color: #222; font-weight: 600; margin-bottom: 4px; }
    .field input[type="text"], .field input[type="number"], .field input[type="date"], .field select, .field textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }

    .radio ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 14px; flex-wrap: wrap; }
    .radio li { margin: 0; }
    .radio label { display: inline; font-size: 14px; color: #111; margin: 0; }

    .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; margin-top: 6px; }
    @media (max-width: 720px) { .checks { grid-template-columns: 1fr; } }
    .check { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid #f0f0f0; border-radius: 10px; background: #fcfcfc; }
    .check label { margin: 0; display: inline; font-size: 14px; color: #111; }

    .errors { color: #b00020; font-size: 13px; margin-top: 6px; }
    .nonfield { color: #b00020; background: #fff2f2; border: 1px solid #ffd0d0; padding: 10px 12px; border-radius: 10px; margin: 10px 0; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button, a.button {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      text-decoration: none;
      cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }

    .ask-child { color: #888; font-size: 12px; margin: 2px 0 6px 0; }
    .qrow { border: 1px solid #f0f0f0; border-radius: 12px; background: #fcfcfc; padding: 10px 12px; margin: 10px 0; }
    .qrow .qtitle { font-size: 14px; font-weight: 700; color: #111; margin: 0 0 4px 0; }
    .qrow .qtitle label { font-size: 14px; font-weight: 700; color: #111; margin: 0; display: inline; }
    .qrow select { margin-top: 4px; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Screening – {{ student.full_name }}</h2>
    

    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="nonfield">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- SECTION A -->
      <fieldset>
        <legend>Section A: Particulars</legend>
        

        <div class="grid">
          <div class="field">
            <label for="{{ form.student_name.id_for_label }}">{{ form.student_name.label }}</label>
            {{ form.student_name }}
            {% if form.student_name.errors %}<div class="errors">{{ form.student_name.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.unique_student_id.id_for_label }}">{{ form.unique_student_id.label }}</label>
            {{ form.unique_student_id }}
            {% if form.unique_student_id.errors %}<div class="errors">{{ form.unique_student_id.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.dob.id_for_label }}">{{ form.dob.label }}</label>
            {{ form.dob }}
            {% if form.dob.errors %}<div class="errors">{{ form.dob.errors }}</div>{% endif %}
            <div id="age-display" class="muted" style="margin-top: 4px;"></div>
          </div>

          <div class="field">
            <label for="{{ form.sex.id_for_label }}">{{ form.sex.label }}</label>
            {{ form.sex }}
            {% if form.sex.errors %}<div class="errors">{{ form.sex.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.parent_phone_e164.id_for_label }}">{{ form.parent_phone_e164.label }}</label>
            {{ form.parent_phone_e164 }}
            {% if form.parent_phone_e164.errors %}<div class="errors">{{ form.parent_phone_e164.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

      <!-- SECTION B -->
      <fieldset>
        <legend>Section B: Anthropometry</legend>
        

        <div class="grid">
          <div class="field">
            <label for="{{ form.weight_kg_r1.id_for_label }}">{{ form.weight_kg_r1.label }}</label>
            {{ form.weight_kg_r1 }}
            {% if form.weight_kg_r1.errors %}<div class="errors">{{ form.weight_kg_r1.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.height_cm_r1.id_for_label }}">{{ form.height_cm_r1.label }}</label>
            {{ form.height_cm_r1 }}
            {% if form.height_cm_r1.errors %}<div class="errors">{{ form.height_cm_r1.errors }}</div>{% endif %}
          </div>

          <div class="field radio" id="muac-field">
            <label for="{{ form.muac_tape_color.id_for_label }}">{{ form.muac_tape_color.label }}</label>
            {{ form.muac_tape_color }}
            {% if form.muac_tape_color.errors %}<div class="errors">{{ form.muac_tape_color.errors }}</div>{% endif %}
          </div>

        </div>
      </fieldset>


      <!-- SECTION C -->
      <fieldset>
        <legend>Section C: Quick Health Red Flags</legend>


      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_general_poor.id_for_label }}">{{ form.health_general_poor.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Do you feel healthy?</div>

        <div style="display:none;">
          {{ form.health_general_poor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_general_poor.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_general_poor.errors %}<div class="errors">{{ form.health_general_poor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_pallor.id_for_label }}">{{ form.health_pallor.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Does the child have pallor?</div>

        <div style="display:none;">
          {{ form.health_pallor }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_pallor.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_pallor.errors %}<div class="errors">{{ form.health_pallor.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_fatigue_dizzy_faint.id_for_label }}">{{ form.health_fatigue_dizzy_faint.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they remember having fainted while doing normal work/play, or if the child feels very too tired to do routine work/play?</div>

        <div style="display:none;">
          {{ form.health_fatigue_dizzy_faint }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_fatigue_dizzy_faint.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_fatigue_dizzy_faint.errors %}<div class="errors">{{ form.health_fatigue_dizzy_faint.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_breathlessness.id_for_label }}">{{ form.health_breathlessness.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they feel breathless on doing routine activities or while walking normally?</div>

        <div style="display:none;">
          {{ form.health_breathlessness }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_breathlessness.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_breathlessness.errors %}<div class="errors">{{ form.health_breathlessness.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_frequent_infections.id_for_label }}">{{ form.health_frequent_infections.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Does the child fall sick very often? Has been ill 3 times or more in the last month?</div>

        <div style="display:none;">
          {{ form.health_frequent_infections }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_frequent_infections.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_frequent_infections.errors %}<div class="errors">{{ form.health_frequent_infections.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_chronic_cough_or_diarrhea.id_for_label }}">{{ form.health_chronic_cough_or_diarrhea.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Does the child have cough and has had it for last 4 weeks or more, or does the child have loose motions and it has lasted more than 2 weeks?</div>

        <div style="display:none;">
          {{ form.health_chronic_cough_or_diarrhea }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_chronic_cough_or_diarrhea.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_chronic_cough_or_diarrhea.errors %}<div class="errors">{{ form.health_chronic_cough_or_diarrhea.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_visible_worms.id_for_label }}">{{ form.health_visible_worms.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they have ever seen small worms in their stool.</div>

        <div style="display:none;">
          {{ form.health_visible_worms }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_visible_worms.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_visible_worms.errors %}<div class="errors">{{ form.health_visible_worms.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_dental_or_gum_or_ulcers.id_for_label }}">{{ form.health_dental_or_gum_or_ulcers.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they have teeth pain, gum bleeding or mouth ulcers?</div>

        <div style="display:none;">
          {{ form.health_dental_or_gum_or_ulcers }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_dental_or_gum_or_ulcers.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_dental_or_gum_or_ulcers.errors %}<div class="errors">{{ form.health_dental_or_gum_or_ulcers.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_night_vision_difficulty.id_for_label }}">{{ form.health_night_vision_difficulty.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they stumble while walking in the dark since they can't see properly</div>

        <div style="display:none;">
          {{ form.health_night_vision_difficulty }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_night_vision_difficulty.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_night_vision_difficulty.errors %}<div class="errors">{{ form.health_night_vision_difficulty.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.health_bone_or_joint_pain.id_for_label }}">{{ form.health_bone_or_joint_pain.label }}</label>
        </div>
        <div class="ask-child">Ask the child- If they have pain in their arms/legs/joints, although they haven't been hurt and even without hard work/play?</div>

        <div style="display:none;">
          {{ form.health_bone_or_joint_pain }}
        </div>

        <select class="yn-proxy" data-checkbox-id="{{ form.health_bone_or_joint_pain.id_for_label }}">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        {% if form.health_bone_or_joint_pain.errors %}<div class="errors">{{ form.health_bone_or_joint_pain.errors }}</div>{% endif %}
      </div>


      <div class="field radio" style="margin-top: 12px;">
        <label for="{{ form.appetite.id_for_label }}">{{ form.appetite.label }}</label>
        {{ form.appetite }}
        {% if form.appetite.errors %}<div class="errors">{{ form.appetite.errors }}</div>{% endif %}
      </div>


      <fieldset id="girls-only-section" style="margin-top: 12px;">
        <legend>Girls only</legend>

        <div class="qrow" style="margin-top: 10px;">
          <div class="qtitle">
            <label for="{{ form.menarche_started.id_for_label }}">{{ form.menarche_started.label }}</label>
          </div>
          <div class="ask-child">Ask the child- If her menstruation has started. Put this ask the child question just above the selection box.</div>

          <div style="display:none;">
            {{ form.menarche_started }}
          </div>

          <select class="yn-proxy" data-checkbox-id="{{ form.menarche_started.id_for_label }}">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>

          {% if form.menarche_started.errors %}<div class="errors">{{ form.menarche_started.errors }}</div>{% endif %}
        </div>

        <div id="girls-menarche-details" style="margin-top: 8px;">
          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.menarche_age_years.id_for_label }}">{{ form.menarche_age_years.label }}</label>
            </div>
            <div class="ask-child">Ask the child- Menstruation started at what age?</div>
            {{ form.menarche_age_years }}
            {% if form.menarche_age_years.errors %}<div class="errors">{{ form.menarche_age_years.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.pads_per_day.id_for_label }}">{{ form.pads_per_day.label }}</label>
            </div>
            <div class="ask-child">Ask the child- How many pads per day does she need on heavy bleeding days.</div>
            {{ form.pads_per_day }}
            {% if form.pads_per_day.errors %}<div class="errors">{{ form.pads_per_day.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.cycle_length_days.id_for_label }}">{{ form.cycle_length_days.label }}</label>
            </div>
            <div class="ask-child">Ask the child- After how many days do your menses happen again?</div>
            {{ form.cycle_length_days }}
            {% if form.cycle_length_days.errors %}<div class="errors">{{ form.cycle_length_days.errors }}</div>{% endif %}
          </div>

          <div class="qrow">
            <div class="qtitle">
              <label for="{{ form.bleeding_clots.id_for_label }}">{{ form.bleeding_clots.label }}</label>
            </div>
            <div class="ask-child">Ask the child- Does the child pass clots while bleeding?</div>

            <div style="display:none;">
              {{ form.bleeding_clots }}
            </div>

            <select class="yn-proxy" data-checkbox-id="{{ form.bleeding_clots.id_for_label }}">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>

            {% if form.bleeding_clots.errors %}<div class="errors">{{ form.bleeding_clots.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>
      </fieldset>

<!-- SECTION D -->
      <fieldset>
        <legend>Section D: Diet Type & Diversity</legend>


      <div class="field radio">
        <label for="{{ form.diet_type.id_for_label }}">{{ form.diet_type.label }}</label>

        <div class="qrow" style="margin-top: 8px;">
          {% for radio in form.diet_type %}
            <div style="margin: 10px 0;">
              <div style="display:flex; gap:10px; align-items:center;">
                {{ radio.tag }}
                <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
              </div>

              {% if "Lacto-vegetarian" in radio.choice_label %}
                <div class="ask-child">Ask the child- Do you drink milk or eat dahi or paneer at home?</div>
              {% elif "Lacto-ovo-vegetarian" in radio.choice_label %}
                <div class="ask-child">Ask the child- Do you eat eggs at home?</div>
              {% elif "Non-vegetarian" in radio.choice_label %}
                <div class="ask-child">Ask the child- Do you eat fish, chicken or mutton at home?</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        {% if form.diet_type.errors %}<div class="errors">{{ form.diet_type.errors }}</div>{% endif %}
      </div>

        <p class="section-hint" style="margin-top: 12px; font-weight: 700; color: #111;">
          Did the student have the following in last 24 hours?
        </p>


      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.breakfast_eaten.id_for_label }}">{{ form.breakfast_eaten.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat Breakfast?</div>
        {{ form.breakfast_eaten }}
        {% if form.breakfast_eaten.errors %}<div class="errors">{{ form.breakfast_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.lunch_eaten.id_for_label }}">{{ form.lunch_eaten.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat Lunch?</div>
        {{ form.lunch_eaten }}
        {% if form.lunch_eaten.errors %}<div class="errors">{{ form.lunch_eaten.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.green_leafy_veg.id_for_label }}">{{ form.green_leafy_veg.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat green leafy vegetables in your last meal?</div>
        {{ form.green_leafy_veg }}
        {% if form.green_leafy_veg.errors %}<div class="errors">{{ form.green_leafy_veg.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.other_vegetables.id_for_label }}">{{ form.other_vegetables.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat any other vegetable in your last meal?</div>
        {{ form.other_vegetables }}
        {% if form.other_vegetables.errors %}<div class="errors">{{ form.other_vegetables.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.fruits.id_for_label }}">{{ form.fruits.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat fruits yesterday?</div>
        {{ form.fruits }}
        {% if form.fruits.errors %}<div class="errors">{{ form.fruits.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.dal_pulses_beans.id_for_label }}">{{ form.dal_pulses_beans.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat Dal / Pulses / Beans yesterday?</div>
        {{ form.dal_pulses_beans }}
        {% if form.dal_pulses_beans.errors %}<div class="errors">{{ form.dal_pulses_beans.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.milk_curd.id_for_label }}">{{ form.milk_curd.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you drink milk or eat curd yesterday?</div>
        {{ form.milk_curd }}
        {% if form.milk_curd.errors %}<div class="errors">{{ form.milk_curd.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-egg-field">
        <div class="qtitle">
          <label for="{{ form.egg.id_for_label }}">{{ form.egg.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat egg yesterday?</div>
        {{ form.egg }}
        {% if form.egg.errors %}<div class="errors">{{ form.egg.errors }}</div>{% endif %}
      </div>

      <div class="qrow" id="diet-meat-field">
        <div class="qtitle">
          <label for="{{ form.fish_chicken_meat.id_for_label }}">{{ form.fish_chicken_meat.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat Fish / Chicken / Meat in the the last 3 days?</div>
        {{ form.fish_chicken_meat }}
        {% if form.fish_chicken_meat.errors %}<div class="errors">{{ form.fish_chicken_meat.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.nuts_groundnuts.id_for_label }}">{{ form.nuts_groundnuts.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Did you eat Nuts / Groundnuts yesterday?</div>
        {{ form.nuts_groundnuts }}
        {% if form.nuts_groundnuts.errors %}<div class="errors">{{ form.nuts_groundnuts.errors }}</div>{% endif %}
      </div>

      <div class="qrow">
        <div class="qtitle">
          <label for="{{ form.ssb_or_packaged_snacks.id_for_label }}">{{ form.ssb_or_packaged_snacks.label }}</label>
        </div>
        <div class="ask-child">Ask the child- Do you drink soft drinks like coca cola, pepsi, mirinda, fanta, limca etc.? Do you drink fruit juice that is not made at home? Do you eat snacks like biscuits, chocolates, chips, cakes etc.?</div>
        {{ form.ssb_or_packaged_snacks }}
        {% if form.ssb_or_packaged_snacks.errors %}<div class="errors">{{ form.ssb_or_packaged_snacks.errors }}</div>{% endif %}
      </div>
      </fieldset>

<!-- SECTION E -->
      <fieldset>
        <legend>Section E: Program Enablers</legend>

        <div class="grid">
          <div class="field radio">
            <label for="{{ form.deworming_taken.id_for_label }}">{{ form.deworming_taken.label }}</label>
            {{ form.deworming_taken }}
            <div class="ask-child">Ask the child- Did you take the big pill for deworming?</div>
            {% if form.deworming_taken.errors %}<div class="errors">{{ form.deworming_taken.errors }}</div>{% endif %}
          </div>
          <div class="field" id="deworming-months-field">
            <label for="{{ form.deworming_date.id_for_label }}">{{ form.deworming_date.label }}</label>
            {{ form.deworming_date }}
            {% if form.deworming_date.errors %}<div class="errors">{{ form.deworming_date.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

<!-- SECTION F -->
      <fieldset>
        <legend>Section F: Food Security</legend>

        <div class="field radio">
          <label for="{{ form.hunger_vital_sign.id_for_label }}">{{ form.hunger_vital_sign.label }}</label>
          {{ form.hunger_vital_sign }}
          {% if form.hunger_vital_sign.errors %}<div class="errors">{{ form.hunger_vital_sign.errors }}</div>{% endif %}
        </div>
      </fieldset>

      <div class="actions">
        <button class="primary" type="submit">Complete Screening</button>
        <a class="button" href="{% url 'teacher_portal' %}">Cancel</a>
      </div>
    </form>
  </div>
  
  <script>
    (function () {
      'use strict';
    
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
    
      // ---------- Age calculation helpers ----------
      function parseISODateToLocal(iso) {
        // Expect yyyy-mm-dd (from <input type="date">)
        if (!iso) return null;
        var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso));
        if (!m) return null;
        var y = Number(m[1]);
        var mo = Number(m[2]) - 1;
        var d = Number(m[3]);
        var dt = new Date(y, mo, d);
        if (isNaN(dt.getTime())) return null;
        // Validate round-trip (guards invalid dates like 2024-02-31)
        if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
        return dt;
      }
    
      function computeAgeMonths(dob, today) {
        if (!dob || !today) return null;
        var months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
        if (today.getDate() < dob.getDate()) months -= 1; // not completed the month yet
        if (months < 0) return null;
        return months;
      }
    
      function formatAge(months) {
        var y = Math.floor(months / 12);
        var m = months % 12;
        var yLabel = (y === 1) ? 'year' : 'years';
        var mLabel = (m === 1) ? 'month' : 'months';
        return y + ' ' + yLabel + ' ' + m + ' ' + mLabel;
      }
    
      // ---------- Generic helpers ----------
      function clearInputs(root) {
        if (!root) return;
        qsa('input, select, textarea', root).forEach(function (el) {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
          } else {
            el.value = '';
          }
        });
      }
    
      function getCheckedValue(name) {
        var el = qs('input[name="' + name + '"]:checked');
        return el ? el.value : '';
      }
    
      function setRadioChecked(name, value) {
        var el = qs('input[name="' + name + '"][value="' + value + '"]');
        if (el) el.checked = true;
      }
    
      function setSelectValueByName(name, value) {
        var el = qs('select[name="' + name + '"]');
        if (el) el.value = value;
      }
    
      // ---------- DOM refs (shared by both templates) ----------
      var dobEl = qs('[name="dob"]');
      var ageDisplayEl = document.getElementById('age-display');
    
      var sexEl = qs('[name="sex"]');
      var sexHintEl = document.getElementById('sex-disabled-hint');
    
      var muacWrapper = document.getElementById('muac-field');
      var girlsSection = document.getElementById('girls-only-section');
      var menarcheDetails = document.getElementById('girls-menarche-details');
      var menarcheStartedEl = qs('[name="menarche_started"]');
    
      var dewormingMonthsWrapper = document.getElementById('deworming-months-field');
    
      var eggField = document.getElementById('diet-egg-field');
      var meatField = document.getElementById('diet-meat-field');
    
      // ---------- Sync functions ----------
      function syncAgeAndSexLock() {
        var today = new Date();
        var dob = dobEl ? parseISODateToLocal(dobEl.value) : null;
        var ageMonths = dob ? computeAgeMonths(dob, today) : null;
    
        // Age display (below DOB)
        if (ageDisplayEl) {
          ageDisplayEl.textContent = (typeof ageMonths === 'number') ? formatAge(ageMonths) : '';
        }
    
        // Enforce: DOB required before Sex
        if (sexEl) {
          var enableSex = (typeof ageMonths === 'number');
          sexEl.disabled = !enableSex;
    
          if (!enableSex) {
            sexEl.value = '';
          }
    
          if (sexHintEl) {
            sexHintEl.style.display = enableSex ? 'none' : '';
          }
        }
    
        return ageMonths;
      }
    
      function syncMuacVisibility(ageMonths) {
        if (!muacWrapper) return;
    
        // Only hide MUAC for age >= 5 years (>= 60 months)
        var hide = (typeof ageMonths === 'number') && (ageMonths >= 60);
    
        muacWrapper.style.display = hide ? 'none' : '';
    
        if (hide) {
          // Auto-select GREEN so no red/yellow flags occur
          // Support either radio or select (in case rendering changes)
          setRadioChecked('muac_tape_color', 'GREEN');
          setSelectValueByName('muac_tape_color', 'GREEN');
        }
      }
    
      function syncGirlsVisibility(ageMonths) {
        if (!girlsSection) return;
    
        var sex = sexEl ? String(sexEl.value || '').toUpperCase() : '';
        var isGirl = (sex === 'F' || sex === 'FEMALE');
        var is10Plus = (typeof ageMonths === 'number') && (ageMonths >= 120);
    
        var showGirls = isGirl && is10Plus;
    
        girlsSection.style.display = showGirls ? '' : 'none';
    
        if (!showGirls) {
          clearInputs(girlsSection);
          // also hide details wrapper if present
          if (menarcheDetails) menarcheDetails.style.display = 'none';
        }
      }
    
      function syncMenarcheDetailsVisibility() {
        if (!girlsSection || !menarcheDetails) return;
    
        // If girls section is hidden, keep details hidden and cleared.
        if (girlsSection.style.display === 'none') {
          menarcheDetails.style.display = 'none';
          clearInputs(menarcheDetails);
          return;
        }
    
        var started = !!(menarcheStartedEl && menarcheStartedEl.checked);
        menarcheDetails.style.display = started ? '' : 'none';
    
        if (!started) {
          clearInputs(menarcheDetails);
        }
      }
    
      function syncDewormingMonthsVisibility() {
        if (!dewormingMonthsWrapper) return;
    
        var v = getCheckedValue('deworming_taken'); // 'yes' | 'no' | 'dont_know'
        var show = (String(v || '').toLowerCase() === 'yes');
    
        dewormingMonthsWrapper.style.display = show ? '' : 'none';
    
        if (!show) {
          // clear follow-up field when hidden
          clearInputs(dewormingMonthsWrapper);
          // If wrapper contains only the months select, this is enough.
          // If needed, also explicitly clear by name:
          setSelectValueByName('deworming_date', '');
        }
      }
    
      function forceNoAnswer(fieldWrapper, fieldName) {
        if (!fieldWrapper) return;
    
        // New behavior: Yes/No may be a <select>
        var sel = fieldWrapper.querySelector('select[name="' + fieldName + '"]');
        if (sel) {
          sel.value = 'no';
          return;
        }
    
        // Old behavior: Yes/No as radios
        var no = fieldWrapper.querySelector('input[name="' + fieldName + '"][value="no"]');
        if (no) no.checked = true;
      }
    
      function syncDietVisibility() {
        var dietTypeRadios = qsa('input[name="diet_type"]');
        if (!dietTypeRadios.length) return;
    
        var checked = qs('input[name="diet_type"]:checked');
        var dietType = String(checked ? checked.value : '').toUpperCase();
    
        var knownTypes = { 'LACTO_VEG': true, 'LACTO_OVO': true, 'NON_VEG': true };
    
        // Keep default UI unchanged until diet type is chosen.
        var showEgg = !knownTypes[dietType] || dietType === 'LACTO_OVO' || dietType === 'NON_VEG';
        var showMeat = !knownTypes[dietType] || dietType === 'NON_VEG';
    
        if (eggField) {
          eggField.style.display = showEgg ? '' : 'none';
          if (!showEgg) forceNoAnswer(eggField, 'egg');
        }
    
        if (meatField) {
          meatField.style.display = showMeat ? '' : 'none';
          if (!showMeat) forceNoAnswer(meatField, 'fish_chicken_meat');
        }
      }
    
      function syncAll() {
        var ageMonths = syncAgeAndSexLock();
        syncMuacVisibility(ageMonths);
        syncGirlsVisibility(ageMonths);
        syncMenarcheDetailsVisibility();
        syncDewormingMonthsVisibility();
        syncDietVisibility();
      }
    
      // ---------- Wire events ----------
      if (dobEl) dobEl.addEventListener('change', syncAll);
      if (sexEl) sexEl.addEventListener('change', syncAll);
    
      // Menarche checkbox toggles details
      if (menarcheStartedEl) menarcheStartedEl.addEventListener('change', syncMenarcheDetailsVisibility);
    
      // Deworming radios toggle months
      qsa('input[name="deworming_taken"]').forEach(function (el) {
        el.addEventListener('change', syncDewormingMonthsVisibility);
      });
    
      // Diet type radios toggle egg/meat fields
      qsa('input[name="diet_type"]').forEach(function (el) {
        el.addEventListener('change', syncDietVisibility);
      });
    
      // Initial state
      syncAll();
    })();
    </script>
    
  

  <script>
    (function () {
      'use strict';

      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

      function setSelectFromCheckbox(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;
        sel.value = cb.checked ? 'yes' : 'no';
      }

      function setCheckboxFromSelect(sel) {
        var checkboxId = sel.getAttribute('data-checkbox-id');
        if (!checkboxId) return;
        var cb = document.getElementById(checkboxId);
        if (!cb) return;

        cb.checked = (String(sel.value).toLowerCase() === 'yes');

        // Trigger change so existing scripts (e.g. menarche details) react.
        try { cb.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) {}
      }

      function syncYesNoProxies() {
        var sels = qsa('select.yn-proxy[data-checkbox-id]');
        sels.forEach(function (sel) {
          setSelectFromCheckbox(sel);
          sel.addEventListener('change', function () { setCheckboxFromSelect(sel); });
        });
      }

      syncYesNoProxies();
    })();
  </script>
</body>
</html>
