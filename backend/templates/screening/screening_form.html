<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Screening – {{ student.full_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background: #fafafa; color: #111; }
    .container { max-width: 980px; margin: 0 auto; }
    h2 { margin: 0 0 4px 0; }
    .muted { color: #666; font-size: 14px; margin: 4px 0 0 0; }
    form { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; }

    fieldset { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin: 14px 0; }
    legend { padding: 0 8px; font-weight: 700; }
    .section-hint { margin: 8px 0 0 0; color: #666; font-size: 13px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    .field { margin: 8px 0; }
    .field label { display: block; font-size: 13px; color: #333; margin-bottom: 4px; }
    .field input[type="text"], .field input[type="number"], .field input[type="date"], .field select, .field textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }

    .radio ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 14px; flex-wrap: wrap; }
    .radio li { margin: 0; }
    .radio label { display: inline; font-size: 14px; color: #111; margin: 0; }

    .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; margin-top: 6px; }
    @media (max-width: 720px) { .checks { grid-template-columns: 1fr; } }
    .check { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border: 1px solid #f0f0f0; border-radius: 10px; background: #fcfcfc; }
    .check label { margin: 0; display: inline; font-size: 14px; color: #111; }

    .errors { color: #b00020; font-size: 13px; margin-top: 6px; }
    .nonfield { color: #b00020; background: #fff2f2; border: 1px solid #ffd0d0; padding: 10px 12px; border-radius: 10px; margin: 10px 0; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button, a.button {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      text-decoration: none;
      cursor: pointer;
    }
    button.primary { background: #111; color: #fff; border-color: #111; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Screening – {{ student.full_name }}</h2>
    <p class="muted">Complete Sections A–F, then submit to compute GREEN / YELLOW / RED.</p>

    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="nonfield">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- SECTION A -->
      <fieldset>
        <legend>Section A: Particulars</legend>
        <p class="section-hint">Student/teacher details required for the screening record.</p>

        <div class="grid">
          <div class="field">
            <label for="{{ form.student_name.id_for_label }}">{{ form.student_name.label }}</label>
            {{ form.student_name }}
            {% if form.student_name.errors %}<div class="errors">{{ form.student_name.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.unique_student_id.id_for_label }}">{{ form.unique_student_id.label }}</label>
            {{ form.unique_student_id }}
            {% if form.unique_student_id.errors %}<div class="errors">{{ form.unique_student_id.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.dob.id_for_label }}">{{ form.dob.label }}</label>
            {{ form.dob }}
            {% if form.dob.errors %}<div class="errors">{{ form.dob.errors }}</div>{% endif %}
            <div id="age-display" class="muted" style="margin-top: 4px;"></div>
          </div>

          <div class="field">
            <label for="{{ form.sex.id_for_label }}">{{ form.sex.label }}</label>
            {{ form.sex }}
            {% if form.sex.errors %}<div class="errors">{{ form.sex.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.parent_phone_e164.id_for_label }}">{{ form.parent_phone_e164.label }}</label>
            {{ form.parent_phone_e164 }}
            {% if form.parent_phone_e164.errors %}<div class="errors">{{ form.parent_phone_e164.errors }}</div>{% endif %}
          </div>
        </div>
      </fieldset>

      <!-- SECTION B -->
      <fieldset>
        <legend>Section B: Anthropometry</legend>
        <p class="section-hint">
          Enter one reading each for weight and height; the system will compute BMI and BAZ where applicable.
          MUAC is used for ages 6–59 months only.
        </p>

        <div class="grid">
          <div class="field">
            <label for="{{ form.weight_kg_r1.id_for_label }}">{{ form.weight_kg_r1.label }}</label>
            {{ form.weight_kg_r1 }}
            {% if form.weight_kg_r1.errors %}<div class="errors">{{ form.weight_kg_r1.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <label for="{{ form.height_cm_r1.id_for_label }}">{{ form.height_cm_r1.label }}</label>
            {{ form.height_cm_r1 }}
            {% if form.height_cm_r1.errors %}<div class="errors">{{ form.height_cm_r1.errors }}</div>{% endif %}
          </div>

          <div class="field radio" id="muac-field">
            <label for="{{ form.muac_tape_color.id_for_label }}">{{ form.muac_tape_color.label }}</label>
            {{ form.muac_tape_color }}
            {% if form.muac_tape_color.errors %}<div class="errors">{{ form.muac_tape_color.errors }}</div>{% endif %}
          </div>

        </div>
      </fieldset>


      <!-- SECTION C -->
      <fieldset>
        <legend>Section C: Quick Health Red Flags</legend>
        <p class="section-hint">Tick any that apply. Any red-flag symptom may lead to RED status.</p>

        <div class="checks">
          <div class="check">{{ form.health_general_poor }} <label for="{{ form.health_general_poor.id_for_label }}">{{ form.health_general_poor.label }}</label></div>
          <div class="check">{{ form.health_pallor }} <label for="{{ form.health_pallor.id_for_label }}">{{ form.health_pallor.label }}</label></div>
          <div class="check">{{ form.health_fatigue_dizzy_faint }} <label for="{{ form.health_fatigue_dizzy_faint.id_for_label }}">{{ form.health_fatigue_dizzy_faint.label }}</label></div>
          <div class="check">{{ form.health_breathlessness }} <label for="{{ form.health_breathlessness.id_for_label }}">{{ form.health_breathlessness.label }}</label></div>
          <div class="check">{{ form.health_frequent_infections }} <label for="{{ form.health_frequent_infections.id_for_label }}">{{ form.health_frequent_infections.label }}</label></div>
          <div class="check">{{ form.health_chronic_cough_or_diarrhea }} <label for="{{ form.health_chronic_cough_or_diarrhea.id_for_label }}">{{ form.health_chronic_cough_or_diarrhea.label }}</label></div>
          <div class="check">{{ form.health_visible_worms }} <label for="{{ form.health_visible_worms.id_for_label }}">{{ form.health_visible_worms.label }}</label></div>
          <div class="check">{{ form.health_dental_or_gum_or_ulcers }} <label for="{{ form.health_dental_or_gum_or_ulcers.id_for_label }}">{{ form.health_dental_or_gum_or_ulcers.label }}</label></div>
          <div class="check">{{ form.health_night_vision_difficulty }} <label for="{{ form.health_night_vision_difficulty.id_for_label }}">{{ form.health_night_vision_difficulty.label }}</label></div>
          <div class="check">{{ form.health_bone_or_joint_pain }} <label for="{{ form.health_bone_or_joint_pain.id_for_label }}">{{ form.health_bone_or_joint_pain.label }}</label></div>
        </div>

        {% if form.health_general_poor.errors or form.health_pallor.errors or form.health_fatigue_dizzy_faint.errors %}
          <div class="errors">Please review the health checkbox inputs.</div>
        {% endif %}

        <div class="field radio" style="margin-top: 12px;">
          <label for="{{ form.appetite.id_for_label }}">{{ form.appetite.label }}</label>
          {{ form.appetite }}
          {% if form.appetite.errors %}<div class="errors">{{ form.appetite.errors }}</div>{% endif %}
        </div>

        <fieldset id="girls-only-section" style="margin-top: 12px;">
          <legend>Girls only (Age 10+)</legend>
          <p class="section-hint">Visible only for girls age 10+. The following fields appear only if menarche has started.</p>

          <div class="checks">
            <div class="check">{{ form.menarche_started }}
              <label for="{{ form.menarche_started.id_for_label }}">{{ form.menarche_started.label }}</label>
            </div>
          </div>

          <div id="girls-menarche-details" style="margin-top: 8px;">
            <div class="grid">
              <div class="field">
                <label for="{{ form.menarche_age_years.id_for_label }}">{{ form.menarche_age_years.label }}</label>
                {{ form.menarche_age_years }}
              </div>
              <div class="field">
                <label for="{{ form.pads_per_day.id_for_label }}">{{ form.pads_per_day.label }}</label>
                {{ form.pads_per_day }}
              </div>
              <div class="field">
                <label for="{{ form.cycle_length_days.id_for_label }}">{{ form.cycle_length_days.label }}</label>
                {{ form.cycle_length_days }}
              </div>
            </div>

            <div class="checks" style="margin-top: 8px;">
              <div class="check">{{ form.bleeding_clots }}
                <label for="{{ form.bleeding_clots.id_for_label }}">{{ form.bleeding_clots.label }}</label>
              </div>
            </div>
          </div>
        </fieldset>

      </fieldset>

      <!-- SECTION D -->
      <fieldset>
        <legend>Section D: Diet Type & Diversity</legend>
        <p class="section-hint">Answer Yes/No for each item. Low diversity contributes to YELLOW status.</p>

        <div class="field radio">
          <label for="{{ form.diet_type.id_for_label }}">{{ form.diet_type.label }}</label>
          {{ form.diet_type }}
          {% if form.diet_type.errors %}<div class="errors">{{ form.diet_type.errors }}</div>{% endif %}
        </div>

        <div class="grid" style="margin-top: 8px;">
          <div class="field radio">
            <label for="{{ form.breakfast_eaten.id_for_label }}">{{ form.breakfast_eaten.label }}</label>
            {{ form.breakfast_eaten }}
            {% if form.breakfast_eaten.errors %}<div class="errors">{{ form.breakfast_eaten.errors }}</div>{% endif %}
          </div>

          <div class="field radio">
            <label for="{{ form.lunch_eaten.id_for_label }}">{{ form.lunch_eaten.label }}</label>
            {{ form.lunch_eaten }}
            {% if form.lunch_eaten.errors %}<div class="errors">{{ form.lunch_eaten.errors }}</div>{% endif %}
          </div>
        </div>
        
        <p class="section-hint" style="margin-top: 12px; font-weight: 700; color: #111;">
          Did the student have the following in last 24 hours?
        </p>

        <div class="grid">
          <div class="field radio"><label>{{ form.green_leafy_veg.label }}</label>{{ form.green_leafy_veg }}{% if form.green_leafy_veg.errors %}<div class="errors">{{ form.green_leafy_veg.errors }}</div>{% endif %}</div>
          <div class="field radio"><label>{{ form.other_vegetables.label }}</label>{{ form.other_vegetables }}{% if form.other_vegetables.errors %}<div class="errors">{{ form.other_vegetables.errors }}</div>{% endif %}</div>

          <div class="field radio"><label>{{ form.fruits.label }}</label>{{ form.fruits }}{% if form.fruits.errors %}<div class="errors">{{ form.fruits.errors }}</div>{% endif %}</div>
          <div class="field radio"><label>{{ form.dal_pulses_beans.label }}</label>{{ form.dal_pulses_beans }}{% if form.dal_pulses_beans.errors %}<div class="errors">{{ form.dal_pulses_beans.errors }}</div>{% endif %}</div>

          <div class="field radio"><label>{{ form.milk_curd.label }}</label>{{ form.milk_curd }}{% if form.milk_curd.errors %}<div class="errors">{{ form.milk_curd.errors }}</div>{% endif %}</div>
          <div class="field radio" id="diet-egg-field">
            <label>{{ form.egg.label }}</label>
            {{ form.egg }}
            {% if form.egg.errors %}<div class="errors">{{ form.egg.errors }}</div>{% endif %}
          </div>
          

          <div class="field radio" id="diet-meat-field">
            <label>{{ form.fish_chicken_meat.label }}</label>
            {{ form.fish_chicken_meat }}
            {% if form.fish_chicken_meat.errors %}<div class="errors">{{ form.fish_chicken_meat.errors }}</div>{% endif %}
          </div>
          
          <div class="field radio"><label>{{ form.nuts_groundnuts.label }}</label>{{ form.nuts_groundnuts }}{% if form.nuts_groundnuts.errors %}<div class="errors">{{ form.nuts_groundnuts.errors }}</div>{% endif %}</div>

          <div class="field radio"><label>{{ form.ssb_or_packaged_snacks.label }}</label>{{ form.ssb_or_packaged_snacks }}{% if form.ssb_or_packaged_snacks.errors %}<div class="errors">{{ form.ssb_or_packaged_snacks.errors }}</div>{% endif %}</div>
        </div>
      </fieldset>

      <!-- SECTION E -->
      <fieldset>
        <legend>Section E: Program Enablers</legend>
        <p class="section-hint">Deworming is a key enabler; missing deworming contributes to YELLOW status.</p>

        <div class="grid">
          <div class="field radio">
            <label for="{{ form.deworming_taken.id_for_label }}">{{ form.deworming_taken.label }}</label>
            {{ form.deworming_taken }}
            {% if form.deworming_taken.errors %}<div class="errors">{{ form.deworming_taken.errors }}</div>{% endif %}
          </div>
          <div class="field" id="deworming-months-field">
            <div class="field">
              <label for="{{ form.deworming_date.id_for_label }}">{{ form.deworming_date.label }}</label>
              {{ form.deworming_date }}
              {% if form.deworming_date.errors %}<div class="errors">{{ form.deworming_date.errors }}</div>{% endif %}
            </div>
          </div>
        </div>
      </fieldset>

      <!-- SECTION F -->
      <fieldset>
        <legend>Section F: Food Security</legend>
        <p class="section-hint">If “Never true” or “Sometimes true”, status becomes RED per logic.</p>

        <div class="field radio">
          <label for="{{ form.hunger_vital_sign.id_for_label }}">{{ form.hunger_vital_sign.label }}</label>
          {{ form.hunger_vital_sign }}
          {% if form.hunger_vital_sign.errors %}<div class="errors">{{ form.hunger_vital_sign.errors }}</div>{% endif %}
        </div>
      </fieldset>

      <div class="actions">
        <button class="primary" type="submit">Complete Screening</button>
        <a class="button" href="{% url 'teacher_portal' %}">Cancel</a>
      </div>
    </form>
  </div>
  
  <script>
    (function () {
      'use strict';
    
      function qs(sel, root) { return (root || document).querySelector(sel); }
      function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }
    
      // ---------- Age calculation helpers ----------
      function parseISODateToLocal(iso) {
        // Expect yyyy-mm-dd (from <input type="date">)
        if (!iso) return null;
        var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso));
        if (!m) return null;
        var y = Number(m[1]);
        var mo = Number(m[2]) - 1;
        var d = Number(m[3]);
        var dt = new Date(y, mo, d);
        if (isNaN(dt.getTime())) return null;
        // Validate round-trip (guards invalid dates like 2024-02-31)
        if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
        return dt;
      }
    
      function computeAgeMonths(dob, today) {
        if (!dob || !today) return null;
        var months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
        if (today.getDate() < dob.getDate()) months -= 1; // not completed the month yet
        if (months < 0) return null;
        return months;
      }
    
      function formatAge(months) {
        var y = Math.floor(months / 12);
        var m = months % 12;
        var yLabel = (y === 1) ? 'year' : 'years';
        var mLabel = (m === 1) ? 'month' : 'months';
        return y + ' ' + yLabel + ' ' + m + ' ' + mLabel;
      }
    
      // ---------- Generic helpers ----------
      function clearInputs(root) {
        if (!root) return;
        qsa('input, select, textarea', root).forEach(function (el) {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
          } else {
            el.value = '';
          }
        });
      }
    
      function getCheckedValue(name) {
        var el = qs('input[name="' + name + '"]:checked');
        return el ? el.value : '';
      }
    
      function setRadioChecked(name, value) {
        var el = qs('input[name="' + name + '"][value="' + value + '"]');
        if (el) el.checked = true;
      }
    
      function setSelectValueByName(name, value) {
        var el = qs('select[name="' + name + '"]');
        if (el) el.value = value;
      }
    
      // ---------- DOM refs (shared by both templates) ----------
      var dobEl = qs('[name="dob"]');
      var ageDisplayEl = document.getElementById('age-display');
    
      var sexEl = qs('[name="sex"]');
      var sexHintEl = document.getElementById('sex-disabled-hint');
    
      var muacWrapper = document.getElementById('muac-field');
      var girlsSection = document.getElementById('girls-only-section');
      var menarcheDetails = document.getElementById('girls-menarche-details');
      var menarcheStartedEl = qs('[name="menarche_started"]');
    
      var dewormingMonthsWrapper = document.getElementById('deworming-months-field');
    
      var eggField = document.getElementById('diet-egg-field');
      var meatField = document.getElementById('diet-meat-field');
    
      // ---------- Sync functions ----------
      function syncAgeAndSexLock() {
        var today = new Date();
        var dob = dobEl ? parseISODateToLocal(dobEl.value) : null;
        var ageMonths = dob ? computeAgeMonths(dob, today) : null;
    
        // Age display (below DOB)
        if (ageDisplayEl) {
          ageDisplayEl.textContent = (typeof ageMonths === 'number') ? formatAge(ageMonths) : '';
        }
    
        // Enforce: DOB required before Sex
        if (sexEl) {
          var enableSex = (typeof ageMonths === 'number');
          sexEl.disabled = !enableSex;
    
          if (!enableSex) {
            sexEl.value = '';
          }
    
          if (sexHintEl) {
            sexHintEl.style.display = enableSex ? 'none' : '';
          }
        }
    
        return ageMonths;
      }
    
      function syncMuacVisibility(ageMonths) {
        if (!muacWrapper) return;
    
        // Only hide MUAC for age >= 5 years (>= 60 months)
        var hide = (typeof ageMonths === 'number') && (ageMonths >= 60);
    
        muacWrapper.style.display = hide ? 'none' : '';
    
        if (hide) {
          // Auto-select GREEN so no red/yellow flags occur
          // Support either radio or select (in case rendering changes)
          setRadioChecked('muac_tape_color', 'GREEN');
          setSelectValueByName('muac_tape_color', 'GREEN');
        }
      }
    
      function syncGirlsVisibility(ageMonths) {
        if (!girlsSection) return;
    
        var sex = sexEl ? String(sexEl.value || '').toUpperCase() : '';
        var isGirl = (sex === 'F' || sex === 'FEMALE');
        var is10Plus = (typeof ageMonths === 'number') && (ageMonths >= 120);
    
        var showGirls = isGirl && is10Plus;
    
        girlsSection.style.display = showGirls ? '' : 'none';
    
        if (!showGirls) {
          clearInputs(girlsSection);
          // also hide details wrapper if present
          if (menarcheDetails) menarcheDetails.style.display = 'none';
        }
      }
    
      function syncMenarcheDetailsVisibility() {
        if (!girlsSection || !menarcheDetails) return;
    
        // If girls section is hidden, keep details hidden and cleared.
        if (girlsSection.style.display === 'none') {
          menarcheDetails.style.display = 'none';
          clearInputs(menarcheDetails);
          return;
        }
    
        var started = !!(menarcheStartedEl && menarcheStartedEl.checked);
        menarcheDetails.style.display = started ? '' : 'none';
    
        if (!started) {
          clearInputs(menarcheDetails);
        }
      }
    
      function syncDewormingMonthsVisibility() {
        if (!dewormingMonthsWrapper) return;
    
        var v = getCheckedValue('deworming_taken'); // 'yes' | 'no' | 'dont_know'
        var show = (String(v || '').toLowerCase() === 'yes');
    
        dewormingMonthsWrapper.style.display = show ? '' : 'none';
    
        if (!show) {
          // clear follow-up field when hidden
          clearInputs(dewormingMonthsWrapper);
          // If wrapper contains only the months select, this is enough.
          // If needed, also explicitly clear by name:
          setSelectValueByName('deworming_date', '');
        }
      }
    
      function forceNoAnswer(fieldWrapper, fieldName) {
        if (!fieldWrapper) return;
    
        // New behavior: Yes/No may be a <select>
        var sel = fieldWrapper.querySelector('select[name="' + fieldName + '"]');
        if (sel) {
          sel.value = 'no';
          return;
        }
    
        // Old behavior: Yes/No as radios
        var no = fieldWrapper.querySelector('input[name="' + fieldName + '"][value="no"]');
        if (no) no.checked = true;
      }
    
      function syncDietVisibility() {
        var dietTypeRadios = qsa('input[name="diet_type"]');
        if (!dietTypeRadios.length) return;
    
        var checked = qs('input[name="diet_type"]:checked');
        var dietType = String(checked ? checked.value : '').toUpperCase();
    
        var knownTypes = { 'LACTO_VEG': true, 'LACTO_OVO': true, 'NON_VEG': true };
    
        // Keep default UI unchanged until diet type is chosen.
        var showEgg = !knownTypes[dietType] || dietType === 'LACTO_OVO' || dietType === 'NON_VEG';
        var showMeat = !knownTypes[dietType] || dietType === 'NON_VEG';
    
        if (eggField) {
          eggField.style.display = showEgg ? '' : 'none';
          if (!showEgg) forceNoAnswer(eggField, 'egg');
        }
    
        if (meatField) {
          meatField.style.display = showMeat ? '' : 'none';
          if (!showMeat) forceNoAnswer(meatField, 'fish_chicken_meat');
        }
      }
    
      function syncAll() {
        var ageMonths = syncAgeAndSexLock();
        syncMuacVisibility(ageMonths);
        syncGirlsVisibility(ageMonths);
        syncMenarcheDetailsVisibility();
        syncDewormingMonthsVisibility();
        syncDietVisibility();
      }
    
      // ---------- Wire events ----------
      if (dobEl) dobEl.addEventListener('change', syncAll);
      if (sexEl) sexEl.addEventListener('change', syncAll);
    
      // Menarche checkbox toggles details
      if (menarcheStartedEl) menarcheStartedEl.addEventListener('change', syncMenarcheDetailsVisibility);
    
      // Deworming radios toggle months
      qsa('input[name="deworming_taken"]').forEach(function (el) {
        el.addEventListener('change', syncDewormingMonthsVisibility);
      });
    
      // Diet type radios toggle egg/meat fields
      qsa('input[name="diet_type"]').forEach(function (el) {
        el.addEventListener('change', syncDietVisibility);
      });
    
      // Initial state
      syncAll();
    })();
    </script>
    
  
</body>
</html>
